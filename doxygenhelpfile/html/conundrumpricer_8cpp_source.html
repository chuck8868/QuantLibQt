<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>QuantLib: /home/deriversatile/QuantLib/QuantLibQt/ql/cashflows/conundrumpricer.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">QuantLib
   &#160;<span id="projectnumber">1.3</span>
   </div>
   <div id="projectbrief">ql1-3</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('conundrumpricer_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">conundrumpricer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="conundrumpricer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> Copyright (C) 2006 Giorgio Facchinetti</span>
<a name="l00003"></a>00003 <span class="comment"> Copyright (C) 2006 Mario Pucci</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment"> This file is part of QuantLib, a free-software/open-source library</span>
<a name="l00006"></a>00006 <span class="comment"> for financial quantitative analysts and developers - http://quantlib.org/</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment"> QuantLib is free software: you can redistribute it and/or modify it</span>
<a name="l00009"></a>00009 <span class="comment"> under the terms of the QuantLib license.  You should have received a</span>
<a name="l00010"></a>00010 <span class="comment"> copy of the license along with this program; if not, please email</span>
<a name="l00011"></a>00011 <span class="comment"> &lt;quantlib-dev@lists.sf.net&gt;. The license is also available online at</span>
<a name="l00012"></a>00012 <span class="comment"> &lt;http://quantlib.org/license.shtml&gt;.</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment"> This program is distributed in the hope that it will be useful, but</span>
<a name="l00016"></a>00016 <span class="comment"> WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<a name="l00017"></a>00017 <span class="comment"> or FITNESS FOR A PARTICULAR PURPOSE. See the license for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="conundrumpricer_8hpp.html" title="CMS-coupon pricer.">ql/cashflows/conundrumpricer.hpp</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="kronrodintegral_8hpp.html" title="Integral of a 1-dimensional function using the Gauss-Kronrod method.">ql/math/integrals/kronrodintegral.hpp</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="normaldistribution_8hpp.html" title="normal, cumulative and inverse cumulative distributions">ql/math/distributions/normaldistribution.hpp</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="blackformula_8hpp.html" title="Black formula.">ql/pricingengines/blackformula.hpp</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="newton_8hpp.html" title="Newton 1-D solver.">ql/math/solvers1d/newton.hpp</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="smilesection_8hpp.html" title="Smile section base class.">ql/termstructures/volatility/smilesection.hpp</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="cmscoupon_8hpp.html" title="CMS coupon.">ql/cashflows/cmscoupon.hpp</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="yieldtermstructure_8hpp.html" title="Interest-rate term structure.">ql/termstructures/yieldtermstructure.hpp</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="simplequote_8hpp.html" title="simple quote class">ql/quotes/simplequote.hpp</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="swapindex_8hpp.html" title="swap-rate indexes">ql/indexes/swapindex.hpp</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="interestrateindex_8hpp.html" title="base class for interest rate indexes">ql/indexes/interestrateindex.hpp</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="ql_2time_2schedule_8hpp.html">ql/time/schedule.hpp</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="vanillaswap_8hpp.html" title="Simple fixed-rate vs Libor swap.">ql/instruments/vanillaswap.hpp</a>&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="keyword">namespace </span>QuantLib {
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">//===========================================================================//</span>
<a name="l00043"></a>00043 <span class="comment">//                          BlackVanillaOptionPricer                         //</span>
<a name="l00044"></a>00044 <span class="comment">//===========================================================================//</span>
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#abc504bbe30be09090059f06c614a87e0">00046</a>     <a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#abc504bbe30be09090059f06c614a87e0">BlackVanillaOptionPricer::BlackVanillaOptionPricer</a>(
<a name="l00047"></a>00047             <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> forwardValue,
<a name="l00048"></a>00048             <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> expiryDate,
<a name="l00049"></a>00049             <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_period.html">Period</a>&amp; swapTenor,
<a name="l00050"></a>00050             <span class="keyword">const</span> boost::shared_ptr&lt;SwaptionVolatilityStructure&gt;&amp; volatilityStructure) :
<a name="l00051"></a>00051     forwardValue_(forwardValue), expiryDate_(expiryDate), swapTenor_(swapTenor),
<a name="l00052"></a>00052         volatilityStructure_(volatilityStructure),
<a name="l00053"></a>00053         smile_(volatilityStructure_-&gt;smileSection(expiryDate_, swapTenor_)) {
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#af246b098a76c47abaedafdb4e90cf568">00056</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#af246b098a76c47abaedafdb4e90cf568">BlackVanillaOptionPricer::operator()</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike,
<a name="l00057"></a>00057                                               <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> optionType,
<a name="l00058"></a>00058                                               <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deflator)<span class="keyword"> const </span>{
<a name="l00059"></a>00059         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance = <a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#a1344dda056a6e6e158807c76a9b4f481">smile_</a>-&gt;variance(strike);
<a name="l00060"></a>00060         <span class="keywordflow">return</span> deflator * <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(optionType, strike,
<a name="l00061"></a>00061             <a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html#a84e08ba918cec8a670678b55c19975ad">forwardValue_</a>, std::sqrt(variance));
<a name="l00062"></a>00062     }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">//===========================================================================//</span>
<a name="l00066"></a>00066 <span class="comment">//                             HaganPricer                               //</span>
<a name="l00067"></a>00067 <span class="comment">//===========================================================================//</span>
<a name="l00068"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a0fefad3d776101a4ca31baf72e4a4090">00068</a>     <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a0fefad3d776101a4ca31baf72e4a4090">HaganPricer::HaganPricer</a>(
<a name="l00069"></a>00069                 <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;SwaptionVolatilityStructure&gt;</a>&amp; swaptionVol,
<a name="l00070"></a>00070                 <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7">GFunctionFactory::YieldCurveModel</a> modelOfYieldCurve,
<a name="l00071"></a>00071                 <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>&amp; meanReversion)
<a name="l00072"></a>00072     : <a class="code" href="class_quant_lib_1_1_cms_coupon_pricer.html" title="base pricer for vanilla CMS coupons">CmsCouponPricer</a>(swaptionVol),
<a name="l00073"></a>00073       modelOfYieldCurve_(modelOfYieldCurve),
<a name="l00074"></a>00074       cutoffForCaplet_(2), cutoffForFloorlet_(0),
<a name="l00075"></a>00075       meanReversion_(meanReversion) {
<a name="l00076"></a>00076           <a class="code" href="class_quant_lib_1_1_observer.html#a4c9f4fc7a6b55b246566c40462b95121">registerWith</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aae634a1a2f490a623c63da255f1d09ca">meanReversion_</a>);
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#ac166d89a0750832b5670f9c840277a51">00079</a>     <span class="keywordtype">void</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#ac166d89a0750832b5670f9c840277a51">HaganPricer::initialize</a>(<span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html" title="base floating-rate coupon class">FloatingRateCoupon</a>&amp; coupon){
<a name="l00080"></a>00080         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a> =  <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_quant_lib_1_1_cms_coupon.html" title="CMS coupon class.">CmsCoupon</a>*<span class="keyword">&gt;</span>(&amp;coupon);
<a name="l00081"></a>00081         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>, <span class="stringliteral">&quot;CMS coupon needed&quot;</span>);
<a name="l00082"></a>00082         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html#a6899d7fd252bc77fa4da197c6079108d" title="index gearing, i.e. multiplicative coefficient for the index">gearing</a>();
<a name="l00083"></a>00083         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acfd12878edba4d013b4d3237a2836fdf">spread_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html#ac548f352341aab3b734217316148806a" title="spread paid over the fixing of the underlying index">spread</a>();
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html#ade4e0a12442deea28516877180463e69" title="fixing date">fixingDate</a>();
<a name="l00086"></a>00086         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acdbbcabc3ec155e8011da10248d42f39">paymentDate_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#a788ea38a274e104a4b10e98544053fc8">date</a>();
<a name="l00087"></a>00087         <span class="keyword">const</span> boost::shared_ptr&lt;SwapIndex&gt;&amp; swapIndex = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>();
<a name="l00088"></a>00088         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a> = *(swapIndex-&gt;forwardingTermStructure());
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>();
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="keywordflow">if</span>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acdbbcabc3ec155e8011da10248d42f39">paymentDate_</a> &gt; today)
<a name="l00093"></a>00093             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a>-&gt;discount(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acdbbcabc3ec155e8011da10248d42f39">paymentDate_</a>);
<a name="l00094"></a>00094         <span class="keywordflow">else</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>= 1.;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af7bfe24cf6893d63a5c81c9bb8be90b7">spreadLegValue_</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acfd12878edba4d013b4d3237a2836fdf">spread_</a> * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()* <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> &gt; today){
<a name="l00099"></a>00099             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a> = swapIndex-&gt;tenor();
<a name="l00100"></a>00100             boost::shared_ptr&lt;VanillaSwap&gt; <a class="code" href="namespace_quant_lib.html#a68c12b666ea6ffeba405c5e5e5303b03">swap</a> = swapIndex-&gt;underlyingSwap(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a> = swap-&gt;fairRate();
<a name="l00103"></a>00103 
<a name="l00104"></a>00104             <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#ad61d2e1a3f01154233de0d5fbb85177c" title="spreads on interest rates">Spread</a> bp = 1.0e-4;
<a name="l00105"></a>00105             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a> = (swap-&gt;floatingLegBPS()/bp);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107             <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> q = swapIndex-&gt;fixedLegTenor().frequency();
<a name="l00108"></a>00108             <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_schedule.html" title="Payment schedule.">Schedule</a>&amp; schedule = swap-&gt;fixedSchedule();
<a name="l00109"></a>00109             <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a>&amp; dc = swapIndex-&gt;dayCounter();
<a name="l00110"></a>00110             <span class="comment">//const DayCounter dc = coupon.dayCounter();</span>
<a name="l00111"></a>00111             <a class="code" href="namespace_quant_lib.html#a4f78b18a4dd1a979eb78b4e1e8ac1503" title="continuous quantity with 1-year units">Time</a> startTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a>-&gt;referenceDate(),
<a name="l00112"></a>00112                                              swap-&gt;startDate());
<a name="l00113"></a>00113             <a class="code" href="namespace_quant_lib.html#a4f78b18a4dd1a979eb78b4e1e8ac1503" title="continuous quantity with 1-year units">Time</a> swapFirstPaymentTime =
<a name="l00114"></a>00114                 dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a>-&gt;referenceDate(), schedule.<a class="code" href="class_quant_lib_1_1_schedule.html#a80b5a2496275939f69991e1b72dfe158">date</a>(1));
<a name="l00115"></a>00115             <a class="code" href="namespace_quant_lib.html#a4f78b18a4dd1a979eb78b4e1e8ac1503" title="continuous quantity with 1-year units">Time</a> paymentTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a>-&gt;referenceDate(),
<a name="l00116"></a>00116                                                <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acdbbcabc3ec155e8011da10248d42f39">paymentDate_</a>);
<a name="l00117"></a>00117             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta = (paymentTime-startTime) / (swapFirstPaymentTime-startTime);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119             <span class="keywordflow">switch</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a1894ea557ce85c0c635d44d5fcb5d6db">modelOfYieldCurve_</a>) {
<a name="l00120"></a>00120                 <span class="keywordflow">case</span> <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7ad4a2ae733569c325e22e5e8f7de85d5e">GFunctionFactory::Standard</a>:
<a name="l00121"></a>00121                     <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a2943ea230bf009e8e3f63c07f80b6ed2">GFunctionFactory::newGFunctionStandard</a>(q, delta, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a>.<a class="code" href="class_quant_lib_1_1_period.html#abdabf27dcfc80e09d06989d5941a9188">length</a>());
<a name="l00122"></a>00122                     <span class="keywordflow">break</span>;
<a name="l00123"></a>00123                 <span class="keywordflow">case</span> <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7ac6286a660ef6120c6964724e37ee1feb">GFunctionFactory::ExactYield</a>:
<a name="l00124"></a>00124                     <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a6cc5452c93c6ba8fc2ababf17310d478">GFunctionFactory::newGFunctionExactYield</a>(*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>);
<a name="l00125"></a>00125                     <span class="keywordflow">break</span>;
<a name="l00126"></a>00126                 <span class="keywordflow">case</span> <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7afab545f138f4bf2dc2b75dc6a24b24de">GFunctionFactory::ParallelShifts</a>: {
<a name="l00127"></a>00127                     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> nullMeanReversionQuote(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(0.0)));
<a name="l00128"></a>00128                     <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory.html#af23b90b4f8b591f490e5b58122eb7927">GFunctionFactory::newGFunctionWithShifts</a>(*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>, nullMeanReversionQuote);
<a name="l00129"></a>00129                     }
<a name="l00130"></a>00130                     <span class="keywordflow">break</span>;
<a name="l00131"></a>00131                 <span class="keywordflow">case</span> <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7a4c09dcf23d634a5ace62dffed99abc93">GFunctionFactory::NonParallelShifts</a>:
<a name="l00132"></a>00132                     <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory.html#af23b90b4f8b591f490e5b58122eb7927">GFunctionFactory::newGFunctionWithShifts</a>(*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aae634a1a2f490a623c63da255f1d09ca">meanReversion_</a>);
<a name="l00133"></a>00133                     <span class="keywordflow">break</span>;
<a name="l00134"></a>00134                 <span class="keywordflow">default</span>:
<a name="l00135"></a>00135                     <a class="code" href="errors_8hpp.html#a8efe9cb3e67c8d0585e57b4d53c5d2fe" title="throw an error (possibly with file and line information)">QL_FAIL</a>(<span class="stringliteral">&quot;unknown/illegal gFunction type&quot;</span>);
<a name="l00136"></a>00136             }
<a name="l00137"></a>00137             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a12ccf78a4cf422133758334cd8335088">vanillaOptionPricer_</a>= boost::shared_ptr&lt;VanillaOptionPricer&gt;(<span class="keyword">new</span>
<a name="l00138"></a>00138                 <a class="code" href="class_quant_lib_1_1_black_vanilla_option_pricer.html">BlackVanillaOptionPricer</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a>,
<a name="l00139"></a>00139                                         *<a class="code" href="class_quant_lib_1_1_cms_coupon_pricer.html#ad417d63974807dca3ec7a112bd78555b">swaptionVolatility</a>()));
<a name="l00140"></a>00140          }
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a71ef5a53b1c644ca330147499c61541a">00143</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a71ef5a53b1c644ca330147499c61541a">HaganPricer::meanReversion</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aae634a1a2f490a623c63da255f1d09ca">meanReversion_</a>-&gt;value();}
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa45bb41e56a3fbe5289921d0e9a4533a">00145</a>     <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa45bb41e56a3fbe5289921d0e9a4533a">HaganPricer::swapletRate</a>()<span class="keyword"> const </span>{
<a name="l00146"></a>00146         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#ae6cf7a8b93927b7e6abe13e474573761">swapletPrice</a>()/(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00147"></a>00147     }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8149bb11679d21d7f940307ff73e4955">00149</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8149bb11679d21d7f940307ff73e4955">HaganPricer::capletPrice</a>(<a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveCap)<span class="keyword"> const </span>{
<a name="l00150"></a>00150         <span class="comment">// caplet is equivalent to call option on fixing</span>
<a name="l00151"></a>00151         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>();
<a name="l00152"></a>00152         <span class="keywordflow">if</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> &lt;= today) {
<a name="l00153"></a>00153             <span class="comment">// the fixing is determined</span>
<a name="l00154"></a>00154             <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> Rs =
<a name="l00155"></a>00155                 std::max(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>()-&gt;fixing(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>)-effectiveCap, 0.);
<a name="l00156"></a>00156             <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> price = (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a>*Rs)*(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00157"></a>00157             <span class="keywordflow">return</span> price;
<a name="l00158"></a>00158         } <span class="keywordflow">else</span> {
<a name="l00159"></a>00159             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> cutoffNearZero = 1e-10;
<a name="l00160"></a>00160             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8149bb11679d21d7f940307ff73e4955">capletPrice</a> = 0;
<a name="l00161"></a>00161             <span class="keywordflow">if</span> (effectiveCap &lt; <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8d981391b98f1df5f11fb46bb758d323">cutoffForCaplet_</a>) {
<a name="l00162"></a>00162                 <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveStrikeForMax = std::max(effectiveCap,cutoffNearZero);
<a name="l00163"></a>00163                 capletPrice = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a7bec565a0e862a620d413908cba59e61">optionletPrice</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, effectiveStrikeForMax);
<a name="l00164"></a>00164             }
<a name="l00165"></a>00165             <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a> * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8149bb11679d21d7f940307ff73e4955">capletPrice</a>;
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#ae57596a94b2e7ff47be44eec5e406925">00169</a>     <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#ae57596a94b2e7ff47be44eec5e406925">HaganPricer::capletRate</a>(<a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveCap)<span class="keyword"> const </span>{
<a name="l00170"></a>00170         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a8149bb11679d21d7f940307ff73e4955">capletPrice</a>(effectiveCap)/(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af33ab98d5074f9ac651ca1ce228816e3">00173</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af33ab98d5074f9ac651ca1ce228816e3">HaganPricer::floorletPrice</a>(<a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveFloor)<span class="keyword"> const </span>{
<a name="l00174"></a>00174         <span class="comment">// floorlet is equivalent to put option on fixing</span>
<a name="l00175"></a>00175         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>();
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> &lt;= today) {
<a name="l00177"></a>00177             <span class="comment">// the fixing is determined</span>
<a name="l00178"></a>00178             <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> Rs =
<a name="l00179"></a>00179                 std::max(effectiveFloor-<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>()-&gt;fixing(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>),0.);
<a name="l00180"></a>00180             <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> price = (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a>*Rs)*(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00181"></a>00181             <span class="keywordflow">return</span> price;
<a name="l00182"></a>00182         } <span class="keywordflow">else</span> {
<a name="l00183"></a>00183             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> cutoffNearZero = 1e-10;
<a name="l00184"></a>00184             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af33ab98d5074f9ac651ca1ce228816e3">floorletPrice</a> = 0;
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (effectiveFloor &gt; <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c4258ba367ef503b1f8444417205ba9">cutoffForFloorlet_</a>){
<a name="l00186"></a>00186                 <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveStrikeForMin = std::max(effectiveFloor,cutoffNearZero);
<a name="l00187"></a>00187                 floorletPrice=<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a7bec565a0e862a620d413908cba59e61">optionletPrice</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, effectiveStrikeForMin);
<a name="l00188"></a>00188             }
<a name="l00189"></a>00189             <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a> * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af33ab98d5074f9ac651ca1ce228816e3">floorletPrice</a>;
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af880fa7a55f86242bb8da890e4a8d72d">00193</a>     <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af880fa7a55f86242bb8da890e4a8d72d">HaganPricer::floorletRate</a>(<a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> effectiveFloor)<span class="keyword"> const </span>{
<a name="l00194"></a>00194         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af33ab98d5074f9ac651ca1ce228816e3">floorletPrice</a>(effectiveFloor)/(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">//===========================================================================//</span>
<a name="l00198"></a>00198 <span class="comment">//                  NumericHaganPricer                    //</span>
<a name="l00199"></a>00199 <span class="comment">//===========================================================================//</span>
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03.html">00201</a>     <span class="keyword">namespace </span>{
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html">00203</a>         <span class="keyword">class </span><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html">VariableChange</a> {
<a name="l00204"></a>00204           <span class="keyword">public</span>:
<a name="l00205"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#a5bbd5823104597d400ea6a494c1f043d">00205</a>             <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html">VariableChange</a>(boost::function&lt;<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> (<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a>)&gt;&amp; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>,
<a name="l00206"></a>00206                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>, <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>, <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k)
<a name="l00207"></a>00207             : <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#a1afed352d00c9e300f81a6798be37845">a_</a>(a), <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#af38ce48ed76df5b27dc44fa974d57f83">b_</a>(b), width_(b-a), <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#afdc6e9dda1a20804c81a14ff21cdaaa8">f_</a>(<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>), <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a6ffdceb692ed665e9d5e5a6ebbd775ef">k_</a>(k) {}
<a name="l00208"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#ab0d45eafaf2af3216cfd76dce2775e57">00208</a>             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#ab0d45eafaf2af3216cfd76dce2775e57">value</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x)<span class="keyword"> const </span>{
<a name="l00209"></a>00209                 <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> newVar;
<a name="l00210"></a>00210                 <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> temp = width_;
<a name="l00211"></a>00211                 <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 1; i &lt; <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a6ffdceb692ed665e9d5e5a6ebbd775ef">k_</a> ; ++i) {
<a name="l00212"></a>00212                     temp *= x;
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214                 newVar = <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#a1afed352d00c9e300f81a6798be37845">a_</a> + x* temp;
<a name="l00215"></a>00215                 <span class="keywordflow">return</span> <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#afdc6e9dda1a20804c81a14ff21cdaaa8">f_</a>(newVar) * k_* temp;
<a name="l00216"></a>00216             }
<a name="l00217"></a>00217           <span class="keyword">private</span>:
<a name="l00218"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#ac9e8fde3e3786646a4e32f70e35af46c">00218</a>             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#a1afed352d00c9e300f81a6798be37845">a_</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#af38ce48ed76df5b27dc44fa974d57f83">b_</a>, <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#ac9e8fde3e3786646a4e32f70e35af46c">width_</a>;
<a name="l00219"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#acae8d7379f2b1219ba7c79dc86afd729">00219</a>             boost::function&lt;Real (Real)&gt; <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#acae8d7379f2b1219ba7c79dc86afd729">f_</a>;
<a name="l00220"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#a238e2512e697efdc53cdb74817d11ae5">00220</a>             <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_variable_change.html#a238e2512e697efdc53cdb74817d11ae5">k_</a>;
<a name="l00221"></a>00221         };
<a name="l00222"></a>00222 
<a name="l00223"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html">00223</a>         <span class="keyword">class </span><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html">Spy</a> {
<a name="l00224"></a>00224           <span class="keyword">public</span>:
<a name="l00225"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#afd1b7554e7952d2e5428b66ff2ebbb49">00225</a>             <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#afd1b7554e7952d2e5428b66ff2ebbb49">Spy</a>(boost::function&lt;<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> (<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a>)&gt; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>) : <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#afdc6e9dda1a20804c81a14ff21cdaaa8">f_</a>(<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>) {}
<a name="l00226"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#a54d19b9ec90c1480063a79efa2c9089b">00226</a>             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#a54d19b9ec90c1480063a79efa2c9089b">value</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x){
<a name="l00227"></a>00227                 abscissas.push_back(x);
<a name="l00228"></a>00228                 <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> value = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#afdc6e9dda1a20804c81a14ff21cdaaa8">f_</a>(x);
<a name="l00229"></a>00229                 functionValues.push_back(value);
<a name="l00230"></a>00230                 <span class="keywordflow">return</span> value;
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232           <span class="keyword">private</span>:
<a name="l00233"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#a165d4eb755f12eeccfbe68cd5baead4e">00233</a>             boost::function&lt;Real (Real)&gt; <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#a165d4eb755f12eeccfbe68cd5baead4e">f_</a>;
<a name="l00234"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#aa946f83f03ae00472e6605ff982a07a0">00234</a>             std::vector&lt;Real&gt; <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#aa946f83f03ae00472e6605ff982a07a0">abscissas</a>;
<a name="l00235"></a><a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#acbfe930e35758845033e5f69366398e0">00235</a>             std::vector&lt;Real&gt; <a class="code" href="class_quant_lib_1_1anonymous__namespace_02conundrumpricer_8cpp_03_1_1_spy.html#acbfe930e35758845033e5f69366398e0">functionValues</a>;
<a name="l00236"></a>00236         };
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239 
<a name="l00240"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#abaf4139e1b21aefe6b78003d8f8d3a52">00240</a>     <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#abaf4139e1b21aefe6b78003d8f8d3a52">NumericHaganPricer::NumericHaganPricer</a>(
<a name="l00241"></a>00241         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;SwaptionVolatilityStructure&gt;</a>&amp; swaptionVol,
<a name="l00242"></a>00242         <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7">GFunctionFactory::YieldCurveModel</a> modelOfYieldCurve,
<a name="l00243"></a>00243         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>&amp; meanReversion,
<a name="l00244"></a>00244         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lowerLimit,
<a name="l00245"></a>00245         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> upperLimit,
<a name="l00246"></a>00246         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> precision)
<a name="l00247"></a>00247     : <a class="code" href="class_quant_lib_1_1_hagan_pricer.html" title="CMS-coupon pricer.">HaganPricer</a>(swaptionVol, modelOfYieldCurve, meanReversion),
<a name="l00248"></a>00248        upperLimit_(upperLimit),
<a name="l00249"></a>00249        lowerLimit_(lowerLimit),
<a name="l00250"></a>00250        requiredStdDeviations_(8),
<a name="l00251"></a>00251        precision_(precision),
<a name="l00252"></a>00252        refiningIntegrationTolerance_(.0001){
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a9b43df7e92790ae573dcbbee252581be">00256</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a9b43df7e92790ae573dcbbee252581be">NumericHaganPricer::integrate</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>,
<a name="l00257"></a>00257         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>, <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html">ConundrumIntegrand</a>&amp; integrand)<span class="keyword"> const </span>{
<a name="l00258"></a>00258             <span class="keywordtype">double</span> result =.0;
<a name="l00259"></a>00259             <span class="comment">//double abserr =.0;</span>
<a name="l00260"></a>00260             <span class="comment">//double alpha = 1.0;</span>
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00263"></a>00263             <span class="comment">//double epsabs = precision_;</span>
<a name="l00264"></a>00264             <span class="comment">//double epsrel = 1.0; // we are interested only in absolute precision</span>
<a name="l00265"></a>00265             <span class="comment">//size_t neval =0;</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267             <span class="comment">// we use the non adaptive algorithm only for semi infinite interval</span>
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (a&gt;0){
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                 <span class="comment">// we estimate the actual boudary by testing integrand values</span>
<a name="l00271"></a>00271                 <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> upperBoundary = 2*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>;
<a name="l00272"></a>00272                 <span class="keywordflow">while</span>(integrand(upperBoundary)&gt;<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a26b114bfb27984b2a850c4fc30d38d55">precision_</a>)
<a name="l00273"></a>00273                     upperBoundary *=2.0;
<a name="l00274"></a>00274                 <span class="comment">// sometimes b &lt; a because of a wrong estimation of b based on stdev</span>
<a name="l00275"></a>00275                 <span class="keywordflow">if</span> (b &gt; a)
<a name="l00276"></a>00276                     upperBoundary = std::min(upperBoundary, b);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278                 boost::function&lt;Real (Real)&gt; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>;
<a name="l00279"></a>00279                 <a class="code" href="class_quant_lib_1_1_gauss_kronrod_non_adaptive.html" title="Integral of a 1-dimensional function using the Gauss-Kronrod methods.">GaussKronrodNonAdaptive</a>
<a name="l00280"></a>00280                     gaussKronrodNonAdaptive(<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a26b114bfb27984b2a850c4fc30d38d55">precision_</a>, 1000000, 1.0);
<a name="l00281"></a>00281                 <span class="comment">// if the integration intervall is wide enough we use the</span>
<a name="l00282"></a>00282                 <span class="comment">// following change variable x -&gt; a + (b-a)*(t/(a-b))^3</span>
<a name="l00283"></a>00283                 <span class="keywordflow">if</span> (upperBoundary &gt; 2*a){
<a name="l00284"></a>00284                     <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k = 3;
<a name="l00285"></a>00285                     boost::function&lt;Real (Real)&gt; temp = boost::ref(integrand);
<a name="l00286"></a>00286                     VariableChange variableChange(temp, a, upperBoundary, k);
<a name="l00287"></a>00287                     f = boost::bind(&amp;VariableChange::value, &amp;variableChange, _1);
<a name="l00288"></a>00288                     result = gaussKronrodNonAdaptive(f, .0, 1.0);
<a name="l00289"></a>00289                 } <span class="keywordflow">else</span> {
<a name="l00290"></a>00290                     f = boost::ref(integrand);
<a name="l00291"></a>00291                     result = gaussKronrodNonAdaptive(f, a, upperBoundary);
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294                 <span class="comment">// if the expected precision has not been reached we use the old algorithm</span>
<a name="l00295"></a>00295                 <span class="keywordflow">if</span> (!gaussKronrodNonAdaptive.<a class="code" href="class_quant_lib_1_1_integrator.html#a990a0ce5c01ba6d3d5ff43da28c0be93">integrationSuccess</a>()){
<a name="l00296"></a>00296                     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_gauss_kronrod_adaptive.html" title="Integral of a 1-dimensional function using the Gauss-Kronrod methods.">GaussKronrodAdaptive</a> integrator(<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a26b114bfb27984b2a850c4fc30d38d55">precision_</a>, 1000000);
<a name="l00297"></a>00297                     result = integrator(integrand,a , b);
<a name="l00298"></a>00298                 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300             } <span class="keywordflow">else</span> {   <span class="comment">// if a &lt; b we use the old algorithm</span>
<a name="l00301"></a>00301 
<a name="l00302"></a>00302                 <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_gauss_kronrod_adaptive.html" title="Integral of a 1-dimensional function using the Gauss-Kronrod methods.">GaussKronrodAdaptive</a> integrator(<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a26b114bfb27984b2a850c4fc30d38d55">precision_</a>, 1000000);
<a name="l00303"></a>00303                 result = integrator(integrand,a , b);
<a name="l00304"></a>00304             }
<a name="l00305"></a>00305             <span class="keywordflow">return</span> result;
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 
<a name="l00308"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a01a44da7c6cf69358eda5195ea0cf59e">00308</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a01a44da7c6cf69358eda5195ea0cf59e">NumericHaganPricer::optionletPrice</a>(
<a name="l00309"></a>00309                                 <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> optionType, <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike)<span class="keyword"> const </span>{
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         boost::shared_ptr&lt;ConundrumIntegrand&gt; integrand(<span class="keyword">new</span>
<a name="l00312"></a>00312             <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html">ConundrumIntegrand</a>(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a12ccf78a4cf422133758334cd8335088">vanillaOptionPricer_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a6965477eb2d00309165ef6b2d9fdb8f0">rateCurve_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>,
<a name="l00313"></a>00313                                <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acdbbcabc3ec155e8011da10248d42f39">paymentDate_</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>,
<a name="l00314"></a>00314                                <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>, strike, optionType));
<a name="l00315"></a>00315         <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ab7ada641b232668f31fa5dbadb0ed9b3">stdDeviationsForUpperLimit_</a>= <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ab0482633ae23568a00ed33456ed6e1d7">requiredStdDeviations_</a>;
<a name="l00316"></a>00316         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>, integralValue;
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (optionType==<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>) {
<a name="l00318"></a>00318             <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a5f0ac75df40e76e0a59c701587ac8e3b">upperLimit_</a> = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ac758a117fc4a1136fe629e37f5930a1a">resetUpperLimit</a>(<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ab7ada641b232668f31fa5dbadb0ed9b3">stdDeviationsForUpperLimit_</a>);
<a name="l00319"></a>00319         <span class="comment">//    while(upperLimit_ &lt;= strike){</span>
<a name="l00320"></a>00320         <span class="comment">//        stdDeviationsForUpperLimit_ += 1.;</span>
<a name="l00321"></a>00321         <span class="comment">//        upperLimit_ = resetUpperLimit(stdDeviationsForUpperLimit_);</span>
<a name="l00322"></a>00322         <span class="comment">//    }</span>
<a name="l00323"></a>00323             integralValue = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a9b43df7e92790ae573dcbbee252581be">integrate</a>(strike, <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a5f0ac75df40e76e0a59c701587ac8e3b">upperLimit_</a>, *integrand);
<a name="l00324"></a>00324             <span class="comment">//refineIntegration(integralValue, *integrand);</span>
<a name="l00325"></a>00325         } <span class="keywordflow">else</span> {
<a name="l00326"></a>00326             a = std::min(strike, <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#aaf9f126ae652bc411bccd98e821351e3">lowerLimit_</a>);
<a name="l00327"></a>00327             b = strike;
<a name="l00328"></a>00328             integralValue = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a9b43df7e92790ae573dcbbee252581be">integrate</a>(a, b, *integrand);
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> dFdK = integrand-&gt;firstDerivativeOfF(strike);
<a name="l00332"></a>00332         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swaptionPrice =
<a name="l00333"></a>00333             (*vanillaOptionPricer_)(strike, optionType, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <span class="comment">// v. HAGAN, Conundrums..., formule 2.17a, 2.18a</span>
<a name="l00336"></a>00336         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>() * (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>/<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>) *
<a name="l00337"></a>00337             ((1 + dFdK) * swaptionPrice + optionType*integralValue);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a44f606f8c5028ab6b3a4c86e1dd54d8b">00340</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a44f606f8c5028ab6b3a4c86e1dd54d8b">NumericHaganPricer::swapletPrice</a>()<span class="keyword"> const </span>{
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>();
<a name="l00343"></a>00343         <span class="keywordflow">if</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> &lt;= today) {
<a name="l00344"></a>00344             <span class="comment">// the fixing is determined</span>
<a name="l00345"></a>00345             <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> Rs = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>()-&gt;fixing(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>);
<a name="l00346"></a>00346             <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> price = (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a>*Rs + <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acfd12878edba4d013b4d3237a2836fdf">spread_</a>)*(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00347"></a>00347             <span class="keywordflow">return</span> price;
<a name="l00348"></a>00348         } <span class="keywordflow">else</span> {
<a name="l00349"></a>00349             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> atmCapletPrice = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a01a44da7c6cf69358eda5195ea0cf59e">optionletPrice</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>);
<a name="l00350"></a>00350             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> atmFloorletPrice = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a01a44da7c6cf69358eda5195ea0cf59e">optionletPrice</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>);
<a name="l00351"></a>00351             <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a> *(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()* <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a> * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>
<a name="l00352"></a>00352                              + atmCapletPrice - atmFloorletPrice)
<a name="l00353"></a>00353                    + <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af7bfe24cf6893d63a5c81c9bb8be90b7">spreadLegValue_</a>;
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a1676b982f918b1dc85029052cc8483e2">00357</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a1676b982f918b1dc85029052cc8483e2">NumericHaganPricer::refineIntegration</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> integralValue,
<a name="l00358"></a>00358                                                 <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html">ConundrumIntegrand</a>&amp; integrand)<span class="keyword"> const </span>{
<a name="l00359"></a>00359         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> percDiff = 1000.;
<a name="l00360"></a>00360         <span class="keywordflow">while</span>(std::fabs(percDiff) &lt; <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a069efb6e1a74cc2bae6a88d0794fbee0">refiningIntegrationTolerance_</a>){
<a name="l00361"></a>00361             <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ab7ada641b232668f31fa5dbadb0ed9b3">stdDeviationsForUpperLimit_</a> += 1.;
<a name="l00362"></a>00362             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lowerLimit = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a5f0ac75df40e76e0a59c701587ac8e3b">upperLimit_</a>;
<a name="l00363"></a>00363             <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a5f0ac75df40e76e0a59c701587ac8e3b">upperLimit_</a> = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ac758a117fc4a1136fe629e37f5930a1a">resetUpperLimit</a>(<a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ab7ada641b232668f31fa5dbadb0ed9b3">stdDeviationsForUpperLimit_</a>);
<a name="l00364"></a>00364             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> diff = <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a9b43df7e92790ae573dcbbee252581be">integrate</a>(lowerLimit, <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#a5f0ac75df40e76e0a59c701587ac8e3b">upperLimit_</a>,integrand);
<a name="l00365"></a>00365             percDiff = diff/integralValue;
<a name="l00366"></a>00366             integralValue += diff;
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368         <span class="keywordflow">return</span> integralValue;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370 
<a name="l00371"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ac758a117fc4a1136fe629e37f5930a1a">00371</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer.html#ac758a117fc4a1136fe629e37f5930a1a">NumericHaganPricer::resetUpperLimit</a>(
<a name="l00372"></a>00372                         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> stdDeviationsForUpperLimit)<span class="keyword"> const </span>{
<a name="l00373"></a>00373         <span class="comment">//return 1.0;</span>
<a name="l00374"></a>00374         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance =
<a name="l00375"></a>00375             <a class="code" href="class_quant_lib_1_1_cms_coupon_pricer.html#ad417d63974807dca3ec7a112bd78555b">swaptionVolatility</a>()-&gt;blackVariance(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>,<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a>,<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>);
<a name="l00376"></a>00376         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a> *
<a name="l00377"></a>00377             std::exp(stdDeviationsForUpperLimit*std::sqrt(variance));
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="comment">//===========================================================================//</span>
<a name="l00382"></a>00382 <span class="comment">//                              ConundrumIntegrand                           //</span>
<a name="l00383"></a>00383 <span class="comment">//===========================================================================//</span>
<a name="l00384"></a>00384 
<a name="l00385"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#abf2dacca2faaf0564d6bbaeca6cde9ec">00385</a>     <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#abf2dacca2faaf0564d6bbaeca6cde9ec">NumericHaganPricer::ConundrumIntegrand::ConundrumIntegrand</a>(
<a name="l00386"></a>00386         <span class="keyword">const</span> boost::shared_ptr&lt;VanillaOptionPricer&gt;&amp; o,
<a name="l00387"></a>00387         <span class="keyword">const</span> boost::shared_ptr&lt;YieldTermStructure&gt;&amp;,
<a name="l00388"></a>00388         <span class="keyword">const</span> boost::shared_ptr&lt;GFunction&gt;&amp; gFunction,
<a name="l00389"></a>00389         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> fixingDate,
<a name="l00390"></a>00390         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> paymentDate,
<a name="l00391"></a>00391         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> annuity,
<a name="l00392"></a>00392         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> forwardValue,
<a name="l00393"></a>00393         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike,
<a name="l00394"></a>00394         <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> optionType)
<a name="l00395"></a>00395     : vanillaOptionPricer_(o), forwardValue_(forwardValue), annuity_(annuity),
<a name="l00396"></a>00396       fixingDate_(fixingDate), paymentDate_(paymentDate), strike_(strike),
<a name="l00397"></a>00397       optionType_(optionType),
<a name="l00398"></a>00398       gFunction_(gFunction) {}
<a name="l00399"></a>00399 
<a name="l00400"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a1c75cd63f047187157cfb673d160866a">00400</a>     <span class="keywordtype">void</span> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a1c75cd63f047187157cfb673d160866a">NumericHaganPricer::ConundrumIntegrand::setStrike</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike) {
<a name="l00401"></a>00401         strike_ = strike;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a58a44a97432db801edd1ed4c326f42c2">00404</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a58a44a97432db801edd1ed4c326f42c2">NumericHaganPricer::ConundrumIntegrand::strike</a>()<span class="keyword"> const </span>{
<a name="l00405"></a>00405         <span class="keywordflow">return</span> strike_;
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407 
<a name="l00408"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#aa673a61799104d81c77f325feb2144cb">00408</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#aa673a61799104d81c77f325feb2144cb">NumericHaganPricer::ConundrumIntegrand::annuity</a>()<span class="keyword"> const </span>{
<a name="l00409"></a>00409         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#ad1c798178375eacb779376c5fd89fa14">00412</a>     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#ad1c798178375eacb779376c5fd89fa14">NumericHaganPricer::ConundrumIntegrand::fixingDate</a>()<span class="keyword"> const </span>{
<a name="l00413"></a>00413         <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>;
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415 
<a name="l00416"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a1873b2461e03108ef7c841e89cbbe54a">00416</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a1873b2461e03108ef7c841e89cbbe54a">NumericHaganPricer::ConundrumIntegrand::functionF</a> (<span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x)<span class="keyword"> const </span>{
<a name="l00417"></a>00417         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Gx = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;operator()(x);
<a name="l00418"></a>00418         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> GR = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;operator()(forwardValue_);
<a name="l00419"></a>00419         <span class="keywordflow">return</span> (x - strike_) * (Gx/GR - 1.0);
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a46424c4bccdf4d18e3538e78aa0c92ba">00422</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a46424c4bccdf4d18e3538e78aa0c92ba">NumericHaganPricer::ConundrumIntegrand::firstDerivativeOfF</a> (<span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x)<span class="keyword"> const </span>{
<a name="l00423"></a>00423         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Gx = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;operator()(x);
<a name="l00424"></a>00424         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> GR = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;operator()(forwardValue_) ;
<a name="l00425"></a>00425         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> G1 = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;firstDerivative(x);
<a name="l00426"></a>00426         <span class="keywordflow">return</span> (Gx/GR - 1.0) + G1/GR * (x - strike_);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 
<a name="l00429"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a09b907b68835d8fb36735581467ded31">00429</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a09b907b68835d8fb36735581467ded31">NumericHaganPricer::ConundrumIntegrand::secondDerivativeOfF</a> (<span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x)<span class="keyword"> const </span>{
<a name="l00430"></a>00430         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> GR = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;operator()(forwardValue_) ;
<a name="l00431"></a>00431         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> G1 = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;firstDerivative(x);
<a name="l00432"></a>00432         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g2.html" title="Two-additive-factor gaussian model class.">G2</a> = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;secondDerivative(x);
<a name="l00433"></a>00433         <span class="keywordflow">return</span> 2.0 * G1/GR + (x - strike_) * G2/GR;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 
<a name="l00436"></a><a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a34c6c21e98be62d14dc9ed1506623b54">00436</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_numeric_hagan_pricer_1_1_conundrum_integrand.html#a34c6c21e98be62d14dc9ed1506623b54">NumericHaganPricer::ConundrumIntegrand::operator()</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x)<span class="keyword"> const </span>{
<a name="l00437"></a>00437         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> option = (*vanillaOptionPricer_)(x, optionType_, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>);
<a name="l00438"></a>00438         <span class="keywordflow">return</span> option * secondDerivativeOfF(x);
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="comment">//===========================================================================//</span>
<a name="l00444"></a>00444 <span class="comment">//                          AnalyticHaganPricer                           //</span>
<a name="l00445"></a>00445 <span class="comment">//===========================================================================//</span>
<a name="l00446"></a>00446 
<a name="l00447"></a><a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#aeb43a4ec7c49e5399b1fa1ad75c189da">00447</a>     <a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#aeb43a4ec7c49e5399b1fa1ad75c189da">AnalyticHaganPricer::AnalyticHaganPricer</a>(
<a name="l00448"></a>00448         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;SwaptionVolatilityStructure&gt;</a>&amp; swaptionVol,
<a name="l00449"></a>00449         <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a61c4b3f9e74cd8cb22f96eb4b0e1a2f7">GFunctionFactory::YieldCurveModel</a> modelOfYieldCurve,
<a name="l00450"></a>00450         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>&amp; <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a71ef5a53b1c644ca330147499c61541a">meanReversion</a>)
<a name="l00451"></a>00451     : <a class="code" href="class_quant_lib_1_1_hagan_pricer.html" title="CMS-coupon pricer.">HaganPricer</a>(swaptionVol, modelOfYieldCurve, meanReversion)
<a name="l00452"></a>00452       { }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="comment">//Hagan, 3.5b, 3.5c</span>
<a name="l00455"></a><a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#a0d23b8fb8c4c4b44d7216440fcda7fd4">00455</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#a0d23b8fb8c4c4b44d7216440fcda7fd4">AnalyticHaganPricer::optionletPrice</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> optionType,
<a name="l00456"></a>00456                                                   <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike)<span class="keyword"> const </span>{
<a name="l00457"></a>00457         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance = <a class="code" href="class_quant_lib_1_1_cms_coupon_pricer.html#ad417d63974807dca3ec7a112bd78555b">swaptionVolatility</a>()-&gt;blackVariance(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>,
<a name="l00458"></a>00458                                                            <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a>,
<a name="l00459"></a>00459                                                            <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>);
<a name="l00460"></a>00460         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> firstDerivativeOfGAtForwardValue = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;firstDerivative(
<a name="l00461"></a>00461                                                         <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>);
<a name="l00462"></a>00462         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> price = 0;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> CK = (*vanillaOptionPricer_)(strike, optionType, <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>);
<a name="l00465"></a>00465         price += (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>/<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>)*CK;
<a name="l00466"></a>00466         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sqrtSigma2T = std::sqrt(variance);
<a name="l00467"></a>00467         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lnRoverK =  std::log(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>/strike);
<a name="l00468"></a>00468         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> d32 = (lnRoverK+1.5*variance)/sqrtSigma2T;
<a name="l00469"></a>00469         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> d12 =  (lnRoverK+.5*variance)/sqrtSigma2T;
<a name="l00470"></a>00470         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> dminus12 =  (lnRoverK-.5*variance)/sqrtSigma2T;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         <a class="code" href="class_quant_lib_1_1_cumulative_normal_distribution.html" title="Cumulative normal distribution function.">CumulativeNormalDistribution</a> cumulativeOfNormal;
<a name="l00473"></a>00473         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> N32 = cumulativeOfNormal(optionType*d32);
<a name="l00474"></a>00474         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> N12 = cumulativeOfNormal(optionType*d12);
<a name="l00475"></a>00475         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Nminus12 = cumulativeOfNormal(optionType*dminus12);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         price += optionType * firstDerivativeOfGAtForwardValue * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a> *
<a name="l00478"></a>00478             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a> * (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a> * std::exp(variance) * N32-
<a name="l00479"></a>00479             (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>+strike) * N12 + strike * Nminus12);
<a name="l00480"></a>00480         price *= <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>();
<a name="l00481"></a>00481         <span class="keywordflow">return</span> price;
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">//Hagan 3.4c</span>
<a name="l00485"></a><a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#af158d7216440a95ea88209cb3dcc0a25">00485</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_analytic_hagan_pricer.html#af158d7216440a95ea88209cb3dcc0a25">AnalyticHaganPricer::swapletPrice</a>()<span class="keyword"> const </span>{
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>();
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a> &lt;= today) {
<a name="l00489"></a>00489             <span class="comment">// the fixing is determined</span>
<a name="l00490"></a>00490             <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> Rs = <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>()-&gt;fixing(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>);
<a name="l00491"></a>00491             <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> price = (<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a>*Rs + <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#acfd12878edba4d013b4d3237a2836fdf">spread_</a>)*(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>()*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>);
<a name="l00492"></a>00492             <span class="keywordflow">return</span> price;
<a name="l00493"></a>00493         } <span class="keywordflow">else</span> {
<a name="l00494"></a>00494             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance(<a class="code" href="class_quant_lib_1_1_cms_coupon_pricer.html#ad417d63974807dca3ec7a112bd78555b">swaptionVolatility</a>()-&gt;blackVariance(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a18e41279298a4a3dd2a251ac4fdf1498">fixingDate_</a>,
<a name="l00495"></a>00495                                                                <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#aa2fef42f64bb4726eec39835b2860434">swapTenor_</a>,
<a name="l00496"></a>00496                                                                <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>));
<a name="l00497"></a>00497             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> firstDerivativeOfGAtForwardValue(<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a124863857170eed483cdf9bef5e040ca">gFunction_</a>-&gt;firstDerivative(
<a name="l00498"></a>00498                                                             <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>));
<a name="l00499"></a>00499             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> price = 0;
<a name="l00500"></a>00500             price += <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a76db990b95396406bbf97b4d5431a2eb">discount_</a>*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a170bfbd56bee89be9b61c2d8768ba23c">swapRateValue_</a>;
<a name="l00501"></a>00501             price += firstDerivativeOfGAtForwardValue*<a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a74105a7b79a91e1822fdcb2274a7b035">annuity_</a>*swapRateValue_*
<a name="l00502"></a>00502                      swapRateValue_*(std::exp(variance)-1.);
<a name="l00503"></a>00503             <span class="keywordflow">return</span> <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2b95693c334a5a6ed1d5fd81c46f192b">gearing_</a> * price * <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#a2c86caba4adefc7316d3406ededd7676">coupon_</a>-&gt;<a class="code" href="class_quant_lib_1_1_coupon.html#ad28791d408d01be147007b26cc722733" title="accrual period as fraction of year">accrualPeriod</a>() + <a class="code" href="class_quant_lib_1_1_hagan_pricer.html#af7bfe24cf6893d63a5c81c9bb8be90b7">spreadLegValue_</a>;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="comment">//===========================================================================//</span>
<a name="l00509"></a>00509 <span class="comment">//                              GFunctionStandard                            //</span>
<a name="l00510"></a>00510 <span class="comment">//===========================================================================//</span>
<a name="l00511"></a>00511 
<a name="l00512"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a6cae04b29ef7d3e06cb4b8be1c2514a6">00512</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a6cae04b29ef7d3e06cb4b8be1c2514a6">GFunctionFactory::GFunctionStandard::operator()</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00513"></a>00513         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> n = <span class="keyword">static_cast&lt;</span><a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a><span class="keyword">&gt;</span>(<a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#ad677b27243db9e971efdf33865b119ae">swapLength_</a>) * <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a474ad1c60b703a96d9e39688ccf4cbd9">q_</a>;
<a name="l00514"></a>00514         <span class="keywordflow">return</span> x / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>((1.0 + x/<a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a474ad1c60b703a96d9e39688ccf4cbd9">q_</a>), <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a1317aab0d9a318d76c1bdf1e768343c4">delta_</a>) * 1.0 /
<a name="l00515"></a>00515             (1.0 - 1.0 / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>((1.0 + x/<a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a474ad1c60b703a96d9e39688ccf4cbd9">q_</a>), n));
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517 
<a name="l00518"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a5c895f88e7e29563fc4467b66bb591c5">00518</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a5c895f88e7e29563fc4467b66bb591c5">GFunctionFactory::GFunctionStandard::firstDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00519"></a>00519         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> n = <span class="keyword">static_cast&lt;</span><a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a><span class="keyword">&gt;</span>(swapLength_) * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a>;
<a name="l00520"></a>00520         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a> = 1.0 + x / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a>;
<a name="l00521"></a>00521         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> AA = a - delta_/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * x;
<a name="l00522"></a>00522         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> B = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a,(n - delta_ - 1.0))/(<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a,n) - 1.0);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> secNum = n * x * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a,(n-1.0));
<a name="l00525"></a>00525         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> secDen = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, delta_) * (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0) *
<a name="l00526"></a>00526             (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0);
<a name="l00527"></a>00527         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sec = secNum / secDen;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <span class="keywordflow">return</span> AA * B - sec;
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a800f4bb80a86810b75de7d35846a58b9">00532</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html#a800f4bb80a86810b75de7d35846a58b9">GFunctionFactory::GFunctionStandard::secondDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00533"></a>00533         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> n = <span class="keyword">static_cast&lt;</span><a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a><span class="keyword">&gt;</span>(swapLength_) * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a>;
<a name="l00534"></a>00534         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a> = 1.0 + x/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a>;
<a name="l00535"></a>00535         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> AA = a - delta_/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * x;
<a name="l00536"></a>00536         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> A1 = (1.0 - delta_)/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a>;
<a name="l00537"></a>00537         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> B = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a,(n - delta_ - 1.0))/(<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a,n) - 1.0);
<a name="l00538"></a>00538         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Num = (1.0 + delta_ - n) * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (n-delta_-2.0)) -
<a name="l00539"></a>00539             (1.0 + delta_) * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (2.0*n-delta_-2.0));
<a name="l00540"></a>00540         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Den = (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0) * (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0);
<a name="l00541"></a>00541         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> B1 = 1.0 / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * Num / Den;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> C =  x / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, delta_);
<a name="l00544"></a>00544         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> C1 = (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, delta_)
<a name="l00545"></a>00545             - delta_ /<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * x * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (delta_ - 1.0))) / <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, 2 * delta_);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> D =  <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (n-1.0))/ ((<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0) * (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0));
<a name="l00548"></a>00548         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> D1 = ((n - 1.0) * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (n-2.0)) * (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0)
<a name="l00549"></a>00549             - 2 * n * <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, (2 * (n-1.0))))
<a name="l00550"></a>00550             / (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * (<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0)*(<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0)*(<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(a, n) - 1.0));
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="keywordflow">return</span> A1 * B + AA * B1 - n/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02zigguratrng_8cpp_03.html#a39cc4fa02231bc5344990424a5b174c9">q_</a> * (C1 * D + C * D1);
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554 
<a name="l00555"></a><a class="code" href="class_quant_lib_1_1_g_function_factory.html#a2943ea230bf009e8e3f63c07f80b6ed2">00555</a>     boost::shared_ptr&lt;GFunction&gt; <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a2943ea230bf009e8e3f63c07f80b6ed2">GFunctionFactory::newGFunctionStandard</a>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> q,
<a name="l00556"></a>00556                                                             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta, <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> swapLength) {
<a name="l00557"></a>00557         <span class="keywordflow">return</span> boost::shared_ptr&lt;GFunction&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_standard.html">GFunctionStandard</a>(q, delta, swapLength));
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">//===========================================================================//</span>
<a name="l00561"></a>00561 <span class="comment">//                              GFunctionExactYield                          //</span>
<a name="l00562"></a>00562 <span class="comment">//===========================================================================//</span>
<a name="l00563"></a>00563 
<a name="l00564"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#a65e32eed26f2c68cc0d7eb719af41e41">00564</a>     <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#a65e32eed26f2c68cc0d7eb719af41e41">GFunctionFactory::GFunctionExactYield::GFunctionExactYield</a>(<span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_cms_coupon.html" title="CMS coupon class.">CmsCoupon</a>&amp; coupon){
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="keyword">const</span> boost::shared_ptr&lt;SwapIndex&gt;&amp; swapIndex = coupon.<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>();
<a name="l00567"></a>00567         <span class="keyword">const</span> boost::shared_ptr&lt;VanillaSwap&gt;&amp; <a class="code" href="namespace_quant_lib.html#a68c12b666ea6ffeba405c5e5e5303b03">swap</a> =
<a name="l00568"></a>00568             swapIndex-&gt;underlyingSwap(coupon.<a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html#ade4e0a12442deea28516877180463e69" title="fixing date">fixingDate</a>());
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_schedule.html" title="Payment schedule.">Schedule</a>&amp; schedule = swap-&gt;fixedSchedule();
<a name="l00571"></a>00571         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> rateCurve =
<a name="l00572"></a>00572             swapIndex-&gt;forwardingTermStructure();
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a>&amp; dc = swapIndex-&gt;dayCounter();
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swapStartTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(),
<a name="l00577"></a>00577                                              schedule.<a class="code" href="class_quant_lib_1_1_schedule.html#adb87da229732833503bdf33e902881d2">startDate</a>());
<a name="l00578"></a>00578         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swapFirstPaymentTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(),
<a name="l00579"></a>00579                                                     schedule.<a class="code" href="class_quant_lib_1_1_schedule.html#a80b5a2496275939f69991e1b72dfe158">date</a>(1));
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> paymentTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(),
<a name="l00582"></a>00582                                                  coupon.<a class="code" href="class_quant_lib_1_1_coupon.html#a788ea38a274e104a4b10e98544053fc8">date</a>());
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         delta_ = (paymentTime-swapStartTime) / (swapFirstPaymentTime-swapStartTime);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#abdb8d18844749e7614125fe36661bb11" title="Sequence of cash-flows.">Leg</a>&amp; fixedLeg(swap-&gt;fixedLeg());
<a name="l00587"></a>00587         <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n = fixedLeg.size();
<a name="l00588"></a>00588         <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.reserve(n);
<a name="l00589"></a>00589         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;n; ++i) {
<a name="l00590"></a>00590             boost::shared_ptr&lt;Coupon&gt; coupon =
<a name="l00591"></a>00591                 boost::dynamic_pointer_cast&lt;<a class="code" href="class_quant_lib_1_1_coupon.html" title="coupon accruing over a fixed period">Coupon</a>&gt;(fixedLeg[i]);
<a name="l00592"></a>00592             <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.push_back(coupon-&gt;accrualPeriod());
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 
<a name="l00596"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#ae69830045671b4f4487fde09f86570ac">00596</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#ae69830045671b4f4487fde09f86570ac">GFunctionFactory::GFunctionExactYield::operator()</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00597"></a>00597         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> product = 1.;
<a name="l00598"></a>00598         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00599"></a>00599             product *= 1./(1.+ <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*x);
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601         <span class="keywordflow">return</span> x*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(1.+ <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*x,-delta_)*(1./(1.-product));
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#ac3ba01cd5ec9410a33f990196b1f3d10">00604</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#ac3ba01cd5ec9410a33f990196b1f3d10">GFunctionFactory::GFunctionExactYield::firstDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00605"></a>00605         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a> = -1.;
<a name="l00606"></a>00606         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derC = 0.;
<a name="l00607"></a>00607         std::vector&lt;Real&gt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>;
<a name="l00608"></a>00608         b.reserve(<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size());
<a name="l00609"></a>00609         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00610"></a>00610             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> temp = 1.0/(1.0+ <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*x);
<a name="l00611"></a>00611             b.push_back(temp);
<a name="l00612"></a>00612             c *= temp;
<a name="l00613"></a>00613             derC += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*temp;
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615         c += 1.;
<a name="l00616"></a>00616         c = 1./<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>;
<a name="l00617"></a>00617         derC *= (c-c*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keywordflow">return</span> -delta_*<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_+1.)*x*c+
<a name="l00620"></a>00620                 <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_)*c+ <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_)*x*derC;
<a name="l00621"></a>00621         <span class="comment">//Real dx = 1.0e-8;</span>
<a name="l00622"></a>00622         <span class="comment">//return (operator()(x+dx)-operator()(x-dx))/(2.0*dx);</span>
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00625"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#a860f615feed533b770545c05e1ac691c">00625</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html#a860f615feed533b770545c05e1ac691c">GFunctionFactory::GFunctionExactYield::secondDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00626"></a>00626         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a> = -1.;
<a name="l00627"></a>00627         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sum = 0.;
<a name="l00628"></a>00628         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sumOfSquare = 0.;
<a name="l00629"></a>00629         std::vector&lt;Real&gt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>;
<a name="l00630"></a>00630         b.reserve(<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size());
<a name="l00631"></a>00631         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00632"></a>00632             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> temp = 1.0/(1.0+ <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*x);
<a name="l00633"></a>00633             b.push_back(temp);
<a name="l00634"></a>00634             c *= temp;
<a name="l00635"></a>00635             sum += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*temp;
<a name="l00636"></a>00636             sumOfSquare += <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*temp, 2.0);
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638         c += 1.;
<a name="l00639"></a>00639         c = 1./<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>;
<a name="l00640"></a>00640         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derC =sum*(c-c*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>);
<a name="l00641"></a>00641 
<a name="l00642"></a>00642         <span class="keywordflow">return</span> (-delta_*<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_+1.)*c+ <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_)*derC)*
<a name="l00643"></a>00643                (-delta_*<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*b[0]*x + 1. + x*(1.-c)*sum)+
<a name="l00644"></a>00644                 <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(b[0],delta_)*c*(delta_*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*b[0],2.)*x - delta_* <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[0]*b[0] -
<a name="l00645"></a>00645                 x*derC*sum + (1.-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)*sum - x*(1.-c)*sumOfSquare);
<a name="l00646"></a>00646         <span class="comment">//Real dx = 1.0e-8;</span>
<a name="l00647"></a>00647         <span class="comment">//return (firstDerivative(x+dx)-firstDerivative(x-dx))/(2.0*dx);</span>
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="class_quant_lib_1_1_g_function_factory.html#a6cc5452c93c6ba8fc2ababf17310d478">00650</a>     boost::shared_ptr&lt;GFunction&gt; <a class="code" href="class_quant_lib_1_1_g_function_factory.html#a6cc5452c93c6ba8fc2ababf17310d478">GFunctionFactory::newGFunctionExactYield</a>(<span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_cms_coupon.html" title="CMS coupon class.">CmsCoupon</a>&amp; coupon) {
<a name="l00651"></a>00651         <span class="keywordflow">return</span> boost::shared_ptr&lt;GFunction&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_exact_yield.html">GFunctionExactYield</a>(coupon));
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="comment">//===========================================================================//</span>
<a name="l00657"></a>00657 <span class="comment">//                            GFunctionWithShifts                            //</span>
<a name="l00658"></a>00658 <span class="comment">//===========================================================================//</span>
<a name="l00659"></a>00659 
<a name="l00660"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#aeff67326ff5829d0939625d19d7a0bf2">00660</a>     <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#aeff67326ff5829d0939625d19d7a0bf2">GFunctionFactory::GFunctionWithShifts::GFunctionWithShifts</a>(
<a name="l00661"></a>00661                     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_cms_coupon.html" title="CMS coupon class.">CmsCoupon</a>&amp; coupon,
<a name="l00662"></a>00662                     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>&amp; meanReversion)
<a name="l00663"></a>00663     : meanReversion_(meanReversion), calibratedShift_(0.03),
<a name="l00664"></a>00664       tmpRs_(10000000.0), accuracy_( 1.0e-14) {
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="keyword">const</span> boost::shared_ptr&lt;SwapIndex&gt;&amp; swapIndex = coupon.<a class="code" href="class_quant_lib_1_1_cms_coupon.html#a790addf563dd91ae1ded95af38deb964">swapIndex</a>();
<a name="l00667"></a>00667         <span class="keyword">const</span> boost::shared_ptr&lt;VanillaSwap&gt;&amp; <a class="code" href="namespace_quant_lib.html#a68c12b666ea6ffeba405c5e5e5303b03">swap</a> = swapIndex-&gt;underlyingSwap(coupon.<a class="code" href="class_quant_lib_1_1_floating_rate_coupon.html#ade4e0a12442deea28516877180463e69" title="fixing date">fixingDate</a>());
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a3d9aa5658b4a728c5b634a5d410713ee">swapRateValue_</a> = swap-&gt;fairRate();
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a1b724808c686dd423d98d3182eab023e">objectiveFunction_</a> = boost::shared_ptr&lt;ObjectiveFunction&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a917aa9b96504fb8ed651232abff00e2d">ObjectiveFunction</a>(*<span class="keyword">this</span>, <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a3d9aa5658b4a728c5b634a5d410713ee">swapRateValue_</a>));
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_schedule.html" title="Payment schedule.">Schedule</a>&amp; schedule = swap-&gt;fixedSchedule();
<a name="l00674"></a>00674         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> rateCurve =
<a name="l00675"></a>00675             swapIndex-&gt;forwardingTermStructure();
<a name="l00676"></a>00676         <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a>&amp; dc = swapIndex-&gt;dayCounter();
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a783468af04c835f08f5ffbda417a2695">swapStartTime_</a> = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(),
<a name="l00679"></a>00679                                          schedule.startDate());
<a name="l00680"></a>00680         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#aefdbc9c4325ef829e38708c14f1211c1">discountAtStart_</a> = rateCurve-&gt;discount(schedule.startDate());
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> paymentTime = dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(),
<a name="l00683"></a>00683                                                  coupon.<a class="code" href="class_quant_lib_1_1_coupon.html#a788ea38a274e104a4b10e98544053fc8">date</a>());
<a name="l00684"></a>00684 
<a name="l00685"></a>00685         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#abc6c6dfa84c71257cba0a6bd19e4bd53">shapedPaymentTime_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a65ae9081d4f989c65cb28184648499b9">shapeOfShift</a>(paymentTime);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#abdb8d18844749e7614125fe36661bb11" title="Sequence of cash-flows.">Leg</a>&amp; fixedLeg(swap-&gt;fixedLeg());
<a name="l00688"></a>00688         <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n = fixedLeg.size();
<a name="l00689"></a>00689         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a678f07489c63fed6e59025b4d4dbd71e">accruals_</a>.reserve(n);
<a name="l00690"></a>00690         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ae67e08c84885a3faf6d8d07b6e91ac9b">shapedSwapPaymentTimes_</a>.reserve(n);
<a name="l00691"></a>00691         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a471e73394c87a01cdf0106a072dfd2e6">swapPaymentDiscounts_</a>.reserve(n);
<a name="l00692"></a>00692         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;n; ++i) {
<a name="l00693"></a>00693             boost::shared_ptr&lt;Coupon&gt; coupon =
<a name="l00694"></a>00694                 boost::dynamic_pointer_cast&lt;<a class="code" href="class_quant_lib_1_1_coupon.html" title="coupon accruing over a fixed period">Coupon</a>&gt;(fixedLeg[i]);
<a name="l00695"></a>00695             <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a678f07489c63fed6e59025b4d4dbd71e">accruals_</a>.push_back(coupon-&gt;accrualPeriod());
<a name="l00696"></a>00696             <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> paymentDate(coupon-&gt;date());
<a name="l00697"></a>00697             <span class="keyword">const</span> <span class="keywordtype">double</span> swapPaymentTime(dc.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(rateCurve-&gt;referenceDate(), paymentDate));
<a name="l00698"></a>00698             <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ae67e08c84885a3faf6d8d07b6e91ac9b">shapedSwapPaymentTimes_</a>.push_back(<a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a65ae9081d4f989c65cb28184648499b9">shapeOfShift</a>(swapPaymentTime));
<a name="l00699"></a>00699             <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a471e73394c87a01cdf0106a072dfd2e6">swapPaymentDiscounts_</a>.push_back(rateCurve-&gt;discount(paymentDate));
<a name="l00700"></a>00700         }
<a name="l00701"></a>00701         <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#af8f07da7814cda39bd55db05ee2b1e75">discountRatio_</a> = <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a471e73394c87a01cdf0106a072dfd2e6">swapPaymentDiscounts_</a>.back()/<a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#aefdbc9c4325ef829e38708c14f1211c1">discountAtStart_</a>;
<a name="l00702"></a>00702     }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ab5b8c45781e51f5c80ba0a3c5db4257f">00704</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ab5b8c45781e51f5c80ba0a3c5db4257f">GFunctionFactory::GFunctionWithShifts::operator()</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Rs) {
<a name="l00705"></a>00705         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calibratedShift = calibrationOfShift(Rs);
<a name="l00706"></a>00706         <span class="keywordflow">return</span> Rs* functionZ(calibratedShift);
<a name="l00707"></a>00707     }
<a name="l00708"></a>00708 
<a name="l00709"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a7bf3a8e034d5c0581a2c025ea1d24f5e">00709</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a7bf3a8e034d5c0581a2c025ea1d24f5e">GFunctionFactory::GFunctionWithShifts::functionZ</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00710"></a>00710         <span class="keywordflow">return</span> std::exp(-shapedPaymentTime_*x)
<a name="l00711"></a>00711             / (1.-discountRatio_*std::exp(-shapedSwapPaymentTimes_.back()*x));
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713 
<a name="l00714"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a8c038f4805f6113282a21525ff6ce608">00714</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a8c038f4805f6113282a21525ff6ce608">GFunctionFactory::GFunctionWithShifts::derRs_derX</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00715"></a>00715         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sqrtDenominator = 0;
<a name="l00716"></a>00716         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derSqrtDenominator = 0;
<a name="l00717"></a>00717         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00718"></a>00718             sqrtDenominator += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i]
<a name="l00719"></a>00719                 *std::exp(-shapedSwapPaymentTimes_[i]*x);
<a name="l00720"></a>00720             derSqrtDenominator -= shapedSwapPaymentTimes_[i]* <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i]
<a name="l00721"></a>00721                 *std::exp(-shapedSwapPaymentTimes_[i]*x);
<a name="l00722"></a>00722         }
<a name="l00723"></a>00723         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denominator = sqrtDenominator* sqrtDenominator;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerator = 0;
<a name="l00726"></a>00726         numerator += shapedSwapPaymentTimes_.back()* swapPaymentDiscounts_.back()*
<a name="l00727"></a>00727                      std::exp(-shapedSwapPaymentTimes_.back()*x)*sqrtDenominator;
<a name="l00728"></a>00728         numerator -= (discountAtStart_ - swapPaymentDiscounts_.back()* std::exp(-shapedSwapPaymentTimes_.back()*x))*
<a name="l00729"></a>00729                      derSqrtDenominator;
<a name="l00730"></a>00730         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(denominator!=0, <span class="stringliteral">&quot;GFunctionWithShifts::derRs_derX: denominator == 0&quot;</span>);
<a name="l00731"></a>00731         <span class="keywordflow">return</span> numerator/denominator;
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733 
<a name="l00734"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a2275da1770f46e4f8ae4c82894f37dbf">00734</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a2275da1770f46e4f8ae4c82894f37dbf">GFunctionFactory::GFunctionWithShifts::der2Rs_derX2</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00735"></a>00735         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denOfRfunztion = 0.;
<a name="l00736"></a>00736         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derDenOfRfunztion = 0.;
<a name="l00737"></a>00737         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> der2DenOfRfunztion = 0.;
<a name="l00738"></a>00738         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00739"></a>00739             denOfRfunztion += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i]
<a name="l00740"></a>00740                 *std::exp(-shapedSwapPaymentTimes_[i]*x);
<a name="l00741"></a>00741             derDenOfRfunztion -= shapedSwapPaymentTimes_[i]* <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i]
<a name="l00742"></a>00742                 *std::exp(-shapedSwapPaymentTimes_[i]*x);
<a name="l00743"></a>00743             der2DenOfRfunztion+= shapedSwapPaymentTimes_[i]*shapedSwapPaymentTimes_[i]* <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*
<a name="l00744"></a>00744                 swapPaymentDiscounts_[i]*std::exp(-shapedSwapPaymentTimes_[i]*x);
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denominator = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(denOfRfunztion, 4);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numOfDerR = 0;
<a name="l00750"></a>00750         numOfDerR += shapedSwapPaymentTimes_.back()* swapPaymentDiscounts_.back()*
<a name="l00751"></a>00751                      std::exp(-shapedSwapPaymentTimes_.back()*x)*denOfRfunztion;
<a name="l00752"></a>00752         numOfDerR -= (discountAtStart_ - swapPaymentDiscounts_.back()* std::exp(-shapedSwapPaymentTimes_.back()*x))*
<a name="l00753"></a>00753                      derDenOfRfunztion;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denOfDerR = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(denOfRfunztion,2);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derNumOfDerR = 0.;
<a name="l00758"></a>00758         derNumOfDerR -= shapedSwapPaymentTimes_.back()*shapedSwapPaymentTimes_.back()* swapPaymentDiscounts_.back()*
<a name="l00759"></a>00759                      std::exp(-shapedSwapPaymentTimes_.back()*x)*denOfRfunztion;
<a name="l00760"></a>00760         derNumOfDerR += shapedSwapPaymentTimes_.back()* swapPaymentDiscounts_.back()*
<a name="l00761"></a>00761                      std::exp(-shapedSwapPaymentTimes_.back()*x)*derDenOfRfunztion;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763         derNumOfDerR -= (shapedSwapPaymentTimes_.back()*swapPaymentDiscounts_.back()*
<a name="l00764"></a>00764                         std::exp(-shapedSwapPaymentTimes_.back()*x))* derDenOfRfunztion;
<a name="l00765"></a>00765         derNumOfDerR -= (discountAtStart_ - swapPaymentDiscounts_.back()* std::exp(-shapedSwapPaymentTimes_.back()*x))*
<a name="l00766"></a>00766                      der2DenOfRfunztion;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derDenOfDerR = 2*denOfRfunztion*derDenOfRfunztion;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerator = derNumOfDerR*denOfDerR -numOfDerR*derDenOfDerR;
<a name="l00771"></a>00771         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(denominator!=0, <span class="stringliteral">&quot;GFunctionWithShifts::der2Rs_derX2: denominator == 0&quot;</span>);
<a name="l00772"></a>00772         <span class="keywordflow">return</span> numerator/denominator;
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774 
<a name="l00775"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ae2ef0edf32aa0c2ca6fa84a0ea88eba0">00775</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#ae2ef0edf32aa0c2ca6fa84a0ea88eba0">GFunctionFactory::GFunctionWithShifts::derZ_derX</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00776"></a>00776         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sqrtDenominator = (1.-discountRatio_*std::exp(-shapedSwapPaymentTimes_.back()*x));
<a name="l00777"></a>00777         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denominator = sqrtDenominator* sqrtDenominator;
<a name="l00778"></a>00778         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(denominator!=0, <span class="stringliteral">&quot;GFunctionWithShifts::derZ_derX: denominator == 0&quot;</span>);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerator = 0;
<a name="l00781"></a>00781         numerator -= shapedPaymentTime_* std::exp(-shapedPaymentTime_*x)* sqrtDenominator;
<a name="l00782"></a>00782         numerator -= shapedSwapPaymentTimes_.back()* std::exp(-shapedPaymentTime_*x)* (1.-sqrtDenominator);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="keywordflow">return</span> numerator/denominator;
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786 
<a name="l00787"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a3947ebf238b30150bbb971f71e4febe4">00787</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a3947ebf238b30150bbb971f71e4febe4">GFunctionFactory::GFunctionWithShifts::der2Z_derX2</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00788"></a>00788         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denOfZfunction = (1.-discountRatio_*std::exp(-shapedSwapPaymentTimes_.back()*x));
<a name="l00789"></a>00789         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derDenOfZfunction = shapedSwapPaymentTimes_.back()*discountRatio_*std::exp(-shapedSwapPaymentTimes_.back()*x);
<a name="l00790"></a>00790         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denominator = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(denOfZfunction, 4);
<a name="l00791"></a>00791         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(denominator!=0, <span class="stringliteral">&quot;GFunctionWithShifts::der2Z_derX2: denominator == 0&quot;</span>);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numOfDerZ = 0;
<a name="l00794"></a>00794         numOfDerZ -= shapedPaymentTime_* std::exp(-shapedPaymentTime_*x)* denOfZfunction;
<a name="l00795"></a>00795         numOfDerZ -= shapedSwapPaymentTimes_.back()* std::exp(-shapedPaymentTime_*x)* (1.-denOfZfunction);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> denOfDerZ = <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(denOfZfunction,2);
<a name="l00798"></a>00798         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derNumOfDerZ = (-shapedPaymentTime_* std::exp(-shapedPaymentTime_*x)*
<a name="l00799"></a>00799                              (-shapedPaymentTime_+(shapedPaymentTime_*discountRatio_-
<a name="l00800"></a>00800                                shapedSwapPaymentTimes_.back()*discountRatio_)* std::exp(-shapedSwapPaymentTimes_.back()*x))
<a name="l00801"></a>00801                               -shapedSwapPaymentTimes_.back()*std::exp(-shapedPaymentTime_*x)*
<a name="l00802"></a>00802                               (shapedPaymentTime_*discountRatio_- shapedSwapPaymentTimes_.back()*discountRatio_)*
<a name="l00803"></a>00803                               std::exp(-shapedSwapPaymentTimes_.back()*x));
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> derDenOfDerZ = 2*denOfZfunction*derDenOfZfunction;
<a name="l00806"></a>00806         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerator = derNumOfDerZ*denOfDerZ -numOfDerZ*derDenOfDerZ;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <span class="keywordflow">return</span> numerator/denominator;
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00811"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a6fb04d317d71473c1427d4783d2e34b0">00811</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a6fb04d317d71473c1427d4783d2e34b0">GFunctionFactory::GFunctionWithShifts::firstDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Rs) {
<a name="l00812"></a>00812         <span class="comment">//Real dRs = 1.0e-8;</span>
<a name="l00813"></a>00813         <span class="comment">//return (operator()(Rs+dRs)-operator()(Rs-dRs))/(2.0*dRs);</span>
<a name="l00814"></a>00814         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calibratedShift = calibrationOfShift(Rs);
<a name="l00815"></a>00815         <span class="keywordflow">return</span> functionZ(calibratedShift) + Rs * derZ_derX(calibratedShift)/derRs_derX(calibratedShift);
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817 
<a name="l00818"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#adf62981922f17b924bd0486ce834689d">00818</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#adf62981922f17b924bd0486ce834689d">GFunctionFactory::GFunctionWithShifts::secondDerivative</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Rs) {
<a name="l00819"></a>00819         <span class="comment">//Real dRs = 1.0e-8;</span>
<a name="l00820"></a>00820         <span class="comment">//return (firstDerivative(Rs+dRs)-firstDerivative(Rs-dRs))/(2.0*dRs);</span>
<a name="l00821"></a>00821         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calibratedShift = calibrationOfShift(Rs);
<a name="l00822"></a>00822         <span class="keywordflow">return</span> 2.*derZ_derX(calibratedShift)/derRs_derX(calibratedShift) +
<a name="l00823"></a>00823             Rs * der2Z_derX2(calibratedShift)/<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(derRs_derX(calibratedShift),2.)-
<a name="l00824"></a>00824             Rs * derZ_derX(calibratedShift)*der2Rs_derX2(calibratedShift)/
<a name="l00825"></a>00825             <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02analyticgjrgarchengine_8cpp_03.html#a3011339a7df8a9688c1a29a9b6cff359">std::pow</a>(derRs_derX(calibratedShift),3.);
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00828"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a5f7721695fac30a339585d2e0b92a0a2">00828</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a5f7721695fac30a339585d2e0b92a0a2">GFunctionFactory::GFunctionWithShifts::ObjectiveFunction::operator ()</a>(<span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a>&amp; x)<span class="keyword"> const </span>{
<a name="l00829"></a>00829         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> result = 0;
<a name="l00830"></a>00830         derivative_ = 0;
<a name="l00831"></a>00831         <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;o_.accruals_.size(); i++) {
<a name="l00832"></a>00832             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> temp = o_.accruals_[i]*o_.swapPaymentDiscounts_[i]
<a name="l00833"></a>00833                 *std::exp(-o_.shapedSwapPaymentTimes_[i]*x);
<a name="l00834"></a>00834             result += temp;
<a name="l00835"></a>00835             derivative_ -= o_.shapedSwapPaymentTimes_[i] * temp;
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837         result *= Rs_;
<a name="l00838"></a>00838         derivative_ *= Rs_;
<a name="l00839"></a>00839         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> temp = o_.swapPaymentDiscounts_.back()
<a name="l00840"></a>00840             * std::exp(-o_.shapedSwapPaymentTimes_.back()*x);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         result += temp-o_.discountAtStart_;
<a name="l00843"></a>00843         derivative_ -= o_.shapedSwapPaymentTimes_.back()*temp;
<a name="l00844"></a>00844         <span class="keywordflow">return</span> result;
<a name="l00845"></a>00845     }
<a name="l00846"></a>00846 
<a name="l00847"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a26b5b79dcf46839d8774b66966fcaf4a">00847</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a26b5b79dcf46839d8774b66966fcaf4a">GFunctionFactory::GFunctionWithShifts::ObjectiveFunction::derivative</a>(<span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a>&amp;)<span class="keyword"> const </span>{
<a name="l00848"></a>00848         <span class="keywordflow">return</span> derivative_;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850 
<a name="l00851"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a2ed9732edebeb4e19e79c6f1165517fc">00851</a>     <span class="keywordtype">void</span> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts_1_1_objective_function.html#a2ed9732edebeb4e19e79c6f1165517fc">GFunctionFactory::GFunctionWithShifts::ObjectiveFunction::setSwapRateValue</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x) {
<a name="l00852"></a>00852         Rs_ = x;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 
<a name="l00855"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a65ae9081d4f989c65cb28184648499b9">00855</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a65ae9081d4f989c65cb28184648499b9">GFunctionFactory::GFunctionWithShifts::shapeOfShift</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> s)<span class="keyword"> const </span>{
<a name="l00856"></a>00856         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> x(s-swapStartTime_);
<a name="l00857"></a>00857         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> meanReversion = meanReversion_-&gt;value();
<a name="l00858"></a>00858         <span class="keywordflow">if</span>(meanReversion&gt;0) {
<a name="l00859"></a>00859             <span class="keywordflow">return</span> (1.-std::exp(-meanReversion*x))/meanReversion;
<a name="l00860"></a>00860         }
<a name="l00861"></a>00861         <span class="keywordflow">else</span> {
<a name="l00862"></a>00862             <span class="keywordflow">return</span> x;
<a name="l00863"></a>00863         }
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865 
<a name="l00866"></a><a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a132c59d6c738f099f2d98d65feb53787">00866</a>     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html#a132c59d6c738f099f2d98d65feb53787">GFunctionFactory::GFunctionWithShifts::calibrationOfShift</a>(<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> Rs){
<a name="l00867"></a>00867 
<a name="l00868"></a>00868         <span class="keywordflow">if</span>(Rs!=tmpRs_){
<a name="l00869"></a>00869             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialGuess, <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a>=0, D=0;
<a name="l00870"></a>00870             <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.size(); i++) {
<a name="l00871"></a>00871                 N+=<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i];
<a name="l00872"></a>00872                 D+=<a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>[i]*swapPaymentDiscounts_[i]*shapedSwapPaymentTimes_[i];
<a name="l00873"></a>00873             }
<a name="l00874"></a>00874             N *= Rs;
<a name="l00875"></a>00875             D *= Rs;
<a name="l00876"></a>00876             N += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.back() * swapPaymentDiscounts_.back()
<a name="l00877"></a>00877                 - objectiveFunction_-&gt;gFunctionWithShifts().discountAtStart_;
<a name="l00878"></a>00878             D += <a class="code" href="namespaceanonymous__namespace_02marketmodel__smmcapletalphacalibration_8cpp_03.html#ac2ccc4c7b8ec34a7fa60d67e09b1b79d">accruals_</a>.back() * swapPaymentDiscounts_.back()*
<a name="l00879"></a>00879                             shapedSwapPaymentTimes_.back();
<a name="l00880"></a>00880             initialGuess = N/D;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882             objectiveFunction_-&gt;setSwapRateValue(Rs);
<a name="l00883"></a>00883             <a class="code" href="class_quant_lib_1_1_newton.html" title="Newton 1-D solver">Newton</a> solver;
<a name="l00884"></a>00884             solver.<a class="code" href="class_quant_lib_1_1_solver1_d.html#a65b912b5ea70e93f3a942c3f1ed020b0">setMaxEvaluations</a>(1000);
<a name="l00885"></a>00885 
<a name="l00886"></a>00886             <span class="comment">// these boundaries migth not be big enough if the volatility</span>
<a name="l00887"></a>00887             <span class="comment">// of big swap rate values is too high . In this case the G function</span>
<a name="l00888"></a>00888             <span class="comment">// is not even integrable, so better to fix the vol than increasing</span>
<a name="l00889"></a>00889             <span class="comment">// these values</span>
<a name="l00890"></a>00890             <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lower = -20, upper = 20.;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892             <span class="keywordflow">try</span> {
<a name="l00893"></a>00893                 calibratedShift_ = solver.<a class="code" href="class_quant_lib_1_1_solver1_d.html#a7503f2685815872cc8382abaa3001134">solve</a>(*objectiveFunction_, accuracy_,
<a name="l00894"></a>00894                     std::max( std::min(initialGuess, upper*.99), lower*.99),
<a name="l00895"></a>00895                     lower, upper);
<a name="l00896"></a>00896             } <span class="keywordflow">catch</span> (std::exception&amp; e) {
<a name="l00897"></a>00897                 <a class="code" href="errors_8hpp.html#a8efe9cb3e67c8d0585e57b4d53c5d2fe" title="throw an error (possibly with file and line information)">QL_FAIL</a>(<span class="stringliteral">&quot;meanReversion: &quot;</span> &lt;&lt; meanReversion_-&gt;value() &lt;&lt;
<a name="l00898"></a>00898                         <span class="stringliteral">&quot;, swapRateValue: &quot;</span> &lt;&lt; swapRateValue_ &lt;&lt;
<a name="l00899"></a>00899                         <span class="stringliteral">&quot;, swapStartTime: &quot;</span> &lt;&lt; swapStartTime_ &lt;&lt;
<a name="l00900"></a>00900                         <span class="stringliteral">&quot;, shapedPaymentTime: &quot;</span> &lt;&lt; shapedPaymentTime_ &lt;&lt;
<a name="l00901"></a>00901                         <span class="stringliteral">&quot;\n error message: &quot;</span> &lt;&lt; e.what());
<a name="l00902"></a>00902             }
<a name="l00903"></a>00903             tmpRs_=Rs;
<a name="l00904"></a>00904         }
<a name="l00905"></a>00905         <span class="keywordflow">return</span> calibratedShift_;
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907 
<a name="l00908"></a><a class="code" href="class_quant_lib_1_1_g_function_factory.html#af23b90b4f8b591f490e5b58122eb7927">00908</a>     boost::shared_ptr&lt;GFunction&gt; <a class="code" href="class_quant_lib_1_1_g_function_factory.html#af23b90b4f8b591f490e5b58122eb7927">GFunctionFactory::newGFunctionWithShifts</a>(<span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_cms_coupon.html" title="CMS coupon class.">CmsCoupon</a>&amp; coupon,
<a name="l00909"></a>00909                                                                           <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>&amp; meanReversion) {
<a name="l00910"></a>00910         <span class="keywordflow">return</span> boost::shared_ptr&lt;GFunction&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_g_function_factory_1_1_g_function_with_shifts.html">GFunctionWithShifts</a>(coupon, meanReversion));
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="conundrumpricer_8cpp.html">conundrumpricer.cpp</a>      </li>

    <li class="footer">Generated on Sat Aug 25 2012 13:50:42 for QuantLib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
