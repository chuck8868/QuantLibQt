<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>QuantLib: /home/deriversatile/QuantLib/QuantLibQt/test-suite/hestonmodel.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">QuantLib
   &#160;<span id="projectnumber">1.3</span>
   </div>
   <div id="projectbrief">ql1-3</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('test-suite_2hestonmodel_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">hestonmodel.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="test-suite_2hestonmodel_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- mode: c++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment"> Copyright (C) 2005, 2007, 2009, 2010, 2012 Klaus Spanderen</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment"> This file is part of QuantLib, a free-software/open-source library</span>
<a name="l00007"></a>00007 <span class="comment"> for financial quantitative analysts and developers - http://quantlib.org/</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment"> QuantLib is free software: you can redistribute it and/or modify it</span>
<a name="l00010"></a>00010 <span class="comment"> under the terms of the QuantLib license.  You should have received a</span>
<a name="l00011"></a>00011 <span class="comment"> copy of the license along with this program; if not, please email</span>
<a name="l00012"></a>00012 <span class="comment"> &lt;quantlib-dev@lists.sf.net&gt;. The license is also available online at</span>
<a name="l00013"></a>00013 <span class="comment"> &lt;http://quantlib.org/license.shtml&gt;.</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment"> This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00016"></a>00016 <span class="comment"> ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00017"></a>00017 <span class="comment"> FOR A PARTICULAR PURPOSE.  See the license for more details.</span>
<a name="l00018"></a>00018 <span class="comment">*/</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="ql_2models_2equity_2hestonmodel_8hpp.html">hestonmodel.hpp</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="test-suite_2utilities_8hpp.html">utilities.hpp</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="dividendbarrieroption_8hpp.html" title="Barrier option on a single asset with discrete dividends.">ql/instruments/dividendbarrieroption.hpp</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="dividendvanillaoption_8hpp.html" title="Vanilla option on a single asset with discrete dividends.">ql/instruments/dividendvanillaoption.hpp</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="hestonprocess_8hpp.html" title="Heston stochastic process.">ql/processes/hestonprocess.hpp</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="ql_2models_2equity_2hestonmodel_8hpp.html">ql/models/equity/hestonmodel.hpp</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="hestonmodelhelper_8hpp.html" title="Heston-model calibration helper.">ql/models/equity/hestonmodelhelper.hpp</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="piecewisetimedependenthestonmodel_8hpp.html" title="piecewise constant time dependent Heston-model">ql/models/equity/piecewisetimedependenthestonmodel.hpp</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="analyticdividendeuropeanengine_8hpp.html" title="Analytic discrete-dividend European engine.">ql/pricingengines/vanilla/analyticdividendeuropeanengine.hpp</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="analytichestonengine_8hpp.html" title="analytic Heston-model engine">ql/pricingengines/vanilla/analytichestonengine.hpp</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="fdamericanengine_8hpp.html" title="Finite-differences American option engine.">ql/pricingengines/vanilla/fdamericanengine.hpp</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="fddividendeuropeanengine_8hpp.html" title="finite-differences engine for European option with dividends">ql/pricingengines/vanilla/fddividendeuropeanengine.hpp</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="fdeuropeanengine_8hpp.html" title="Finite-difference European engine.">ql/pricingengines/vanilla/fdeuropeanengine.hpp</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="analyticptdhestonengine_8hpp.html" title="analytic piecewise time dependent Heston-model engine">ql/pricingengines/vanilla/analyticptdhestonengine.hpp</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="fdhestonbarrierengine_8hpp.html" title="Finite-Differences Heston barrier option engine.">ql/pricingengines/barrier/fdhestonbarrierengine.hpp</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="fdblackscholesbarrierengine_8hpp.html" title="Finite-Differences Black Scholes barrier option engine.">ql/pricingengines/barrier/fdblackscholesbarrierengine.hpp</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="fdblackscholesvanillaengine_8hpp.html" title="Finite-Differences Black Scholes vanilla option engine.">ql/pricingengines/vanilla/fdblackscholesvanillaengine.hpp</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="fdhestonvanillaengine_8hpp.html" title="Finite-Differences Heston vanilla option engine.">ql/pricingengines/vanilla/fdhestonvanillaengine.hpp</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="mceuropeanhestonengine_8hpp.html" title="Monte Carlo Heston-model engine for European options.">ql/pricingengines/vanilla/mceuropeanhestonengine.hpp</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="blackformula_8hpp.html" title="Black formula.">ql/pricingengines/blackformula.hpp</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="target_8hpp.html" title="TARGET calendar.">ql/time/calendars/target.hpp</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="nullcalendar_8hpp.html" title="Calendar for reproducing theoretical calculations.">ql/time/calendars/nullcalendar.hpp</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="actual365fixed_8hpp.html" title="Actual/365 (Fixed) day counter.">ql/time/daycounters/actual365fixed.hpp</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="actual360_8hpp.html" title="act/360 day counter">ql/time/daycounters/actual360.hpp</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="actualactual_8hpp.html" title="act/act day counters">ql/time/daycounters/actualactual.hpp</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="zerocurve_8hpp.html" title="interpolated zero-rates structure">ql/termstructures/yield/zerocurve.hpp</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="flatforward_8hpp.html" title="flat forward rate term structure">ql/termstructures/yield/flatforward.hpp</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="levenbergmarquardt_8hpp.html" title="Levenberg-Marquardt optimization method.">ql/math/optimization/levenbergmarquardt.hpp</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="ql_2time_2period_8hpp.html">ql/time/period.hpp</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="simplequote_8hpp.html" title="simple quote class">ql/quotes/simplequote.hpp</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">using namespace </span>QuantLib;
<a name="l00052"></a>00052 <span class="keyword">using namespace </span>boost::unit_test_framework;
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="namespaceanonymous__namespace_02hestonmodel_8cpp_03.html">00054</a> <span class="keyword">namespace </span>{
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html">00056</a>     <span class="keyword">struct </span><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html">CalibrationMarketData</a> {
<a name="l00057"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#ab62c1e0e6c398e34db1e23083038b94e">00057</a>         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#ab62c1e0e6c398e34db1e23083038b94e">s0</a>;
<a name="l00058"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#a609db76d1b166bd61be3f64ef1842ad4">00058</a>         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#a609db76d1b166bd61be3f64ef1842ad4">riskFreeTS</a>, dividendYield;
<a name="l00059"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#af51c730056bcd5958760e6c2b676327e">00059</a>         std::vector&lt;boost::shared_ptr&lt;CalibrationHelper&gt; &gt; <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html#af51c730056bcd5958760e6c2b676327e">options</a>;
<a name="l00060"></a>00060     };
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="namespaceanonymous__namespace_02hestonmodel_8cpp_03.html#a2796fb73922d0236026c39dfafff2da2">00062</a>     <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html">CalibrationMarketData</a> <a class="code" href="namespaceanonymous__namespace_02hestonmodel_8cpp_03.html#a2796fb73922d0236026c39dfafff2da2">getDAXCalibrationMarketData</a>() {
<a name="l00063"></a>00063         <span class="comment">/* this example is taken from A. Sepp</span>
<a name="l00064"></a>00064 <span class="comment">           Pricing European-Style Options under Jump Diffusion Processes</span>
<a name="l00065"></a>00065 <span class="comment">           with Stochstic Volatility: Applications of Fourier Transform</span>
<a name="l00066"></a>00066 <span class="comment">           http://math.ut.ee/~spartak/papers/stochjumpvols.pdf</span>
<a name="l00067"></a>00067 <span class="comment">        */</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(<a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().evaluationDate());
<a name="l00070"></a>00070         
<a name="l00071"></a>00071         <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual365_fixed.html" title="Actual/365 (Fixed) day count convention.">Actual365Fixed</a>();
<a name="l00072"></a>00072         <a class="code" href="class_quant_lib_1_1_calendar.html" title="calendar class">Calendar</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a86803e870514df19c0cf3863edb2b8f8">calendar</a> = <a class="code" href="class_quant_lib_1_1_t_a_r_g_e_t.html" title="TARGET calendar">TARGET</a>();
<a name="l00073"></a>00073         
<a name="l00074"></a>00074         <a class="code" href="namespace_quant_lib.html#a8ac1a45a37d8d3dda438a2e59e222620" title="integer number">Integer</a> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>[] = { 13, 41, 75, 165, 256, 345, 524, 703 };
<a name="l00075"></a>00075         <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> r[] = { 0.0357,0.0349,0.0341,0.0355,0.0359,0.0368,0.0386,0.0401 };
<a name="l00076"></a>00076         
<a name="l00077"></a>00077         std::vector&lt;Date&gt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a800db345cacda47dd48925126ea05f91">dates</a>;
<a name="l00078"></a>00078         std::vector&lt;Rate&gt; rates;
<a name="l00079"></a>00079         dates.push_back(settlementDate);
<a name="l00080"></a>00080         rates.push_back(0.0357);
<a name="l00081"></a>00081         <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i;
<a name="l00082"></a>00082         <span class="keywordflow">for</span> (i = 0; i &lt; 8; ++i) {
<a name="l00083"></a>00083             dates.push_back(settlementDate + t[i]);
<a name="l00084"></a>00084             rates.push_back(r[i]);
<a name="l00085"></a>00085         }
<a name="l00086"></a>00086         <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l00087"></a>00087         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(
<a name="l00088"></a>00088                            boost::shared_ptr&lt;YieldTermStructure&gt;(
<a name="l00089"></a>00089                                       <span class="keyword">new</span> <a class="code" href="namespace_quant_lib.html#aba455dd6323746ed70a64eb4fa65c276" title="Term structure based on linear interpolation of zero yields.">ZeroCurve</a>(dates, rates, dayCounter)));
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendYield(
<a name="l00092"></a>00092                                     <a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(settlementDate, 0.0, dayCounter));
<a name="l00093"></a>00093         
<a name="l00094"></a>00094         <a class="code" href="namespace_quant_lib.html#ae3abfa256de5aa2b506ab6bda014e4dc" title="volatility">Volatility</a> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>[] =
<a name="l00095"></a>00095           { 0.6625,0.4875,0.4204,0.3667,0.3431,0.3267,0.3121,0.3121,
<a name="l00096"></a>00096             0.6007,0.4543,0.3967,0.3511,0.3279,0.3154,0.2984,0.2921,
<a name="l00097"></a>00097             0.5084,0.4221,0.3718,0.3327,0.3155,0.3027,0.2919,0.2889,
<a name="l00098"></a>00098             0.4541,0.3869,0.3492,0.3149,0.2963,0.2926,0.2819,0.2800,
<a name="l00099"></a>00099             0.4060,0.3607,0.3330,0.2999,0.2887,0.2811,0.2751,0.2775,
<a name="l00100"></a>00100             0.3726,0.3396,0.3108,0.2781,0.2788,0.2722,0.2661,0.2686,
<a name="l00101"></a>00101             0.3550,0.3277,0.3012,0.2781,0.2781,0.2661,0.2661,0.2681,
<a name="l00102"></a>00102             0.3428,0.3209,0.2958,0.2740,0.2688,0.2627,0.2580,0.2620,
<a name="l00103"></a>00103             0.3302,0.3062,0.2799,0.2631,0.2573,0.2533,0.2504,0.2544,
<a name="l00104"></a>00104             0.3343,0.2959,0.2705,0.2540,0.2504,0.2464,0.2448,0.2462,
<a name="l00105"></a>00105             0.3460,0.2845,0.2624,0.2463,0.2425,0.2385,0.2373,0.2422,
<a name="l00106"></a>00106             0.3857,0.2860,0.2578,0.2399,0.2357,0.2327,0.2312,0.2351,
<a name="l00107"></a>00107             0.3976,0.2860,0.2607,0.2356,0.2297,0.2268,0.2241,0.2320 };
<a name="l00108"></a>00108         
<a name="l00109"></a>00109         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(4468.17)));
<a name="l00110"></a>00110         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike[] = { 3400,3600,3800,4000,4200,4400,
<a name="l00111"></a>00111                           4500,4600,4800,5000,5200,5400,5600 };
<a name="l00112"></a>00112         
<a name="l00113"></a>00113         std::vector&lt;boost::shared_ptr&lt;CalibrationHelper&gt; &gt; options;
<a name="l00114"></a>00114         
<a name="l00115"></a>00115         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s = 0; s &lt; 13; ++s) {
<a name="l00116"></a>00116             <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m = 0; m &lt; 8; ++m) {
<a name="l00117"></a>00117                 <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> vol(boost::shared_ptr&lt;Quote&gt;(
<a name="l00118"></a>00118                                                     <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(v[s*8+m])));
<a name="l00119"></a>00119         
<a name="l00120"></a>00120                 <a class="code" href="class_quant_lib_1_1_period.html">Period</a> maturity((<span class="keywordtype">int</span>)((t[m]+3)/7.), <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3abfe6416a9a483125b6b22548c1ff3947">Weeks</a>); <span class="comment">// round to weeks</span>
<a name="l00121"></a>00121                 options.push_back(boost::shared_ptr&lt;CalibrationHelper&gt;(
<a name="l00122"></a>00122                         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model_helper.html" title="calibration helper for Heston model">HestonModelHelper</a>(maturity, calendar,
<a name="l00123"></a>00123                                               s0-&gt;value(), strike[s], vol,
<a name="l00124"></a>00124                                               riskFreeTS, dividendYield,
<a name="l00125"></a>00125                                           <a class="code" href="class_quant_lib_1_1_calibration_helper.html#a52a24fdd49df7512c424da2ca2f53ed0a01fa965e7e2f5506c5afd8bed3338fa7">CalibrationHelper::ImpliedVolError</a>)));
<a name="l00126"></a>00126             }
<a name="l00127"></a>00127         }
<a name="l00128"></a>00128         
<a name="l00129"></a>00129         <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_calibration_market_data.html">CalibrationMarketData</a> marketData
<a name="l00130"></a>00130                                     ={ s0, riskFreeTS, dividendYield, options };
<a name="l00131"></a>00131         
<a name="l00132"></a>00132         <span class="keywordflow">return</span> marketData;
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134         
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="class_heston_model_test.html#a27380e52abafd6136eee9ee650837270">00138</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a27380e52abafd6136eee9ee650837270">HestonModelTest::testBlackCalibration</a>() {
<a name="l00139"></a>00139     BOOST_MESSAGE(
<a name="l00140"></a>00140        <span class="stringliteral">&quot;Testing Heston model calibration using a flat volatility surface...&quot;</span>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">/* calibrate a Heston model to a constant volatility surface without</span>
<a name="l00145"></a>00145 <span class="comment">       smile. expected result is a vanishing volatility of the volatility.</span>
<a name="l00146"></a>00146 <span class="comment">       In addition theta and v0 should be equal to the constant variance */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1b42c838cf0f4cf17262f0b22bac899">Date::todaysDate</a>();
<a name="l00149"></a>00149     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = today;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual360.html" title="Actual/360 day count convention.">Actual360</a>();
<a name="l00152"></a>00152     <a class="code" href="class_quant_lib_1_1_calendar.html" title="calendar class">Calendar</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a86803e870514df19c0cf3863edb2b8f8">calendar</a> = <a class="code" href="class_quant_lib_1_1_null_calendar.html" title="Calendar for reproducing theoretical calculations.">NullCalendar</a>();
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.04, dayCounter));
<a name="l00155"></a>00155     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.50, dayCounter));
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     std::vector&lt;Period&gt; optionMaturities;
<a name="l00158"></a>00158     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(1, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>));
<a name="l00159"></a>00159     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(2, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>));
<a name="l00160"></a>00160     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(3, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>));
<a name="l00161"></a>00161     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(6, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>));
<a name="l00162"></a>00162     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(9, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>));
<a name="l00163"></a>00163     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(1, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3ae2d856134531729a1696e66bebeafb32">Years</a>));
<a name="l00164"></a>00164     optionMaturities.push_back(<a class="code" href="class_quant_lib_1_1_period.html">Period</a>(2, <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3ae2d856134531729a1696e66bebeafb32">Years</a>));
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     std::vector&lt;boost::shared_ptr&lt;CalibrationHelper&gt; &gt; options;
<a name="l00167"></a>00167     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.0)));
<a name="l00168"></a>00168     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> vol(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(0.1)));
<a name="l00169"></a>00169     <a class="code" href="namespace_quant_lib.html#ae3abfa256de5aa2b506ab6bda014e4dc" title="volatility">Volatility</a> <a class="code" href="group__manips.html#ga9890b88f8d11494a518492be973b9046" title="output volatilities as percentages">volatility</a> = vol-&gt;value();
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; optionMaturities.size(); ++i) {
<a name="l00172"></a>00172         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> moneyness = -1.0; moneyness &lt; 2.0; moneyness += 1.0) {
<a name="l00173"></a>00173             <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l00174"></a>00174             <span class="keyword">const</span> <a class="code" href="class_time.html">Time</a> tau = dayCounter.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(
<a name="l00175"></a>00175                                  riskFreeTS-&gt;referenceDate(),
<a name="l00176"></a>00176                                  calendar.<a class="code" href="class_quant_lib_1_1_calendar.html#a1b8d9da28e4f012b89b00bf0ef388cc9">advance</a>(riskFreeTS-&gt;referenceDate(),
<a name="l00177"></a>00177                                                   optionMaturities[i]));
<a name="l00178"></a>00178         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> fwdPrice = s0-&gt;value()*dividendTS-&gt;discount(tau)
<a name="l00179"></a>00179                             / riskFreeTS-&gt;discount(tau);
<a name="l00180"></a>00180         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strikePrice = fwdPrice * std::exp(-moneyness * volatility
<a name="l00181"></a>00181                                                      * std::sqrt(tau));
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         options.push_back(boost::shared_ptr&lt;CalibrationHelper&gt;(
<a name="l00184"></a>00184                           <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model_helper.html" title="calibration helper for Heston model">HestonModelHelper</a>(optionMaturities[i], calendar,
<a name="l00185"></a>00185                                                 s0-&gt;value(), strikePrice, vol,
<a name="l00186"></a>00186                                                 riskFreeTS, dividendTS)));
<a name="l00187"></a>00187         }
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> = 0.1; <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> &lt; 0.7; <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> += 0.2) {
<a name="l00191"></a>00191         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0=0.01;
<a name="l00192"></a>00192         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa=0.2;
<a name="l00193"></a>00193         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta=0.02;
<a name="l00194"></a>00194         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho=-0.75;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         boost::shared_ptr&lt;HestonProcess&gt; process(
<a name="l00197"></a>00197             <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(riskFreeTS, dividendTS,
<a name="l00198"></a>00198                               s0, v0, kappa, theta, <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>, rho));
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         boost::shared_ptr&lt;HestonModel&gt; model(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process));
<a name="l00201"></a>00201         boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(
<a name="l00202"></a>00202                                          <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, 96));
<a name="l00203"></a>00203 
<a name="l00204"></a>00204         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; options.size(); ++i)
<a name="l00205"></a>00205             options[i]-&gt;setPricingEngine(engine);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <a class="code" href="class_quant_lib_1_1_levenberg_marquardt.html" title="Levenberg-Marquardt optimization method.">LevenbergMarquardt</a> om(1e-8, 1e-8, 1e-8);
<a name="l00208"></a>00208         model-&gt;calibrate(options, om, <a class="code" href="class_quant_lib_1_1_end_criteria.html" title="Criteria to end optimization process:">EndCriteria</a>(400, 40, 1.0e-8,
<a name="l00209"></a>00209                                                   1.0e-8, 1.0e-8));
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 3.0e-3;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (model-&gt;sigma() &gt; <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a>) {
<a name="l00214"></a>00214             BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce expected sigma&quot;</span>
<a name="l00215"></a>00215                         &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; model-&gt;sigma()
<a name="l00216"></a>00216                         &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; 0.0
<a name="l00217"></a>00217                         &lt;&lt; <span class="stringliteral">&quot;\n    tolerance:  &quot;</span> &lt;&lt; <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a>);
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (std::fabs(model-&gt;kappa()
<a name="l00221"></a>00221                   *(model-&gt;theta()-volatility*<a class="code" href="group__manips.html#ga9890b88f8d11494a518492be973b9046" title="output volatilities as percentages">volatility</a>)) &gt; <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a>) {
<a name="l00222"></a>00222             BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce expected theta&quot;</span>
<a name="l00223"></a>00223                         &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; model-&gt;theta()
<a name="l00224"></a>00224                         &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; volatility*<a class="code" href="group__manips.html#ga9890b88f8d11494a518492be973b9046" title="output volatilities as percentages">volatility</a>);
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (std::fabs(model-&gt;v0()-volatility*<a class="code" href="group__manips.html#ga9890b88f8d11494a518492be973b9046" title="output volatilities as percentages">volatility</a>) &gt; tolerance) {
<a name="l00228"></a>00228             BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce expected v0&quot;</span>
<a name="l00229"></a>00229                         &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; model-&gt;v0()
<a name="l00230"></a>00230                         &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; volatility*<a class="code" href="group__manips.html#ga9890b88f8d11494a518492be973b9046" title="output volatilities as percentages">volatility</a>);
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="class_heston_model_test.html#a296d82e6a33d88133ae7ae0c549479f5">00236</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a296d82e6a33d88133ae7ae0c549479f5">HestonModelTest::testDAXCalibration</a>() {
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     BOOST_MESSAGE(
<a name="l00239"></a>00239              <span class="stringliteral">&quot;Testing Heston model calibration using DAX volatility data...&quot;</span>);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(5, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a6e2eb13b444eddc908b702f9e3030b15">July</a>, 2002);
<a name="l00244"></a>00244     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     CalibrationMarketData marketData = <a class="code" href="namespaceanonymous__namespace_02hestonmodel_8cpp_03.html#a2796fb73922d0236026c39dfafff2da2">getDAXCalibrationMarketData</a>();
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS = marketData.riskFreeTS;
<a name="l00249"></a>00249     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS = marketData.dividendYield;
<a name="l00250"></a>00250     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0 = marketData.s0;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keyword">const</span> std::vector&lt;boost::shared_ptr&lt;CalibrationHelper&gt; &gt; options
<a name="l00253"></a>00253                                                     = marketData.options;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0=0.1;
<a name="l00256"></a>00256     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa=1.0;
<a name="l00257"></a>00257     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta=0.1;
<a name="l00258"></a>00258     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>=0.5;
<a name="l00259"></a>00259     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho=-0.5;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00262"></a>00262               riskFreeTS, dividendTS, s0, v0, kappa, theta, sigma, rho));
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     boost::shared_ptr&lt;HestonModel&gt; model(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process));
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(
<a name="l00267"></a>00267                                          <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, 64));
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; options.size(); ++i)
<a name="l00270"></a>00270         options[i]-&gt;setPricingEngine(engine);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <a class="code" href="class_quant_lib_1_1_levenberg_marquardt.html" title="Levenberg-Marquardt optimization method.">LevenbergMarquardt</a> om(1e-8, 1e-8, 1e-8);
<a name="l00273"></a>00273     model-&gt;calibrate(options, om, <a class="code" href="class_quant_lib_1_1_end_criteria.html" title="Criteria to end optimization process:">EndCriteria</a>(400, 40, 1.0e-8, 1.0e-8, 1.0e-8));
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sse = 0;
<a name="l00276"></a>00276     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; 13*8; ++i) {
<a name="l00277"></a>00277         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> diff = options[i]-&gt;calibrationError()*100.0;
<a name="l00278"></a>00278         sse += diff*diff;
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 177.2; <span class="comment">//see article by A. Sepp.</span>
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (std::fabs(sse - expected) &gt; 1.0) {
<a name="l00282"></a>00282         BOOST_FAIL(<span class="stringliteral">&quot;Failed to reproduce calibration error&quot;</span>
<a name="l00283"></a>00283                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; sse
<a name="l00284"></a>00284                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="class_heston_model_test.html#a56d0cc091c48414dfbf04e2464a2d264">00288</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a56d0cc091c48414dfbf04e2464a2d264">HestonModelTest::testAnalyticVsBlack</a>() {
<a name="l00289"></a>00289     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing analytic Heston engine against Black formula...&quot;</span>);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1b42c838cf0f4cf17262f0b22bac899">Date::todaysDate</a>();
<a name="l00294"></a>00294     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00295"></a>00295     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00296"></a>00296     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate = settlementDate + 6*<a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00299"></a>00299                                      <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, 30));
<a name="l00300"></a>00300     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.1, dayCounter));
<a name="l00303"></a>00303     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.04, dayCounter));
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(32.0)));
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0=0.05;
<a name="l00308"></a>00308     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa=5.0;
<a name="l00309"></a>00309     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta=0.05;
<a name="l00310"></a>00310     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>=1.0e-4;
<a name="l00311"></a>00311     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho=0.0;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00314"></a>00314                    riskFreeTS, dividendTS, s0, v0, kappa, theta, sigma, rho));
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00317"></a>00317     <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l00318"></a>00318     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00319"></a>00319               boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)), 144));
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00322"></a>00322     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> yearFraction = dayCounter.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(settlementDate, exerciseDate);
<a name="l00325"></a>00325     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> forwardPrice = 32*std::exp((0.1-0.04)*yearFraction);
<a name="l00326"></a>00326     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(payoff-&gt;optionType(), payoff-&gt;strike(),
<a name="l00327"></a>00327         forwardPrice, std::sqrt(0.05*yearFraction)) *
<a name="l00328"></a>00328                                             std::exp(-0.1*yearFraction);
<a name="l00329"></a>00329     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = std::fabs(calculated - expected);
<a name="l00330"></a>00330     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 2.0e-7;
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00332"></a>00332         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce Black price with AnalyticHestonEngine&quot;</span>
<a name="l00333"></a>00333                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00334"></a>00334                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00335"></a>00335                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(
<a name="l00339"></a>00339               boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)),
<a name="l00340"></a>00340               200,200,100));
<a name="l00341"></a>00341     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00344"></a>00344     error = std::fabs(calculated - expected);
<a name="l00345"></a>00345     tolerance = 1.0e-3;
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00347"></a>00347         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce Black price with FdHestonVanillaEngine&quot;</span>
<a name="l00348"></a>00348                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00349"></a>00349                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00350"></a>00350                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="class_heston_model_test.html#ae0f287f1e4578c8b819a0a6aa9462b14">00356</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#ae0f287f1e4578c8b819a0a6aa9462b14">HestonModelTest::testAnalyticVsCached</a>() {
<a name="l00357"></a>00357     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing analytic Heston engine against cached values...&quot;</span>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l00362"></a>00362     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00363"></a>00363     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00364"></a>00364     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2005);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00367"></a>00367                                   <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, 1.05));
<a name="l00368"></a>00368     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.0225, dayCounter));
<a name="l00371"></a>00371     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.02, dayCounter));
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.0)));
<a name="l00374"></a>00374     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0 = 0.1;
<a name="l00375"></a>00375     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa = 3.16;
<a name="l00376"></a>00376     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta = 0.09;
<a name="l00377"></a>00377     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> = 0.4;
<a name="l00378"></a>00378     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho = -0.2;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00381"></a>00381                    riskFreeTS, dividendTS, s0, v0, kappa, theta, sigma, rho));
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     boost::shared_ptr&lt;AnalyticHestonEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00386"></a>00386                boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)), 64));
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected1 = 0.0404774515;
<a name="l00391"></a>00391     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated1 = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00392"></a>00392     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 1.0e-8;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">if</span> (std::fabs(calculated1 - expected1) &gt; tolerance) {
<a name="l00395"></a>00395         BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce cached analytic price&quot;</span>
<a name="l00396"></a>00396                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated1
<a name="l00397"></a>00397                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected1);
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">// reference values from www.wilmott.com, technical forum</span>
<a name="l00402"></a>00402     <span class="comment">// search for &quot;Heston or VG price check&quot;</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> K[] = {0.9,1.0,1.1};
<a name="l00405"></a>00405     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected2[] = { 0.1330371,0.0641016, 0.0270645 };
<a name="l00406"></a>00406     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated2[6];
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i;
<a name="l00409"></a>00409     <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {
<a name="l00410"></a>00410         <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(8+i/3, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4e26bc88f6e25cf9e31ba9400771d49">September</a>, 2005);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00413"></a>00413                                 <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, K[i%3]));
<a name="l00414"></a>00414         boost::shared_ptr&lt;Exercise&gt; exercise(
<a name="l00415"></a>00415                                           <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.05, dayCounter));
<a name="l00418"></a>00418         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.02, dayCounter));
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> s = riskFreeTS-&gt;discount(0.7)/dividendTS-&gt;discount(0.7);
<a name="l00421"></a>00421         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(s)));
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00424"></a>00424                    riskFreeTS, dividendTS, s0, 0.09, 1.2, 0.08, 1.8, -0.45));
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         boost::shared_ptr&lt;PricingEngine&gt; engine(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00429"></a>00429                    boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process))));
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00432"></a>00432         calculated2[i] = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">// we are after the value for T=0.7</span>
<a name="l00436"></a>00436     <a class="code" href="class_time.html">Time</a> t1 = dayCounter.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(settlementDate, <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a>(8, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4e26bc88f6e25cf9e31ba9400771d49">September</a>,2005));
<a name="l00437"></a>00437     <a class="code" href="class_time.html">Time</a> t2 = dayCounter.<a class="code" href="class_quant_lib_1_1_day_counter.html#aba442c829252ee786e1b4ea3d0f04bd9" title="Returns the period between two dates as a fraction of year.">yearFraction</a>(settlementDate, <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a>(9, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4e26bc88f6e25cf9e31ba9400771d49">September</a>,2005));
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i) {
<a name="l00440"></a>00440         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> interpolated =
<a name="l00441"></a>00441             calculated2[i]+(calculated2[i+3]-calculated2[i])/(t2-t1)*(0.7-t1);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (std::fabs(interpolated - expected2[i]) &gt; 100*<a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a>) {
<a name="l00444"></a>00444             BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce cached analytic prices:&quot;</span>
<a name="l00445"></a>00445                         &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; interpolated
<a name="l00446"></a>00446                         &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected2[i] );
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="class_heston_model_test.html#ade7ff0b8e84afe3ecafae9ce7aa75088">00452</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#ade7ff0b8e84afe3ecafae9ce7aa75088">HestonModelTest::testMcVsCached</a>() {
<a name="l00453"></a>00453     BOOST_MESSAGE(
<a name="l00454"></a>00454                 <span class="stringliteral">&quot;Testing Monte Carlo Heston engine against cached values...&quot;</span>);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l00459"></a>00459     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00462"></a>00462     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2005);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00465"></a>00465                                    <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, 1.05));
<a name="l00466"></a>00466     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.7, dayCounter));
<a name="l00469"></a>00469     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.4, dayCounter));
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.05)));
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00474"></a>00474                    riskFreeTS, dividendTS, s0, 0.3, 1.16, 0.2, 0.8, 0.8,
<a name="l00475"></a>00475                    <a class="code" href="class_quant_lib_1_1_heston_process.html#a7efd616697f1321b654176850dc55cb6a7f2c6e4e5736d78341ecd686e7fc401b">HestonProcess::QuadraticExponentialMartingale</a>));
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>;
<a name="l00480"></a>00480     engine = <a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html" title="Monte Carlo Heston European engine factory.">MakeMCEuropeanHestonEngine&lt;PseudoRandom&gt;</a>(process)
<a name="l00481"></a>00481         .withStepsPerYear(11)
<a name="l00482"></a>00482         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#ada4b189a85a9b2314ead5e0e820b4724">withAntitheticVariate</a>()
<a name="l00483"></a>00483         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a55548e87523e1b7e9ae54e56a1b20c28">withSamples</a>(50000)
<a name="l00484"></a>00484         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a5ae0aa8a83228f658e849e95ecb8d212">withSeed</a>(1234);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 0.0632851308977151;
<a name="l00489"></a>00489     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00490"></a>00490     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorEstimate = option.<a class="code" href="class_quant_lib_1_1_instrument.html#ada8c62ad5a0f65c2c55ac67651689aa9" title="returns the error estimate on the NPV when available.">errorEstimate</a>();
<a name="l00491"></a>00491     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 7.5e-4;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (std::fabs(calculated - expected) &gt; 2.34*errorEstimate) {
<a name="l00494"></a>00494         BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce cached price&quot;</span>
<a name="l00495"></a>00495                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00496"></a>00496                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00497"></a>00497                     &lt;&lt; <span class="stringliteral">&quot; +/- &quot;</span> &lt;&lt; errorEstimate);
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (errorEstimate &gt; tolerance) {
<a name="l00501"></a>00501         BOOST_ERROR(<span class="stringliteral">&quot;failed to reproduce error estimate&quot;</span>
<a name="l00502"></a>00502                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; errorEstimate
<a name="l00503"></a>00503                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; tolerance);
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="class_heston_model_test.html#ab75c691bed4106487b7873083251d8be">00507</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#ab75c691bed4106487b7873083251d8be">HestonModelTest::testFdBarrierVsCached</a>() {
<a name="l00508"></a>00508     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing FD barrier Heston engine against cached values...&quot;</span>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> dc = <a class="code" href="class_quant_lib_1_1_actual360.html" title="Actual/360 day count convention.">Actual360</a>();
<a name="l00513"></a>00513     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> today = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1b42c838cf0f4cf17262f0b22bac899">Date::todaysDate</a>();
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(100.0)));
<a name="l00516"></a>00516     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> rTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(today, 0.08, dc));
<a name="l00517"></a>00517     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> qTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(today, 0.04, dc));
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exDate = today + <a class="code" href="namespace_quant_lib.html#a8ac1a45a37d8d3dda438a2e59e222620" title="integer number">Integer</a>(0.5*360+0.5);
<a name="l00520"></a>00520     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exDate));
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(<span class="keyword">new</span>
<a name="l00523"></a>00523             <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, 90.0));
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00526"></a>00526             rTS, qTS, s0, 0.25*0.25, 1.0, 0.25*0.25, 0.001, 0.0));
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>;
<a name="l00529"></a>00529     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_barrier_engine.html" title="Finite-Differences Heston Barrier Option engine.">FdHestonBarrierEngine</a>(
<a name="l00530"></a>00530                     boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)),
<a name="l00531"></a>00531                     200,400,100));
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <a class="code" href="class_quant_lib_1_1_barrier_option.html" title="Barrier option on a single asset.">BarrierOption</a> option(<a class="code" href="struct_quant_lib_1_1_barrier.html#a74f1d3a3af3f96c1b79b27e057930afea75749a709329ca38f06c9e1052690e71">Barrier::DownOut</a>, 95.0, 3.0, payoff, exercise);
<a name="l00534"></a>00534     option.setPricingEngine(engine);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.NPV();
<a name="l00537"></a>00537     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 9.0246;
<a name="l00538"></a>00538     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = std::fabs(calculated-expected);
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (error &gt; 1.0e-3) {
<a name="l00540"></a>00540         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce cached price with FD Barrier engine&quot;</span>
<a name="l00541"></a>00541                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00542"></a>00542                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00543"></a>00543                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     option = <a class="code" href="class_quant_lib_1_1_barrier_option.html" title="Barrier option on a single asset.">BarrierOption</a>(<a class="code" href="struct_quant_lib_1_1_barrier.html#a74f1d3a3af3f96c1b79b27e057930afea5023747b19a7aa5988cb536cdf918bb7">Barrier::DownIn</a>, 95.0, 3.0, payoff, exercise);
<a name="l00547"></a>00547     option.setPricingEngine(engine);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     calculated = option.NPV();
<a name="l00550"></a>00550     expected = 7.7627;
<a name="l00551"></a>00551     error = std::fabs(calculated-expected);
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (error &gt; 1.0e-3) {
<a name="l00553"></a>00553         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce cached price with FD Barrier engine&quot;</span>
<a name="l00554"></a>00554                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00555"></a>00555                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00556"></a>00556                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a><a class="code" href="class_heston_model_test.html#a22b450728cf64c8e0fc33c2a4af6330b">00560</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a22b450728cf64c8e0fc33c2a4af6330b">HestonModelTest::testFdVanillaVsCached</a>() {
<a name="l00561"></a>00561     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing FD vanilla Heston engine against cached values...&quot;</span>);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l00566"></a>00566     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00569"></a>00569     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2005);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00572"></a>00572                                    <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, 1.05));
<a name="l00573"></a>00573     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.7, dayCounter));
<a name="l00576"></a>00576     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.4, dayCounter));
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.05)));
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00583"></a>00583                    riskFreeTS, dividendTS, s0, 0.3, 1.16, 0.2, 0.8, 0.8));
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>;
<a name="l00586"></a>00586     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(
<a name="l00587"></a>00587                     boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)),
<a name="l00588"></a>00588                     100,200,100));
<a name="l00589"></a>00589     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 0.06325;
<a name="l00592"></a>00592     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00593"></a>00593     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = std::fabs(calculated - expected);
<a name="l00594"></a>00594     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 1.0e-4;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00597"></a>00597         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce cached price with FD engine&quot;</span>
<a name="l00598"></a>00598                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00599"></a>00599                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00600"></a>00600                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing FD vanilla Heston engine for discrete dividends...&quot;</span>);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     payoff = boost::shared_ptr&lt;StrikedTypePayoff&gt;(
<a name="l00606"></a>00606                           <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, 95.0));
<a name="l00607"></a>00607     s0 = <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a>(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(100.0)));
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     riskFreeTS = <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a>(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.05, dayCounter));
<a name="l00610"></a>00610     dividendTS = <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a>(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.0, dayCounter));
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     exerciseDate = <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a>(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2006);
<a name="l00613"></a>00613     exercise = boost::shared_ptr&lt;Exercise&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     std::vector&lt;Date&gt; dividendDates;
<a name="l00616"></a>00616     std::vector&lt;Real&gt; dividends;
<a name="l00617"></a>00617     <span class="keywordflow">for</span> (<a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a> = settlementDate + 3*<a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>;
<a name="l00618"></a>00618               <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a> &lt; exercise-&gt;lastDate();
<a name="l00619"></a>00619               <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a> += 6*<a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>) {
<a name="l00620"></a>00620         dividendDates.push_back(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a>);
<a name="l00621"></a>00621         dividends.push_back(1.0);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <a class="code" href="class_quant_lib_1_1_dividend_vanilla_option.html" title="Single-asset vanilla option (no barriers) with discrete dividends.">DividendVanillaOption</a> divOption(payoff, exercise,
<a name="l00625"></a>00625                                     dividendDates, dividends);
<a name="l00626"></a>00626     process = boost::shared_ptr&lt;HestonProcess&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00627"></a>00627                    riskFreeTS, dividendTS, s0, 0.04, 1.0, 0.04, 0.001, 0.0));
<a name="l00628"></a>00628     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(
<a name="l00629"></a>00629                     boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)),
<a name="l00630"></a>00630                     200,400,100));
<a name="l00631"></a>00631     divOption.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00632"></a>00632     calculated = divOption.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00633"></a>00633     <span class="comment">// Value calculated with an independent FD framework, validated with</span>
<a name="l00634"></a>00634     <span class="comment">// an independent MC framework</span>
<a name="l00635"></a>00635     expected = 12.946;
<a name="l00636"></a>00636     error = std::fabs(calculated - expected);
<a name="l00637"></a>00637     tolerance = 5.0e-3;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00640"></a>00640         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce discrete dividend price with FD engine&quot;</span>
<a name="l00641"></a>00641                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00642"></a>00642                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00643"></a>00643                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing FD vanilla Heston engine for american exercise...&quot;</span>);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     dividendTS = <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a>(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.03, dayCounter));
<a name="l00649"></a>00649     process = boost::shared_ptr&lt;HestonProcess&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00650"></a>00650                    riskFreeTS, dividendTS, s0, 0.04, 1.0, 0.04, 0.001, 0.0));
<a name="l00651"></a>00651     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(
<a name="l00652"></a>00652                     boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process)),
<a name="l00653"></a>00653                     200,400,100));
<a name="l00654"></a>00654     payoff = boost::shared_ptr&lt;StrikedTypePayoff&gt;(
<a name="l00655"></a>00655                           <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, 95.0));
<a name="l00656"></a>00656     exercise = boost::shared_ptr&lt;Exercise&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_american_exercise.html" title="American exercise.">AmericanExercise</a>(
<a name="l00657"></a>00657             settlementDate, exerciseDate));
<a name="l00658"></a>00658     option = <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a>(payoff, exercise);
<a name="l00659"></a>00659     option.setPricingEngine(engine);
<a name="l00660"></a>00660     calculated = option.NPV();
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;BlackVolTermStructure&gt;</a> volTS(<a class="code" href="namespace_quant_lib.html#a589d5c4b0b60b0bdd42ae07d820b2ed3">flatVol</a>(settlementDate, 0.2,
<a name="l00663"></a>00663                                                   dayCounter));
<a name="l00664"></a>00664     boost::shared_ptr&lt;BlackScholesMertonProcess&gt; ref_process(
<a name="l00665"></a>00665         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_black_scholes_merton_process.html" title="Merton (1973) extension to the Black-Scholes stochastic process.">BlackScholesMertonProcess</a>(s0, dividendTS, riskFreeTS, volTS));
<a name="l00666"></a>00666     boost::shared_ptr&lt;PricingEngine&gt; ref_engine(
<a name="l00667"></a>00667                   <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_f_d_american_engine.html" title="Finite-differences pricing engine for American one asset options.">FDAmericanEngine&lt;CrankNicolson&gt;</a>(ref_process, 200, 400));
<a name="l00668"></a>00668     option.setPricingEngine(ref_engine);
<a name="l00669"></a>00669     expected = option.NPV();
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     error = std::fabs(calculated - expected);
<a name="l00672"></a>00672     tolerance = 1.0e-3;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00675"></a>00675         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce american option price with FD engine&quot;</span>
<a name="l00676"></a>00676                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00677"></a>00677                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00678"></a>00678                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 }
<a name="l00681"></a>00681 
<a name="l00682"></a><a class="code" href="class_heston_model_test.html#ae37f08065f361d93a81d465878153245">00682</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#ae37f08065f361d93a81d465878153245">HestonModelTest::testKahlJaeckelCase</a>() {
<a name="l00683"></a>00683     BOOST_MESSAGE(
<a name="l00684"></a>00684           <span class="stringliteral">&quot;Testing MC and FD Heston engines for the Kahl-Jaeckel example...&quot;</span>);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/* Example taken from Wilmott mag (Sept. 2005).</span>
<a name="l00687"></a>00687 <span class="comment">       &quot;Not-so-complex logarithms in the Heston model&quot;,</span>
<a name="l00688"></a>00688 <span class="comment">       Example was also discussed within the Wilmott thread</span>
<a name="l00689"></a>00689 <span class="comment">       &quot;QuantLib code is very high quatlity&quot;</span>
<a name="l00690"></a>00690 <span class="comment">    */</span>
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(30, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2007);
<a name="l00695"></a>00695     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00698"></a>00698     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(30, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2017);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00701"></a>00701                                    <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, 200));
<a name="l00702"></a>00702     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.0, dayCounter));
<a name="l00705"></a>00705     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.0, dayCounter));
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(100)));
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     boost::shared_ptr&lt;HestonProcess&gt; processNonCentral(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00710"></a>00710                    riskFreeTS, dividendTS, s0, 0.16, 1.0, 0.16, 2.0, -0.8,
<a name="l00711"></a>00711                    <a class="code" href="class_quant_lib_1_1_heston_process.html#a7efd616697f1321b654176850dc55cb6a8a3b27552e3b86dbc9001343c837a683">HestonProcess::NonCentralChiSquareVariance</a>));
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     boost::shared_ptr&lt;HestonProcess&gt; processQE_M(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00714"></a>00714                    riskFreeTS, dividendTS, s0, 0.16, 1.0, 0.16, 2.0, -0.8,
<a name="l00715"></a>00715                    <a class="code" href="class_quant_lib_1_1_heston_process.html#a7efd616697f1321b654176850dc55cb6a7f2c6e4e5736d78341ecd686e7fc401b">HestonProcess::QuadraticExponentialMartingale</a>));
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 0.1;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a> =
<a name="l00723"></a>00723         <a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html" title="Monte Carlo Heston European engine factory.">MakeMCEuropeanHestonEngine&lt;PseudoRandom&gt;</a>(processNonCentral)
<a name="l00724"></a>00724         .withSteps(10)
<a name="l00725"></a>00725         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#ada4b189a85a9b2314ead5e0e820b4724">withAntitheticVariate</a>()
<a name="l00726"></a>00726         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a082553a9b12ce2955b5af23ec0095f65">withAbsoluteTolerance</a>(tolerance)
<a name="l00727"></a>00727         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a5ae0aa8a83228f658e849e95ecb8d212">withSeed</a>(1234);
<a name="l00728"></a>00728     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 4.95212;
<a name="l00731"></a>00731           <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00732"></a>00732           <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorEstimate = option.<a class="code" href="class_quant_lib_1_1_instrument.html#ada8c62ad5a0f65c2c55ac67651689aa9" title="returns the error estimate on the NPV when available.">errorEstimate</a>();
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (std::fabs(calculated - expected) &gt; 2.34*errorEstimate) {
<a name="l00735"></a>00735         BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce cached price with MC engine&quot;</span>
<a name="l00736"></a>00736                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00737"></a>00737                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00738"></a>00738                     &lt;&lt; <span class="stringliteral">&quot; +/- &quot;</span> &lt;&lt; errorEstimate);
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (errorEstimate &gt; tolerance) {
<a name="l00742"></a>00742         BOOST_ERROR(<span class="stringliteral">&quot;failed to reproduce error estimate with MC engine&quot;</span>
<a name="l00743"></a>00743                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; errorEstimate
<a name="l00744"></a>00744                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; tolerance);
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     engine =
<a name="l00748"></a>00748         <a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html" title="Monte Carlo Heston European engine factory.">MakeMCEuropeanHestonEngine&lt;PseudoRandom&gt;</a>(processQE_M)
<a name="l00749"></a>00749         .withSteps(100)
<a name="l00750"></a>00750         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#ada4b189a85a9b2314ead5e0e820b4724">withAntitheticVariate</a>()
<a name="l00751"></a>00751         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a082553a9b12ce2955b5af23ec0095f65">withAbsoluteTolerance</a>(tolerance)
<a name="l00752"></a>00752         .<a class="code" href="class_quant_lib_1_1_make_m_c_european_heston_engine.html#a5ae0aa8a83228f658e849e95ecb8d212">withSeed</a>(1234);
<a name="l00753"></a>00753     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00756"></a>00756     errorEstimate = option.<a class="code" href="class_quant_lib_1_1_instrument.html#ada8c62ad5a0f65c2c55ac67651689aa9" title="returns the error estimate on the NPV when available.">errorEstimate</a>();
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">if</span> (std::fabs(calculated - expected) &gt; 2.34*errorEstimate) {
<a name="l00759"></a>00759         BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce cached price with MC engine&quot;</span>
<a name="l00760"></a>00760                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00761"></a>00761                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00762"></a>00762                     &lt;&lt; <span class="stringliteral">&quot; +/- &quot;</span> &lt;&lt; errorEstimate);
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (errorEstimate &gt; tolerance) {
<a name="l00766"></a>00766         BOOST_ERROR(<span class="stringliteral">&quot;failed to reproduce error estimate with MC engine&quot;</span>
<a name="l00767"></a>00767                     &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; errorEstimate
<a name="l00768"></a>00768                     &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; tolerance);
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     engine = boost::shared_ptr&lt;PricingEngine&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(
<a name="l00772"></a>00772                  boost::shared_ptr&lt;HestonModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(processQE_M)),
<a name="l00773"></a>00773                  200,400,100));
<a name="l00774"></a>00774     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00777"></a>00777     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = std::fabs(calculated - expected);
<a name="l00778"></a>00778     tolerance = 5.0e-2;
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (error &gt; tolerance) {
<a name="l00780"></a>00780         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce cached price with FD engine&quot;</span>
<a name="l00781"></a>00781                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l00782"></a>00782                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected
<a name="l00783"></a>00783                    &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; error);
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="keyword">namespace </span>{
<a name="l00788"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_heston_parameter.html">00788</a>     <span class="keyword">struct </span><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_heston_parameter.html">HestonParameter</a> {
<a name="l00789"></a><a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_heston_parameter.html#a1ebac2a7cd21bd35531ad0415d72b3e7">00789</a>         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="structanonymous__namespace_02hestonmodel_8cpp_03_1_1_heston_parameter.html#a1ebac2a7cd21bd35531ad0415d72b3e7">v0</a>, kappa, theta, <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>, rho; };
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a><a class="code" href="class_heston_model_test.html#a8b51b8317a48980f0e71a3dda7b7ecd5">00792</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a8b51b8317a48980f0e71a3dda7b7ecd5">HestonModelTest::testDifferentIntegrals</a>() {
<a name="l00793"></a>00793     BOOST_MESSAGE(
<a name="l00794"></a>00794        <span class="stringliteral">&quot;Testing different numerical Heston integration algorithms...&quot;</span>);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l00799"></a>00799     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.05, dayCounter));
<a name="l00804"></a>00804     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.03, dayCounter));
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strikes[] = { 0.5, 0.7, 1.0, 1.25, 1.5, 2.0 };
<a name="l00807"></a>00807     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a8ac1a45a37d8d3dda438a2e59e222620" title="integer number">Integer</a> maturities[] = { 1, 2, 3, 12, 60, 120, 360};
<a name="l00808"></a>00808     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> types[] ={ <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a> };
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="keyword">const</span> HestonParameter equityfx      = { 0.07, 2.0, 0.04, 0.55, -0.8 };
<a name="l00811"></a>00811     <span class="keyword">const</span> HestonParameter highCorr      = { 0.07, 1.0, 0.04, 0.55,  0.995 };
<a name="l00812"></a>00812     <span class="keyword">const</span> HestonParameter lowVolOfVol   = { 0.07, 1.0, 0.04, 0.025, -0.75 };
<a name="l00813"></a>00813     <span class="keyword">const</span> HestonParameter highVolOfVol  = { 0.07, 1.0, 0.04, 5.0, -0.75 };
<a name="l00814"></a>00814     <span class="keyword">const</span> HestonParameter kappaEqSigRho = { 0.07, 0.4, 0.04, 0.5, 0.8 };
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     std::vector&lt;HestonParameter&gt; params;
<a name="l00817"></a>00817     params.push_back(equityfx);
<a name="l00818"></a>00818     params.push_back(highCorr);
<a name="l00819"></a>00819     params.push_back(lowVolOfVol);
<a name="l00820"></a>00820     params.push_back(highVolOfVol);
<a name="l00821"></a>00821     params.push_back(kappaEqSigRho);
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tol[] = { 1e-3, 1e-3, 0.2, 0.01, 1e-3 };
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     <span class="keywordflow">for</span> (std::vector&lt;HestonParameter&gt;::const_iterator iter = params.begin();
<a name="l00826"></a>00826          iter != params.end(); ++iter) {
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.0)));
<a name="l00829"></a>00829         boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00830"></a>00830             riskFreeTS, dividendTS,
<a name="l00831"></a>00831             s0, iter-&gt;v0, iter-&gt;kappa,
<a name="l00832"></a>00832             iter-&gt;theta, iter-&gt;sigma, iter-&gt;rho));
<a name="l00833"></a>00833 
<a name="l00834"></a>00834         boost::shared_ptr&lt;HestonModel&gt; model(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process));
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         boost::shared_ptr&lt;AnalyticHestonEngine&gt; lobattoEngine(
<a name="l00837"></a>00837                               <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, 1e-10,
<a name="l00838"></a>00838                                                        1000000));
<a name="l00839"></a>00839         boost::shared_ptr&lt;AnalyticHestonEngine&gt; laguerreEngine(
<a name="l00840"></a>00840                                         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, 192));
<a name="l00841"></a>00841         boost::shared_ptr&lt;AnalyticHestonEngine&gt; legendreEngine(
<a name="l00842"></a>00842             <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00843"></a>00843                 model, <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html#a99a76bd449100675e84d2d8af904bba9afeafbbdface61417ba7352bbe1089350">AnalyticHestonEngine::Gatheral</a>,
<a name="l00844"></a>00844                 <a class="code" href="class_quant_lib_1_1_analytic_heston_engine_1_1_integration.html#af1935bc5bfa21690ded1486128501638">AnalyticHestonEngine::Integration::gaussLegendre</a>(512)));
<a name="l00845"></a>00845         boost::shared_ptr&lt;AnalyticHestonEngine&gt; chebyshevEngine(
<a name="l00846"></a>00846             <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00847"></a>00847                 model, <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html#a99a76bd449100675e84d2d8af904bba9afeafbbdface61417ba7352bbe1089350">AnalyticHestonEngine::Gatheral</a>,
<a name="l00848"></a>00848                 <a class="code" href="class_quant_lib_1_1_analytic_heston_engine_1_1_integration.html#ad1d7e9b17efa073a6be7480060b077a3">AnalyticHestonEngine::Integration::gaussChebyshev</a>(512)));
<a name="l00849"></a>00849         boost::shared_ptr&lt;AnalyticHestonEngine&gt; chebyshev2ndEngine(
<a name="l00850"></a>00850             <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(
<a name="l00851"></a>00851                 model, <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html#a99a76bd449100675e84d2d8af904bba9afeafbbdface61417ba7352bbe1089350">AnalyticHestonEngine::Gatheral</a>,
<a name="l00852"></a>00852                 <a class="code" href="class_quant_lib_1_1_analytic_heston_engine_1_1_integration.html#acf58b8a236d40e25c89079508f41c8c6">AnalyticHestonEngine::Integration::gaussChebyshev2nd</a>(512)));
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> maxLegendreDiff    = 0.0;
<a name="l00855"></a>00855         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> maxChebyshevDiff   = 0.0;
<a name="l00856"></a>00856         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> maxChebyshev2ndDiff= 0.0;
<a name="l00857"></a>00857         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> maxLaguerreDiff    = 0.0;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(maturities); ++i) {
<a name="l00860"></a>00860             boost::shared_ptr&lt;Exercise&gt; exercise(
<a name="l00861"></a>00861                 <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(settlementDate
<a name="l00862"></a>00862                                      + <a class="code" href="class_quant_lib_1_1_period.html">Period</a>(maturities[i], <a class="code" href="namespace_quant_lib.html#a6cdac5e2dae1e972076cc8e3302e4ad3a3d158b618e2bf6e66da9aca81f706dae">Months</a>)));
<a name="l00863"></a>00863 
<a name="l00864"></a>00864             <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(strikes); ++j) {
<a name="l00865"></a>00865                 <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(types); ++k) {
<a name="l00866"></a>00866 
<a name="l00867"></a>00867                     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00868"></a>00868                         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(types[k], strikes[j]));
<a name="l00869"></a>00869 
<a name="l00870"></a>00870                     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(lobattoEngine);
<a name="l00873"></a>00873                     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lobattoNPV = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00874"></a>00874 
<a name="l00875"></a>00875                     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(laguerreEngine);
<a name="l00876"></a>00876                     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> laguerre = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00877"></a>00877 
<a name="l00878"></a>00878                     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(legendreEngine);
<a name="l00879"></a>00879                     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> legendre = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00880"></a>00880 
<a name="l00881"></a>00881                     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(chebyshevEngine);
<a name="l00882"></a>00882                     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> chebyshev = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00883"></a>00883 
<a name="l00884"></a>00884                     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(chebyshev2ndEngine);
<a name="l00885"></a>00885                     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> chebyshev2nd = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00886"></a>00886 
<a name="l00887"></a>00887                     maxLaguerreDiff
<a name="l00888"></a>00888                         = std::max(maxLaguerreDiff,
<a name="l00889"></a>00889                                    std::fabs(lobattoNPV-laguerre));
<a name="l00890"></a>00890                     maxLegendreDiff
<a name="l00891"></a>00891                         = std::max(maxLegendreDiff,
<a name="l00892"></a>00892                                    std::fabs(lobattoNPV-legendre));
<a name="l00893"></a>00893                     maxChebyshevDiff
<a name="l00894"></a>00894                         = std::max(maxChebyshevDiff,
<a name="l00895"></a>00895                                    std::fabs(lobattoNPV-chebyshev));
<a name="l00896"></a>00896                     maxChebyshev2ndDiff
<a name="l00897"></a>00897                         = std::max(maxChebyshev2ndDiff,
<a name="l00898"></a>00898                                    std::fabs(lobattoNPV-chebyshev2nd));
<a name="l00899"></a>00899 
<a name="l00900"></a>00900                 }
<a name="l00901"></a>00901             }
<a name="l00902"></a>00902         }
<a name="l00903"></a>00903         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02brownianbridge_8cpp_03.html#a14172217d34262f9c6403d95f266de1c">maxDiff</a> = std::max(std::max(
<a name="l00904"></a>00904             std::max(maxLaguerreDiff,maxLegendreDiff),
<a name="l00905"></a>00905                                      maxChebyshevDiff), maxChebyshev2ndDiff);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tr = tol[iter - params.begin()];
<a name="l00908"></a>00908         <span class="keywordflow">if</span> (maxDiff &gt; tr) {
<a name="l00909"></a>00909             BOOST_ERROR(<span class="stringliteral">&quot;Failed to reproduce Heston pricing values &quot;</span>
<a name="l00910"></a>00910                         <span class="stringliteral">&quot;within given tolerance&quot;</span>
<a name="l00911"></a>00911                         &lt;&lt; <span class="stringliteral">&quot;\n    maxDifference: &quot;</span> &lt;&lt; maxDiff
<a name="l00912"></a>00912                         &lt;&lt; <span class="stringliteral">&quot;\n    tolerance:     &quot;</span> &lt;&lt; tr);
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914     }
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="class_heston_model_test.html#a22a2460b5b6f478e65121a59a9199adf">00917</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a22a2460b5b6f478e65121a59a9199adf">HestonModelTest::testMultipleStrikesEngine</a>() {
<a name="l00918"></a>00918     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing multiple-strikes FD Heston engine...&quot;</span>);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l00923"></a>00923     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l00926"></a>00926     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2006);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.06, dayCounter));
<a name="l00931"></a>00931     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.02, dayCounter));
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.05)));
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l00936"></a>00936                      riskFreeTS, dividendTS, s0, 0.16, 2.5, 0.09, 0.8, -0.8));
<a name="l00937"></a>00937     boost::shared_ptr&lt;HestonModel&gt; model(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process));
<a name="l00938"></a>00938 
<a name="l00939"></a>00939     std::vector&lt;Real&gt; strikes;
<a name="l00940"></a>00940     strikes.push_back(1.0);  strikes.push_back(0.5);
<a name="l00941"></a>00941     strikes.push_back(0.75); strikes.push_back(1.5); strikes.push_back(2.0);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     boost::shared_ptr&lt;FdHestonVanillaEngine&gt; singleStrikeEngine(
<a name="l00944"></a>00944                              <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(model, 20, 400, 50));
<a name="l00945"></a>00945     boost::shared_ptr&lt;FdHestonVanillaEngine&gt; multiStrikeEngine(
<a name="l00946"></a>00946                              <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fd_heston_vanilla_engine.html" title="Finite-Differences Heston Vanilla Option engine.">FdHestonVanillaEngine</a>(model, 20, 400, 50));
<a name="l00947"></a>00947     multiStrikeEngine-&gt;enableMultipleStrikesCaching(strikes);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> relTol = 5e-3;
<a name="l00950"></a>00950     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; strikes.size(); ++i) {
<a name="l00951"></a>00951         boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l00952"></a>00952                            <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, strikes[i]));
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> aOption(payoff, exercise);
<a name="l00955"></a>00955         aOption.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(multiStrikeEngine);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> npvCalculated   = aOption.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00958"></a>00958         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaCalculated = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#a17265f927ab9be13ce870d9b575c00cb">delta</a>();
<a name="l00959"></a>00959         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> gammaCalculated = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#ae566241a75e5f240846a80923c7a2f39">gamma</a>();
<a name="l00960"></a>00960         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thetaCalculated = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#a56f7387983ab8268b9200421b4f59098">theta</a>();
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         aOption.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(singleStrikeEngine);
<a name="l00963"></a>00963         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> npvExpected   = aOption.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l00964"></a>00964         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaExpected = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#a17265f927ab9be13ce870d9b575c00cb">delta</a>();
<a name="l00965"></a>00965         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> gammaExpected = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#ae566241a75e5f240846a80923c7a2f39">gamma</a>();
<a name="l00966"></a>00966         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thetaExpected = aOption.<a class="code" href="class_quant_lib_1_1_one_asset_option.html#a56f7387983ab8268b9200421b4f59098">theta</a>();
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="keywordflow">if</span> (std::fabs(npvCalculated-npvExpected)/npvExpected &gt; relTol) {
<a name="l00969"></a>00969             BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce price with FD multi strike engine&quot;</span>
<a name="l00970"></a>00970                        &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; npvCalculated
<a name="l00971"></a>00971                        &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; npvExpected
<a name="l00972"></a>00972                        &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; relTol);
<a name="l00973"></a>00973         }
<a name="l00974"></a>00974         <span class="keywordflow">if</span> (std::fabs(deltaCalculated-deltaExpected)/deltaExpected &gt; relTol) {
<a name="l00975"></a>00975             BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce delta with FD multi strike engine&quot;</span>
<a name="l00976"></a>00976                        &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; deltaCalculated
<a name="l00977"></a>00977                        &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; deltaExpected
<a name="l00978"></a>00978                        &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; relTol);
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980         <span class="keywordflow">if</span> (std::fabs(gammaCalculated-gammaExpected)/gammaExpected &gt; relTol) {
<a name="l00981"></a>00981             BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce gamma with FD multi strike engine&quot;</span>
<a name="l00982"></a>00982                        &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; gammaCalculated
<a name="l00983"></a>00983                        &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; gammaExpected
<a name="l00984"></a>00984                        &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; relTol);
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (std::fabs(thetaCalculated-thetaExpected)/thetaExpected &gt; relTol) {
<a name="l00987"></a>00987             BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce theta with FD multi strike engine&quot;</span>
<a name="l00988"></a>00988                        &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; thetaCalculated
<a name="l00989"></a>00989                        &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; thetaExpected
<a name="l00990"></a>00990                        &lt;&lt; <span class="stringliteral">&quot;\n    error:      &quot;</span> &lt;&lt; <a class="code" href="test-suite_2utilities_8hpp.html#a8aef6dd018d8f7ff76fa37cde97e5067">QL_SCIENTIFIC</a> &lt;&lt; relTol);
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 
<a name="l00997"></a><a class="code" href="class_heston_model_test.html#a2c7b33abb3eaf0c40bf2b2240239f78f">00997</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#a2c7b33abb3eaf0c40bf2b2240239f78f">HestonModelTest::testAnalyticPiecewiseTimeDependent</a>() {
<a name="l00998"></a>00998     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing analytic piecewise time dependent Heston prices...&quot;</span>);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(27, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4ad4988bf6760edb92c088bb47d4b61dc5">December</a>, 2004);
<a name="l01003"></a>01003     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l01004"></a>01004     <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual_actual.html" title="Actual/Actual day count.">ActualActual</a>();
<a name="l01005"></a>01005     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> exerciseDate(28, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a982c9e93cf4b41f4b71b5c256df6191c">March</a>, 2005);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007     boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l01008"></a>01008                                   <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(<a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a>, 1.0));
<a name="l01009"></a>01009     boost::shared_ptr&lt;Exercise&gt; exercise(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(exerciseDate));
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     std::vector&lt;Date&gt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a800db345cacda47dd48925126ea05f91">dates</a>; 
<a name="l01012"></a>01012     dates.push_back(settlementDate); dates.push_back(<a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a>(01, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a2c2c73e76831dec3bfead45af4e7e293">January</a>, 2007));
<a name="l01013"></a>01013     std::vector&lt;Rate&gt; irates;
<a name="l01014"></a>01014     irates.push_back(0.0); irates.push_back(0.2);
<a name="l01015"></a>01015     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(
<a name="l01016"></a>01016             boost::shared_ptr&lt;YieldTermStructure&gt;(
<a name="l01017"></a>01017                                     <span class="keyword">new</span> <a class="code" href="namespace_quant_lib.html#aba455dd6323746ed70a64eb4fa65c276" title="Term structure based on linear interpolation of zero yields.">ZeroCurve</a>(dates, irates, dayCounter)));
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     std::vector&lt;Rate&gt; qrates;
<a name="l01020"></a>01020     qrates.push_back(0.0); qrates.push_back(0.3);
<a name="l01021"></a>01021     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(
<a name="l01022"></a>01022             boost::shared_ptr&lt;YieldTermStructure&gt;(
<a name="l01023"></a>01023                                     <span class="keyword">new</span> <a class="code" href="namespace_quant_lib.html#aba455dd6323746ed70a64eb4fa65c276" title="Term structure based on linear interpolation of zero yields.">ZeroCurve</a>(dates, qrates, dayCounter)));
<a name="l01024"></a>01024     
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0 = 0.1;
<a name="l01027"></a>01027     <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(1.0)));
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> theta(0.09, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01030"></a>01030     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> kappa(3.16, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01031"></a>01031     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>(4.40, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01032"></a>01032     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> rho  (-0.8, <a class="code" href="class_quant_lib_1_1_boundary_constraint.html" title="Constraint imposing all arguments to be in [low,high]">BoundaryConstraint</a>(-1.0, 1.0));
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     boost::shared_ptr&lt;PiecewiseTimeDependentHestonModel&gt; model(
<a name="l01035"></a>01035         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_piecewise_time_dependent_heston_model.html" title="Piecewise time dependent Heston model.">PiecewiseTimeDependentHestonModel</a>(riskFreeTS, dividendTS,
<a name="l01036"></a>01036                                               s0, v0, theta, kappa, 
<a name="l01037"></a>01037                                               sigma, rho, <a class="code" href="class_quant_lib_1_1_time_grid.html" title="time grid class">TimeGrid</a>(20.0, 2)));
<a name="l01038"></a>01038     
<a name="l01039"></a>01039     <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l01040"></a>01040     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(boost::shared_ptr&lt;PricingEngine&gt;(
<a name="l01041"></a>01041                                            <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_p_t_d_heston_engine.html" title="analytic piecewise constant time dependent Heston-model engine">AnalyticPTDHestonEngine</a>(model)));
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l01044"></a>01044     boost::shared_ptr&lt;HestonProcess&gt; hestonProcess(
<a name="l01045"></a>01045         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(riskFreeTS, dividendTS, s0, v0,
<a name="l01046"></a>01046                           kappa(0.0), theta(0.0), <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>(0.0), rho(0.0)));
<a name="l01047"></a>01047     boost::shared_ptr&lt;HestonModel&gt; hestonModel(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(hestonProcess));
<a name="l01048"></a>01048     option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(boost::shared_ptr&lt;PricingEngine&gt;(
<a name="l01049"></a>01049                                     <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(hestonModel)));
<a name="l01050"></a>01050     
<a name="l01051"></a>01051     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l01052"></a>01052     
<a name="l01053"></a>01053     <span class="keywordflow">if</span> (std::fabs(calculated-expected) &gt; 1e-12) {
<a name="l01054"></a>01054         BOOST_FAIL(<span class="stringliteral">&quot;failed to reproduce heston prices &quot;</span>
<a name="l01055"></a>01055                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; calculated
<a name="l01056"></a>01056                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected);
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058 }
<a name="l01059"></a>01059 
<a name="l01060"></a><a class="code" href="class_heston_model_test.html#acc0d2b472dbb490c6472600dfa75e6b0">01060</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#acc0d2b472dbb490c6472600dfa75e6b0">HestonModelTest::testDAXCalibrationOfTimeDependentModel</a>() {
<a name="l01061"></a>01061     BOOST_MESSAGE(
<a name="l01062"></a>01062              <span class="stringliteral">&quot;Testing Time dependent Heston model calibration ...&quot;</span>);
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(5, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a6e2eb13b444eddc908b702f9e3030b15">July</a>, 2002);
<a name="l01067"></a>01067     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     CalibrationMarketData marketData = <a class="code" href="namespaceanonymous__namespace_02hestonmodel_8cpp_03.html#a2796fb73922d0236026c39dfafff2da2">getDAXCalibrationMarketData</a>();
<a name="l01070"></a>01070     
<a name="l01071"></a>01071     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS = marketData.riskFreeTS;
<a name="l01072"></a>01072     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS = marketData.dividendYield;
<a name="l01073"></a>01073     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0 = marketData.s0;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075     <span class="keyword">const</span> std::vector&lt;boost::shared_ptr&lt;CalibrationHelper&gt; &gt; options
<a name="l01076"></a>01076                                                     = marketData.options;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     std::vector&lt;Time&gt; modelTimes;
<a name="l01079"></a>01079     modelTimes.push_back(0.25);
<a name="l01080"></a>01080     modelTimes.push_back(10.0);
<a name="l01081"></a>01081     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_time_grid.html" title="time grid class">TimeGrid</a> modelGrid(modelTimes.begin(), modelTimes.end());
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0=0.1;
<a name="l01084"></a>01084     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>( 0.5, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01085"></a>01085     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> theta( 0.1, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01086"></a>01086     <a class="code" href="class_quant_lib_1_1_constant_parameter.html" title="Standard constant parameter .">ConstantParameter</a> rho( -0.5, <a class="code" href="class_quant_lib_1_1_boundary_constraint.html" title="Constraint imposing all arguments to be in [low,high]">BoundaryConstraint</a>(-1.0, 1.0));
<a name="l01087"></a>01087    
<a name="l01088"></a>01088     std::vector&lt;Time&gt; pTimes(1, 0.25);
<a name="l01089"></a>01089     <a class="code" href="class_quant_lib_1_1_piecewise_constant_parameter.html" title="Piecewise-constant parameter.">PiecewiseConstantParameter</a> kappa(pTimes, <a class="code" href="class_quant_lib_1_1_positive_constraint.html" title="Constraint imposing positivity to all arguments">PositiveConstraint</a>());
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; pTimes.size()+1; ++i) {
<a name="l01092"></a>01092         kappa.<a class="code" href="class_quant_lib_1_1_parameter.html#a1e28f9ff5c6873a8d43b5b256772832c">setParam</a>(i, 10.0);
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     boost::shared_ptr&lt;PiecewiseTimeDependentHestonModel&gt; model(
<a name="l01096"></a>01096         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_piecewise_time_dependent_heston_model.html" title="Piecewise time dependent Heston model.">PiecewiseTimeDependentHestonModel</a>(riskFreeTS, dividendTS,
<a name="l01097"></a>01097                                               s0, v0, theta, kappa, 
<a name="l01098"></a>01098                                               sigma, rho, modelGrid));
<a name="l01099"></a>01099     
<a name="l01100"></a>01100     boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_p_t_d_heston_engine.html" title="analytic piecewise constant time dependent Heston-model engine">AnalyticPTDHestonEngine</a>(model));
<a name="l01101"></a>01101     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; options.size(); ++i)
<a name="l01102"></a>01102         options[i]-&gt;setPricingEngine(engine);
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <a class="code" href="class_quant_lib_1_1_levenberg_marquardt.html" title="Levenberg-Marquardt optimization method.">LevenbergMarquardt</a> om(1e-8, 1e-8, 1e-8);
<a name="l01105"></a>01105     model-&gt;calibrate(options, om, <a class="code" href="class_quant_lib_1_1_end_criteria.html" title="Criteria to end optimization process:">EndCriteria</a>(400, 40, 1.0e-8, 1.0e-8, 1.0e-8));
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sse = 0;
<a name="l01108"></a>01108     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i = 0; i &lt; 13*8; ++i) {
<a name="l01109"></a>01109         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> diff = options[i]-&gt;calibrationError()*100.0;
<a name="l01110"></a>01110         sse += diff*diff;
<a name="l01111"></a>01111     }
<a name="l01112"></a>01112     
<a name="l01113"></a>01113     <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = 74.4;
<a name="l01114"></a>01114     <span class="keywordflow">if</span> (std::fabs(sse - expected) &gt; 1.0) {
<a name="l01115"></a>01115         BOOST_FAIL(<span class="stringliteral">&quot;Failed to reproduce calibration error&quot;</span>
<a name="l01116"></a>01116                    &lt;&lt; <span class="stringliteral">&quot;\n    calculated: &quot;</span> &lt;&lt; sse
<a name="l01117"></a>01117                    &lt;&lt; <span class="stringliteral">&quot;\n    expected:   &quot;</span> &lt;&lt; expected);
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119 }
<a name="l01120"></a>01120 
<a name="l01121"></a><a class="code" href="class_heston_model_test.html#ac55a62d30072322cc7d92c94764c26e8">01121</a> <span class="keywordtype">void</span> <a class="code" href="class_heston_model_test.html#ac55a62d30072322cc7d92c94764c26e8">HestonModelTest::testAlanLewisReferencePrices</a>() {
<a name="l01122"></a>01122     BOOST_MESSAGE(<span class="stringliteral">&quot;Testing Alan Lewis Reference Prices ...&quot;</span>);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="comment">/*</span>
<a name="l01125"></a>01125 <span class="comment">     * testing Alan Lewis reference prices posted in</span>
<a name="l01126"></a>01126 <span class="comment">     * http://wilmott.com/messageview.cfm?catid=34&amp;threadid=90957</span>
<a name="l01127"></a>01127 <span class="comment">     */</span>
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <a class="code" href="class_quant_lib_1_1_saved_settings.html">SavedSettings</a> backup;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> settlementDate(5, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a6e2eb13b444eddc908b702f9e3030b15">July</a>, 2002);
<a name="l01132"></a>01132     <a class="code" href="class_quant_lib_1_1_singleton.html#ab79257029fa4841505227497a56cbd93" title="access to the unique instance">Settings::instance</a>().<a class="code" href="class_quant_lib_1_1_settings.html#a908ff4717a9706c4329fb316a49a5720" title="the date at which pricing is to be performed.">evaluationDate</a>() = settlementDate;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_date.html" title="Concrete date class.">Date</a> maturityDate(5, <a class="code" href="namespace_quant_lib.html#afc504c75e7ee54a75e255256d99781e4a6e2eb13b444eddc908b702f9e3030b15">July</a>, 2003);
<a name="l01135"></a>01135     <span class="keyword">const</span> boost::shared_ptr&lt;Exercise&gt; exercise(
<a name="l01136"></a>01136         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_european_exercise.html" title="European exercise.">EuropeanExercise</a>(maturityDate));
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_day_counter.html" title="day counter class">DayCounter</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc24484d02b5cded0a275ade16b95733">dayCounter</a> = <a class="code" href="class_quant_lib_1_1_actual365_fixed.html" title="Actual/365 (Fixed) day count convention.">Actual365Fixed</a>();
<a name="l01139"></a>01139     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> riskFreeTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.01, dayCounter));
<a name="l01140"></a>01140     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;YieldTermStructure&gt;</a> dividendTS(<a class="code" href="namespace_quant_lib.html#a1309465a856634dcd0caff78af7ca223">flatRate</a>(0.02, dayCounter));
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_handle.html">Handle&lt;Quote&gt;</a> s0(boost::shared_ptr&lt;Quote&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_simple_quote.html" title="market element returning a stored value">SimpleQuote</a>(100.0)));
<a name="l01143"></a>01143 
<a name="l01144"></a>01144     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0    =  0.04;
<a name="l01145"></a>01145     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho   = -0.5;
<a name="l01146"></a>01146     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> =  1.0;
<a name="l01147"></a>01147     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa =  4.0;
<a name="l01148"></a>01148     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta =  0.25;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150     <span class="keyword">const</span> boost::shared_ptr&lt;HestonProcess&gt; process(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_process.html" title="Square-root stochastic-volatility Heston process.">HestonProcess</a>(
<a name="l01151"></a>01151         riskFreeTS, dividendTS, s0, v0, kappa, theta, sigma, rho));
<a name="l01152"></a>01152     <span class="keyword">const</span> boost::shared_ptr&lt;HestonModel&gt; model(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_heston_model.html" title="Heston model for the stochastic volatility of an asset.">HestonModel</a>(process));
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     <span class="keyword">const</span> boost::shared_ptr&lt;PricingEngine&gt; laguerreEngine(
<a name="l01155"></a>01155         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, 192u));
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keyword">const</span> boost::shared_ptr&lt;PricingEngine&gt; gaussLobattoEngine(
<a name="l01158"></a>01158         <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_analytic_heston_engine.html" title="analytic Heston-model engine based on Fourier transform">AnalyticHestonEngine</a>(model, <a class="code" href="group__limit_macros.html#ga4f2e6bcf6b19224bce1a5a6234286c17">QL_EPSILON</a>, 100000u));
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strikes[] = { 80, 90, 100, 110, 120 };
<a name="l01161"></a>01161     <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> types[] = { <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>, <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845a4f872c1ba3286c1af60485c2f4a4d3c1">Option::Call</a> };
<a name="l01162"></a>01162     <span class="keyword">const</span> boost::shared_ptr&lt;PricingEngine&gt; engines[]
<a name="l01163"></a>01163         = { laguerreEngine, gaussLobattoEngine };
<a name="l01164"></a>01164 
<a name="l01165"></a>01165     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expectedResults[][2] = {
<a name="l01166"></a>01166         { 7.958878113256768285213263077598987193482161301733,
<a name="l01167"></a>01167           26.774758743998854221382195325726949201687074848341 },
<a name="l01168"></a>01168         { 12.017966707346304987709573290236471654992071308187,
<a name="l01169"></a>01169           20.933349000596710388139445766564068085476194042256 },
<a name="l01170"></a>01170         { 17.055270961270109413522653999411000974895436309183,
<a name="l01171"></a>01171           16.070154917028834278213466703938231827658768230714 },
<a name="l01172"></a>01172         { 23.017825898442800538908781834822560777763225722188,
<a name="l01173"></a>01173           12.132211516709844867860534767549426052805766831181 },
<a name="l01174"></a>01174         { 29.811026202682471843340682293165857439167301370697,
<a name="l01175"></a>01175           9.024913483457835636553375454092357136489051667150  }
<a name="l01176"></a>01176     };
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tol = 1e-12; <span class="comment">// 3e-15 works on linux/ia32,</span>
<a name="l01179"></a>01179                             <span class="comment">// but keep some buffer for other platforms</span>
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(strikes); ++i) {
<a name="l01182"></a>01182         <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> strike = strikes[i];
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(types); ++j) {
<a name="l01185"></a>01185             <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845">Option::Type</a> <a class="code" href="class_traits_1_1template_01curve_1_1type.html">type</a> = types[j];
<a name="l01186"></a>01186 
<a name="l01187"></a>01187             <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; <a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(engines); ++k) {
<a name="l01188"></a>01188                 <span class="keyword">const</span> boost::shared_ptr&lt;PricingEngine&gt; <a class="code" href="class_quant_lib_1_1engine.html">engine</a> = engines[k];
<a name="l01189"></a>01189 
<a name="l01190"></a>01190                 <span class="keyword">const</span> boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
<a name="l01191"></a>01191                     <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(type, strike));
<a name="l01192"></a>01192 
<a name="l01193"></a>01193                 <a class="code" href="class_quant_lib_1_1_vanilla_option.html" title="Vanilla option (no discrete dividends, no barriers) on a single asset.">VanillaOption</a> option(payoff, exercise);
<a name="l01194"></a>01194                 option.<a class="code" href="class_quant_lib_1_1_instrument.html#ac3f954c0c65d5c9815deb3e398ba1fe9" title="set the pricing engine to be used.">setPricingEngine</a>(engine);
<a name="l01195"></a>01195 
<a name="l01196"></a>01196                 <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expected = expectedResults[i][j];
<a name="l01197"></a>01197                 <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> calculated = option.<a class="code" href="class_quant_lib_1_1_instrument.html#a7dfec8f05e4dffbec262cecb6a4bab68" title="returns the net present value of the instrument.">NPV</a>();
<a name="l01198"></a>01198                 <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> relError = std::fabs(calculated-expected)/expected;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200                 <span class="keywordflow">if</span> (relError &gt; tol) {
<a name="l01201"></a>01201                     BOOST_FAIL(
<a name="l01202"></a>01202                            <span class="stringliteral">&quot;failed to reproduce Alan Lewis Reference prices &quot;</span>
<a name="l01203"></a>01203                         &lt;&lt; <span class="stringliteral">&quot;\n    strike     : &quot;</span> &lt;&lt; strike
<a name="l01204"></a>01204                         &lt;&lt; <span class="stringliteral">&quot;\n    option type: &quot;</span> &lt;&lt; type
<a name="l01205"></a>01205                         &lt;&lt; <span class="stringliteral">&quot;\n    engine type: &quot;</span> &lt;&lt; k
<a name="l01206"></a>01206                         &lt;&lt; <span class="stringliteral">&quot;\n    rel. error : &quot;</span> &lt;&lt; relError);
<a name="l01207"></a>01207                 }
<a name="l01208"></a>01208             }
<a name="l01209"></a>01209         }
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211 }
<a name="l01212"></a>01212 
<a name="l01213"></a><a class="code" href="class_heston_model_test.html#a4bedeea751274cd9d2e669b54a54faac">01213</a> test_suite* <a class="code" href="class_heston_model_test.html#a4bedeea751274cd9d2e669b54a54faac">HestonModelTest::suite</a>() {
<a name="l01214"></a>01214     test_suite* suite = BOOST_TEST_SUITE(<span class="stringliteral">&quot;Heston model tests&quot;</span>);
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l01217"></a>01217     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a27380e52abafd6136eee9ee650837270">HestonModelTest::testBlackCalibration</a>));
<a name="l01218"></a>01218     <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l01219"></a>01219     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a296d82e6a33d88133ae7ae0c549479f5">HestonModelTest::testDAXCalibration</a>));
<a name="l01220"></a>01220     <span class="comment">// FLOATING_POINT_EXCEPTION</span>
<a name="l01221"></a>01221     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a56d0cc091c48414dfbf04e2464a2d264">HestonModelTest::testAnalyticVsBlack</a>));
<a name="l01222"></a>01222     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#ae0f287f1e4578c8b819a0a6aa9462b14">HestonModelTest::testAnalyticVsCached</a>));
<a name="l01223"></a>01223     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#ae37f08065f361d93a81d465878153245">HestonModelTest::testKahlJaeckelCase</a>));
<a name="l01224"></a>01224     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a8b51b8317a48980f0e71a3dda7b7ecd5">HestonModelTest::testDifferentIntegrals</a>));
<a name="l01225"></a>01225     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#ab75c691bed4106487b7873083251d8be">HestonModelTest::testFdBarrierVsCached</a>));
<a name="l01226"></a>01226     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a22b450728cf64c8e0fc33c2a4af6330b">HestonModelTest::testFdVanillaVsCached</a>));
<a name="l01227"></a>01227     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#a22a2460b5b6f478e65121a59a9199adf">HestonModelTest::testMultipleStrikesEngine</a>));
<a name="l01228"></a>01228     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_heston_model_test.html#ade7ff0b8e84afe3ecafae9ce7aa75088">HestonModelTest::testMcVsCached</a>));
<a name="l01229"></a>01229     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(
<a name="l01230"></a>01230                     &amp;<a class="code" href="class_heston_model_test.html#a2c7b33abb3eaf0c40bf2b2240239f78f">HestonModelTest::testAnalyticPiecewiseTimeDependent</a>));
<a name="l01231"></a>01231     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(
<a name="l01232"></a>01232                     &amp;<a class="code" href="class_heston_model_test.html#acc0d2b472dbb490c6472600dfa75e6b0">HestonModelTest::testDAXCalibrationOfTimeDependentModel</a>));
<a name="l01233"></a>01233     suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(
<a name="l01234"></a>01234                     &amp;<a class="code" href="class_heston_model_test.html#ac55a62d30072322cc7d92c94764c26e8">HestonModelTest::testAlanLewisReferencePrices</a>));
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     <span class="keywordflow">return</span> suite;
<a name="l01237"></a>01237 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="test-suite_2hestonmodel_8cpp.html">hestonmodel.cpp</a>      </li>

    <li class="footer">Generated on Sat Aug 25 2012 13:50:49 for QuantLib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
