<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>QuantLib: MarketModelTest Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">QuantLib
   &#160;<span id="projectnumber">1.3</span>
   </div>
   <div id="projectbrief">ql1-3</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_market_model_test.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-static-methods">Static Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">MarketModelTest Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="MarketModelTest" -->
<p><code>#include &lt;<a class="el" href="test-suite_2marketmodel_8hpp_source.html">marketmodel.hpp</a>&gt;</code></p>

<p><a href="class_market_model_test-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a75b0b2c359cccfd08c8168b6415b1042">testInverseFloater</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#aeb6f6bee584d3d73f1b2752fc65c9d0a">testPeriodAdapter</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a1c6b7adabf714a36c0af97800eabdf61">testAllMultiStepProducts</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a5b3ddc9f21d25a8aa7c534fd33541280">testOneStepForwardsAndOptionlets</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a7087c5803d8cfbb230430c68ead2c8e0">testOneStepNormalForwardsAndOptionlets</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#adf706701406e0987f7b155ea1943e8ee">testCallableSwapNaif</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a9cb4fc09b46e0c185e49353f02110b8c">testCallableSwapLS</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#afb5cb1cc7d8cfb23c9b122402c9473a8">testCallableSwapAnderson</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#afe0e2ad764c8617ab121712d675e2467">testGreeks</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#af6389ab8bba26c145d096be06d240ee5">testPathwiseGreeks</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a55cab040b18aa60cff9a2a9f7d962826">testPathwiseVegas</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a9b93e5cb909d977d2a454a43ea784201">testPathwiseMarketVegas</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a3a03f7b086f2d538bb20c65b80e8f854">testStochVolForwardsAndOptionlets</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a2c4924fdf74c76dfd21d8833212d787b">testAbcdVolatilityIntegration</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a2acad3641ade915414b420aa2339e4fb">testAbcdVolatilityCompare</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a5131b8a1f60c8d87689236d7ef4b6238">testAbcdVolatilityFit</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a29a95ab71a7436f0ad341b2bd7b7f4b5">testDriftCalculator</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#a57480798c0dbcb9eecd665dc6d372ea2">testIsInSubset</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <br class="typebreak"/>
boost::unit_test_framework::test_suite *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_market_model_test.html#afbeade3d23021865efaf828ba07ca3fa">suite</a> ()</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="test-suite_2marketmodel_8hpp_source.html#l00029">29</a> of file <a class="el" href="test-suite_2marketmodel_8hpp_source.html">marketmodel.hpp</a>.</p>
</div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="afbeade3d23021865efaf828ba07ca3fa"></a><!-- doxytag: member="MarketModelTest::suite" ref="afbeade3d23021865efaf828ba07ca3fa" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">test_suite * <a class="el" href="class_market_model_test.html#afbeade3d23021865efaf828ba07ca3fa">MarketModelTest::suite</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">4774</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2utilities_8hpp_source.html#l00061">QUANTLIB_TEST_CASE</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04395">testAbcdVolatilityCompare()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04443">testAbcdVolatilityFit()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04342">testAbcdVolatilityIntegration()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01259">testAllMultiStepProducts()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01776">testCallableSwapAnderson()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01598">testCallableSwapLS()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01429">testCallableSwapNaif()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04695">testDriftCalculator()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01944">testGreeks()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00902">testInverseFloater()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00718">testOneStepForwardsAndOptionlets()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00810">testOneStepNormalForwardsAndOptionlets()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l02183">testPathwiseGreeks()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l03647">testPathwiseMarketVegas()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l02438">testPathwiseVegas()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01276">testPeriodAdapter()</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04493">testStochVolForwardsAndOptionlets()</a>.</p>

<p>Referenced by <a class="el" href="quantlibtestsuite_8cpp_source.html#l00206">init_unit_test_suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                   {
    test_suite* <a class="code" href="class_market_model_test.html#afbeade3d23021865efaf828ba07ca3fa">suite</a> = BOOST_TEST_SUITE(<span class="stringliteral">&quot;Market-model tests&quot;</span>);
 
 suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a75b0b2c359cccfd08c8168b6415b1042">MarketModelTest::testInverseFloater</a>));
 suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a9cb4fc09b46e0c185e49353f02110b8c">MarketModelTest::testCallableSwapLS</a>));

 
    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a55cab040b18aa60cff9a2a9f7d962826">MarketModelTest::testPathwiseVegas</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a9b93e5cb909d977d2a454a43ea784201">MarketModelTest::testPathwiseMarketVegas</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a3a03f7b086f2d538bb20c65b80e8f854">MarketModelTest::testStochVolForwardsAndOptionlets</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#af6389ab8bba26c145d096be06d240ee5">MarketModelTest::testPathwiseGreeks</a>));


    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a1c6b7adabf714a36c0af97800eabdf61">MarketModelTest::testAllMultiStepProducts</a>));



    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a5b3ddc9f21d25a8aa7c534fd33541280">MarketModelTest::testOneStepForwardsAndOptionlets</a>));
    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a7087c5803d8cfbb230430c68ead2c8e0">MarketModelTest::testOneStepNormalForwardsAndOptionlets</a>));

    <span class="comment">// FLOATING_POINT_EXCEPTION</span>

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#adf706701406e0987f7b155ea1943e8ee">MarketModelTest::testCallableSwapNaif</a>));

    <span class="comment">// FLOATING_POINT_EXCEPTION</span>
    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#afb5cb1cc7d8cfb23c9b122402c9473a8">MarketModelTest::testCallableSwapAnderson</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#afe0e2ad764c8617ab121712d675e2467">MarketModelTest::testGreeks</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a2c4924fdf74c76dfd21d8833212d787b">MarketModelTest::testAbcdVolatilityIntegration</a>));
    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a2acad3641ade915414b420aa2339e4fb">MarketModelTest::testAbcdVolatilityCompare</a>));
    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a5131b8a1f60c8d87689236d7ef4b6238">MarketModelTest::testAbcdVolatilityFit</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#aeb6f6bee584d3d73f1b2752fc65c9d0a">MarketModelTest::testPeriodAdapter</a>));

    suite-&gt;add(<a class="code" href="test-suite_2utilities_8hpp.html#a80550c9c9a7264738072a40a2fc8fd8d">QUANTLIB_TEST_CASE</a>(&amp;<a class="code" href="class_market_model_test.html#a29a95ab71a7436f0ad341b2bd7b7f4b5">MarketModelTest::testDriftCalculator</a>));
    <span class="comment">//suite-&gt;add(QUANTLIB_TEST_CASE(&amp;MarketModelTest::testIsInSubset));</span>

    <span class="keywordflow">return</span> <a class="code" href="class_market_model_test.html#afbeade3d23021865efaf828ba07ca3fa">suite</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2acad3641ade915414b420aa2339e4fb"></a><!-- doxytag: member="MarketModelTest::testAbcdVolatilityCompare" ref="a2acad3641ade915414b420aa2339e4fb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a2acad3641ade915414b420aa2339e4fb">MarketModelTest::testAbcdVolatilityCompare</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04395">4395</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::a</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::b</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::c</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::d</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, and <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                                {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing different implementations of Abcd-volatility...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <span class="comment">/*</span>
<span class="comment">    Given the instantaneous volatilities related to forward expiring at</span>
<span class="comment">    rateTimes[i1] and at rateTimes[i2], the methods:</span>
<span class="comment">    - LmExtLinearExponentialVolModel::integratedVariance(i1,i2,T)</span>
<span class="comment">    - Abcd::covariance(T)</span>
<span class="comment">    return the same result only if T &lt; min(rateTimes[i1],rateTimes[i2]).</span>
<span class="comment">    */</span>

    <span class="comment">// Parameters following Rebonato / Parameters following Brigo-Mercurio</span>
    <span class="comment">// used in Abcd class              used in LmExtLinearExponentialVolModel</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a> = 0.0597;                      <span class="comment">// --&gt; d</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> = 0.1677;                      <span class="comment">// --&gt; a</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a> = 0.5403;                      <span class="comment">// --&gt; b</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a> = 0.1710;                      <span class="comment">// --&gt; c</span>

    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i1; <span class="comment">// index of forward 1</span>
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i2; <span class="comment">// index of forward 2</span>

    boost::shared_ptr&lt;LmVolatilityModel&gt; lmAbcd(
        <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_lm_ext_linear_exponential_vol_model.html" title="extended linear exponential volatility model">LmExtLinearExponentialVolModel</a>(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,b,c,d,a));
    boost::shared_ptr&lt;AbcdFunction&gt; abcd(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_abcd_function.html" title="Abcd functional form for instantaneous volatility">AbcdFunction</a>(a,b,c,d));
    <span class="keywordflow">for</span> (i1=0; i1&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.size(); i1++ ) {
        <span class="keywordflow">for</span> (i2=0; i2&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.size(); i2++ ) {
            <a class="code" href="class_time.html">Time</a> <a class="code" href="class_t.html">T</a> = 0.;
            <span class="keywordflow">do</span> {
                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> lmCovariance = lmAbcd-&gt;integratedVariance(i1,i2,T);
                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> abcdCovariance =
                    abcd-&gt;covariance(0,T,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i1],<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i2]);
                <span class="keywordflow">if</span>(std::abs(lmCovariance-abcdCovariance)&gt;1e-10) {
                    BOOST_FAIL(<span class="stringliteral">&quot; T1=&quot;</span>   &lt;&lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i1] &lt;&lt; <span class="stringliteral">&quot;,&quot;</span>     &lt;&lt;
                        <span class="stringliteral">&quot;T2=&quot;</span>   &lt;&lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i2] &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;xMin=&quot;</span> &lt;&lt; 0  &lt;&lt; <span class="stringliteral">&quot;,&quot;</span>     &lt;&lt;
                        <span class="stringliteral">&quot;xMax=&quot;</span> &lt;&lt; T  &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;abcd: &quot;</span> &lt;&lt; abcdCovariance &lt;&lt; <span class="stringliteral">&quot;,\t&quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;lm: &quot;</span>   &lt;&lt; lmCovariance);
                }
                T += 0.5;
            } <span class="keywordflow">while</span> (T&lt;std::min(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i1],<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i2])) ;
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5131b8a1f60c8d87689236d7ef4b6238"></a><!-- doxytag: member="MarketModelTest::testAbcdVolatilityFit" ref="a5131b8a1f60c8d87689236d7ef4b6238" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a5131b8a1f60c8d87689236d7ef4b6238">MarketModelTest::testAbcdVolatilityFit</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04443">4443</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="abcdcalibration_8cpp_source.html#l00130">QuantLib::AbcdCalibration::a()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00134">QuantLib::AbcdCalibration::b()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00135">anonymous_namespace{marketmodel.cpp}::blackVols</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00138">QuantLib::AbcdCalibration::c()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00067">QuantLib::AbcdCalibration::compute()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00142">QuantLib::AbcdCalibration::d()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00191">QuantLib::AbcdCalibration::endCriteria()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00163">QuantLib::AbcdCalibration::error()</a>, <a class="el" href="abcdcalibration_8cpp_source.html#l00151">QuantLib::AbcdCalibration::k()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, and <a class="el" href="abcd_8cpp_source.html#l00058">QuantLib::AbcdFunction::volatility()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                            {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing Abcd-volatility fit...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="class_quant_lib_1_1_abcd_calibration.html">AbcdCalibration</a> instVol(std::vector&lt;Time&gt;(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.begin(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.end()-1), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a3678819d1a74b83027d3b1425d720151">blackVols</a>);
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> a0 = instVol.a();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> b0 = instVol.b();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> c0 = instVol.c();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> d0 = instVol.d();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error0 = instVol.error();

    instVol.compute();

    <a class="code" href="class_quant_lib_1_1_end_criteria.html#aa338799214a20227a4d11a4219b66a66">EndCriteria::Type</a> ec = instVol.endCriteria();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> a1 = instVol.a();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> b1 = instVol.b();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> c1 = instVol.c();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> d1 = instVol.d();
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error1 = instVol.error();

    <span class="keywordflow">if</span> (error1&gt;=error0)
        BOOST_FAIL(<span class="stringliteral">&quot;Parameters:&quot;</span> &lt;&lt;
        <span class="stringliteral">&quot;\na:     &quot;</span> &lt;&lt; a0 &lt;&lt; <span class="stringliteral">&quot; ---&gt; &quot;</span> &lt;&lt; a1 &lt;&lt;
        <span class="stringliteral">&quot;\nb:     &quot;</span> &lt;&lt; b0 &lt;&lt; <span class="stringliteral">&quot; ---&gt; &quot;</span> &lt;&lt; b1 &lt;&lt;
        <span class="stringliteral">&quot;\nc:     &quot;</span> &lt;&lt; c0 &lt;&lt; <span class="stringliteral">&quot; ---&gt; &quot;</span> &lt;&lt; c1 &lt;&lt;
        <span class="stringliteral">&quot;\nd:     &quot;</span> &lt;&lt; d0 &lt;&lt; <span class="stringliteral">&quot; ---&gt; &quot;</span> &lt;&lt; d1 &lt;&lt;
        <span class="stringliteral">&quot;\nerror: &quot;</span> &lt;&lt; error0 &lt;&lt; <span class="stringliteral">&quot; ---&gt; &quot;</span> &lt;&lt; error1);

    <a class="code" href="class_quant_lib_1_1_abcd_function.html" title="Abcd functional form for instantaneous volatility">AbcdFunction</a> abcd(a1, b1, c1, d1);
    std::vector&lt;Real&gt; k = instVol.k(std::vector&lt;Time&gt;(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.begin(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.end()-1), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a3678819d1a74b83027d3b1425d720151">blackVols</a>);
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tol = 3.0e-4;
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a3678819d1a74b83027d3b1425d720151">blackVols</a>.size(); i++) {
        <span class="keywordflow">if</span> (std::abs(k[i]-1.0)&gt;tol) {
            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> modelVol =
                abcd.volatility(0.0, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i], <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i]);
            BOOST_FAIL(<span class="stringliteral">&quot;\n EndCriteria = &quot;</span> &lt;&lt; ec &lt;&lt;
                <span class="stringliteral">&quot;\n Fixing Time = &quot;</span> &lt;&lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i] &lt;&lt;
                <span class="stringliteral">&quot;\n MktVol      = &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a3678819d1a74b83027d3b1425d720151">blackVols</a>[i]) &lt;&lt;
                <span class="stringliteral">&quot;\n ModVol      = &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(modelVol) &lt;&lt;
                <span class="stringliteral">&quot;\n k           = &quot;</span> &lt;&lt; k[i] &lt;&lt;
                <span class="stringliteral">&quot;\n error       = &quot;</span> &lt;&lt; std::abs(k[i]-1.0) &lt;&lt;
                <span class="stringliteral">&quot;\n tol         = &quot;</span> &lt;&lt; tol);
        }
    }

}
</pre></div>
</div>
</div>
<a class="anchor" id="a2c4924fdf74c76dfd21d8833212d787b"></a><!-- doxytag: member="MarketModelTest::testAbcdVolatilityIntegration" ref="a2c4924fdf74c76dfd21d8833212d787b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a2c4924fdf74c76dfd21d8833212d787b">MarketModelTest::testAbcdVolatilityIntegration</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04342">4342</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::a</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::b</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::c</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::d</a>, <a class="el" href="matrices_8cpp_source.html#l00037">anonymous_namespace{matrices.cpp}::N</a>, and <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                                    {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing Abcd-volatility integration...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a> = -0.0597;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> =  0.1677;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a> =  0.5403;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a06d0bee201af9d379ec8f9563ecf7f66">d</a> =  0.1710;

    <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a> = 10;
    <span class="keyword">const</span> <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> precision = 1e-04;

    boost::shared_ptr&lt;AbcdFunction&gt; instVol(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_abcd_function.html" title="Abcd functional form for instantaneous volatility">AbcdFunction</a>(a,b,c,d));
    <a class="code" href="class_quant_lib_1_1_segment_integral.html" title="Integral of a one-dimensional function.">SegmentIntegral</a> SI(20000);
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a>; i++) {
        <a class="code" href="class_time.html">Time</a> T1 = 0.5*(1+i);     <span class="comment">// expiry of forward 1: after T1 AbcdVol = 0</span>
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;N-i; k++) {
            <a class="code" href="class_time.html">Time</a> T2 = 0.5*(1+k); <span class="comment">// expiry of forward 2: after T2 AbcdVol = 0</span>
            <span class="comment">//Integration</span>
            <span class="keywordflow">for</span>(<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a>; j++) {
                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> xMin = 0.5*j;
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l&lt;N-j; l++) {
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> xMax = xMin + 0.5*l;
                    <a class="code" href="class_quant_lib_1_1_abcd_squared.html">AbcdSquared</a> abcd2(a,b,c,d,T1,T2);
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerical = SI(abcd2,xMin,xMax);
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> analytical = instVol-&gt;covariance(xMin,xMax,T1,T2);
                    <span class="keywordflow">if</span> (std::abs(analytical-numerical)&gt;precision) {
                        BOOST_MESSAGE(<span class="stringliteral">&quot;     T1=&quot;</span> &lt;&lt; T1 &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;T2=&quot;</span> &lt;&lt; T2 &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;xMin=&quot;</span> &lt;&lt; xMin &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;xMax=&quot;</span> &lt;&lt; xMax &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;analytical: &quot;</span> &lt;&lt; analytical &lt;&lt; <span class="stringliteral">&quot;,\t&quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;numerical:   &quot;</span> &lt;&lt; numerical);
                    }
                    <span class="keywordflow">if</span> (T1==T2) {
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance = instVol-&gt;variance(xMin,xMax,T1);
                        <span class="keywordflow">if</span> (std::abs(analytical-variance)&gt;1e-14) {
                            BOOST_FAIL(<span class="stringliteral">&quot;     T1=&quot;</span> &lt;&lt; T1 &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;T2=&quot;</span> &lt;&lt; T2 &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;xMin=&quot;</span> &lt;&lt; xMin &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;xMax=&quot;</span> &lt;&lt; xMax &lt;&lt; <span class="stringliteral">&quot;,\t\t&quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;variance: &quot;</span> &lt;&lt; variance &lt;&lt; <span class="stringliteral">&quot;,\t&quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;analytical: &quot;</span> &lt;&lt; analytical);
                        }
                    }
                }
            }
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1c6b7adabf714a36c0af97800eabdf61"></a><!-- doxytag: member="MarketModelTest::testAllMultiStepProducts" ref="a1c6b7adabf714a36c0af97800eabdf61" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a1c6b7adabf714a36c0af97800eabdf61">MarketModelTest::testAllMultiStepProducts</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01259">1259</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01177">addCoinitialSwaps()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01197">addCoterminalSwapsAndSwaptions()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01120">addForwards()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01143">addOptionLets()</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01047">testMultiProductComposite()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                               {
    std::string testDescription = <span class="stringliteral">&quot;all multi-step products &quot;</span>;

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> product;
    std::vector&lt;SubProductExpectedValues&gt; subProductExpectedValues;
    <a class="code" href="test-suite_2marketmodel_8cpp.html#abe32b2a4a21a24ce9e59e85b0354e18f">addForwards</a>(product, subProductExpectedValues);
    <a class="code" href="test-suite_2marketmodel_8cpp.html#a4e695cdab2c5ca045b7a1a750c45d8ae">addOptionLets</a>(product, subProductExpectedValues);
    <a class="code" href="test-suite_2marketmodel_8cpp.html#a04894a69419aa7dd610d87ba17d697a3">addCoinitialSwaps</a>(product, subProductExpectedValues);
    <a class="code" href="test-suite_2marketmodel_8cpp.html#a48937cc9295ce42200fcd6504e7f44cf">addCoterminalSwapsAndSwaptions</a>(product, subProductExpectedValues);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();
    <a class="code" href="test-suite_2marketmodel_8cpp.html#a96d0f272f30f8c8aaf28f2143ecc6a1a">testMultiProductComposite</a>(product, subProductExpectedValues,
        testDescription);
}
</pre></div>
</div>
</div>
<a class="anchor" id="afb5cb1cc7d8cfb23c9b122402c9473a8"></a><!-- doxytag: member="MarketModelTest::testCallableSwapAnderson" ref="afb5cb1cc7d8cfb23c9b122402c9473a8" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#afb5cb1cc7d8cfb23c9b122402c9473a8">MarketModelTest::testCallableSwapAnderson</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01776">1776</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Balland</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00671">anonymous_namespace{marketmodel.cpp}::checkCallableSwap()</a>, <a class="el" href="collectnodedata_8cpp_source.html#l00036">QuantLib::collectNodeData()</a>, <a class="el" href="sobolbrowniangenerator_8hpp_source.html#l00044">QuantLib::SobolBrownianGenerator::Diagonal</a>, <a class="el" href="callspecifiedmultiproduct_8cpp_source.html#l00093">QuantLib::CallSpecifiedMultiProduct::evolution()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00089">QuantLib::EvolutionDescription::evolutionTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="parametricexerciseadapter_8cpp_source.html#l00041">QuantLib::ParametricExerciseAdapter::exerciseTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="parametricexercise_8cpp_source.html#l00081">QuantLib::genericEarlyExerciseOptimization()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Ipc</a>, <a class="el" href="ql_2models_2marketmodels_2utilities_8cpp_source.html#l00059">QuantLib::isInSubset()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00131">QuantLib::isInTerminalMeasure()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="upperboundengine_8cpp_source.html#l00170">QuantLib::UpperBoundEngine::multiplePathValues()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00369">anonymous_namespace{marketmodel.cpp}::Terminal</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::trainingPaths_</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                               {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Pricing callable swap with Anderson exercise strategy in a LIBOR market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> fixedRate = 0.04;

    <span class="comment">// 0. a payer swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> payerSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">true</span>);

    <span class="comment">// 1. the equivalent receiver swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> receiverSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">false</span>);

    <span class="comment">//exercise schedule</span>
    std::vector&lt;Rate&gt; exerciseTimes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    exerciseTimes.pop_back();
    <span class="comment">//std::vector&lt;Rate&gt; exerciseTimes;</span>
    <span class="comment">//for (Size i=2; i&lt;rateTimes.size()-1; i+=2)</span>
    <span class="comment">//    exerciseTimes.push_back(rateTimes[i]);</span>

    <span class="comment">// naif exercise strategy</span>
    std::vector&lt;Rate&gt; swapTriggers(exerciseTimes.size(), fixedRate);
    <a class="code" href="class_quant_lib_1_1_swap_rate_trigger.html">SwapRateTrigger</a> naifStrategy(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, swapTriggers, exerciseTimes);

    <span class="comment">// Anderson exercise strategy</span>
    std::vector&lt;std::vector&lt;NodeData&gt; &gt; collectedData;
    std::vector&lt;std::vector&lt;Real&gt; &gt; parameters;
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> control(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> nullRebate(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    <a class="code" href="class_quant_lib_1_1_triggered_swap_exercise.html">TriggeredSwapExercise</a> parametricForm(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, exerciseTimes,
        std::vector&lt;Time&gt;(exerciseTimes.size(),fixedRate));

    <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> dummyProduct =
        <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(receiverSwap, naifStrategy,
        <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = dummyProduct.<a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html#ad31a93fbf18add8acaaede3f99c17bee">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 4, 8,
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <span class="comment">// Composite&#39;s ProductSuggested is the Terminal one</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <span class="comment">// ProductSuggested,</span>
                    <span class="comment">// MoneyMarketPlus,</span>
                    <span class="comment">// MoneyMarket,</span>
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccba6f28481dc98c0a4bb1c59693c180de71">Terminal</a>
                };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(dummyProduct, measures[k]);
                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64ae1eec6d770cb5d78f54e7e962c0cb07c">Balland</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a023bafd223de3a53c27ebd77f7c08866">Ipc</a> };
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> stop =
                        <a class="code" href="namespace_quant_lib.html#ab6ef4e92ef66e91f3e04e6a7587fbfb3">isInTerminalMeasure</a>(evolution, numeraires) ? 0 : 1;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers)-stop; i++) {
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                            <span class="comment">//MTBrownianGeneratorFactory generatorFactory(seed_);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> generatorFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);
                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());
                            <span class="comment">// 1. calculate the exercise strategy</span>
                            <a class="code" href="namespace_quant_lib.html#affdf0ca758e1c79f6139e953e7e7f0be">collectNodeData</a>(*evolver,
                                receiverSwap, parametricForm, nullRebate,
                                control, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0fbb8727c6242639bc200cdd02d55d2b">trainingPaths_</a>, collectedData);
                            <a class="code" href="class_quant_lib_1_1_simplex.html" title="Multi-dimensional simplex class.">Simplex</a> om(0.01);
                            <a class="code" href="class_quant_lib_1_1_end_criteria.html" title="Criteria to end optimization process:">EndCriteria</a> ec(1000, 100, 1e-8, 1e-16, 1e-8);
                            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver-&gt;numeraires().front();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> firstPassValue = <a class="code" href="namespace_quant_lib.html#a5461676d8c9c5f75aa942b4ee80872fe" title="returns the biased estimate obtained while optimizing">genericEarlyExerciseOptimization</a>(
                                collectedData, parametricForm, parameters, ec, om) *
                                initialNumeraireValue;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    initial estimate:  &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(firstPassValue));
                            <a class="code" href="class_quant_lib_1_1_parametric_exercise_adapter.html">ParametricExerciseAdapter</a> exerciseStrategy(parametricForm, parameters);

                            <span class="comment">// 2. bermudan swaption to enter into the payer swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> bermudanProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                <a class="code" href="class_quant_lib_1_1_multi_step_nothing.html">MultiStepNothing</a>(evolution),
                                exerciseStrategy, payerSwap);

                            <span class="comment">// 3. callable receiver swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> callableProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                receiverSwap, exerciseStrategy,
                                <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));
                            <span class="comment">// lower bound: evolve all 4 products togheter</span>
                            <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> allProducts;
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(payerSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(receiverSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(bermudanProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(callableProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();
                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, allProducts);
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a922dfa2427c416014fcc97a72564b47d">checkCallableSwap</a>(*stats, config.str());

                            <span class="comment">// upper bound</span>
                            <span class="comment">//MTBrownianGeneratorFactory uFactory(seed_+142);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> uFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+142);
                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                uFactory,
                                evolvers[i]);
                            std::vector&lt;boost::shared_ptr&lt;MarketModelEvolver&gt; &gt;
                                innerEvolvers;
                            std::valarray&lt;bool&gt; isExerciseTime =
                                <a class="code" href="namespace_quant_lib.html#a63702629fc8bcdc4fccada3763aac0d1">isInSubset</a>(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#acfce18fa0ad78b0360955701f94e29d3">evolutionTimes</a>(),
                                           exerciseStrategy.exerciseTimes());
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s &lt; isExerciseTime.size(); ++s) {
                                <span class="keywordflow">if</span> (isExerciseTime[s]) {
                                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> iFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+s);
                                    boost::shared_ptr&lt;MarketModelEvolver&gt; e =
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                        numeraires,
                                        iFactory,
                                        evolvers[i],
                                        s);
                                    innerEvolvers.push_back(e);
                                }
                            }
                            <a class="code" href="class_quant_lib_1_1_upper_bound_engine.html" title="Market-model engine for upper-bound estimation.">UpperBoundEngine</a> uEngine(evolver, innerEvolvers,
                                receiverSwap, nullRebate,
                                receiverSwap, nullRebate,
                                exerciseStrategy,
                                initialNumeraireValue);
                            <a class="code" href="class_quant_lib_1_1_generic_risk_statistics.html" title="empirical-distribution risk measures">Statistics</a> uStats;
                            uEngine.multiplePathValues(uStats,255,256);
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta = uStats.mean();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaError = uStats.errorEstimate();
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    upper bound delta: &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(delta) &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(deltaError));

                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9cb4fc09b46e0c185e49353f02110b8c"></a><!-- doxytag: member="MarketModelTest::testCallableSwapLS" ref="a9cb4fc09b46e0c185e49353f02110b8c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a9cb4fc09b46e0c185e49353f02110b8c">MarketModelTest::testCallableSwapLS</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01598">1598</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Balland</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00671">anonymous_namespace{marketmodel.cpp}::checkCallableSwap()</a>, <a class="el" href="collectnodedata_8cpp_source.html#l00036">QuantLib::collectNodeData()</a>, <a class="el" href="sobolbrowniangenerator_8hpp_source.html#l00044">QuantLib::SobolBrownianGenerator::Diagonal</a>, <a class="el" href="callspecifiedmultiproduct_8cpp_source.html#l00093">QuantLib::CallSpecifiedMultiProduct::evolution()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00089">QuantLib::EvolutionDescription::evolutionTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="lsstrategy_8cpp_source.html#l00090">QuantLib::LongstaffSchwartzExerciseStrategy::exerciseTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="genericlsregression_8cpp_source.html#l00026">QuantLib::genericLongstaffSchwartzRegression()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Ipc</a>, <a class="el" href="ql_2models_2marketmodels_2utilities_8cpp_source.html#l00059">QuantLib::isInSubset()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00131">QuantLib::isInTerminalMeasure()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="upperboundengine_8cpp_source.html#l00170">QuantLib::UpperBoundEngine::multiplePathValues()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::trainingPaths_</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                         {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Pricing callable swap with Longstaff-Schwartz exercise strategy in a LIBOR market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> fixedRate = 0.04;

    <span class="comment">// 0. a payer swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> payerSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">true</span>);

    <span class="comment">// 1. the equivalent receiver swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> receiverSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">false</span>);

    <span class="comment">//exercise schedule</span>
    std::vector&lt;Rate&gt; exerciseTimes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    exerciseTimes.pop_back();
    <span class="comment">//std::vector&lt;Rate&gt; exerciseTimes;</span>
    <span class="comment">//for (Size i=2; i&lt;rateTimes.size()-1; i+=2)</span>
    <span class="comment">//    exerciseTimes.push_back(rateTimes[i]);</span>

    <span class="comment">// naif exercise strategy</span>
    std::vector&lt;Rate&gt; swapTriggers(exerciseTimes.size(), fixedRate);
    <a class="code" href="class_quant_lib_1_1_swap_rate_trigger.html">SwapRateTrigger</a> naifStrategy(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, swapTriggers, exerciseTimes);

    <span class="comment">// Longstaff-Schwartz exercise strategy</span>
    std::vector&lt;std::vector&lt;NodeData&gt; &gt; collectedData;
    std::vector&lt;std::vector&lt;Real&gt; &gt; basisCoefficients;
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> control(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    <a class="code" href="class_quant_lib_1_1_swap_basis_system.html">SwapBasisSystem</a> basisSystem(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,exerciseTimes);
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> nullRebate(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);

    <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> dummyProduct =
        <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(receiverSwap, naifStrategy,
        <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = dummyProduct.<a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html#ad31a93fbf18add8acaaede3f99c17bee">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 4, <span class="comment">// 8,</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <span class="comment">// Composite&#39;s ProductSuggested is the Terminal one</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <span class="comment">// ProductSuggested,</span>
                    <span class="comment">// MoneyMarketPlus,</span>
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>
                    <span class="comment">//Terminal</span>
                };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(dummyProduct, measures[k]);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);


                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64ae1eec6d770cb5d78f54e7e962c0cb07c">Balland</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a023bafd223de3a53c27ebd77f7c08866">Ipc</a> };
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> stop =
                        <a class="code" href="namespace_quant_lib.html#ab6ef4e92ef66e91f3e04e6a7587fbfb3">isInTerminalMeasure</a>(evolution, numeraires) ? 0 : 1;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers)-stop; i++) {

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                            <span class="comment">//MTBrownianGeneratorFactory generatorFactory(seed_);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> generatorFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            <span class="comment">// calculate the exercise strategy</span>
                            <a class="code" href="namespace_quant_lib.html#affdf0ca758e1c79f6139e953e7e7f0be">collectNodeData</a>(*evolver,
                                receiverSwap, basisSystem, nullRebate,
                                control, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0fbb8727c6242639bc200cdd02d55d2b">trainingPaths_</a>, collectedData);
                            <a class="code" href="namespace_quant_lib.html#a1eb8f30fb584a6d2b39c7ea348e2a48e" title="returns the biased estimate obtained while regressing">genericLongstaffSchwartzRegression</a>(collectedData,
                                basisCoefficients);
                            <a class="code" href="class_quant_lib_1_1_longstaff_schwartz_exercise_strategy.html">LongstaffSchwartzExerciseStrategy</a> exerciseStrategy(
                                basisSystem, basisCoefficients,
                                evolution, numeraires,
                                nullRebate, control);

                            <span class="comment">// 2. bermudan swaption to enter into the payer swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> bermudanProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                <a class="code" href="class_quant_lib_1_1_multi_step_nothing.html">MultiStepNothing</a>(evolution),
                                exerciseStrategy, payerSwap);

                            <span class="comment">// 3. callable receiver swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> callableProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                receiverSwap, exerciseStrategy,
                                <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));

                            <span class="comment">// lower bound: evolve all 4 products togheter</span>
                            <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> allProducts;
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(payerSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(receiverSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(bermudanProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(callableProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, allProducts);
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a922dfa2427c416014fcc97a72564b47d">checkCallableSwap</a>(*stats, config.str());


                            <span class="comment">// upper bound</span>

                            <span class="comment">//MTBrownianGeneratorFactory uFactory(seed_+142);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> uFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+142);
                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                uFactory,
                                evolvers[i]);

                            std::vector&lt;boost::shared_ptr&lt;MarketModelEvolver&gt; &gt;
                                innerEvolvers;

                            std::valarray&lt;bool&gt; isExerciseTime =
                                <a class="code" href="namespace_quant_lib.html#a63702629fc8bcdc4fccada3763aac0d1">isInSubset</a>(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#acfce18fa0ad78b0360955701f94e29d3">evolutionTimes</a>(),
                                           exerciseStrategy.exerciseTimes());
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s &lt; isExerciseTime.size(); ++s) {
                                <span class="keywordflow">if</span> (isExerciseTime[s]) {
                                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> iFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+s);
                                    boost::shared_ptr&lt;MarketModelEvolver&gt; e =
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                        numeraires,
                                        iFactory,
                                        evolvers[i],
                                        s);
                                    innerEvolvers.push_back(e);
                                }
                            }

                            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver-&gt;numeraires().front();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];

                            <a class="code" href="class_quant_lib_1_1_upper_bound_engine.html" title="Market-model engine for upper-bound estimation.">UpperBoundEngine</a> uEngine(evolver, innerEvolvers,
                                receiverSwap, nullRebate,
                                receiverSwap, nullRebate,
                                exerciseStrategy,
                                initialNumeraireValue);
                            <a class="code" href="class_quant_lib_1_1_generic_risk_statistics.html" title="empirical-distribution risk measures">Statistics</a> uStats;
                            uEngine.multiplePathValues(uStats,255,256);
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta = uStats.mean();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaError = uStats.errorEstimate();
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    upper bound delta: &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(delta) &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(deltaError));

                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="adf706701406e0987f7b155ea1943e8ee"></a><!-- doxytag: member="MarketModelTest::testCallableSwapNaif" ref="adf706701406e0987f7b155ea1943e8ee" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#adf706701406e0987f7b155ea1943e8ee">MarketModelTest::testCallableSwapNaif</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01429">1429</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Balland</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00671">anonymous_namespace{marketmodel.cpp}::checkCallableSwap()</a>, <a class="el" href="sobolbrowniangenerator_8hpp_source.html#l00044">QuantLib::SobolBrownianGenerator::Diagonal</a>, <a class="el" href="callspecifiedmultiproduct_8cpp_source.html#l00093">QuantLib::CallSpecifiedMultiProduct::evolution()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00089">QuantLib::EvolutionDescription::evolutionTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Ipc</a>, <a class="el" href="ql_2models_2marketmodels_2utilities_8cpp_source.html#l00059">QuantLib::isInSubset()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00131">QuantLib::isInTerminalMeasure()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarketPlus</a>, <a class="el" href="upperboundengine_8cpp_source.html#l00170">QuantLib::UpperBoundEngine::multiplePathValues()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                           {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Pricing callable swap with naif exercise strategy in a LIBOR market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> fixedRate = 0.04;

    <span class="comment">// 0. a payer swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> payerSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">true</span>);

    <span class="comment">// 1. the equivalent receiver swap</span>
    <a class="code" href="class_quant_lib_1_1_multi_step_swap.html">MultiStepSwap</a> receiverSwap(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        fixedRate, <span class="keyword">false</span>);

    <span class="comment">//exercise schedule</span>
    std::vector&lt;Rate&gt; exerciseTimes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    exerciseTimes.pop_back();
    <span class="comment">//std::vector&lt;Rate&gt; exerciseTimes;</span>
    <span class="comment">//for (Size i=2; i&lt;rateTimes.size()-1; i+=2)</span>
    <span class="comment">//    exerciseTimes.push_back(rateTimes[i]);</span>

    <span class="comment">// naif exercise strategy</span>
    std::vector&lt;Rate&gt; swapTriggers(exerciseTimes.size(), fixedRate);
    <a class="code" href="class_quant_lib_1_1_swap_rate_trigger.html">SwapRateTrigger</a> naifStrategy(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, swapTriggers, exerciseTimes);

    <span class="comment">// Longstaff-Schwartz exercise strategy</span>
    std::vector&lt;std::vector&lt;NodeData&gt; &gt; collectedData;
    std::vector&lt;std::vector&lt;Real&gt; &gt; basisCoefficients;
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> control(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    <a class="code" href="class_quant_lib_1_1_swap_basis_system.html">SwapBasisSystem</a> basisSystem(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,exerciseTimes);
    <a class="code" href="class_quant_lib_1_1_nothing_exercise_value.html">NothingExerciseValue</a> nullRebate(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);

    <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> dummyProduct =
        <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(receiverSwap, naifStrategy,
        <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = dummyProduct.<a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html#ad31a93fbf18add8acaaede3f99c17bee">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 4, <span class="comment">// 8,</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <span class="comment">// Composite&#39;s ProductSuggested is the Terminal one</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <span class="comment">// ProductSuggested,</span>
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccba881adbb8f5cfcf5f0506a4a77ec91ee2">MoneyMarketPlus</a>
                    <span class="comment">// MoneyMarket,</span>
                    <span class="comment">// Terminal</span>
                };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(dummyProduct, measures[k]);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);


                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64ae1eec6d770cb5d78f54e7e962c0cb07c">Balland</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a023bafd223de3a53c27ebd77f7c08866">Ipc</a> };
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> stop =
                        <a class="code" href="namespace_quant_lib.html#ab6ef4e92ef66e91f3e04e6a7587fbfb3">isInTerminalMeasure</a>(evolution, numeraires) ? 0 : 1;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers)-stop; i++) {

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                            <span class="comment">//MTBrownianGeneratorFactory generatorFactory(seed_);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> generatorFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            <span class="comment">// use the naif strategy</span>

                            <span class="comment">// 2. bermudan swaption to enter into the payer swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> bermudanProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                <a class="code" href="class_quant_lib_1_1_multi_step_nothing.html">MultiStepNothing</a>(evolution),
                                naifStrategy, payerSwap);

                            <span class="comment">// 3. callable receiver swap</span>
                            <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a> callableProduct =
                                <a class="code" href="class_quant_lib_1_1_call_specified_multi_product.html">CallSpecifiedMultiProduct</a>(
                                receiverSwap, naifStrategy,
                                <a class="code" href="class_quant_lib_1_1_exercise_adapter.html">ExerciseAdapter</a>(nullRebate));

                            <span class="comment">// lower bound: evolve all 4 products togheter</span>
                            <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> allProducts;
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(payerSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(receiverSwap);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(bermudanProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(callableProduct);
                            allProducts.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, allProducts);
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a922dfa2427c416014fcc97a72564b47d">checkCallableSwap</a>(*stats, config.str());


                            <span class="comment">// upper bound</span>

                            <span class="comment">//MTBrownianGeneratorFactory uFactory(seed_+142);</span>
                            <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> uFactory(
                                SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+142);
                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                uFactory,
                                evolvers[i]);

                            std::vector&lt;boost::shared_ptr&lt;MarketModelEvolver&gt; &gt;
                                innerEvolvers;

                            std::valarray&lt;bool&gt; isExerciseTime =
                                <a class="code" href="namespace_quant_lib.html#a63702629fc8bcdc4fccada3763aac0d1">isInSubset</a>(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#acfce18fa0ad78b0360955701f94e29d3">evolutionTimes</a>(),
                                           naifStrategy.exerciseTimes());
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s &lt; isExerciseTime.size(); ++s) {
                                <span class="keywordflow">if</span> (isExerciseTime[s]) {
                                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> iFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>+s);
                                    boost::shared_ptr&lt;MarketModelEvolver&gt; e =
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                        numeraires,
                                        iFactory,
                                        evolvers[i],
                                        s);
                                    innerEvolvers.push_back(e);
                                }
                            }

                            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver-&gt;numeraires().front();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];

                            <a class="code" href="class_quant_lib_1_1_upper_bound_engine.html" title="Market-model engine for upper-bound estimation.">UpperBoundEngine</a> uEngine(evolver, innerEvolvers,
                                receiverSwap, nullRebate,
                                receiverSwap, nullRebate,
                                naifStrategy,
                                initialNumeraireValue);
                            <a class="code" href="class_quant_lib_1_1_generic_risk_statistics.html" title="empirical-distribution risk measures">Statistics</a> uStats;
                            uEngine.multiplePathValues(uStats,255,256);
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta = uStats.mean();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaError = uStats.errorEstimate();
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    upper bound delta: &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(delta) &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">io::rate</a>(deltaError));

                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a29a95ab71a7436f0ad341b2bd7b7f4b5"></a><!-- doxytag: member="MarketModelTest::testDriftCalculator" ref="a29a95ab71a7436f0ad341b2bd7b7f4b5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a29a95ab71a7436f0ad341b2bd7b7f4b5">MarketModelTest::testDriftCalculator</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04695">4695</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="lmmdriftcalculator_8cpp_source.html#l00088">QuantLib::LMMDriftCalculator::computePlain()</a>, <a class="el" href="lmmdriftcalculator_8cpp_source.html#l00115">QuantLib::LMMDriftCalculator::computeReduced()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00139">anonymous_namespace{marketmodel.cpp}::measureOffset_</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00168">QuantLib::moneyMarketPlusMeasure()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00116">QuantLib::io::ordinal()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                          {

    <span class="comment">// Test full factor drift equivalence between compute() and</span>
    <span class="comment">// computeReduced()</span>

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing drift calculation...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 1.0e-16;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size();
    std::vector&lt;Time&gt; evolutionTimes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.size()-1);
    std::copy(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.begin(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>.end()-1, evolutionTimes.begin());
    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,evolutionTimes);
    std::vector&lt;Real&gt; rateTaus = evolution.rateTaus();
    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespace_quant_lib.html#a2a9372579dbf6f4cf14a92ac2f4c9f6c">moneyMarketPlusMeasure</a>(evolution,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a83a2fbe6065bcd6ce4ff2816a4396435">measureOffset_</a>);
    std::vector&lt;Size&gt; alive = evolution.firstAliveRate();
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberOfSteps = evolutionTimes.size();
    std::vector&lt;Real&gt; drifts(numberOfSteps), driftsReduced(numberOfSteps);
    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a>};
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); ++k) {   <span class="comment">// loop over market models</span>
        <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
        boost::shared_ptr&lt;MarketModel&gt; marketModel =
            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[k]);
        std::vector&lt;Rate&gt; displacements = marketModel-&gt;displacements();
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;numberOfSteps; ++j) {     <span class="comment">// loop over steps</span>
            <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a>&amp; A = marketModel-&gt;pseudoRoot(j);
            <span class="comment">//BOOST_MESSAGE(io::ordinal(j+1) &lt;&lt; &quot; pseudoroot:\n&quot; &lt;&lt; A);</span>
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> inf = std::max(0,static_cast&lt;Integer&gt;(alive[j]));
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> h=inf; h&lt;numeraires.size(); ++h) {     <span class="comment">// loop over numeraires</span>
                <a class="code" href="class_quant_lib_1_1_l_m_m_drift_calculator.html" title="Drift computation for log-normal Libor market models.">LMMDriftCalculator</a> driftcalculator(A, displacements, rateTaus,
                    numeraires[h], alive[j]);
                driftcalculator.computePlain(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>, drifts);
                driftcalculator.computeReduced(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>,
                    driftsReduced);
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;drifts.size(); ++i) {
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = std::abs(driftsReduced[i]-drifts[i]);
                    <span class="keywordflow">if</span> (error&gt;tolerance)
                        BOOST_ERROR(<span class="stringliteral">&quot;MarketModel: &quot;</span> &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[k]) &lt;&lt;
                        <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(j+1) &lt;&lt; <span class="stringliteral">&quot; step, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(h+1) &lt;&lt; <span class="stringliteral">&quot; numeraire, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; <a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot; drift, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;\ndrift        =&quot;</span> &lt;&lt; drifts[i] &lt;&lt;
                        <span class="stringliteral">&quot;\ndriftReduced =&quot;</span> &lt;&lt; driftsReduced[i] &lt;&lt;
                        <span class="stringliteral">&quot;\n       error =&quot;</span> &lt;&lt; error &lt;&lt;
                        <span class="stringliteral">&quot;\n   tolerance =&quot;</span> &lt;&lt; tolerance);
                }
            }
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="afe0e2ad764c8617ab121712d675e2467"></a><!-- doxytag: member="MarketModelTest::testGreeks" ref="afe0e2ad764c8617ab121712d675e2467" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#afe0e2ad764c8617ab121712d675e2467">MarketModelTest::testGreeks</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01944">1944</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="sobolbrowniangenerator_8hpp_source.html#l00044">QuantLib::SobolBrownianGenerator::Diagonal</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="multiproductmultistep_8cpp_source.html#l00042">QuantLib::MultiProductMultiStep::evolution()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00089">QuantLib::EvolutionDescription::evolutionTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="proxygreekengine_8cpp_source.html#l00081">QuantLib::ProxyGreekEngine::multiplePathValues()</a>, <a class="el" href="multistepoptionlets_8hpp_source.html#l00065">QuantLib::MultiStepOptionlets::numberOfProducts()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00116">QuantLib::io::ordinal()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::paths_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, <a class="el" href="blackcalculator_8cpp_source.html#l00199">QuantLib::BlackCalculator::value()</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00135">anonymous_namespace{marketmodel.cpp}::volatilities</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                 {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing caplet greeks in a lognormal forward rate market model using partial proxy simulation...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; payoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        payoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <span class="comment">//PlainVanillaPayoff(Option::Call, todaysForwards[i]));</span>
            <a class="code" href="class_quant_lib_1_1_cash_or_nothing_payoff.html" title="Binary cash-or-nothing payoff.">CashOrNothingPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i], 0.01));
        displacedPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <span class="comment">//PlainVanillaPayoff(Option::Call, todaysForwards[i]+displacement));</span>
            <a class="code" href="class_quant_lib_1_1_cash_or_nothing_payoff.html" title="Binary cash-or-nothing payoff.">CashOrNothingPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>, 0.01));
    }

    <a class="code" href="class_quant_lib_1_1_multi_step_optionlets.html">MultiStepOptionlets</a> product(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, payoffs);

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product.evolution();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <span class="comment">// ExponentialCorrelationFlatVolatility,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 4, 8, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() };
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <span class="comment">//MoneyMarketPlus,</span>
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a><span class="comment">//,</span>
                    <span class="comment">//Terminal</span>
                };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                        <span class="comment">//MTBrownianGeneratorFactory generatorFactory(seed_);</span>
                        <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> generatorFactory(
                            SobolBrownianGenerator::Diagonal,
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                        <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                        boost::shared_ptr&lt;MarketModel&gt; marketModel =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                            marketModels[j]);

                        boost::shared_ptr&lt;MarketModelEvolver&gt; evolver(<span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(marketModel,
                            generatorFactory,
                            numeraires));
                        <a class="code" href="class_quant_lib_1_1_generic_sequence_statistics.html" title="Statistics analysis of N-dimensional (sequence) data.">SequenceStatisticsInc</a> stats(product.numberOfProducts());


                        std::vector&lt;Size&gt; startIndexOfConstraint;
                        std::vector&lt;Size&gt; endIndexOfConstraint;

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#acfce18fa0ad78b0360955701f94e29d3">evolutionTimes</a>().size(); ++i) {
                            startIndexOfConstraint.push_back(i);
                            endIndexOfConstraint.push_back(i+1);
                        }


                        std::vector&lt;
                            std::vector&lt;boost::shared_ptr&lt;ConstrainedEvolver&gt; &gt; &gt;
                            constrainedEvolvers;
                        std::vector&lt;std::vector&lt;std::vector&lt;Real&gt; &gt; &gt; diffWeights;
                        std::vector&lt;std::vector&lt;SequenceStatisticsInc&gt; &gt; greekStats;

                        std::vector&lt;boost::shared_ptr&lt;ConstrainedEvolver&gt; &gt;
                            deltaGammaEvolvers;
                        std::vector&lt;std::vector&lt;Real&gt; &gt; deltaGammaWeights(
                            2, std::vector&lt;Real&gt;(3));
                        std::vector&lt;SequenceStatisticsInc&gt; deltaGammaStats(2,stats);


                        <a class="code" href="namespace_quant_lib.html#ad61d2e1a3f01154233de0d5fbb85177c" title="spreads on interest rates">Spread</a> forwardBump = 1.0e-6;
                        marketModel =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                            marketModels[j], -forwardBump);
                        deltaGammaEvolvers.push_back(
                            boost::shared_ptr&lt;ConstrainedEvolver&gt;(<span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler_constrained.html" title="euler stepping">LogNormalFwdRateEulerConstrained</a>(marketModel,
                            generatorFactory,
                            numeraires)));
                        deltaGammaEvolvers.back()-&gt;setConstraintType(
                            startIndexOfConstraint, endIndexOfConstraint);
                        marketModel =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                            marketModels[j], forwardBump);
                        deltaGammaEvolvers.push_back(
                            boost::shared_ptr&lt;ConstrainedEvolver&gt;(<span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler_constrained.html" title="euler stepping">LogNormalFwdRateEulerConstrained</a>(marketModel,
                            generatorFactory,
                            numeraires)));
                        deltaGammaEvolvers.back()-&gt;setConstraintType(
                            startIndexOfConstraint, endIndexOfConstraint);

                        deltaGammaWeights[0][0] = 0.0;
                        deltaGammaWeights[0][1] = -1.0/(2.0*forwardBump);
                        deltaGammaWeights[0][2] = 1.0/(2.0*forwardBump);

                        deltaGammaWeights[1][0] = -2.0/(forwardBump*forwardBump);
                        deltaGammaWeights[1][1] = 1.0/(forwardBump*forwardBump);
                        deltaGammaWeights[1][2] = 1.0/(forwardBump*forwardBump);


                        std::vector&lt;boost::shared_ptr&lt;ConstrainedEvolver&gt; &gt;
                            vegaEvolvers;
                        std::vector&lt;std::vector&lt;Real&gt; &gt; vegaWeights(
                            1, std::vector&lt;Real&gt;(3));
                        std::vector&lt;SequenceStatisticsInc&gt; vegaStats(1,stats);

                        <a class="code" href="namespace_quant_lib.html#ae3abfa256de5aa2b506ab6bda014e4dc" title="volatility">Volatility</a> volBump = 1.0e-4;
                        marketModel =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                            marketModels[j], 0.0, -volBump);
                        vegaEvolvers.push_back(
                            boost::shared_ptr&lt;ConstrainedEvolver&gt;(<span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler_constrained.html" title="euler stepping">LogNormalFwdRateEulerConstrained</a>(marketModel,
                            generatorFactory,
                            numeraires)));
                        vegaEvolvers.back()-&gt;setConstraintType(
                            startIndexOfConstraint, endIndexOfConstraint);
                        marketModel =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                            marketModels[j], 0.0, volBump);
                        vegaEvolvers.push_back(
                            boost::shared_ptr&lt;ConstrainedEvolver&gt;(<span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler_constrained.html" title="euler stepping">LogNormalFwdRateEulerConstrained</a>(marketModel,
                            generatorFactory,
                            numeraires)));
                        vegaEvolvers.back()-&gt;setConstraintType(
                            startIndexOfConstraint, endIndexOfConstraint);

                        vegaWeights[0][0] = 0.0;
                        vegaWeights[0][1] = -1.0/(2.0*volBump);
                        vegaWeights[0][2] = 1.0/(2.0*volBump);



                        constrainedEvolvers.push_back(deltaGammaEvolvers);
                        diffWeights.push_back(deltaGammaWeights);
                        greekStats.push_back(deltaGammaStats);

                        constrainedEvolvers.push_back(vegaEvolvers);
                        diffWeights.push_back(vegaWeights);
                        greekStats.push_back(vegaStats);

                        std::ostringstream config;
                        config &lt;&lt;
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                            factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                            <span class="stringliteral">&quot;MT BGF&quot;</span>;
                        <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                            BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver-&gt;numeraires().front();
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];

                        <a class="code" href="class_quant_lib_1_1_proxy_greek_engine.html">ProxyGreekEngine</a> <a class="code" href="class_quant_lib_1_1engine.html">engine</a>(evolver,
                            constrainedEvolvers, diffWeights,
                            startIndexOfConstraint,
                            endIndexOfConstraint,
                            product,
                            initialNumeraireValue);

                        <a class="code" href="class_quant_lib_1_1engine.html">engine</a>.multiplePathValues(stats, greekStats, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc967feecd2831cf784e1ee7561915c8">paths_</a>);

                        std::vector&lt;Real&gt; values = stats.mean();
                        std::vector&lt;Real&gt; errors = stats.errorEstimate();
                        std::vector&lt;Real&gt; deltas = greekStats[0][0].mean();
                        std::vector&lt;Real&gt; deltaErrors = greekStats[0][0].errorEstimate();
                        std::vector&lt;Real&gt; gammas = greekStats[0][1].mean();
                        std::vector&lt;Real&gt; gammaErrors = greekStats[0][1].errorEstimate();
                        std::vector&lt;Real&gt; vegas = greekStats[1][0].mean();
                        std::vector&lt;Real&gt; vegaErrors = greekStats[1][0].errorEstimate();

                        std::vector&lt;DiscountFactor&gt; discPlus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]);
                        std::vector&lt;DiscountFactor&gt; discMinus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]);
                        std::vector&lt;Rate&gt; fwdPlus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                        std::vector&lt;Rate&gt; fwdMinus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                        std::vector&lt;Rate&gt; pricePlus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                        std::vector&lt;Rate&gt; price0(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                        std::vector&lt;Rate&gt; priceMinus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
                            <a class="code" href="class_time.html">Time</a> tau = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i];
                            fwdPlus[i]=<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+forwardBump;
                            fwdMinus[i]=<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]-forwardBump;
                            discPlus[i+1]=discPlus[i]/(1.0+fwdPlus[i]*tau);
                            discMinus[i+1]=discMinus[i]/(1.0+fwdMinus[i]*tau);
                            pricePlus[i]=<a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[i], fwdPlus[i],
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[i]*sqrt(rateTimes[i]),
                                discPlus[i+1]*tau).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();
                            price0[i]=<a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[i], <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i],
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[i]*sqrt(rateTimes[i]),
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1]*tau).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();
                            priceMinus[i]=<a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[i], fwdMinus[i],
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[i]*sqrt(rateTimes[i]),
                                discMinus[i+1]*tau).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();
                        }

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;product.numberOfProducts(); ++i) {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numDelta = (pricePlus[i]-priceMinus[i])/(2.0*forwardBump);
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numGamma = (pricePlus[i]-2*price0[i]+priceMinus[i])/(forwardBump*forwardBump);
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>) {
                                BOOST_MESSAGE(<a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot; caplet: &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;value = &quot;</span> &lt;&lt; price0[i] &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;delta = &quot;</span> &lt;&lt; numDelta &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;gamma = &quot;</span> &lt;&lt; numGamma);
                                BOOST_MESSAGE(<a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot; caplet: &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;value = &quot;</span> &lt;&lt; values[i]
                                &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; errors[i]
                                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; (values[i]-price0[i])/errors[i] &lt;&lt; <span class="stringliteral">&quot; s.e.), &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;delta = &quot;</span> &lt;&lt; deltas[i]
                                &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; deltaErrors[i]
                                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; (deltas[i]-numDelta)/deltaErrors[i] &lt;&lt; <span class="stringliteral">&quot; s.e.), &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;gamma = &quot;</span> &lt;&lt; gammas[i]
                                &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; gammaErrors[i]
                                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; (gammas[i]-numGamma)/gammaErrors[i] &lt;&lt; <span class="stringliteral">&quot; s.e.), &quot;</span>
                                    &lt;&lt; <span class="stringliteral">&quot;vega = &quot;</span> &lt;&lt; vegas[i]
                                &lt;&lt; <span class="stringliteral">&quot; +- &quot;</span> &lt;&lt; vegaErrors[i]);
                            }
                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a75b0b2c359cccfd08c8168b6415b1042"></a><!-- doxytag: member="MarketModelTest::testInverseFloater" ref="a75b0b2c359cccfd08c8168b6415b1042" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a75b0b2c359cccfd08c8168b6415b1042">MarketModelTest::testInverseFloater</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00902">902</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="blackformula_8cpp_source.html#l00045">QuantLib::blackFormula()</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00028">QuantLib::MarketModelComposite::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="option_8hpp_source.html#l00038">QuantLib::Option::Put</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">{

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing exact repricing of &quot;</span>
        <span class="stringliteral">&quot;inverse floater &quot;</span>
        <span class="stringliteral">&quot;in forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();


    std::vector&lt;Real&gt; fixedStrikes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(), 0.1);
    std::vector&lt;Real&gt; fixedMultipliers(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(), 2.0);
    std::vector&lt;Real&gt; floatingSpreads(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(), 0.002);
    std::vector&lt;Real&gt; fixedAccruals(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>);
    std::vector&lt;Real&gt; floatingAccruals(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>);

    <span class="keywordtype">bool</span> payer = <span class="keyword">true</span>;


    <a class="code" href="class_quant_lib_1_1_multi_step_inverse_floater.html">MultiStepInverseFloater</a> product(
                                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,
                                                        fixedAccruals,
                                                         floatingAccruals,
                                                        fixedStrikes,
                                                        fixedMultipliers, 
                                                        floatingSpreads,
                                                         <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
                                                         payer);

       <a class="code" href="class_quant_lib_1_1_market_model_pathwise_inverse_floater.html">MarketModelPathwiseInverseFloater</a> productPathwise(
                                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,
                                                        fixedAccruals,
                                                         floatingAccruals,
                                                        fixedStrikes,
                                                        fixedMultipliers, 
                                                        floatingSpreads,
                                                         <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
                                                         payer);

       <a class="code" href="class_quant_lib_1_1_multi_product_pathwise_wrapper.html">MultiProductPathwiseWrapper</a> productWrapped(productPathwise);

       <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> productComposite;
       productComposite.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(product);
       productComposite.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(productWrapped);
       productComposite.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

   

    
    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = productComposite.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a0b45c01fcb6e82de5eb951ccccd9aece">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
        {

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(),3)};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) 
            {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>};
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) 
                {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">false</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);

                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = {<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>};
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
        
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers); i++)
                    {

                      
                            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);
                            <span class="comment">//SobolBrownianGeneratorFactory generatorFactory(</span>
                            <span class="comment">//    SobolBrownianGenerator::Diagonal, seed_);</span>

                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, productComposite);

                            std::vector&lt;Real&gt; modelVolatilities(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size());
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt;  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(); ++i)
                                    modelVolatilities[i] = sqrt(marketModel-&gt;totalCovariance(i)[i][i]);
                           


                             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> truePrice =0.0;

                             <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(); ++i)
                             {
                                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> floatingCouponPV = floatingAccruals[i] *(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+floatingSpreads[i])*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1];
                                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> inverseCouponPV =  2*fixedAccruals[i] *<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1]* <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(Option::Put,
                                        fixedStrikes[i]/2.0,
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i],
                                        modelVolatilities[i]);

                                        truePrice += floatingCouponPV - inverseCouponPV;
                              }

                                           
    


                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceError = stats-&gt;mean()[0] - truePrice;
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceSD = stats-&gt;errorEstimate()[0];

                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorInSds = priceError/priceSD;
                            <span class="keywordflow">if</span> (fabs(errorInSds) &gt; 4.0)
                                BOOST_FAIL(<span class="stringliteral">&quot;Inverse floater product has price error equal to &quot;</span> &lt;&lt;errorInSds &lt;&lt; <span class="stringliteral">&quot; sds . Price &quot;</span> &lt;&lt;truePrice &lt;&lt; <span class="stringliteral">&quot; MC price &quot;</span> &lt;&lt; stats-&gt;mean()[0] &lt;&lt;  <span class="stringliteral">&quot; \n&quot;</span> );

                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numericalTolerance = 1E-12;

                            <span class="keywordflow">if</span> (fabs(stats-&gt;mean()[0] - stats-&gt;mean()[1]) &gt; numericalTolerance)
                                BOOST_FAIL(<span class="stringliteral">&quot;Inverse floater and wrapper pathwise inverse floater do not agree:&quot;</span> &lt;&lt; stats-&gt;mean()[0]  &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; stats-&gt;mean()[1] );
                       



                        
                    } <span class="comment">// evolvers</span>
                } <span class="comment">// measures</span>
            } <span class="comment">// factors </span>
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a57480798c0dbcb9eecd665dc6d372ea2"></a><!-- doxytag: member="MarketModelTest::testIsInSubset" ref="a57480798c0dbcb9eecd665dc6d372ea2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a57480798c0dbcb9eecd665dc6d372ea2">MarketModelTest::testIsInSubset</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04750">4750</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="ql_2models_2marketmodels_2utilities_8cpp_source.html#l00059">QuantLib::isInSubset()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00116">QuantLib::io::ordinal()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, and <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>.</p>
<div class="fragment"><pre class="fragment">                                     {

    <span class="comment">// Performance test for isInSubset function (temporary)</span>

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing isInSubset...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> dim = 100;
    std::vector&lt;Time&gt; <span class="keyword">set</span>, subset;
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;dim; i++) <span class="keyword">set</span>.push_back(i*1.0);
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;dim; i++) subset.push_back(dim+i*1.0);
    std::valarray&lt;bool&gt; result = <a class="code" href="namespace_quant_lib.html#a63702629fc8bcdc4fccada3763aac0d1">isInSubset</a>(<span class="keyword">set</span>, subset);
    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>) {
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;dim; i++) {
            BOOST_MESSAGE(<a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt;
                <span class="stringliteral">&quot; set[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] =  &quot;</span> &lt;&lt; <span class="keyword">set</span>[i] &lt;&lt;
                <span class="stringliteral">&quot;, subset[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] =  &quot;</span> &lt;&lt; subset[i] &lt;&lt;
                <span class="stringliteral">&quot;, result[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] =  &quot;</span> &lt;&lt; result[i]);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5b3ddc9f21d25a8aa7c534fd33541280"></a><!-- doxytag: member="MarketModelTest::testOneStepForwardsAndOptionlets" ref="a5b3ddc9f21d25a8aa7c534fd33541280" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a5b3ddc9f21d25a8aa7c534fd33541280">MarketModelTest::testOneStepForwardsAndOptionlets</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00718">718</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Balland</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00536">anonymous_namespace{marketmodel.cpp}::checkForwardsAndOptionlets()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00028">QuantLib::MarketModelComposite::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Ipc</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00131">QuantLib::isInTerminalMeasure()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00369">anonymous_namespace{marketmodel.cpp}::Terminal</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                                       {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing exact repricing of &quot;</span>
        <span class="stringliteral">&quot;one-step forwards and optionlets &quot;</span>
        <span class="stringliteral">&quot;in a lognormal forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    std::vector&lt;Rate&gt; forwardStrikes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; optionletPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        forwardStrikes[i] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i] + 0.01;
        optionletPayoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]));
        displacedPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
    }

    <a class="code" href="class_quant_lib_1_1_one_step_forwards.html">OneStepForwards</a> forwards(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, forwardStrikes);
    <a class="code" href="class_quant_lib_1_1_one_step_optionlets.html">OneStepOptionlets</a> optionlets(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, optionletPayoffs);

    <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> product;
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(forwards);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(optionlets);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a0b45c01fcb6e82de5eb951ccccd9aece">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <span class="comment">// one step must be always full factors</span>
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <span class="comment">// for one step product ProductSuggested is equal to Terminal</span>
                <span class="comment">// for one step product MoneyMarketPlus is equal to Terminal</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>,
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccba6f28481dc98c0a4bb1c59693c180de71">Terminal</a> };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);

                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>,  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64ae1eec6d770cb5d78f54e7e962c0cb07c">Balland</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a023bafd223de3a53c27ebd77f7c08866">Ipc</a>};
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> stop =
                        <a class="code" href="namespace_quant_lib.html#ab6ef4e92ef66e91f3e04e6a7587fbfb3">isInTerminalMeasure</a>(evolution, numeraires) ? 0 : 1;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers)-stop; i++) {

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);
                            <span class="comment">//SobolBrownianGeneratorFactory generatorFactory(</span>
                            <span class="comment">//    SobolBrownianGenerator::Diagonal, seed_);</span>

                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, product);
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aab36de8497e90377a59b5e20ac475d5e">checkForwardsAndOptionlets</a>(*stats,
                                forwardStrikes,
                                displacedPayoffs,
                                config.str());
                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7087c5803d8cfbb230430c68ead2c8e0"></a><!-- doxytag: member="MarketModelTest::testOneStepNormalForwardsAndOptionlets" ref="a7087c5803d8cfbb230430c68ead2c8e0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a7087c5803d8cfbb230430c68ead2c8e0">MarketModelTest::testOneStepNormalForwardsAndOptionlets</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00810">810</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00604">anonymous_namespace{marketmodel.cpp}::checkNormalForwardsAndOptionlets()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00028">QuantLib::MarketModelComposite::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00434">anonymous_namespace{marketmodel.cpp}::evolverTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00131">QuantLib::isInTerminalMeasure()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::NormalPc</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00369">anonymous_namespace{marketmodel.cpp}::Terminal</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                                             {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing exact repricing of &quot;</span>
        <span class="stringliteral">&quot;one-step forwards and optionlets &quot;</span>
        <span class="stringliteral">&quot;in a normal forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    std::vector&lt;Rate&gt; forwardStrikes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; optionletPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;PlainVanillaPayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        forwardStrikes[i] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i] + 0.01;
        optionletPayoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]));
        displacedPayoffs[i] = boost::shared_ptr&lt;PlainVanillaPayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
    }

    <a class="code" href="class_quant_lib_1_1_one_step_forwards.html">OneStepForwards</a> forwards(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, forwardStrikes);
    <a class="code" href="class_quant_lib_1_1_one_step_optionlets.html">OneStepOptionlets</a> optionlets(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, optionletPayoffs);

    <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> product;
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(forwards);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(optionlets);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a0b45c01fcb6e82de5eb951ccccd9aece">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
        <span class="comment">// CalibratedMM,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++) {

            <span class="comment">// one step must be always full factors</span>
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                <span class="comment">// for one step product ProductSuggested is equal to Terminal</span>
                <span class="comment">// for one step product MoneyMarketPlus is equal to Terminal</span>
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>,
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccba6f28481dc98c0a4bb1c59693c180de71">Terminal</a> };
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++) {
                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">false</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);

                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64">EvolverType</a> evolvers[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64ad13d95f650b775c3aaab115429c20e1b">NormalPc</a>};
                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver;
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> stop =
                        <a class="code" href="namespace_quant_lib.html#ab6ef4e92ef66e91f3e04e6a7587fbfb3">isInTerminalMeasure</a>(evolution, numeraires) ? 0 : 1;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(evolvers)-stop; i++) {

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++) {
                            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);
                            <span class="comment">//SobolBrownianGeneratorFactory generatorFactory(</span>
                            <span class="comment">//    SobolBrownianGenerator::Diagonal, seed_);</span>

                            evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(marketModel,
                                numeraires,
                                generatorFactory,
                                evolvers[i]);
                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae946444a99efd75bce983a98b8001ddf">evolverTypeToString</a>(evolvers[i]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, product);
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a94ad520db540b22be565273db5356d3f">checkNormalForwardsAndOptionlets</a>(*stats,
                                forwardStrikes,
                                displacedPayoffs,
                                config.str());
                        }
                    }
                }
            }
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="af6389ab8bba26c145d096be06d240ee5"></a><!-- doxytag: member="MarketModelTest::testPathwiseGreeks" ref="af6389ab8bba26c145d096be06d240ee5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#af6389ab8bba26c145d096be06d240ee5">MarketModelTest::testPathwiseGreeks</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l02183">2183</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00095">QuantLib::MarketModelPathwiseMultiCaplet::clone()</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00242">QuantLib::MarketModelPathwiseMultiDeflatedCaplet::clone()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="class_quant_lib_1_1_generic_sequence_statistics.html#aff9a45944f282051d51070584bd6f7b7">QuantLib::GenericSequenceStatistics&lt; StatisticsType &gt;::errorEstimate()</a>, <a class="el" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a5502f151b42b5a85e50213e0379cea36">QuantLib::MarketModelPathwiseMultiProduct::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="class_quant_lib_1_1_generic_sequence_statistics.html#ae3daaad97b7f821af0ec3f1ddb2aba36">QuantLib::GenericSequenceStatistics&lt; StatisticsType &gt;::mean()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="pathwiseaccountingengine_8cpp_source.html#l00312">QuantLib::PathwiseAccountingEngine::multiplePathValues()</a>, <a class="el" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">QuantLib::MarketModelPathwiseMultiProduct::numberOfProducts()</a>, <a class="el" href="lognormalfwdrateeuler_8cpp_source.html#l00077">QuantLib::LogNormalFwdRateEuler::numeraires()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::paths_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, <a class="el" href="blackcalculator_8cpp_source.html#l00199">QuantLib::BlackCalculator::value()</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00135">anonymous_namespace{marketmodel.cpp}::volatilities</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">{

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing caplet deltas in a lognormal forward rate market model using pathwise method...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();



    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; payoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        payoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]));
        <span class="comment">//CashOrNothingPayoff(Option::Call, todaysForwards[i], 0.01));</span>
        displacedPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
        <span class="comment">//CashOrNothingPayoff(Option::Call, todaysForwards[i]+displacement, 0.01));</span>
    }

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> whichProduct=0; whichProduct&lt;2; ++whichProduct)
    {
        <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_deflated_caplet.html">MarketModelPathwiseMultiDeflatedCaplet</a> product1(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);

        <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_caplet.html" title="market-model pathwise caplet">MarketModelPathwiseMultiCaplet</a> product2(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);

        std::auto_ptr&lt;MarketModelPathwiseMultiProduct&gt; product;

        <span class="keywordflow">if</span> (whichProduct == 0)
            product = product2.clone();
        <span class="keywordflow">else</span>
            product = product1.clone();


        <a class="code" href="class_quant_lib_1_1_multi_step_optionlets.html">MultiStepOptionlets</a> productDummy(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, payoffs);



        <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a5502f151b42b5a85e50213e0379cea36">evolution</a>();

        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] = {
            <span class="comment">// CalibratedMM,</span>
            <span class="comment">// ExponentialCorrelationFlatVolatility,</span>
            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a> };

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
            {

                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 2
                    <span class="comment">//, 4, 8, todaysForwards.size()</span>
                };

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
                {
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = {
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>
                    };

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++)
                    {
                        std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(productDummy, measures[k]);

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++)
                        {
                            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                                marketModels[j]);

                            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                                generatorFactory,
                                numeraires);
                            <a class="code" href="class_quant_lib_1_1_generic_sequence_statistics.html" title="Statistics analysis of N-dimensional (sequence) data.">SequenceStatisticsInc</a> stats(product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1));







                            <a class="code" href="namespace_quant_lib.html#ad61d2e1a3f01154233de0d5fbb85177c" title="spreads on interest rates">Spread</a> forwardBump = 1.0e-6;

                            std::ostringstream config;
                            config &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                                <span class="stringliteral">&quot;MT BGF&quot;</span>;
                            <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver.numeraires().front();
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];



                            {

                                <a class="code" href="class_quant_lib_1_1_pathwise_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseAccountingEngine</a> accountingengine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)), <span class="comment">// method relies heavily on LMM Euler</span>
                                    *product,
                                    marketModel, <span class="comment">// we need pseudo-roots and displacements</span>
                                    initialNumeraireValue);



                                accountingengine.multiplePathValues(stats,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc967feecd2831cf784e1ee7561915c8">paths_</a>);
                            }


                            std::vector&lt;Real&gt; valuesAndDeltas = stats.mean();
                            std::vector&lt;Real&gt; errors = stats.errorEstimate();

                            std::vector&lt;Real&gt; prices(product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());
                            std::vector&lt;Real&gt; priceErrors(product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());

                            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltas( product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltasErrors( product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                            std::vector&lt;Real&gt; modelPrices(product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());


                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(); ++i)
                            {
                                prices[i] = valuesAndDeltas[i];

                                priceErrors[i] = errors[i];

                                modelPrices[i] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[i], <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i],
                                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[i]*sqrt(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i]),
                                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1]*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i])).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();


                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++j)
                                {
                                    deltas[i][j] = valuesAndDeltas[(i+1)*product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()+j];
                                    deltasErrors[i][j]  = errors[(i+1)* product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()+j];

                                }

                            }

                            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> modelDeltas(product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());


                            std::vector&lt;DiscountFactor&gt; discPlus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]);
                            std::vector&lt;DiscountFactor&gt; discMinus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]);
                            std::vector&lt;Rate&gt; fwdPlus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                            std::vector&lt;Rate&gt; fwdMinus(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());


                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i)
                            {
                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++j)
                                {
                                    <span class="keywordflow">if</span> (i != j)
                                    {
                                        fwdPlus[j] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[j];
                                        fwdMinus[j] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[j];

                                    }
                                    <span class="keywordflow">else</span>
                                    {
                                        fwdPlus[j] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[j]+forwardBump;
                                        fwdMinus[j] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[j]-forwardBump;
                                    }

                                    <a class="code" href="class_time.html">Time</a> tau = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[j+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[j];
                                    discPlus[j+1]=discPlus[j]/(1.0+fwdPlus[j]*tau);
                                    discMinus[j+1]=discMinus[j]/(1.0+fwdMinus[j]*tau);

                                }

                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k  &lt; product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(); ++k)
                                {
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tau = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[k+1] - <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[k];
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceUp = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[k], fwdPlus[k],
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[k]*sqrt(rateTimes[k]),
                                        discPlus[k+1]*tau).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceDown = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[k], fwdMinus[k],
                                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[k]*sqrt(rateTimes[k]),
                                        discMinus[k+1]*tau).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();

                                    modelDeltas[k][i] = (priceUp-priceDown)/(2*forwardBump);

                                }
                            }


                            <a class="code" href="namespace_quant_lib.html#a8ac1a45a37d8d3dda438a2e59e222620" title="integer number">Integer</a> numberErrors =0;

                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;product-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(); ++i)
                            {

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisPrice = prices[i];
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisModelPrice =  modelPrices[i];
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceErrorInSds = ((thisPrice - thisModelPrice)/priceErrors[i]);

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorTheshold = 3.5;

                                <span class="keywordflow">if</span> (fabs(priceErrorInSds) &gt; errorTheshold)
                                {
                                    BOOST_MESSAGE(<span class="stringliteral">&quot;Caplet &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; price &quot;</span> &lt;&lt; prices[i] &lt;&lt; <span class="stringliteral">&quot; model price &quot;</span> &lt;&lt; modelPrices[i]
                                    &lt;&lt; <span class="stringliteral">&quot;   Standard error: &quot;</span> &lt;&lt;priceErrors[i] &lt;&lt; <span class="stringliteral">&quot; errors in sds: &quot;</span> &lt;&lt; priceErrorInSds);

                                    ++numberErrors;

                                }

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> threshold =1e-10;

                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j =0; j &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++j)
                                {
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> delta = deltas[i][j];
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> modelDelta = modelDeltas[i][j];

                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> deltaErrorInSds =100;

                                    <span class="keywordflow">if</span> (deltasErrors[i][j] &gt; 0.0)
                                        deltaErrorInSds = (( delta  - modelDelta )/deltasErrors[i][j]);
                                    <span class="keywordflow">else</span>
                                        <span class="keywordflow">if</span> (fabs(modelDelta -delta) &lt; threshold) <span class="comment">// to cope with zero over zero</span>
                                            deltaErrorInSds =0.0;

                                    <span class="keywordflow">if</span> (fabs(deltaErrorInSds) &gt; errorTheshold)
                                    {

                                        BOOST_MESSAGE(<span class="stringliteral">&quot;Caplet &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; delta &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot;has value &quot;</span> &lt;&lt; deltas[i][j] &lt;&lt; <span class="stringliteral">&quot; model value &quot;</span> &lt;&lt; modelDeltas[i][j]
                                        &lt;&lt; <span class="stringliteral">&quot;   Standard error: &quot;</span> &lt;&lt;deltasErrors[i][j] &lt;&lt; <span class="stringliteral">&quot; errors in sds: &quot;</span> &lt;&lt; deltaErrorInSds);

                                        ++numberErrors;
                                    }


                                }


                            }

                            <span class="keywordflow">if</span> (numberErrors &gt;0)
                                BOOST_FAIL(<span class="stringliteral">&quot;Pathwise greeks test has &quot;</span> &lt;&lt; numberErrors &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>);
                        }
                    }
                }
            }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9b93e5cb909d977d2a454a43ea784201"></a><!-- doxytag: member="MarketModelTest::testPathwiseMarketVegas" ref="a9b93e5cb909d977d2a454a43ea784201" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a9b93e5cb909d977d2a454a43ea784201">MarketModelTest::testPathwiseMarketVegas</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l03647">3647</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="blackformula_8cpp_source.html#l00297">QuantLib::blackFormulaVolDerivative()</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00111">QuantLib::LMMCurveState::coterminalSwapAnnuity()</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00138">QuantLib::LMMCurveState::coterminalSwapRate()</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00182">QuantLib::LMMCurveState::coterminalSwapRates()</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00098">QuantLib::LMMCurveState::discountRatio()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00045">QuantLib::VolatilityBumpInstrumentJacobian::Cap::endIndex_</a>, <a class="el" href="multiproductmultistep_8cpp_source.html#l00042">QuantLib::MultiProductMultiStep::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00177">QuantLib::LMMCurveState::forwardRates()</a>, <a class="el" href="bumpinstrumentjacobian_8cpp_source.html#l00156">QuantLib::OrthogonalizedBumpFinder::GetVegaBumps()</a>, <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00378">QuantLib::CapPseudoDerivative::impliedVolatility()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="pathwiseaccountingengine_8cpp_source.html#l00681">QuantLib::PathwiseVegasAccountingEngine::multiplePathValues()</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00329">QuantLib::MarketModelPathwiseMultiDeflatedCap::numberOfProducts()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00109">QuantLib::EvolutionDescription::numberOfSteps()</a>, <a class="el" href="lognormalfwdrateeuler_8cpp_source.html#l00077">QuantLib::LogNormalFwdRateEuler::numeraires()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::paths_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="sparsematrix_8hpp_source.html#l00047">QuantLib::prod()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00041">QuantLib::LMMCurveState::setOnForwardRates()</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00044">QuantLib::VolatilityBumpInstrumentJacobian::Cap::startIndex_</a>, <a class="el" href="lognormalfwdrateeuler_8cpp_source.html#l00095">QuantLib::LogNormalFwdRateEuler::startNewPath()</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00046">QuantLib::VolatilityBumpInstrumentJacobian::Cap::strike_</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00313">QuantLib::MarketModelPathwiseMultiDeflatedCap::suggestedNumeraires()</a>, <a class="el" href="ql_2models_2marketmodels_2swapforwardmappings_8cpp_source.html#l00182">QuantLib::SwapForwardMappings::swaptionImpliedVolatility()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, <a class="el" href="test-suite_2gaussianquadratures_8cpp_source.html#l00032">anonymous_namespace{gaussianquadratures.cpp}::tolerance</a>, <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00136">QuantLib::SwaptionPseudoDerivative::volatilityDerivative()</a>, and <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00371">QuantLib::CapPseudoDerivative::volatilityDerivative()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">{

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing pathwise market vegas in a lognormal forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    <span class="comment">// specify collection of caps and swaptions and then see if their vegas are correct</span>
    <span class="comment">// starting by doing a set of co-terminal swaptions</span>
    <a class="code" href="class_quant_lib_1_1_l_m_m_curve_state.html" title="Curve state for Libor market models">LMMCurveState</a> cs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    cs.setOnForwardRates(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);

    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; payoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        payoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, cs.coterminalSwapRate(i)));

        displacedPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, cs.coterminalSwapRate(i)+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));

    }


    <a class="code" href="class_quant_lib_1_1_multi_step_optionlets.html">MultiStepOptionlets</a> dummyProduct(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, payoffs);

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> bumpSizeNumericalDifferentiation = 1E-6;

    <a class="code" href="class_quant_lib_1_1_market_model_pathwise_coterminal_swaptions_deflated.html">MarketModelPathwiseCoterminalSwaptionsDeflated</a> swaptionsDeflated(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, cs.coterminalSwapRates());
    <a class="code" href="class_quant_lib_1_1_market_model_pathwise_coterminal_swaptions_numerical_deflated.html">MarketModelPathwiseCoterminalSwaptionsNumericalDeflated</a> swaptionsDeflated2(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, cs.coterminalSwapRates(),bumpSizeNumericalDifferentiation);


    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = dummyProduct.evolution();
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> steps = evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>();
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberRates = evolution.numberOfRates();


    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> pathsToDo =10; <span class="comment">// for the numerical differentiation test we are requiring equality on each path so this is actually quite strict</span>
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> pathsToDoSimulation = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc967feecd2831cf784e1ee7561915c8">paths_</a>;

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> multiplier = 50; <span class="comment">// how many times the bump size squared, the numerical differentation is allowed to differ by</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02gaussianquadratures_8cpp_03.html#a0f4d3028fdc8cebd7d9c568c16754cab">tolerance</a> = 1E-6;

    <span class="comment">// printReport_ = true;</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =0.95;

    <span class="keywordtype">bool</span> allowFactorwiseBumping = <span class="keyword">true</span>;
    std::vector&lt;VolatilityBumpInstrumentJacobian::Cap&gt; caps;

    <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> capStrike = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[0];

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i +2 &lt; numberRates; i=i+3)
    {
        <a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html">VolatilityBumpInstrumentJacobian::Cap</a> nextCap;
        nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ac7a3a79be7ff382a3509a643170f0da9">startIndex_</a> = i;
        nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ae394b2a1655cab0c3cd40a556b08160f">endIndex_</a> = i+3;
        nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ac1a398af2da44bd18cfcbd53930f6ee9">strike_</a> = capStrike;
        caps.push_back(nextCap);
    }
    std::vector&lt;std::pair&lt;Size,Size&gt; &gt; startsAndEnds(caps.size());


    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; caps.size(); ++j)
    {
        startsAndEnds[j].first = caps[j].startIndex_;
        startsAndEnds[j].second = caps[j].endIndex_;


    }


    <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_deflated_cap.html">MarketModelPathwiseMultiDeflatedCap</a> capsDeflated(
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
        capStrike,
        startsAndEnds);



    std::vector&lt;VolatilityBumpInstrumentJacobian::Swaption&gt; swaptions(numberRates);

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; numberRates; ++i)
    {
        swaptions[i].startIndex_ = i;
        swaptions[i].endIndex_ = numberRates;

    }



    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] =
    {
        <span class="comment">// CalibratedMM,</span>
        <span class="comment">// ExponentialCorrelationFlatVolatility,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a>
    };
    <span class="comment">// test analytically first, it&#39;s faster!</span>

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(1UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
        };



        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];


            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);


            <span class="comment">// we need to work out our bumps</span>

            <a class="code" href="class_quant_lib_1_1_vega_bump_collection.html">VegaBumpCollection</a> possibleBumps(marketModel,
                allowFactorwiseBumping);

            <a class="code" href="class_quant_lib_1_1_orthogonalized_bump_finder.html">OrthogonalizedBumpFinder</a>  bumpFinder(possibleBumps,
                swaptions,
                caps,
                multiplier, <span class="comment">// if vector length grows by more than this discard</span>
                tolerance);      <span class="comment">// if vector projection before scaling less than this discard</span>
            std::vector&lt;std::vector&lt;Matrix&gt; &gt; theBumps;

            bumpFinder.GetVegaBumps(theBumps);

            <span class="comment">// the bumps is now the bumps required to get a one percent implied vol in each instrumnet</span>
            <span class="comment">// indexed by step, instrument, pseudo-root matrix</span>
            <span class="comment">// if we dot product with swaption derivatives, we should get a 1% change in imp vol on the diagonal</span>
            <span class="comment">// and zero off it</span>
            {
                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> swaptionVegasMatrix(swaptionsDeflated.numberOfProducts(), theBumps[0].size());

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptionsDeflated.numberOfProducts(); ++i)
                {
                    <a class="code" href="class_quant_lib_1_1_swaption_pseudo_derivative.html">SwaptionPseudoDerivative</a> thisPseudoDerivative(marketModel,
                        swaptions[i].startIndex_,
                        swaptions[i].endIndex_);


                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  theBumps[0].size(); ++j)
                    {
                        swaptionVegasMatrix[i][j] = 0;

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; steps; ++k)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; numberRates; ++l)
                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m &lt; factors; ++m)
                                    swaptionVegasMatrix[i][j] += theBumps[k][j][l][m]*thisPseudoDerivative.volatilityDerivative(k)[l][m];
                    }
                }

                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberDiagonalFailures = 0;
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> offDiagonalFailures=0;

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptions.size(); ++i)
                {
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  theBumps[0].size(); ++j)
                    {
                        <span class="keywordflow">if</span> (i == j)
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = swaptionVegasMatrix[i][i] - 0.01;

                            <span class="keywordflow">if</span> (fabs(thisError) &gt; 1e-8)
                                ++numberDiagonalFailures;
                        }
                        <span class="keywordflow">else</span>
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = swaptionVegasMatrix[i][j];
                            <span class="keywordflow">if</span> (fabs(thisError) &gt; 1e-8)
                                ++offDiagonalFailures;
                        }
                    }
                }

                <span class="keywordflow">if</span> (numberDiagonalFailures + offDiagonalFailures&gt;0 )
                    BOOST_FAIL(<span class="stringliteral">&quot;Pathwise market vega analytic test fails for  swaptions : &quot;</span> &lt;&lt; offDiagonalFailures &lt;&lt;<span class="stringliteral">&quot; off diagonal failures \n &quot;</span>
                    &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; numberDiagonalFailures &lt;&lt; <span class="stringliteral">&quot; on the diagonal.&quot;</span> );
            }
            <span class="comment">// now do the caps</span>

            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> capsVegasMatrix(caps.size(), theBumps[0].size());

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caps.size(); ++i)
            {
                <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> thisPseudoDerivative(marketModel,
                    caps[i].strike_,
                    caps[i].startIndex_,
                    caps[i].endIndex_, initialNumeraireValue
                    );


                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  theBumps[0].size(); ++j)
                {
                    capsVegasMatrix[i][j] = 0;

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; steps; ++k)
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; numberRates; ++l)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m &lt; factors; ++m)
                                capsVegasMatrix[i][j] += theBumps[k][j][l][m]*thisPseudoDerivative.volatilityDerivative(k)[l][m];
                }
            }

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberDiagonalFailures = 0;
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> offDiagonalFailures=0;

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caps.size(); ++i)
            {
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  theBumps[0].size(); ++j)
                {
                    <span class="keywordflow">if</span> (i +swaptions.size()== j)
                    {
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = capsVegasMatrix[i][j] - 0.01;

                        <span class="keywordflow">if</span> (fabs(thisError) &gt; 1e-8)
                            ++numberDiagonalFailures;
                    }
                    <span class="keywordflow">else</span>
                    {
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = capsVegasMatrix[i][j];
                        <span class="keywordflow">if</span> (fabs(thisError) &gt; 1e-8)
                            ++offDiagonalFailures;
                    }
                }
            }

            <span class="keywordflow">if</span> (numberDiagonalFailures + offDiagonalFailures&gt;0 )
                BOOST_FAIL(<span class="stringliteral">&quot;Pathwise market vega analytic test fails for caps : &quot;</span> &lt;&lt; offDiagonalFailures &lt;&lt;<span class="stringliteral">&quot; off diagonal failures \n &quot;</span>
                &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; numberDiagonalFailures &lt;&lt; <span class="stringliteral">&quot; on the diagonal.&quot;</span> );


        } <span class="comment">// end of  for (Size m=0; m&lt;LENGTH(testedFactors); ++m)</span>
    } <span class="comment">// end of   for (Size j=0; j&lt;LENGTH(marketModels); j++)</span>
<span class="comment"></span>    <span class="comment">// test numerically differentiated swaptions against analytically done ones</span>
    <span class="comment">// we require equality on very path so we don&#39;t need many paths</span>


    std::vector&lt;Size&gt; numberCashFlowsThisStep1(swaptionsDeflated.numberOfProducts());

    std::vector&lt;std::vector&lt;MarketModelPathwiseMultiProduct::CashFlow&gt; &gt; cashFlowsGenerated1(swaptionsDeflated.numberOfProducts());


    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptionsDeflated.numberOfProducts(); ++i)
    {
        cashFlowsGenerated1[i].resize(swaptionsDeflated.maxNumberOfCashFlowsPerProductPerStep());
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; swaptionsDeflated.maxNumberOfCashFlowsPerProductPerStep(); ++j)
            cashFlowsGenerated1[i][j].amount.resize(numberRates+1);
    }

    std::vector&lt;Size&gt; numberCashFlowsThisStep2(numberCashFlowsThisStep1);
    std::vector&lt;std::vector&lt;MarketModelPathwiseMultiProduct::CashFlow&gt; &gt;
        cashFlowsGenerated2(cashFlowsGenerated1);



    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(1UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
        };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver1(marketModel,
                generatorFactory,swaptionsDeflated.suggestedNumeraires()
                );

            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver2(marketModel,
                generatorFactory,swaptionsDeflated.suggestedNumeraires()
                );

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> p=0; p &lt; pathsToDo; ++p)
            {
                evolver1.<a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html#a7a4a3fda61741faea27d40e02bdc2142">startNewPath</a>();
                swaptionsDeflated.reset();
                evolver2.startNewPath();
                swaptionsDeflated2.reset();
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step =0;

                <span class="keywordtype">bool</span> done,done2;

                <span class="keywordflow">do</span>
                {
                    evolver1.advanceStep();
                    done = swaptionsDeflated.nextTimeStep(evolver1.currentState(),
                        numberCashFlowsThisStep1,
                        cashFlowsGenerated1);

                    evolver2.advanceStep();
                    done2 = swaptionsDeflated2.nextTimeStep(evolver2.currentState(),
                        numberCashFlowsThisStep2,
                        cashFlowsGenerated2);

                    <span class="keywordflow">if</span> (done != done2)
                        BOOST_FAIL(<span class="stringliteral">&quot;numerical swaptions derivative and swaptions disagree on termination&quot;</span>);

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a> = 0; <a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a> &lt;  swaptionsDeflated.numberOfProducts(); ++<a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a>)
                    {
                        <span class="keywordflow">if</span> (numberCashFlowsThisStep1[<a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a>] != numberCashFlowsThisStep2[<a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a>])
                            BOOST_FAIL(<span class="stringliteral">&quot;numerical swaptions derivative and swaptions disagree on number of cash flows&quot;</span>);

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> cf =0; cf &lt; numberCashFlowsThisStep1[<a class="code" href="namespace_quant_lib.html#a93815c1c29ab54eb3715c1605f54785e">prod</a>]; ++cf)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>=0; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>&lt;= numberRates; ++<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>)
                                <span class="keywordflow">if</span> ( fabs(cashFlowsGenerated1[prod][cf].amount[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>] -  cashFlowsGenerated2[prod][cf].amount[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>]) &gt; tolerance )
                                    BOOST_FAIL(<span class="stringliteral">&quot;numerical swaptions derivative and swaptions disagree on cash flow size. cf = &quot;</span> &lt;&lt; cf &lt;&lt;
                                    <span class="stringliteral">&quot;step &quot;</span> &lt;&lt; step &lt;&lt; <span class="stringliteral">&quot;, rate &quot;</span> &lt;&lt; rate &lt;&lt; <span class="stringliteral">&quot;, amount1 &quot;</span> &lt;&lt; cashFlowsGenerated1[prod][cf].amount[rate]
                                &lt;&lt; <span class="stringliteral">&quot; ,amount2 &quot;</span> &lt;&lt; cashFlowsGenerated2[prod][cf].amount[rate] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);





                    }

                    ++step;


                }
                <span class="keywordflow">while</span> (!done);



            }


        } <span class="comment">// end of  for (Size m=0; m&lt;LENGTH(testedFactors); ++m)</span>
    } <span class="comment">// end of   for (Size j=0; j&lt;LENGTH(marketModels); j++)</span>


    <span class="comment">// now time for the full simulation test</span>
    <span class="comment">// measure vega of each swaption with respect to itself, the other swaptions and the caps</span>
    <span class="comment">// should get 0.01 and 0 respectively.</span>
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(1UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
        };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                generatorFactory,swaptionsDeflated.suggestedNumeraires()
                );

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver.<a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html#afdba5eb0abcdb218358a9e3a1fb8dba4">numeraires</a>().front();
            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];


            <span class="comment">// we need to work out our bumps</span>

            <a class="code" href="class_quant_lib_1_1_vega_bump_collection.html">VegaBumpCollection</a> possibleBumps(marketModel,
                allowFactorwiseBumping);


            <a class="code" href="class_quant_lib_1_1_orthogonalized_bump_finder.html">OrthogonalizedBumpFinder</a>  bumpFinder(possibleBumps,
                swaptions,
                caps,
                multiplier, <span class="comment">// if vector length grows by more than this discard</span>
                tolerance);      <span class="comment">// if vector projection before scaling less than this discard</span>
            std::vector&lt;std::vector&lt;Matrix&gt; &gt; theBumps;

            bumpFinder.GetVegaBumps(theBumps);


            std::vector&lt;Real&gt; values;

            std::vector&lt;Real&gt; errors;

            {

                <a class="code" href="class_quant_lib_1_1_pathwise_vegas_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseVegasAccountingEngine</a>
                    accountingEngine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)),
                    swaptionsDeflated,
                    marketModel,
                    theBumps,initialNumeraireValue);


                accountingEngine.multiplePathValues(values,errors,pathsToDoSimulation);

            }

            <span class="comment">// we now have the simulation vegas, put them in more convenient form</span>


            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> vegasMatrix(swaptionsDeflated.numberOfProducts(), theBumps[0].size());
            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> standardErrors(vegasMatrix);
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> entriesPerProduct = 1+numberRates+theBumps[0].size();

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptionsDeflated.numberOfProducts(); ++i)
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; theBumps[0].size(); ++j)
                {
                    vegasMatrix[i][j] = values[i*entriesPerProduct + numberRates+1+j];
                    standardErrors[i][j] = errors[i*entriesPerProduct + numberRates+1 +j];
                }

                <span class="comment">// we next get the model vegas for comparison</span>

                std::vector&lt;Real&gt; impliedVols_(swaptions.size());

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptions.size(); ++i)
                    impliedVols_[i] = SwapForwardMappings::swaptionImpliedVolatility(*marketModel,
                    swaptions[i].startIndex_,
                    swaptions[i].endIndex_);

                std::vector&lt;Real&gt; analyticVegas(swaptions.size());
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptions.size(); ++i)
                {
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swapRate = cs.coterminalSwapRates()[i];
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> annuity =  cs.coterminalSwapAnnuity(0,i)*initialNumeraireValue;
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expiry = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i];
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sd = impliedVols_[i]*sqrt(expiry);
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swapDisplacement=0.0;

                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> vega = <a class="code" href="namespace_quant_lib.html#a53e783b853451e48d13ca9723229bdc3">blackFormulaVolDerivative</a>(swapRate,
                        swapRate,
                        sd,
                        expiry,
                        annuity,
                        swapDisplacement);

                    analyticVegas[i] = vega*0.01; <span class="comment">// one percent move</span>

                }

                <span class="comment">// diagonal vegas should agree up to standard errors</span>
                <span class="comment">// off diagonal vegas should be zero</span>

                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberDiagonalFailures = 0;
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> offDiagonalFailures=0;


                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptions.size(); ++i)
                {
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = vegasMatrix[i][i] - analyticVegas[i];
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisErrorInSds = thisError /  (standardErrors[i][i]+1E-6); <span class="comment">// silly to penalize for tiny standard error</span>

                    <span class="keywordflow">if</span> (fabs(thisErrorInSds) &gt; 4)
                        ++numberDiagonalFailures;

                }

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; swaptions.size(); ++i)
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; theBumps[0].size(); ++j)
                    {
                        <span class="keywordflow">if</span> ( i !=j )
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = vegasMatrix[i][j]; <span class="comment">// true value is zero</span>

                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisErrorInSds = thisError /  (standardErrors[i][j]+1E-6);

                            <span class="keywordflow">if</span> (fabs(thisErrorInSds) &gt; 3.5)
                                ++offDiagonalFailures;
                        }
                    }

                    <span class="keywordflow">if</span> (offDiagonalFailures + numberDiagonalFailures &gt;0)
                        BOOST_FAIL(<span class="stringliteral">&quot;Pathwise market vega test fails for coterminal swaptions : &quot;</span> &lt;&lt; offDiagonalFailures &lt;&lt;<span class="stringliteral">&quot; off diagonal failures \n &quot;</span>
                        &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; numberDiagonalFailures &lt;&lt; <span class="stringliteral">&quot; on the diagonal.&quot;</span> );




        } <span class="comment">// end of  for (Size m=0; m&lt;LENGTH(testedFactors); ++m)</span>
    } <span class="comment">// end of   for (Size j=0; j&lt;LENGTH(marketModels); j++)</span>


    <span class="comment">// now time for the full simulation test</span>
    <span class="comment">// measure vega of each caps with respect to itself, the swaptions and the other caps</span>
    <span class="comment">// should get 0.01, 0 and 0 respectively.</span>
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(2UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
        };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

            <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                generatorFactory,capsDeflated.suggestedNumeraires()
                );

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver.<a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html#afdba5eb0abcdb218358a9e3a1fb8dba4">numeraires</a>().front();
            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];


            <span class="comment">// we need to work out our bumps</span>

            <a class="code" href="class_quant_lib_1_1_vega_bump_collection.html">VegaBumpCollection</a> possibleBumps(marketModel,
                allowFactorwiseBumping);


            <a class="code" href="class_quant_lib_1_1_orthogonalized_bump_finder.html">OrthogonalizedBumpFinder</a>  bumpFinder(possibleBumps,
                swaptions,
                caps,
                multiplier, <span class="comment">// if vector length grows by more than this discard</span>
                tolerance);      <span class="comment">// if vector projection before scaling less than this discard</span>
            std::vector&lt;std::vector&lt;Matrix&gt; &gt; theBumps;

            bumpFinder.GetVegaBumps(theBumps);


            std::vector&lt;Real&gt; values;

            std::vector&lt;Real&gt; errors;

            {

                <a class="code" href="class_quant_lib_1_1_pathwise_vegas_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseVegasAccountingEngine</a>
                    accountingEngine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)),
                    capsDeflated,
                    marketModel,
                    theBumps,initialNumeraireValue);


                accountingEngine.multiplePathValues(values,errors,pathsToDoSimulation);

            }

            <span class="comment">// we now have the simulation vegas, put them in more convenient form</span>


            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> vegasMatrix(capsDeflated.numberOfProducts(), theBumps[0].size());
            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> standardErrors(vegasMatrix);
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> entriesPerProduct = 1+numberRates+theBumps[0].size();


            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; capsDeflated.numberOfProducts(); ++i)
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; theBumps[0].size(); ++j)
                {
                    vegasMatrix[i][j] = values[i*entriesPerProduct +numberRates+j+1];
                    standardErrors[i][j] = errors[i*entriesPerProduct +numberRates+j+1];
                }

                <span class="comment">// we next get the model vegas for comparison</span>

                std::vector&lt;Real&gt; impliedVols_(caps.size());


                std::vector&lt;Real&gt; analyticVegas(caps.size());
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caps.size(); ++i)
                {

                    <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> capPseudo(marketModel,
                        caps[i].strike_,
                        caps[i].startIndex_,
                        caps[i].endIndex_, initialNumeraireValue);

                    impliedVols_[i] = capPseudo.impliedVolatility();

                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> vega=0.0;

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j= caps[i].startIndex_; j&lt; caps[i].endIndex_; ++j)
                    {


                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> forward  = cs.forwardRates()[j];
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> annuity =  cs.discountRatio(j+1,0)*initialNumeraireValue*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>[j];
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expiry = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[j];
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sd = impliedVols_[i]*sqrt(expiry);
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>=0.0;

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> capletVega = <a class="code" href="namespace_quant_lib.html#a53e783b853451e48d13ca9723229bdc3">blackFormulaVolDerivative</a>(caps[i].strike_,forward,
                            sd,
                            expiry,
                            annuity,
                            displacement);

                        vega += capletVega;
                    }



                    analyticVegas[i] = vega*0.01; <span class="comment">// one percent move</span>

                }

                <span class="comment">// diagonal vegas should agree up to standard errors</span>
                <span class="comment">// off diagonal vegas should be zero</span>

                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberDiagonalFailures = 0;
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> offDiagonalFailures=0;


                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caps.size(); ++i)
                {
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = vegasMatrix[i][i+swaptions.size()] - analyticVegas[i];
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisErrorInSds = thisError /  (standardErrors[i][i+swaptions.size()]+1E-6); <span class="comment">// silly to penalize for tiny standard error</span>

                    <span class="keywordflow">if</span> (fabs(thisErrorInSds) &gt; 4)
                    {
                        BOOST_MESSAGE(<span class="stringliteral">&quot; MC cap vega: &quot;</span> &lt;&lt;vegasMatrix[i][i+swaptions.size()] &lt;&lt; <span class="stringliteral">&quot; Analytic cap vega:&quot;</span> &lt;&lt; analyticVegas[i] &lt;&lt; <span class="stringliteral">&quot; Error in sds:&quot;</span> &lt;&lt; thisErrorInSds &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);
                        ++numberDiagonalFailures;
                    }

                }

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caps.size(); ++i)
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; theBumps[0].size(); ++j)
                    {
                        <span class="keywordflow">if</span> ( i+swaptions.size() !=j )
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError = vegasMatrix[i][j]; <span class="comment">// true value is zero</span>

                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisErrorInSds = thisError /  (standardErrors[i][j]+1E-6);

                            <span class="keywordflow">if</span> (fabs(thisErrorInSds) &gt; 3.5)
                                ++offDiagonalFailures;
                        }
                    }

                    <span class="keywordflow">if</span> (offDiagonalFailures + numberDiagonalFailures &gt;0)
                        BOOST_FAIL(<span class="stringliteral">&quot;Pathwise market vega test fails for caps: &quot;</span> &lt;&lt; offDiagonalFailures &lt;&lt;<span class="stringliteral">&quot; off diagonal failures \n &quot;</span>
                        &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; numberDiagonalFailures &lt;&lt; <span class="stringliteral">&quot; on the diagonal.&quot;</span> );




        } <span class="comment">// end of  for (Size m=0; m&lt;LENGTH(testedFactors); ++m)</span>
    } <span class="comment">// end of   for (Size j=0; j&lt;LENGTH(marketModels); j++)</span>





}
</pre></div>
</div>
</div>
<a class="anchor" id="a55cab040b18aa60cff9a2a9f7d962826"></a><!-- doxytag: member="MarketModelTest::testPathwiseVegas" ref="a55cab040b18aa60cff9a2a9f7d962826" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a55cab040b18aa60cff9a2a9f7d962826">MarketModelTest::testPathwiseVegas</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l02438">2438</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00137">anonymous_namespace{marketmodel.cpp}::b</a>, <a class="el" href="blackformula_8cpp_source.html#l00045">QuantLib::blackFormula()</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00095">QuantLib::MarketModelPathwiseMultiCaplet::clone()</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00242">QuantLib::MarketModelPathwiseMultiDeflatedCaplet::clone()</a>, <a class="el" href="mtbrowniangenerator_8cpp_source.html#l00064">QuantLib::MTBrownianGeneratorFactory::create()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00045">QuantLib::VolatilityBumpInstrumentJacobian::Cap::endIndex_</a>, <a class="el" href="class_quant_lib_1_1_generic_sequence_statistics.html#aff9a45944f282051d51070584bd6f7b7">QuantLib::GenericSequenceStatistics&lt; StatisticsType &gt;::errorEstimate()</a>, <a class="el" href="multiproductmultistep_8cpp_source.html#l00042">QuantLib::MultiProductMultiStep::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="interpolations_8cpp_source.html#l01615">anonymous_namespace{interpolations.cpp}::f()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00097">QuantLib::EvolutionDescription::firstAliveRate()</a>, <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00378">QuantLib::CapPseudoDerivative::impliedVolatility()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="multistepoptionlets_8hpp_source.html#l00070">QuantLib::MultiStepOptionlets::maxNumberOfCashFlowsPerProductPerStep()</a>, <a class="el" href="class_quant_lib_1_1_generic_sequence_statistics.html#ae3daaad97b7f821af0ec3f1ddb2aba36">QuantLib::GenericSequenceStatistics&lt; StatisticsType &gt;::mean()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00131">anonymous_namespace{marketmodel.cpp}::meanForward</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="pathwiseaccountingengine_8cpp_source.html#l00312">QuantLib::PathwiseAccountingEngine::multiplePathValues()</a>, <a class="el" href="pathwiseaccountingengine_8cpp_source.html#l00681">QuantLib::PathwiseVegasAccountingEngine::multiplePathValues()</a>, <a class="el" href="pathwiseaccountingengine_8cpp_source.html#l01156">QuantLib::PathwiseVegasOuterAccountingEngine::multiplePathValues()</a>, <a class="el" href="multistepoptionlets_8cpp_source.html#l00038">QuantLib::MultiStepOptionlets::nextTimeStep()</a>, <a class="el" href="multistepoptionlets_8hpp_source.html#l00065">QuantLib::MultiStepOptionlets::numberOfProducts()</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00120">QuantLib::MarketModelPathwiseMultiCaplet::numberOfProducts()</a>, <a class="el" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">QuantLib::MarketModelPathwiseMultiProduct::numberOfProducts()</a>, <a class="el" href="pathwiseproductcaplet_8cpp_source.html#l00329">QuantLib::MarketModelPathwiseMultiDeflatedCap::numberOfProducts()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00105">QuantLib::EvolutionDescription::numberOfRates()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00109">QuantLib::EvolutionDescription::numberOfSteps()</a>, <a class="el" href="lognormalfwdrateeuler_8cpp_source.html#l00077">QuantLib::LogNormalFwdRateEuler::numeraires()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00141">anonymous_namespace{marketmodel.cpp}::paths_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00366">QuantLib::CapPseudoDerivative::priceDerivative()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="dataformatters_8hpp_source.html#l00129">QuantLib::io::rate()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00085">QuantLib::EvolutionDescription::rateTaus()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="multistepoptionlets_8hpp_source.html#l00074">QuantLib::MultiStepOptionlets::reset()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00041">QuantLib::LMMCurveState::setOnForwardRates()</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00044">QuantLib::VolatilityBumpInstrumentJacobian::Cap::startIndex_</a>, <a class="el" href="bumpinstrumentjacobian_8hpp_source.html#l00046">QuantLib::VolatilityBumpInstrumentJacobian::Cap::strike_</a>, <a class="el" href="ql_2models_2marketmodels_2swapforwardmappings_8cpp_source.html#l00182">QuantLib::SwapForwardMappings::swaptionImpliedVolatility()</a>, <a class="el" href="quantlibbenchmark_8cpp_source.html#l00150">anonymous_namespace{quantlibbenchmark.cpp}::t</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, <a class="el" href="blackcalculator_8cpp_source.html#l00199">QuantLib::BlackCalculator::value()</a>, <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00136">QuantLib::SwaptionPseudoDerivative::volatilityDerivative()</a>, and <a class="el" href="swaptionpseudojacobian_8cpp_source.html#l00371">QuantLib::CapPseudoDerivative::volatilityDerivative()</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">{

    BOOST_MESSAGE(
        <span class="stringliteral">&quot;Testing pathwise vegas in a lognormal forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();





    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; payoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i) {
        payoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]));
        <span class="comment">//CashOrNothingPayoff(Option::Call, todaysForwards[i], 0.01));</span>
        displacedPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
        <span class="comment">//CashOrNothingPayoff(Option::Call, todaysForwards[i]+displacement, 0.01));</span>
    }


    <a class="code" href="class_quant_lib_1_1_multi_step_optionlets.html">MultiStepOptionlets</a> product(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, payoffs);

    <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_caplet.html" title="market-model pathwise caplet">MarketModelPathwiseMultiCaplet</a> caplets(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);


    <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_deflated_caplet.html">MarketModelPathwiseMultiDeflatedCaplet</a> capletsDeflated(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);

    <a class="code" href="class_quant_lib_1_1_l_m_m_curve_state.html" title="Curve state for Libor market models">LMMCurveState</a> cs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    cs.setOnForwardRates(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);




    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product.evolution();
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> steps = evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>();
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberRates = evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>();

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> bumpSizeNumericalDifferentiation = 1E-6;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> vegaBumpSize = 1e-2;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> pathsToDo =10; <span class="comment">// for the numerical differentiation test we are requiring equality on each path so this is actually quite strict</span>
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> pathsToDoSimulation = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#abc967feecd2831cf784e1ee7561915c8">paths_</a>;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> bumpIncrement = 1 + evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>()/3;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numericalBumpSizeForSwaptionPseudo =1E-7;

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> multiplier = 50; <span class="comment">// how many times the bump size squared, the numerical differentation is allowed to differ by</span>
    <span class="comment">// printReport_ = true;</span>
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> maxError =0.0;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberSwaptionPseudoFailures =0;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberCapPseudoFailures = 0;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberCapImpVolFailures = 0;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberCapVolPseudoFailures =0;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swaptionPseudoTolerance = 1e-8;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> impVolTolerance = 1e-5;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> capStrike = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa000cefd66320eb1538cff035b774dc7">meanForward</a>;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =0.95;


    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] =
    {
        <span class="comment">// CalibratedMM,</span>
        <span class="comment">// ExponentialCorrelationFlatVolatility,</span>
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a>
    };

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(3UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
        };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];


            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> startIndex = std::min&lt;Size&gt;(1,evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>()-2) ;
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> endIndex = evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>()-1;

            <a class="code" href="class_quant_lib_1_1_swaption_pseudo_derivative.html">SwaptionPseudoDerivative</a> derivative(marketModel,
                startIndex,
                endIndex);

            std::vector&lt;Matrix&gt; pseudoRoots;
            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; marketModel-&gt;numberOfSteps(); ++k)
                pseudoRoots.push_back( marketModel-&gt;pseudoRoot(k));

         <span class="comment">// test that the derivative of swaption implied vols to the pseudo-root elements are correct, finite differencing versus analytic value</span>

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step=0; step &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++ step)
            {
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++l)
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; factors; ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                    {

                        <span class="comment">// change one pseudo root element in the calibration by adding a bump to it </span>

                        pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;


                        <span class="comment">// create new market model with the pseudo root bumped</span>

                        <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedUp(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());


                        <span class="comment">// compute the implied vol of the swaption with the bumped pseudo roots </span>

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> upImpVol = SwapForwardMappings::swaptionImpliedVolatility(bumpedUp,
                            startIndex,
                            endIndex);


                        <span class="comment">// undo the bump</span>

                        pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;


                        <span class="comment">// bump down</span>

                        pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;


                        <span class="comment">// create facade for the bumped down pseudo roots</span>

                        <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedDown(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());

                       <span class="comment">// compute the implied vol of the swaption with the bumped down pseudo roots </span>

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> downImpVol = SwapForwardMappings::swaptionImpliedVolatility(bumpedDown,
                            startIndex,
                            endIndex);

                        <span class="comment">// undo bumping</span>

                        pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;

                        <span class="comment">// use symmetric finite differencing to compute the change in the swaptions implied vol for changes in this pseudo-root element</span>

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volDeriv = (upImpVol-downImpVol)/(2.0*numericalBumpSizeForSwaptionPseudo);

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> modelVal = derivative.volatilityDerivative(step)[l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>];

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = volDeriv - modelVal;

                        <span class="keywordflow">if</span> (fabs(error) &gt; swaptionPseudoTolerance)
                            ++numberSwaptionPseudoFailures;



                    }

            }

            <span class="keywordflow">if</span> (numberSwaptionPseudoFailures &gt;0)
                BOOST_ERROR(<span class="stringliteral">&quot;swaption pseudo test failed &quot;</span> &lt;&lt; numberSwaptionPseudoFailures &lt;&lt; <span class="stringliteral">&quot; times&quot;</span> );
        }
    }


    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { std::min&lt;Size&gt;(3UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
                                                          };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];


            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> startIndex = 1; startIndex &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>()-1; ++startIndex)
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> endIndex = startIndex+1; endIndex &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++endIndex)
                {

                    <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> derivative(marketModel,
                        capStrike,
                        startIndex,
                        endIndex, initialNumeraireValue);

                    std::vector&lt;Matrix&gt; pseudoRoots;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; marketModel-&gt;numberOfSteps(); ++k)
                        pseudoRoots.push_back( marketModel-&gt;pseudoRoot(k));

                    <span class="comment">// test cap price derivatives with respect to pseudo-root elements</span>

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step=0; step &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++ step)
                    {
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++l)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; factors; ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                            {

                                <span class="comment">// similar to swaption pseudo derivative test but with prices not implied vols</span>

                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;

                                <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedUp(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());

                                <span class="comment">// get total covariances of rates with bumped up pseudo-roots , we really only need the variances</span>
                                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> totalCovUp(bumpedUp.totalCovariance( marketModel-&gt;numberOfSteps()-1));


                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;

                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;

                                <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedDown(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());

                                <span class="comment">// get total covariances of rates with bumped down pseudo-roots , we really only need the variances</span>
                                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> totalCovDown(bumpedDown.totalCovariance( marketModel-&gt;numberOfSteps()-1));


                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;


                                <span class="comment">// we have to loop through all the caplets underlying the cap to get the price</span>

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceDeriv=0.0;
                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=startIndex; k &lt; endIndex; ++k)
                                {
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> upSd = sqrt(totalCovUp[k][k]);
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> downSd = sqrt(totalCovDown[k][k]);

                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> annuity =  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[k+1]* marketModel-&gt;evolution().rateTaus()[k];
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> forward = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[k];


                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> upPrice = <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(Option::Call,
                                        capStrike,
                                        forward,
                                        upSd,
                                        annuity,
                                        marketModel-&gt;displacements()[k]);


                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> downPrice = <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(Option::Call,
                                        capStrike,
                                        forward,
                                        downSd,
                                        annuity,
                                        marketModel-&gt;displacements()[k]);


                                    priceDeriv += (upPrice-downPrice)/(2.0*numericalBumpSizeForSwaptionPseudo);

                                }

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> modelVal = derivative.priceDerivative(step)[l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>];

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = priceDeriv - modelVal;

                                <span class="keywordflow">if</span> (fabs(error) &gt; swaptionPseudoTolerance)
                                    ++numberCapPseudoFailures;



                            }

                    }

                    <span class="comment">// test the implied vol of the cap, each underlying caplet has a different implied vol and the cap&#39;s is different again</span>

                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> impVol = derivative.impliedVolatility();

                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> totalCov(marketModel-&gt;totalCovariance(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>()-1 ) );
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceConstVol =0.0;
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceVarVol =0.0;

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m= startIndex; m &lt; endIndex; ++m)
                    {
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> annuity = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[m+1]* marketModel-&gt;evolution().rateTaus()[m];
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> expiry = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[m];
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> forward = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[m];

                        priceConstVol += <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(Option::Call,
                            capStrike,
                            forward,
                            impVol*sqrt(expiry),
                            annuity,
                            marketModel-&gt;displacements()[m]);

                        priceVarVol += <a class="code" href="namespace_quant_lib.html#a3389f4064f58cfc2d4a160d84e992c4f">blackFormula</a>(Option::Call,
                            capStrike,
                            forward,
                            sqrt(totalCov[m][m]),
                            annuity,
                            marketModel-&gt;displacements()[m]);

                    }

                    <span class="keywordflow">if</span> (fabs(priceVarVol - priceConstVol) &gt; impVolTolerance)
                        ++numberCapImpVolFailures;


                }

                <span class="keywordflow">if</span> (numberCapPseudoFailures &gt;0)
                    BOOST_ERROR(<span class="stringliteral">&quot;cap pseudo test failed for prices &quot;</span> &lt;&lt; numberCapPseudoFailures &lt;&lt; <span class="stringliteral">&quot; times&quot;</span> );

                <span class="keywordflow">if</span> (numberCapImpVolFailures &gt;0)
                    BOOST_ERROR(<span class="stringliteral">&quot;cap pseudo test failed for implied vols &quot;</span> &lt;&lt; numberCapImpVolFailures &lt;&lt; <span class="stringliteral">&quot; times&quot;</span> );

        }

        <span class="comment">// we have tested the price derivative and the implied vol function, now the derivative of the cap implied vols</span>
        <span class="comment">// with respect to pseudo-root elements  </span>

        <span class="comment">// since we have already tested the imp vol function we use it here</span>


        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];


            <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;

            boost::shared_ptr&lt;MarketModel&gt; marketModel =
                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                marketModels[j]);

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> startIndex = 1; startIndex &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>()-1; ++startIndex)
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> endIndex = startIndex+1; endIndex &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++endIndex)
                {

                    <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> derivative(marketModel,
                        capStrike,
                        startIndex,
                        endIndex,initialNumeraireValue);

                    std::vector&lt;Matrix&gt; pseudoRoots;
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; marketModel-&gt;numberOfSteps(); ++k)
                        pseudoRoots.push_back( marketModel-&gt;pseudoRoot(k));


                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step=0; step &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++ step)
                    {
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++l)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; factors; ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                            {
                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;

                                <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedUp(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());

                                <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> upDerivative(boost::shared_ptr&lt;MarketModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a>(bumpedUp)),
                                    capStrike,
                                    startIndex,
                                    endIndex,initialNumeraireValue);

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volUp = upDerivative.impliedVolatility();




                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;

                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] -= numericalBumpSizeForSwaptionPseudo;

                                <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a> bumpedDown(pseudoRoots,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,marketModel-&gt;initialRates(),marketModel-&gt;displacements());

                                <a class="code" href="class_quant_lib_1_1_cap_pseudo_derivative.html">CapPseudoDerivative</a> downDerivative(boost::shared_ptr&lt;MarketModel&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_pseudo_root_facade.html">PseudoRootFacade</a>(bumpedDown)),
                                    capStrike,
                                    startIndex,
                                    endIndex,initialNumeraireValue);


                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volDown = downDerivative.impliedVolatility();




                                pseudoRoots[step][l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] += numericalBumpSizeForSwaptionPseudo;


                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volDeriv = (volUp-volDown)/(2.0*numericalBumpSizeForSwaptionPseudo);

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> modelVal = derivative.volatilityDerivative(step)[l][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>];

                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = volDeriv - modelVal;

                                <span class="keywordflow">if</span> (fabs(error) &gt; impVolTolerance*10)
                                    ++numberCapVolPseudoFailures;



                            }



                    }



                }

                <span class="keywordflow">if</span> (numberCapVolPseudoFailures &gt;0)
                    BOOST_ERROR(<span class="stringliteral">&quot;cap pseudo test failed for implied vols &quot;</span> &lt;&lt; numberCapVolPseudoFailures &lt;&lt; <span class="stringliteral">&quot; times&quot;</span> );

        }
    }









    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = { 
                                                                std::min&lt;Size&gt;(1UL,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size())
            <span class="comment">//    todaysForwards.size()</span>
            <span class="comment">//, 4, 8,</span>
                                                        
                                                            };




        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m)
        {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factorsToTest = std::min&lt;Size&gt;(2,factors); <span class="comment">// doing all possible vegas is combinatorially explosive</span>


            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = {
                                                                               <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>
                                                                       };

            std::vector&lt;Matrix&gt; pseudoBumps;
            std::vector&lt;Matrix&gt; pseudoBumpsDown;

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++k)
            {
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; factors; ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                {
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> modelBump(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(), factors,0.0);
                    modelBump[k][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] =bumpSizeNumericalDifferentiation;
                    pseudoBumps.push_back(modelBump);
                    modelBump[k][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] =-bumpSizeNumericalDifferentiation;
                    pseudoBumpsDown.push_back(modelBump);
                }
            }

            std::vector&lt;std::vector&lt;Matrix&gt; &gt; vegaBumps;

            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> modelBump(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(), factors,0.0);


            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l = 0; l &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++l)
            {
                vegaBumps.push_back(std::vector&lt;Matrix&gt;());
                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); k=k+bumpIncrement)
                {
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; factorsToTest; ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                    {

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++m)
                        {
                            <span class="keywordflow">if</span> (l ==m &amp;&amp; k &gt;= l)
                                modelBump[k][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] = vegaBumpSize;

                            vegaBumps[l].push_back(modelBump);

                            modelBump[k][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>] =0.0;
                        }
                    }
                }

            }





            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++)
            {

                std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                std::vector&lt;RatePseudoRootJacobian&gt; testees;
                std::vector&lt;RatePseudoRootJacobianAllElements&gt; testees2;

                std::vector&lt;RatePseudoRootJacobianNumerical&gt; testers;
                std::vector&lt;RatePseudoRootJacobianNumerical&gt; testersDown;


                <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                boost::shared_ptr&lt;MarketModel&gt; marketModel =
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                    marketModels[j]);

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a4c0316f5060a3f06dae6d4495fc87df4">numberOfSteps</a>(); ++l)
                {
                    <span class="keyword">const</span> <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a>&amp; pseudoRoot = marketModel-&gt;pseudoRoot(l);
                    testees.push_back(<a class="code" href="class_quant_lib_1_1_rate_pseudo_root_jacobian.html">RatePseudoRootJacobian</a>(pseudoRoot,
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[l],
                        numeraires[l],
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a6b1d26d991934a10ecbe52caa6621c38">rateTaus</a>(),
                        pseudoBumps,
                        marketModel-&gt;displacements()
                        ));

                      testees2.push_back(<a class="code" href="class_quant_lib_1_1_rate_pseudo_root_jacobian_all_elements.html">RatePseudoRootJacobianAllElements</a>(pseudoRoot,
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[l],
                        numeraires[l],
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a6b1d26d991934a10ecbe52caa6621c38">rateTaus</a>(),
                        marketModel-&gt;displacements()
                        ));


                    testers.push_back(<a class="code" href="class_quant_lib_1_1_rate_pseudo_root_jacobian_numerical.html">RatePseudoRootJacobianNumerical</a>(pseudoRoot,
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[l],
                        numeraires[l],
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a6b1d26d991934a10ecbe52caa6621c38">rateTaus</a>(),
                        pseudoBumps,
                        marketModel-&gt;displacements()
                        ));
                    testersDown.push_back(<a class="code" href="class_quant_lib_1_1_rate_pseudo_root_jacobian_numerical.html">RatePseudoRootJacobianNumerical</a>(pseudoRoot,
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[l],
                        numeraires[l],
                        evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a6b1d26d991934a10ecbe52caa6621c38">rateTaus</a>(),
                        pseudoBumpsDown,
                        marketModel-&gt;displacements()
                        ));

                }




                boost::shared_ptr&lt;BrownianGenerator&gt; generator(generatorFactory.create(factors,
                    steps));
                <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                    generatorFactory,
                    numeraires);


                std::vector&lt;Real&gt; oldRates(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());
                std::vector&lt;Real&gt; newRates(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());
                std::vector&lt;Real&gt; gaussians(factors);

                std::vector&lt;Size&gt; numberCashFlowsThisStep(product.numberOfProducts());

                std::vector&lt;std::vector&lt;MarketModelMultiProduct::CashFlow&gt; &gt; cashFlowsGenerated(product.numberOfProducts());

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; product.numberOfProducts(); ++i)
                    cashFlowsGenerated[i].resize(product.maxNumberOfCashFlowsPerProductPerStep());

                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> B(pseudoBumps.size(),evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());
                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> B2(pseudoBumps.size(),evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());
                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> B3(pseudoBumps.size(),evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());
                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> B4(pseudoBumps.size(),evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>());

                std::vector&lt;Matrix&gt; globalB;
                {
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> modelB(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(), factors);
                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; steps; ++i)
                        globalB.push_back(modelB);
                }

                std::vector&lt;Real&gt; oneStepDFs(evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>()+1);
                oneStepDFs[0] = 1.0;


                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberFailures=0;
                <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberFailures2=0;

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> l=0; l &lt; pathsToDo; ++l)
                {
                    evolver.startNewPath();
                    product.reset();
                    generator-&gt;nextPath();

                    <span class="keywordtype">bool</span> done;
                    newRates = marketModel-&gt;initialRates();
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> currentStep =0;

                    <span class="keywordflow">do</span>
                    {
                        oldRates = newRates;


                        evolver.advanceStep();
                        done = product.nextTimeStep(evolver.currentState(),
                            numberCashFlowsThisStep,
                            cashFlowsGenerated);

                        newRates = evolver.currentState().forwardRates();

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=1; i &lt;= evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#ad70aac98a7b7f668cd0664c287aa37e1">numberOfRates</a>(); ++i)
                            oneStepDFs[i] = 1.0/(1+oldRates[i-1]*evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#a6b1d26d991934a10ecbe52caa6621c38">rateTaus</a>()[i-1]);


                        generator-&gt;nextStep(gaussians);

                        testees[currentStep].getBumps(oldRates, oneStepDFs, newRates, gaussians, B);
                        testees2[currentStep].getBumps(oldRates, oneStepDFs, newRates, gaussians, globalB);
                

                        testers[currentStep].getBumps(oldRates, oneStepDFs, newRates, gaussians, B2);
                        testersDown[currentStep].getBumps(oldRates, oneStepDFs, newRates, gaussians, B3);

                        <span class="comment">// now do make out put of allElements class into same form </span>

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i1 =0; i1 &lt; pseudoBumps.size(); ++i1)
                        {
                            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j1=0;

                            <span class="keywordflow">for</span> (; j1 &lt; evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[i1]; ++j1)
                            {
                                B4[i1][j1]=0.0;
                            }
                            <span class="keywordflow">for</span> (; j1 &lt; numberRates; ++j1)
                            {
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> sum =0.0;

                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k1=evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#af825b56a8d35a6d401d92976bd262cf5">firstAliveRate</a>()[i1]; k1 &lt; numberRates; ++k1)
                                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> f1=0; f1 &lt; factors; ++f1)
                                        sum += pseudoBumps[i1][k1][f1]*globalB[j1][k1][f1];

                                B4[i1][j1] =sum;

                            }
                        }



                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; B.rows(); ++j)
                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k &lt; B.columns(); ++k)
                            {
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> analytic = B[j][k]/bumpSizeNumericalDifferentiation;
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> analytic2 = B4[j][k]/bumpSizeNumericalDifferentiation;
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> numerical = (B2[j][k]-B3[j][k])/(2*bumpSizeNumericalDifferentiation);
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorSize = (analytic - numerical)/ ( bumpSizeNumericalDifferentiation*bumpSizeNumericalDifferentiation);
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorSize2 = (analytic2 - numerical)/ ( bumpSizeNumericalDifferentiation*bumpSizeNumericalDifferentiation);

                                maxError = std::max(maxError,fabs(errorSize));

                                <span class="keywordflow">if</span> ( fabs( errorSize  ) &gt; multiplier  )
                                {
                                    ++numberFailures;
                                    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                        BOOST_MESSAGE(<span class="stringliteral">&quot;path &quot;</span> &lt;&lt; l &lt;&lt; <span class="stringliteral">&quot; step &quot;</span>
                                        &lt;&lt; currentStep &lt;&lt; <span class="stringliteral">&quot; j &quot;</span> &lt;&lt; j
                                        &lt;&lt; <span class="stringliteral">&quot; k &quot;</span> &lt;&lt; k &lt;&lt; <span class="stringliteral">&quot; B &quot;</span> &lt;&lt; B[j][k] &lt;&lt; <span class="stringliteral">&quot;  B2 &quot;</span> &lt;&lt; B2[j][k]);

                                }

                                <span class="keywordflow">if</span> ( fabs( errorSize2  ) &gt; multiplier  )
                                {
                                    ++numberFailures2;
                                    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                                        BOOST_MESSAGE(<span class="stringliteral">&quot;path &quot;</span> &lt;&lt; l &lt;&lt; <span class="stringliteral">&quot; step &quot;</span>
                                        &lt;&lt; currentStep &lt;&lt; <span class="stringliteral">&quot; j &quot;</span> &lt;&lt; j
                                        &lt;&lt; <span class="stringliteral">&quot; k &quot;</span> &lt;&lt; k &lt;&lt; <span class="stringliteral">&quot; B4 &quot;</span> &lt;&lt; B4[j][k] &lt;&lt; <span class="stringliteral">&quot;  B2 &quot;</span> &lt;&lt; B2[j][k]);

                                }

                            }
                            ++currentStep;
                    }
                    <span class="keywordflow">while</span> (!done);

                }

                <span class="keywordflow">if</span> (numberFailures &gt;0)
                    BOOST_FAIL(<span class="stringliteral">&quot;Pathwise rate pseudoroot jacobian test fails : &quot;</span> &lt;&lt; numberFailures &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>);

                
                <span class="keywordflow">if</span> (numberFailures2 &gt;0)
                    BOOST_FAIL(<span class="stringliteral">&quot;Pathwise rate pseudoroot jacobian all elements test fails : &quot;</span> &lt;&lt; numberFailures2 &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>);
            } <span class="comment">// end of k loop over measures</span>


            <span class="comment">// the quick test done now do a simulation test for the vegas for caplets</span>

            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberDeflatedErrors =0;
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberUndeflatedErrors =0;
            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> biggestError=0.0;


            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> deflate =0; deflate &lt;2; ++deflate)
            {
                std::auto_ptr&lt;MarketModelPathwiseMultiProduct&gt; productToUse;

                <span class="keywordflow">if</span> (deflate ==0)
                    productToUse = caplets.clone();
                <span class="keywordflow">else</span>
                    productToUse = capletsDeflated.clone();

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++)
                {

                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                        marketModels[j]);

                    <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                        generatorFactory,
                        numeraires);

                    <span class="comment">//      SequenceStatistics stats(product.numberOfProducts()*(todaysForwards.size()+1+vegaBumps[0].size()));</span>


                    std::ostringstream config;
                    config &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;MT BGF&quot;</span>;
                    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                        BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver.numeraires().front();
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];

                    std::vector&lt;Real&gt; values;

                    std::vector&lt;Real&gt; errors;

                    {

                        <a class="code" href="class_quant_lib_1_1_pathwise_vegas_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseVegasAccountingEngine</a> accountingengine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)), <span class="comment">// method relies heavily on LMM Euler</span>
                            productToUse,
                            marketModel, <span class="comment">// we need pseudo-roots and displacements</span>
                            vegaBumps,
                            initialNumeraireValue);

                        accountingengine.multiplePathValues(values,errors,pathsToDoSimulation);
                    }

                    <span class="comment">// we have computed the vegas now we have to test them against the analytic values</span>

                    <span class="comment">// extract into easier format</span>




                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> vegasMatrix(caplets.numberOfProducts(), vegaBumps[0].size());
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> standardErrors(vegasMatrix);
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltasMatrix(caplets.numberOfProducts(), numberRates);
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltasErrors(deltasMatrix);
                    std::vector&lt;Real&gt; prices(caplets.numberOfProducts());
                    std::vector&lt;Real&gt; priceErrors(caplets.numberOfProducts());

                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> entriesPerProduct = 1+numberRates+vegaBumps[0].size();

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; caplets.numberOfProducts(); ++i)
                    {
                        prices[i] =  values[i*entriesPerProduct];
                        priceErrors[i] = errors[i*entriesPerProduct];

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; vegaBumps[0].size(); ++j)
                        {
                            vegasMatrix[i][j] = values[i*entriesPerProduct + numberRates+1 + j];
                            standardErrors[i][j] = errors[i*entriesPerProduct + numberRates+1 + j];
                        }
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; numberRates; ++j)
                        {
                            deltasMatrix[i][j] = values[i*entriesPerProduct +1 + j];
                            deltasErrors[i][j] = errors[i*entriesPerProduct +1 + j];
                        }
                    }



                    <span class="comment">// first get the terminal vols</span>

                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> totalCovariance(marketModel-&gt;totalCovariance(marketModel-&gt;numberOfSteps()-1));


                    std::vector&lt;Real&gt; truePrices(caplets.numberOfProducts());

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> r =0; r &lt; truePrices.size(); ++r)
                    {
                        truePrices[r] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[r], <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[r], sqrt(totalCovariance[r][r]),
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[r+1]*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r])).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();
                    }


                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> =0; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> &lt; vegaBumps[0].size(); ++<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)
                    {


                        std::vector&lt;Real&gt; bumpedPrices(truePrices.size());
                        std::vector&lt;Real&gt; variances(truePrices.size(),0.0);
                        std::vector&lt;Real&gt; vegas(truePrices.size());


                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step = 0; step &lt; marketModel-&gt;numberOfSteps(); ++step)
                        {
                            <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> pseudoRoot( marketModel-&gt;pseudoRoot(step));
                            pseudoRoot += vegaBumps[step][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];

                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>=step; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>&lt;marketModel-&gt;numberOfRates(); ++<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>)
                            {
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance = 0.0;
                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; marketModel-&gt;numberOfFactors(); ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                                    variance+= pseudoRoot[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>]* pseudoRoot[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>];

                                variances[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>]+=variance;
                            }
                        }

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> r =0; r &lt; truePrices.size(); ++r)
                        {

                            bumpedPrices[r] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedPayoffs[r], <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[r], sqrt(variances[r]),
                                <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[r+1]*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r])).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();

                            vegas[r] = bumpedPrices[r] - truePrices[r];

                        }


                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s  &lt; truePrices.size(); ++s)
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> mcVega = vegasMatrix[s][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> analyticVega = vegas[s];
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError =  mcVega - analyticVega;
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisSE = standardErrors[s][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];

                            <span class="keywordflow">if</span> (fabs(thisError) &gt;  0.0)
                            {
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorInSEs = thisError/thisSE;
                                biggestError = std::max(fabs(errorInSEs),biggestError);

                                <span class="keywordflow">if</span> (fabs(errorInSEs) &gt; 4.5)
                                {
                                    <span class="keywordflow">if</span> (deflate==0)
                                        ++numberUndeflatedErrors;
                                    <span class="keywordflow">else</span>
                                        ++numberDeflatedErrors;
                                }
                            }

                        }


                    }



                    <span class="comment">// for deltas and prices the pathwise vega engine should agree precisely with the pathwiseaccounting engine</span>
                    <span class="comment">// so lets see if it does</span>

                    std::auto_ptr&lt;MarketModelPathwiseMultiProduct&gt; productToUse2;

                    <span class="keywordflow">if</span> (deflate ==0)
                        productToUse2 = caplets.clone();
                    <span class="keywordflow">else</span>
                        productToUse2 = capletsDeflated.clone();


                    <a class="code" href="class_quant_lib_1_1_generic_sequence_statistics.html" title="Statistics analysis of N-dimensional (sequence) data.">SequenceStatisticsInc</a> stats(productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()+1));
                    {
                        <a class="code" href="class_quant_lib_1_1_pathwise_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseAccountingEngine</a> accountingengine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)), <span class="comment">// method relies heavily on LMM Euler</span>
                            *productToUse2,
                            marketModel, <span class="comment">// we need pseudo-roots and displacements</span>
                            initialNumeraireValue);

                        accountingengine.multiplePathValues(stats,pathsToDoSimulation);
                    }

                    std::vector&lt;Real&gt; valuesAndDeltas2 = stats.mean();
                    std::vector&lt;Real&gt; errors2 = stats.errorEstimate();

                    std::vector&lt;Real&gt; prices2(productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());
                    std::vector&lt;Real&gt; priceErrors2(productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());

                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltas2( productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> deltasErrors2( productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(), <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
                    std::vector&lt;Real&gt; modelPrices2(productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>());


                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(); ++i)
                    {
                        prices2[i] = valuesAndDeltas2[i];
                        priceErrors2[i] = errors2[i];

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++j)
                        {
                            deltas2[i][j] = valuesAndDeltas2[(i+1)*productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()+j];
                            deltasErrors2[i][j]  = errors2[(i+1)* productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>()+j];
                        }
                    }

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; productToUse2-&gt;<a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_product.html#a4a6407912f1751e7e736b47204cb5bc0">numberOfProducts</a>(); ++i)
                    {

                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> priceDiff = prices2[i] - prices[i];

                        <span class="keywordflow">if</span> (fabs(priceDiff) &gt; 5*priceErrors2[i])  <span class="comment">// two sets of standard error</span>
                            BOOST_FAIL(<span class="stringliteral">&quot;pathwise accounting engine and pathwise vegas accounting engine not in perfect agreement for price.\n product &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;,  vega computed price: &quot;</span> &lt;&lt; prices[j] &lt;&lt; <span class="stringliteral">&quot; previous price &quot;</span> &lt;&lt; prices2[j] &lt;&lt; <span class="stringliteral">&quot;, deflate &quot;</span> &lt;&lt; deflate &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> );

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt;  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++j)
                        {
                            <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = deltas2[i][j] - deltasMatrix[i][j];
                            <span class="keywordflow">if</span> (fabs(error)&gt; 5* deltasErrors2[i][j] ) <span class="comment">// two sets of standard error</span>
                                BOOST_FAIL(<span class="stringliteral">&quot;pathwise accounting engine and pathwise vegas accounting engine not in perfect agreement for dealts.\n product &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;, rate &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot; vega computed delta: &quot;</span> &lt;&lt; deltasMatrix[i][j] &lt;&lt; <span class="stringliteral">&quot; previous delta &quot;</span> &lt;&lt; deltas2[i][j] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> );
                        }
                    }
                } <span class="comment">// end of k loop over measures</span>
            } <span class="comment">// end of loop over deflation</span>


            <span class="keywordflow">if</span> (numberDeflatedErrors+numberUndeflatedErrors &gt;0)
                BOOST_FAIL(<span class="stringliteral">&quot;Model pathwise vega test for caplets fails : &quot;</span> &lt;&lt; numberDeflatedErrors &lt;&lt;<span class="stringliteral">&quot; deflated errors and &quot;</span> &lt;&lt;numberUndeflatedErrors &lt;&lt;  <span class="stringliteral">&quot; undeflated errors , biggest error in SEs is &quot;</span> &lt;&lt; biggestError &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);


            {
                <span class="comment">//  now do a simulation test for the vegas for caps</span>

                std::vector&lt;VolatilityBumpInstrumentJacobian::Cap&gt; caps;

                <a class="code" href="namespace_quant_lib.html#a919ba3567cc89fca373f8d6b8e80126b" title="interest rates">Rate</a> capStrike = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[0];

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i +2 &lt; numberRates; i=i+3)
                {
                    <a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html">VolatilityBumpInstrumentJacobian::Cap</a> nextCap;
                    <span class="comment">//            nextCap.startIndex_ = i;</span>
                    <span class="comment">//            nextCap.endIndex_ = i+3;</span>
                    <span class="comment">//             nextCap.strike_ = capStrike;</span>
                    <span class="comment">//             caps.push_back(nextCap);</span>

                    <span class="comment">//        nextCap.startIndex_ = i+1;</span>
                    <span class="comment">//      nextCap.endIndex_ = i+3;</span>
                    <span class="comment">//    nextCap.strike_ = capStrike;</span>
                    <span class="comment">//  caps.push_back(nextCap);</span>

                    nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ac7a3a79be7ff382a3509a643170f0da9">startIndex_</a> = i+2;
                    nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ae394b2a1655cab0c3cd40a556b08160f">endIndex_</a> = i+3;
                    nextCap.<a class="code" href="struct_quant_lib_1_1_volatility_bump_instrument_jacobian_1_1_cap.html#ac1a398af2da44bd18cfcbd53930f6ee9">strike_</a> = capStrike;
                    caps.push_back(nextCap);

                }

                std::vector&lt;std::pair&lt;Size,Size&gt; &gt; startsAndEnds(caps.size());

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> r=0; r &lt; caps.size(); ++r)
                {
                    startsAndEnds[r].first = caps[r].startIndex_;
                    startsAndEnds[r].second = caps[r].endIndex_;
                }

                <a class="code" href="class_quant_lib_1_1_market_model_pathwise_multi_deflated_cap.html">MarketModelPathwiseMultiDeflatedCap</a> capsDeflated(
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>,
                    capStrike,
                    startsAndEnds);

                <span class="comment">// define  productToUse = capletsDeflated.clone();</span>

                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++)
                {

                    std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);
                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory2(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                    boost::shared_ptr&lt;MarketModel&gt; marketModel =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors,
                        marketModels[j]);

                    <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver(marketModel,
                        generatorFactory,
                        numeraires);

                     <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a> evolver2(marketModel,
                        generatorFactory2,
                        numeraires);

                    <span class="comment">//      SequenceStatistics stats(product.numberOfProducts()*(todaysForwards.size()+1+vegaBumps[0].size()));</span>


                    std::ostringstream config;
                    config &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;MT BGF&quot;</span>;
                    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                        BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> initialNumeraire = evolver.numeraires().front();
                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> initialNumeraireValue =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[initialNumeraire];

                    std::vector&lt;Real&gt; values;
                    std::vector&lt;Real&gt; errors;

                    std::vector&lt;Real&gt; values2;
                    std::vector&lt;Real&gt; errors2;


                    {

                        <a class="code" href="class_quant_lib_1_1_pathwise_vegas_outer_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseVegasOuterAccountingEngine</a> accountingengine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver2)), <span class="comment">// method relies heavily on LMM Euler</span>
                            capsDeflated,
                            marketModel, <span class="comment">// we need pseudo-roots and displacements</span>
                            vegaBumps,
                            initialNumeraireValue);

                        accountingengine.multiplePathValues(values2,errors2,pathsToDoSimulation);
                    }

                    {

                        <a class="code" href="class_quant_lib_1_1_pathwise_vegas_accounting_engine.html" title="Engine collecting cash flows along a market-model simulation for doing pathwise computation of Deltas...">PathwiseVegasAccountingEngine</a> accountingengine(boost::shared_ptr&lt;LogNormalFwdRateEuler&gt;(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_log_normal_fwd_rate_euler.html" title="Euler.">LogNormalFwdRateEuler</a>(evolver)), <span class="comment">// method relies heavily on LMM Euler</span>
                            capsDeflated,
                            marketModel, <span class="comment">// we need pseudo-roots and displacements</span>
                            vegaBumps,
                            initialNumeraireValue);

                        accountingengine.multiplePathValues(values,errors,pathsToDoSimulation);
                    }

                    <span class="comment">// first test to see that the two implementation give the same results</span>

                    {
                        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> tol = 1E-8;

                        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberMeanFailures =0;

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt;values.size(); ++i)
                            <span class="keywordflow">if</span> (fabs(values[i]-values2[i]) &gt; tol)
                                ++numberMeanFailures;

                              <span class="keywordflow">if</span> (numberMeanFailures &gt;0)
                                  BOOST_FAIL(<span class="stringliteral">&quot;Comparison of Pathwise vegas accounting engine and PathwiseVegasOuterAccountingEngine yields discrepancies:&quot;</span> 
                                                                 &lt;&lt; numberMeanFailures 
                                                                 &lt;&lt; <span class="stringliteral">&quot;  out of &quot;</span> 
                                                                 &lt;&lt; values.size() );

                    }

                    <span class="comment">// we have computed the vegas now we have to test them against the analytic values</span>

                    <span class="comment">// extract into easier format</span>




                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> vegasMatrix(capsDeflated.numberOfProducts(), vegaBumps[0].size());
                    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> standardErrors(vegasMatrix);
                    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> entriesPerProduct = 1+numberRates+vegaBumps[0].size();

                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; capsDeflated.numberOfProducts(); ++i)
                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; vegaBumps[0].size(); ++j)
                        {
                            vegasMatrix[i][j] = values[i*entriesPerProduct + numberRates+1 + j];
                            standardErrors[i][j] = errors[i*entriesPerProduct + numberRates+1 + j];
                        }


                        <span class="comment">// first get the terminal vols</span>

                        <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> totalCovariance(marketModel-&gt;totalCovariance(marketModel-&gt;numberOfSteps()-1));

                        std::vector&lt;Real&gt; trueCapletPrices(numberRates);
                        boost::shared_ptr&lt;StrikedTypePayoff&gt; dispayoff( <span class="keyword">new</span>
                            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, capStrike+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));

                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> r =0; r &lt; trueCapletPrices.size(); ++r)
                            trueCapletPrices[r] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(dispayoff, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[r], sqrt(totalCovariance[r][r]),
                            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[r+1]*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r])).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();

                        std::vector&lt;Real&gt; trueCapPrices(capsDeflated.numberOfProducts());
                        std::vector&lt;Real&gt; vegaCaps(capsDeflated.numberOfProducts());


                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s &lt; capsDeflated.numberOfProducts(); ++s)
                        {

                            trueCapPrices[s]=0.0;

                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>= caps[s].startIndex_; <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a> &lt;  caps[s].endIndex_; ++<a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>)
                                trueCapPrices[s] += trueCapletPrices[<a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>];
                        }

                        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberErrors =0;


                        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> =0; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a> &lt; vegaBumps[0].size(); ++<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)

                        {


                            std::vector&lt;Real&gt; bumpedCapletPrices(trueCapletPrices.size());
                            <span class="comment">//                  std::vector&lt;Real&gt; bumpedCapPrices(trueCapPrices.size());</span>

                            std::vector&lt;Real&gt; variances(trueCapletPrices.size(),0.0);
                            std::vector&lt;Real&gt; vegasCaplets(trueCapletPrices.size());



                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> step = 0; step &lt; marketModel-&gt;numberOfSteps(); ++step)
                            {
                                <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> pseudoRoot( marketModel-&gt;pseudoRoot(step));
                                pseudoRoot += vegaBumps[step][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];

                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>=step; <a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>&lt;marketModel-&gt;numberOfRates(); ++<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>)
                                {
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> variance = 0.0;
                                    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>=0; <a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a> &lt; marketModel-&gt;numberOfFactors(); ++<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>)
                                        variance+= pseudoRoot[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>]* pseudoRoot[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>][<a class="code" href="namespaceanonymous__namespace_02interpolations_8cpp_03.html#a31ee7b72e39dd85ef76ba20ca21a3018">f</a>];

                                    variances[<a class="code" href="group__manips.html#gac9152aad6a69c41f5d30bb1dcb9b2236" title="output rates and spreads as percentages">rate</a>]+=variance;
                                }
                            }

                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> r =0; r &lt; trueCapletPrices.size(); ++r)
                            {

                                bumpedCapletPrices[r] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(dispayoff, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[r], sqrt(variances[r]),
                                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[r+1]*(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r+1]-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[r])).<a class="code" href="class_quant_lib_1_1_black_calculator.html#a94d7b7b03d9e0b8366eeacd22041d49b">value</a>();

                                vegasCaplets[r] = bumpedCapletPrices[r] - trueCapletPrices[r];

                            }

                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s &lt; capsDeflated.numberOfProducts(); ++s)
                            {

                                vegaCaps[s]=0.0;

                                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>= caps[s].startIndex_; <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a> &lt;  caps[s].endIndex_; ++<a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>)
                                    vegaCaps[s] += vegasCaplets[<a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>];
                            }


                            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> s=0; s  &lt; capsDeflated.numberOfProducts(); ++s)
                            {
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> mcVega = vegasMatrix[s][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> analyticVega = vegaCaps[s];
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisError =  mcVega - analyticVega;
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> thisSE = standardErrors[s][<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>];

                                <span class="keywordflow">if</span> (fabs(thisError) &gt;  0.0)
                                {
                                    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorInSEs = fabs(thisError/thisSE);

                                    <span class="keywordflow">if</span> (errorInSEs &gt; 3.5)
                                        ++numberErrors;
                                }

                            }


                        }


                        <span class="keywordflow">if</span> (numberErrors &gt;0)
                            BOOST_FAIL(<span class="stringliteral">&quot;caps Pathwise vega test fails : &quot;</span> &lt;&lt; numberErrors &lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>);

                } <span class="comment">// end of k loop over measures</span>
            }

        }
    }

}
</pre></div>
</div>
</div>
<a class="anchor" id="aeb6f6bee584d3d73f1b2752fc65c9d0a"></a><!-- doxytag: member="MarketModelTest::testPeriodAdapter" ref="aeb6f6bee584d3d73f1b2752fc65c9d0a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#aeb6f6bee584d3d73f1b2752fc65c9d0a">MarketModelTest::testPeriodAdapter</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l01276">1276</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00111">QuantLib::LMMCurveState::coterminalSwapAnnuity()</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00138">QuantLib::LMMCurveState::coterminalSwapRate()</a>, <a class="el" href="sobolbrowniangenerator_8hpp_source.html#l00044">QuantLib::SobolBrownianGenerator::Diagonal</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00098">QuantLib::LMMCurveState::discountRatio()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="multiproductmultistep_8cpp_source.html#l00042">QuantLib::MultiProductMultiStep::evolution()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00285">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationAbcdVolatility</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00105">QuantLib::LMMCurveState::forwardRate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00449">anonymous_namespace{marketmodel.cpp}::makeMarketModelEvolver()</a>, <a class="el" href="curvestate_8hpp_source.html#l00058">QuantLib::CurveState::numberOfRates()</a>, <a class="el" href="dataformatters_8hpp_source.html#l00116">QuantLib::io::ordinal()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00432">anonymous_namespace{marketmodel.cpp}::Pc</a>, <a class="el" href="curvestate_8hpp_source.html#l00061">QuantLib::CurveState::rateTaus()</a>, <a class="el" href="curvestate_8hpp_source.html#l00060">QuantLib::CurveState::rateTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="forwardforwardmappings_8cpp_source.html#l00108">QuantLib::ForwardForwardMappings::RestrictCurveState()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="lmmcurvestate_8cpp_source.html#l00041">QuantLib::LMMCurveState::setOnForwardRates()</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="multiproductmultistep_8cpp_source.html#l00046">QuantLib::MultiProductMultiStep::suggestedNumeraires()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                        {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing period-adaptation routines in LIBOR market model...&quot;</span>);

    std::string testDescription = <span class="stringliteral">&quot;test period adapter &quot;</span>;

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();
    <a class="code" href="class_quant_lib_1_1_l_m_m_curve_state.html" title="Curve state for Libor market models">LMMCurveState</a> cs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>);
    cs.setOnForwardRates(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>);

    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> period=2;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> offset =0;

    <a class="code" href="class_quant_lib_1_1_l_m_m_curve_state.html" title="Curve state for Libor market models">LMMCurveState</a> bigRateCS(
        <a class="code" href="namespace_quant_lib_1_1_forward_forward_mappings.html#a309046db2dd326afb4124cbbf52a3e52">ForwardForwardMappings::RestrictCurveState</a>(cs,
        period,
        offset
        ));

    std::vector&lt;Time&gt; swaptionPaymentTimes(bigRateCS.rateTimes());
    swaptionPaymentTimes.pop_back();

    std::vector&lt;Time&gt; capletPaymentTimes(swaptionPaymentTimes);


    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberBigRates = bigRateCS.numberOfRates();

    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt; optionletPayoffs(numberBigRates);
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt; swaptionPayoffs(numberBigRates);
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt; displacedOptionletPayoffs(numberBigRates);
    std::vector&lt;boost::shared_ptr&lt;StrikedTypePayoff&gt; &gt; displacedSwaptionPayoffs(numberBigRates);

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;numberBigRates; ++i)
    {
        optionletPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, bigRateCS.forwardRate(i)));
        swaptionPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, bigRateCS.coterminalSwapRate(i)));
        displacedOptionletPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, bigRateCS.forwardRate(i)+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
        displacedSwaptionPayoffs[i] = boost::shared_ptr&lt;StrikedTypePayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, bigRateCS.coterminalSwapRate(i)+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));

    }

    <a class="code" href="class_quant_lib_1_1_multi_step_period_caplet_swaptions.html">MultiStepPeriodCapletSwaptions</a> theProduct(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>,
        capletPaymentTimes,
        swaptionPaymentTimes,
        optionletPayoffs,
        swaptionPayoffs,
        period,
        offset);

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution(theProduct.evolution());

    <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = 5;

    boost::shared_ptr&lt;MarketModel&gt; originalModel =
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal,
        evolution,
        factors,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa1bd5ac552b912ba4371d5c7dfe8986a0">ExponentialCorrelationAbcdVolatility</a>);

    std::vector&lt;Spread&gt; newDisplacements;

    boost::shared_ptr&lt;MarketModel&gt; adaptedforwardModel(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_fwd_period_adapter.html">FwdPeriodAdapter</a>(originalModel,
        period,
        offset,
        newDisplacements));

    boost::shared_ptr&lt;MarketModel&gt; adaptedSwapModel(<span class="keyword">new</span>
        <a class="code" href="class_quant_lib_1_1_fwd_to_cot_swap_adapter.html">FwdToCotSwapAdapter</a>(adaptedforwardModel));

    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> finalForwardCovariances(adaptedforwardModel-&gt;totalCovariance(adaptedforwardModel-&gt;numberOfSteps()-1));
    <a class="code" href="class_quant_lib_1_1_matrix.html" title="Matrix used in linear algebra.">Matrix</a> finalSwapCovariances(adaptedSwapModel-&gt;totalCovariance(adaptedSwapModel-&gt;numberOfSteps()-1));

    std::vector&lt;Volatility&gt; adaptedForwardSds(adaptedforwardModel-&gt;numberOfRates());
    std::vector&lt;Volatility&gt; adaptedSwapSds(adaptedSwapModel-&gt;numberOfRates());
    std::vector&lt;Real&gt; approxCapletPrices(adaptedforwardModel-&gt;numberOfRates());
    std::vector&lt;Real&gt; approxSwaptionPrices(adaptedSwapModel-&gt;numberOfRates());

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j &lt; adaptedSwapModel-&gt;numberOfRates(); ++j)
    {
        adaptedForwardSds[j] = sqrt(finalForwardCovariances[j][j]);
        adaptedSwapSds[j] = sqrt(finalSwapCovariances[j][j]);

        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> capletAnnuity = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]*bigRateCS.discountRatio(j+1,0)
            *bigRateCS.rateTaus()[j];

        approxCapletPrices[j] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedOptionletPayoffs[j],
            bigRateCS.forwardRate(j)+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>,
            adaptedForwardSds[j],
            capletAnnuity).value();

        <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swaptionAnnuity = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[0]
        *bigRateCS.coterminalSwapAnnuity(0,j);

        approxSwaptionPrices[j] = <a class="code" href="class_quant_lib_1_1_black_calculator.html" title="Black 1976 calculator class.">BlackCalculator</a>(displacedSwaptionPayoffs[j],
            bigRateCS.coterminalSwapRate(j)+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>,
            adaptedSwapSds[j],
            swaptionAnnuity).value();
    }
    <a class="code" href="class_quant_lib_1_1_sobol_brownian_generator_factory.html">SobolBrownianGeneratorFactory</a> generatorFactory(
        SobolBrownianGenerator::Diagonal, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);



    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a24868e34238b373eb841590d718e1816">makeMarketModelEvolver</a>(originalModel,
        theProduct.suggestedNumeraires(),
        generatorFactory,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#afb636c07f65b71f1fb4ab31b8bf7da64a782e146d675dfdf8b4bf86ee4baf5dc5">Pc</a>);

    boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, theProduct);

    std::vector&lt;Real&gt; <a class="code" href="class_instr_1_1results.html">results</a> = stats-&gt;mean();
    std::vector&lt;Real&gt; errors = stats-&gt;errorEstimate();

    std::vector&lt;Real&gt; capletErrorsInSds(numberBigRates);
    std::vector&lt;Real&gt; swaptionErrorsInSds(numberBigRates);

    <span class="keywordflow">if</span> (2*numberBigRates != results.size())
        BOOST_ERROR(<span class="stringliteral">&quot;mismatch between the size of the result and the \</span>
<span class="stringliteral">                    number of results&quot;</span>);

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; numberBigRates; ++i)
    {
        capletErrorsInSds[i]= (results[i]-approxCapletPrices[i])/errors[i];
        swaptionErrorsInSds[i]= (results[i+numberBigRates]-approxSwaptionPrices[i])/errors[i+numberBigRates];
    }

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> capletTolerance = 4;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> swaptionTolerance = 4;


    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; numberBigRates; ++i) {
        <span class="keywordflow">if</span> (fabs(capletErrorsInSds[i]) &gt; capletTolerance) {
            BOOST_FAIL(<a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot;caplet , approx price &quot;</span> &lt;&lt;
                approxCapletPrices[i] &lt;&lt;
                <span class="stringliteral">&quot;, \t simulation price &quot;</span> &lt;&lt; results[i] &lt;&lt;
                <span class="stringliteral">&quot;, \t error in sds &quot;</span> &lt;&lt; capletErrorsInSds[i]);
        }
    }
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; numberBigRates; ++i) {
        <span class="keywordflow">if</span> (fabs(swaptionErrorsInSds[i]) &gt; swaptionTolerance) {
            BOOST_FAIL(<a class="code" href="group__manips.html#ga9645f8136bf2eabd3bca2955ce5be730" title="outputs naturals as 1st, 2nd, 3rd...">io::ordinal</a>(i+1) &lt;&lt; <span class="stringliteral">&quot;swaption, approx price &quot;</span> &lt;&lt;
                approxSwaptionPrices[i] &lt;&lt;
                <span class="stringliteral">&quot;, \t simulation price &quot;</span> &lt;&lt; results[i+numberBigRates] &lt;&lt;
                <span class="stringliteral">&quot;, \t error in sds &quot;</span> &lt;&lt; swaptionErrorsInSds[i]);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3a03f7b086f2d538bb20c65b80e8f854"></a><!-- doxytag: member="MarketModelTest::testStochVolForwardsAndOptionlets" ref="a3a03f7b086f2d538bb20c65b80e8f854" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_market_model_test.html#a3a03f7b086f2d538bb20c65b80e8f854">MarketModelTest::testStochVolForwardsAndOptionlets</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04493">4493</a> of file <a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a>.</p>

<p>References <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00127">anonymous_namespace{marketmodel.cpp}::accruals</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00053">QuantLib::MarketModelComposite::add()</a>, <a class="el" href="option_8hpp_source.html#l00039">QuantLib::Option::Call</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00133">anonymous_namespace{marketmodel.cpp}::displacement</a>, <a class="el" href="analytichestonengine_8cpp_source.html#l00329">QuantLib::AnalyticHestonEngine::doCalculation()</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00028">QuantLib::MarketModelComposite::evolution()</a>, <a class="el" href="evolutiondescription_8cpp_source.html#l00089">QuantLib::EvolutionDescription::evolutionTimes()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00284">anonymous_namespace{marketmodel.cpp}::ExponentialCorrelationFlatVolatility</a>, <a class="el" href="compositeproduct_8cpp_source.html#l00082">QuantLib::MarketModelComposite::finalize()</a>, <a class="el" href="analytichestonengine_8hpp_source.html#l00084">QuantLib::AnalyticHestonEngine::Gatheral</a>, <a class="el" href="analytichestonengine_8cpp_source.html#l00474">QuantLib::AnalyticHestonEngine::Integration::gaussLaguerre()</a>, <a class="el" href="test-suite_2utilities_8hpp_source.html#l00039">LENGTH</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00302">anonymous_namespace{marketmodel.cpp}::makeMarketModel()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00387">anonymous_namespace{marketmodel.cpp}::makeMeasure()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00289">anonymous_namespace{marketmodel.cpp}::marketModelTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00372">anonymous_namespace{marketmodel.cpp}::measureTypeToString()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00370">anonymous_namespace{marketmodel.cpp}::MoneyMarket</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::paymentTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00142">anonymous_namespace{marketmodel.cpp}::printReport_</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00126">anonymous_namespace{marketmodel.cpp}::rateTimes</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00140">anonymous_namespace{marketmodel.cpp}::seed_</a>, <a class="el" href="inflationvolatility_8cpp_source.html#l00105">anonymous_namespace{inflationvolatility.cpp}::setup()</a>, <a class="el" href="distributions_8cpp_source.html#l00034">anonymous_namespace{distributions.cpp}::sigma</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00270">anonymous_namespace{marketmodel.cpp}::simulate()</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00369">anonymous_namespace{marketmodel.cpp}::Terminal</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00134">anonymous_namespace{marketmodel.cpp}::todaysDiscounts</a>, <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00130">anonymous_namespace{marketmodel.cpp}::todaysForwards</a>, and <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l00135">anonymous_namespace{marketmodel.cpp}::volatilities</a>.</p>

<p>Referenced by <a class="el" href="test-suite_2marketmodel_8cpp_source.html#l04774">suite()</a>.</p>
<div class="fragment"><pre class="fragment">                                                        {

    BOOST_MESSAGE(<span class="stringliteral">&quot;Testing exact repricing of &quot;</span>
        <span class="stringliteral">&quot;forwards and optionlets &quot;</span>
        <span class="stringliteral">&quot;in a stochastic vol displaced diffusion forward rate market model...&quot;</span>);

    <a class="code" href="namespaceanonymous__namespace_02inflationvolatility_8cpp_03.html#a25b6a6f5ceb73352aa6cc406240acd02">setup</a>();

    std::vector&lt;Rate&gt; forwardStrikes(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;Payoff&gt; &gt; optionletPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    std::vector&lt;boost::shared_ptr&lt;PlainVanillaPayoff&gt; &gt;
        displacedPayoffs(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size());
    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i&lt;<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size(); ++i)
    {
        forwardStrikes[i] = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i] + 0.01;
        optionletPayoffs[i] = boost::shared_ptr&lt;Payoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]));
        displacedPayoffs[i] = boost::shared_ptr&lt;PlainVanillaPayoff&gt;(<span class="keyword">new</span>
            <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>));
    }

    <a class="code" href="class_quant_lib_1_1_multi_step_forwards.html">MultiStepForwards</a> forwards(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, forwardStrikes);
    <a class="code" href="class_quant_lib_1_1_multi_step_optionlets.html">MultiStepOptionlets</a> optionlets(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>,
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#aa8aaf35eaadd679bb70c20c619c23337">paymentTimes</a>, optionletPayoffs);

    <a class="code" href="class_quant_lib_1_1_multi_product_composite.html" title="Composition of one or more market-model products.">MultiProductComposite</a> product;
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(forwards);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a7fb546a63d60babb945d3bac04068d38">add</a>(optionlets);
    product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#ac2a805f7801a3077c558a7be2f315ac2">finalize</a>();

    <a class="code" href="class_quant_lib_1_1_evolution_description.html" title="Market-model evolution description.">EvolutionDescription</a> evolution = product.<a class="code" href="class_quant_lib_1_1_market_model_composite.html#a0b45c01fcb6e82de5eb951ccccd9aece">evolution</a>();

    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65f">MarketModelType</a> marketModels[] =
    {
        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a59d1e3c81f3b467422c6d5845714e65fa657bbf7e3fa25bd6f471a1d87052a43a">ExponentialCorrelationFlatVolatility</a>
    };

    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> firstVolatilityFactor = 2;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> volatilityFactorStep = 2;

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> meanLevel=1.0;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> reversionSpeed=1.0;

    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volVar=1;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v0=1.0;
    <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> numberSubSteps=8;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> w1=0.5;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> w2=0.5;
    <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> cutPoint = 1.5;

    boost::shared_ptr&lt;MarketModelVolProcess&gt; volProcess(<span class="keyword">new</span>
                        <a class="code" href="class_quant_lib_1_1_square_root_andersen.html">SquareRootAndersen</a>(meanLevel,
                             reversionSpeed,
                             volVar,
                             v0,
                             evolution.<a class="code" href="class_quant_lib_1_1_evolution_description.html#acfce18fa0ad78b0360955701f94e29d3">evolutionTimes</a>(),
                             numberSubSteps,
                             w1,
                             w2,
                             cutPoint));

    <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> j=0; j&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(marketModels); j++)
    {

        <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> testedFactors[] = {1, 2, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size()};
        <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> m=0; m&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(testedFactors); ++m) {
            <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> factors = testedFactors[m];

            <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccb">MeasureType</a> measures[] = { <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccbab9969f099e4764242ba63bd8d99604f0">MoneyMarket</a>, <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#adbd9b6b7a400423199c36946cf557ccba6f28481dc98c0a4bb1c59693c180de71">Terminal</a> };

            <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> k=0; k&lt;<a class="code" href="test-suite_2utilities_8hpp.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(measures); k++)
            {
                std::vector&lt;Size&gt; numeraires = <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae8e15383c936c538a0a9c3f4f2b49c39">makeMeasure</a>(product, measures[k]);

                <span class="keywordtype">bool</span> logNormal = <span class="keyword">true</span>;
                boost::shared_ptr&lt;MarketModel&gt; marketModel =
                    <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a091da86297252efd380deb7be10d780e">makeMarketModel</a>(logNormal, evolution, factors, marketModels[j]);


                <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> n=0; n&lt;1; n++)
                {
                    <a class="code" href="class_quant_lib_1_1_m_t_brownian_generator_factory.html">MTBrownianGeneratorFactory</a> generatorFactory(<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a187d192d54e2284d9ab82a89976d3d0a">seed_</a>);

                    boost::shared_ptr&lt;MarketModelEvolver&gt; evolver(<span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_s_v_d_d_fwd_rate_pc.html">SVDDFwdRatePc</a>(marketModel,
                                          generatorFactory,
                                          volProcess,
                                          firstVolatilityFactor,
                                          volatilityFactorStep,
                                          numeraires
                                          ));


                    std::ostringstream config;
                    config &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a29f89fb98476ca02de85d9edbe3ebaf1">marketModelTypeToString</a>(marketModels[j]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        factors &lt;&lt; (factors&gt;1 ? (factors==<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>.size() ? <span class="stringliteral">&quot; (full) factors, &quot;</span> : <span class="stringliteral">&quot; factors, &quot;</span>) : <span class="stringliteral">&quot; factor,&quot;</span>) &lt;&lt;
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a0f03f89d82a7e4d094ed4c601aa9be32">measureTypeToString</a>(measures[k]) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;SVDDFwdRatePc&quot;</span> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt;
                        <span class="stringliteral">&quot;MT BGF&quot;</span>;
                    <span class="keywordflow">if</span> (<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae1457cd78b82c6ed8740c734f40aad38">printReport_</a>)
                        BOOST_MESSAGE(<span class="stringliteral">&quot;    &quot;</span> &lt;&lt; config.str());

                    boost::shared_ptr&lt;SequenceStatisticsInc&gt; stats =
                        <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad8f9d16a88ed89268db6d146ee54ac26">simulate</a>(evolver, product);

                    std::vector&lt;Real&gt; <a class="code" href="class_instr_1_1results.html">results</a> = stats-&gt;mean();
                    std::vector&lt;Real&gt; errors = stats-&gt;errorEstimate();


                    <span class="comment">// check forwards</span>


                       <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(); ++i)
                       {
                           <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> trueValue =  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i]- <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1]*(1+ forwardStrikes[i]*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>[i]);
                           <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = results[i] - trueValue;
                           <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorSds = error/ errors[i];

                           <span class="keywordflow">if</span> (fabs(errorSds) &gt; 3.5)
                               BOOST_FAIL(<span class="stringliteral">&quot;error in sds: &quot;</span> &lt;&lt; errorSds &lt;&lt; <span class="stringliteral">&quot; for forward &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; in SV LMM test. True value:&quot;</span> &lt;&lt; trueValue &lt;&lt; <span class="stringliteral">&quot;, actual value: &quot;</span> &lt;&lt; results[i] &lt;&lt; <span class="stringliteral">&quot; , standard error &quot;</span> &lt;&lt; errors[i]);



                       }

                       <span class="keywordflow">for</span> (<a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> i=0; i &lt; <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size(); ++i)
                       {

                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> volCoeff =  <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1bdbbd21f242eccd6cdf86cac0be7277">volatilities</a>[i];
<span class="comment">//                                  sqrt(marketModel-&gt;totalCovariance(i)[i][i]/evolution.evolutionTimes()[i]);</span>
                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> theta = volCoeff*volCoeff*meanLevel;
                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kappa = reversionSpeed;
                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> = volCoeff*volVar;
                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> rho = 0.0;
                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> v1 = v0*volCoeff*volCoeff;




                              boost::shared_ptr&lt;StrikedTypePayoff&gt; payoff(
                                              <span class="keyword">new</span> <a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>(Option::Call, forwardStrikes[i]));



                              <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> trueValue =0.0;
                              <a class="code" href="namespace_quant_lib.html#af4cc4ef40b52c17cc455ead2a97aedb3" title="size of a container">Size</a> evaluations =0;

                              AnalyticHestonEngine::doCalculation(1.0, <span class="comment">// no discounting</span>
                                             1.0 ,<span class="comment">// no discounting</span>
                                             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>,
                                             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a4e902ebd99fc551946add6d20e37c81e">todaysForwards</a>[i]+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a05afb7d58ffec9268f5790b701c57567">displacement</a>,
                                             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a814ea6a1e55b85c243a5bc1bc373871f">rateTimes</a>[i],
                                             kappa,
                                             theta,
                                             sigma,
                                             v1,
                                             rho,
                                             *payoff,
                                             AnalyticHestonEngine::Integration::gaussLaguerre(),
<span class="comment">//                                             AnalyticHestonEngine::Integration::gaussLobatto(1e-8, 1e-8),</span>
                                             AnalyticHestonEngine::Gatheral,
                                             0,
                                             trueValue,
                                             evaluations);


                                trueValue *= <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>[i]*<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a1d2762d314cb098babbb39b38e5239eb">todaysDiscounts</a>[i+1];

                       <span class="comment">//        trueValue =</span>
                      <span class="comment">//                              BlackCalculator(displacedPayoffs[i],</span>
                      <span class="comment">//                                                todaysForwards[i]+displacement,</span>
                      <span class="comment">//                                             volatilities[i]*std::sqrt(rateTimes[i]),</span>
                     <span class="comment">//                                              todaysDiscounts[i+1]*accruals[i]).value();</span>


                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> error = results[i+ <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size()] - trueValue;
                                <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> errorSds = error/ errors[i];

                                <span class="keywordflow">if</span> (fabs(errorSds) &gt; 4)
                                    BOOST_FAIL(<span class="stringliteral">&quot;error in sds: &quot;</span> &lt;&lt; errorSds &lt;&lt; <span class="stringliteral">&quot; for caplet &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; in SV LMM test. True value:&quot;</span> &lt;&lt; trueValue &lt;&lt; <span class="stringliteral">&quot;, actual value: &quot;</span> &lt;&lt; results[i+ <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a139a019e3cf45420817a818ca8eeafd3">accruals</a>.size()] &lt;&lt; <span class="stringliteral">&quot; , standard error &quot;</span> &lt;&lt; errors[i]);




                       }






                }
            }
        }
    }
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>/home/deriversatile/QuantLib/QuantLibQt/test-suite/<a class="el" href="test-suite_2marketmodel_8hpp_source.html">marketmodel.hpp</a></li>
<li>/home/deriversatile/QuantLib/QuantLibQt/test-suite/<a class="el" href="test-suite_2marketmodel_8cpp_source.html">marketmodel.cpp</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_market_model_test.html">MarketModelTest</a>      </li>

    <li class="footer">Generated on Sat Aug 25 2012 13:51:01 for QuantLib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
