<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>QuantLib: /home/deriversatile/QuantLib/QuantLibQt/ql/experimental/barrieroption/perturbativebarrieroptionengine.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">QuantLib
   &#160;<span id="projectnumber">1.3</span>
   </div>
   <div id="projectbrief">ql1-3</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('perturbativebarrieroptionengine_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">perturbativebarrieroptionengine.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="perturbativebarrieroptionengine_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- mode: c++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment"> Copyright (C) 2008 Lorella Fatone</span>
<a name="l00005"></a>00005 <span class="comment"> Copyright (C) 2008 Maria Cristina Recchioni</span>
<a name="l00006"></a>00006 <span class="comment"> Copyright (C) 2008 Francesco Zirilli</span>
<a name="l00007"></a>00007 <span class="comment"> Copyright (C) 2008 StatPro Italia srl</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment"> This file is part of QuantLib, a free-software/open-source library</span>
<a name="l00010"></a>00010 <span class="comment"> for financial quantitative analysts and developers - http://quantlib.org/</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment"> QuantLib is free software: you can redistribute it and/or modify it</span>
<a name="l00013"></a>00013 <span class="comment"> under the terms of the QuantLib license.  You should have received a</span>
<a name="l00014"></a>00014 <span class="comment"> copy of the license along with this program; if not, please email</span>
<a name="l00015"></a>00015 <span class="comment"> &lt;quantlib-dev@lists.sf.net&gt;. The license is also available online at</span>
<a name="l00016"></a>00016 <span class="comment"> &lt;http://quantlib.org/license.shtml&gt;.</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment"> This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00019"></a>00019 <span class="comment"> ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> FOR A PARTICULAR PURPOSE.  See the license for more details.</span>
<a name="l00021"></a>00021 <span class="comment">*/</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="perturbativebarrieroptionengine_8hpp.html" title="perturbative barrier-option engine">ql/experimental/barrieroption/perturbativebarrieroptionengine.hpp</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="exercise_8hpp.html" title="Option exercise classes and payoff function.">ql/exercise.hpp</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="errors_8hpp.html" title="Classes and functions for error handling.">ql/errors.hpp</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;boost/function.hpp&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">using namespace </span>std;
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="perturbativebarrieroptionengine_8cpp.html#ac89d5f8a358eb8a1abdcd0fcef134f1a">00032</a> <span class="preprocessor">#define SIGN(a,b) ((b) &gt;= 0.0 ? fabs(a) : -fabs(a))</span>
<a name="l00033"></a><a class="code" href="perturbativebarrieroptionengine_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define ABS(x) (((x) &lt; 0) ? -(x) : (x))</span>
<a name="l00034"></a><a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define POW(x,y) pow( (double) (x), (double) (y))</span>
<a name="l00035"></a><a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define PI 3.14159265358979324</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html">00037</a> <span class="keyword">namespace </span>{
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>, <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>, <span class="keywordtype">double</span> rho);
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#acd04715fa1d11a3e04068ed1541d4cfd">00041</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af4a99f687d81ba38ce7204c8defbf3e8">H1</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6464138479012cf12084a0d6c2bf785d">H2</a>,  <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aad31cbfa93a6ffef32d2bfbf36afebb8">H3</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae37fba9c30b2ce83c2d5f8b4af48fecf">R23</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af3a3d772b5497d7e840ed04b020b3753">RUA</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a2aacb83ce8c784cd75802afaf0112bb0">RUB</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd7073d8df2267b123de5f5d8b049172">AR</a>, <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#acd04715fa1d11a3e04068ed1541d4cfd">RUC</a>;
<a name="l00042"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6d43c7e73206b8c19b189803b6a50449">00042</a>     <span class="keywordtype">int</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6d43c7e73206b8c19b189803b6a50449">NUC</a>;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044     <span class="comment">// standard normal density function</span>
<a name="l00045"></a>00045     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa081b5a3b7ab1aa27ab243b2fa4e85e1">ndf</a>(<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="comment">// standard normal cumulative distribution function</span>
<a name="l00048"></a>00048     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a92f65f969a12afdf46cdcd5ec12534cb">nc</a>(<span class="keywordtype">double</span> x);
<a name="l00049"></a>00049     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(<span class="keywordtype">double</span> Z);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051     <span class="comment">// Functions used to compute the first order approximation</span>
<a name="l00052"></a>00052     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> gm);
<a name="l00053"></a>00053     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(<span class="keywordtype">double</span> p, <span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm);
<a name="l00054"></a>00054     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b,
<a name="l00055"></a>00055                  <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>, <span class="keywordtype">double</span> gm);
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <span class="comment">// Functions used to compute the second order approximation</span>
<a name="l00058"></a>00058     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(<span class="keywordtype">double</span> limit[4],<span class="keywordtype">double</span> sigmarho[4], <span class="keywordtype">int</span> idx);
<a name="l00059"></a>00059     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#afdff3da0091a96a033a55c5946217728">ddvv</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p, <span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> a,
<a name="l00060"></a>00060                 <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> gm);
<a name="l00061"></a>00061     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm);
<a name="l00062"></a>00062     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,
<a name="l00063"></a>00063                <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,<span class="keywordtype">double</span> gm);
<a name="l00064"></a>00064     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> ax, <span class="keywordtype">double</span> bx,
<a name="l00065"></a>00065                 <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>, <span class="keywordtype">double</span> gm);
<a name="l00066"></a>00066     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm);
<a name="l00067"></a>00067     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm);
<a name="l00068"></a>00068     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(<span class="keywordtype">int</span> jj,<span class="keywordtype">double</span> limit[4],<span class="keywordtype">double</span> sigmarho[4],<span class="keywordtype">double</span> epsi);
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a83b7af85879e60d95a0cbadd8d033c01">00070</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a83b7af85879e60d95a0cbadd8d033c01">BarrierUPD</a>(<span class="keywordtype">double</span> kprice, <span class="keywordtype">double</span> stock, <span class="keywordtype">double</span> hbarr,
<a name="l00071"></a>00071                       <span class="keywordtype">double</span> taumin, <span class="keywordtype">double</span> taumax, <span class="keywordtype">int</span> iord, <span class="keywordtype">int</span> igm,
<a name="l00072"></a>00072                       boost::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keywordtype">double</span>)&gt; integr,
<a name="l00073"></a>00073                       boost::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keywordtype">double</span>)&gt; integalpha,
<a name="l00074"></a>00074                       boost::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>, <span class="keywordtype">double</span>)&gt; integs,
<a name="l00075"></a>00075                       boost::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>)&gt; alpha,
<a name="l00076"></a>00076                       boost::function&lt;<span class="keywordtype">double</span>(<span class="keywordtype">double</span>)&gt; sigmaq)
<a name="l00077"></a>00077     {
<a name="l00078"></a>00078         <span class="keywordtype">double</span> v0=0.0, v1=0.0, v1p=0.0, v2p=0.0, v2pp=0.0, gm=0.0;
<a name="l00079"></a>00079         <span class="keywordtype">int</span> i=0,j=0;
<a name="l00080"></a>00080         <span class="keywordtype">double</span> tmp=0.0, e1=0.0, e2=0.0, e3=0.0, e4=0.0;
<a name="l00081"></a>00081         <span class="keywordtype">double</span> xstar=0.0, s0=0.0;
<a name="l00082"></a>00082         <span class="keywordtype">double</span> sigmat=0.0, disc=0.0, d1=0.0,d2=0.0,d3=0.0,d4=0.0;
<a name="l00083"></a>00083         <span class="keywordtype">double</span> et=0.0,tt=0.0, <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>=0.0,p=0.0;
<a name="l00084"></a>00084         <span class="keywordtype">int</span> npoint,npoint2;
<a name="l00085"></a>00085         <span class="keyword">static</span> <span class="keywordtype">double</span> pi= 3.14159265358979324;
<a name="l00086"></a>00086         <span class="keywordtype">double</span> dsqpi;
<a name="l00087"></a>00087         <span class="keywordtype">double</span> caux=0.0,ccaux=0.0;
<a name="l00088"></a>00088         <span class="keywordtype">double</span> auxnew=0.0;
<a name="l00089"></a>00089         <span class="keywordtype">double</span> x=0.0,b=0.0,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>=0.0;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="keywordflow">if</span>(igm==0) {
<a name="l00092"></a>00092             gm=0.0;
<a name="l00093"></a>00093         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(igm==1) {
<a name="l00094"></a>00094             gm=integalpha(taumin,taumax)/(0.5*integs(taumin,taumax));
<a name="l00095"></a>00095         } <span class="keywordflow">else</span> {
<a name="l00096"></a>00096             igm=0;
<a name="l00097"></a>00097             gm=0.0;
<a name="l00098"></a>00098         }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         <span class="comment">/*</span>
<a name="l00101"></a>00101 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00102"></a>00102 <span class="comment">          !!                                 !!</span>
<a name="l00103"></a>00103 <span class="comment">          !! xstar=min(0,log(kprice/hbarr))  !!</span>
<a name="l00104"></a>00104 <span class="comment">          !!                                 !!</span>
<a name="l00105"></a>00105 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00106"></a>00106 <span class="comment">        */</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         xstar=log(kprice/hbarr);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keywordflow">if</span>(xstar&gt;0.0) xstar=0.0;
<a name="l00111"></a>00111         sigmat=integs(taumin,taumax);
<a name="l00112"></a>00112         disc=-integr(taumin,taumax);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114         <span class="comment">/*</span>
<a name="l00115"></a>00115 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00116"></a>00116 <span class="comment">          !!    Change of variable            !!</span>
<a name="l00117"></a>00117 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00118"></a>00118 <span class="comment">        */</span>
<a name="l00119"></a>00119         s0=stock/hbarr;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         <span class="comment">/*</span>
<a name="l00122"></a>00122 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00123"></a>00123 <span class="comment">          !!                                       !!</span>
<a name="l00124"></a>00124 <span class="comment">          !! Compute the zero-th order term P_0    !!</span>
<a name="l00125"></a>00125 <span class="comment">          !!                                       !!</span>
<a name="l00126"></a>00126 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00127"></a>00127 <span class="comment">        */</span>
<a name="l00128"></a>00128         d1=(xstar-log(s0)+(1.0-gm)*0.5*sigmat)/sqrt(sigmat);
<a name="l00129"></a>00129         d2=(xstar+log(s0)+(1.0-gm)*0.5*sigmat)/sqrt(sigmat);
<a name="l00130"></a>00130         d3=(xstar-log(s0)-(1.0+gm)*0.5*sigmat)/sqrt(sigmat);
<a name="l00131"></a>00131         d4=(xstar+log(s0)-(1.0+gm)*0.5*sigmat)/sqrt(sigmat);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         e1=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(d1);
<a name="l00134"></a>00134         e2=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(d2);
<a name="l00135"></a>00135         e3=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(d3);
<a name="l00136"></a>00136         e4=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(d4);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         v0=kprice*e1-kprice*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(s0,(1.0-gm))*e2;
<a name="l00139"></a>00139         v0=v0+exp(gm*0.5*sigmat)*(-hbarr*s0*e3+hbarr*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(s0,-gm)*e4);
<a name="l00140"></a>00140         v0=v0*exp(disc);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         <span class="keywordflow">if</span>(iord==0) <span class="keywordflow">return</span> v0;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         <span class="comment">/*</span>
<a name="l00145"></a>00145 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00146"></a>00146 <span class="comment">          !!                                           !!</span>
<a name="l00147"></a>00147 <span class="comment">          !! Compute the first order term  P_1         !!</span>
<a name="l00148"></a>00148 <span class="comment">          !!                                           !!</span>
<a name="l00149"></a>00149 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00150"></a>00150 <span class="comment">        */</span>
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         npoint=1000;
<a name="l00153"></a>00153         npoint2=100;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>=(taumax-taumin)/<span class="keywordtype">double</span>(npoint);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         tt=0.5*integs(taumin,taumax);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         x=log(s0);
<a name="l00160"></a>00160         et=exp(0.5*(1.0-gm)*x);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         dsqpi=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(pi,0.5);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         v1=0.0;
<a name="l00165"></a>00165         <span class="keywordflow">for</span>( i=1;i&lt;=npoint;i++) {
<a name="l00166"></a>00166             v1p=0.0;
<a name="l00167"></a>00167             tmp=taumin+<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>*double(2*i-1)*0.5;
<a name="l00168"></a>00168             p=0.5*integs(tmp,taumax);
<a name="l00169"></a>00169             <span class="comment">/*</span>
<a name="l00170"></a>00170 <span class="comment">              !!</span>
<a name="l00171"></a>00171 <span class="comment">              !! Function E(p,tt,a,b,gm)</span>
<a name="l00172"></a>00172 <span class="comment">              !!</span>
<a name="l00173"></a>00173 <span class="comment">            */</span>
<a name="l00174"></a>00174             caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(p,tt,x,xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(p,tt,x,-xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(p,tt,-x,xstar,gm);
<a name="l00175"></a>00175             ccaux=ccaux-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(p,tt,-x,-xstar,gm);
<a name="l00176"></a>00176             auxnew=ccaux*(-kprice*exp(-xstar*0.5*(1.0-gm))+hbarr*exp(xstar*0.5*(1.0+gm)));
<a name="l00177"></a>00177             v1p=v1p+auxnew;
<a name="l00178"></a>00178             <span class="comment">/*</span>
<a name="l00179"></a>00179 <span class="comment">              !!</span>
<a name="l00180"></a>00180 <span class="comment">              !! Function L(p,tt,a,b,c,gm)</span>
<a name="l00181"></a>00181 <span class="comment">              !!</span>
<a name="l00182"></a>00182 <span class="comment">            */</span>
<a name="l00183"></a>00183             b=gm-1.0;
<a name="l00184"></a>00184             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>=-xstar;
<a name="l00185"></a>00185             ccaux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,-x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm);
<a name="l00186"></a>00186             auxnew=kprice*(1.0-gm)*ccaux;
<a name="l00187"></a>00187             v1p=v1p+auxnew;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189             b=-(gm+1.0);
<a name="l00190"></a>00190             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>=xstar;
<a name="l00191"></a>00191             ccaux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,-x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm);
<a name="l00192"></a>00192             auxnew=-exp(gm*p)*hbarr*ccaux;
<a name="l00193"></a>00193             v1p=v1p+auxnew;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195             b=(gm+1.0);
<a name="l00196"></a>00196             <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>=-xstar;
<a name="l00197"></a>00197             ccaux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(p,tt,-x,b,<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,gm);
<a name="l00198"></a>00198             auxnew=exp(gm*p)*hbarr*gm*ccaux;
<a name="l00199"></a>00199             v1p=v1p+auxnew;
<a name="l00200"></a>00200             <span class="comment">/*</span>
<a name="l00201"></a>00201 <span class="comment">              !!</span>
<a name="l00202"></a>00202 <span class="comment">              !! Function F(p,tt,a,b,c,gm)</span>
<a name="l00203"></a>00203 <span class="comment">              !!</span>
<a name="l00204"></a>00204 <span class="comment">            */</span>
<a name="l00205"></a>00205             b=gm-1.0;
<a name="l00206"></a>00206             auxnew=-kprice*(1.0-gm)*(<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(p,tt,x,b,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(p,tt,-x,b,gm));
<a name="l00207"></a>00207             v1p=v1p+auxnew;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209             b=gm+1.0;
<a name="l00210"></a>00210             auxnew=-exp(gm*p)*gm*hbarr*(<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(p,tt,x,b,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(p,tt,-x,b,gm));
<a name="l00211"></a>00211             v1p=v1p+auxnew;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213             v1=v1+(alpha(tmp)-gm*0.5*sigmaq(tmp))*v1p;
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         v1=exp(disc)*et*v1*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>/(dsqpi*2.0);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         <span class="keywordflow">if</span>(iord==1) <span class="keywordflow">return</span> v0+v1;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="comment">/*</span>
<a name="l00221"></a>00221 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00222"></a>00222 <span class="comment">          !!                                          !!</span>
<a name="l00223"></a>00223 <span class="comment">          !! Compute the second order term P_2        !!</span>
<a name="l00224"></a>00224 <span class="comment">          !!                                          !!</span>
<a name="l00225"></a>00225 <span class="comment">          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00226"></a>00226 <span class="comment">        */</span>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="keywordtype">double</span> v2,dtp, tmp1,s,caux2;
<a name="l00229"></a>00229         v2=0.0;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">for</span>(i=1;i&lt;=npoint;i++) {
<a name="l00232"></a>00232             v2p=0.0;
<a name="l00233"></a>00233             tmp=taumin+<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>*(double)(2*i-1)*0.5;
<a name="l00234"></a>00234             p=0.5*integs(tmp,taumax);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236             dtp=(taumax-tmp)/(<span class="keywordtype">double</span>)(npoint2);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238             <span class="keywordflow">for</span>(j=1;j&lt;=npoint2; j++) {
<a name="l00239"></a>00239                 v2pp=0.0;
<a name="l00240"></a>00240                 tmp1=tmp+dtp*(double)(2*j-1)*0.50;
<a name="l00241"></a>00241                 s=0.50*integs(tmp1,taumax);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243                 caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,-x,-1.0+gm,-xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,x,-1.0+gm,-xstar,gm);
<a name="l00244"></a>00244                 v2pp=caux*kprice*(1.0-gm);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246                 caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,-x,-1.0-gm,xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,x,-1.0-gm,xstar,gm);
<a name="l00247"></a>00247                 v2pp=v2pp-exp(gm*s)*hbarr*caux;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                 caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,-x,1.0+gm,-xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(s,p,tt,x,1.0+gm,-xstar,gm);
<a name="l00250"></a>00250                 v2pp=v2pp+exp(gm*s)*gm*hbarr*caux;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252                 caux=+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,-x,xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,x,xstar,gm);
<a name="l00253"></a>00253                 caux=caux+(<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,-x,-xstar,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,x,-xstar,gm));
<a name="l00254"></a>00254                 caux2=hbarr*exp(0.5*(1.0+gm)*xstar)-kprice*exp(-0.5*(1.0-gm)*xstar);
<a name="l00255"></a>00255                 v2pp=v2pp+caux2*caux;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                 caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(s,p,tt,-x,-1.0+gm,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(s,p,tt,x,-1.0+gm,gm);
<a name="l00258"></a>00258                 v2pp=v2pp-(1.0-gm)*kprice*caux;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260                 caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(s,p,tt,-x,1.0+gm,gm)-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(s,p,tt,x,1.0+gm,gm);
<a name="l00261"></a>00261                 v2pp=v2pp-exp(gm*s)*gm*hbarr*caux;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263                 v2pp=v2pp*0.5*(1.0-gm);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,-x,-1.0+gm,-xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,x,-1.0+gm,-xstar,gm);
<a name="l00266"></a>00266                 v2pp=v2pp+caux*kprice*(1.0-gm);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,-x,-1.0-gm,xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,x,-1.0-gm,xstar,gm);
<a name="l00269"></a>00269                 v2pp=v2pp-exp(gm*s)*hbarr*caux;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,-x,1.0+gm,-xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(s,p,tt,x,1.0+gm,-xstar,gm);
<a name="l00272"></a>00272                 v2pp=v2pp+exp(gm*s)*gm*hbarr*caux;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#afdff3da0091a96a033a55c5946217728">ddvv</a>(s,p,tt,-x,xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#afdff3da0091a96a033a55c5946217728">ddvv</a>(s,p,tt,x,xstar,gm);
<a name="l00275"></a>00275                 caux=caux+(-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,-x,-xstar,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(s,p,tt,x,-xstar,gm));
<a name="l00276"></a>00276                 caux2=hbarr*exp(0.5*(1.0+gm)*xstar)-kprice*exp(-0.5*(1-gm)*xstar);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278                 v2pp=v2pp+caux2*caux;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(s,p,tt,-x,-1+gm,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(s,p,tt,x,-1+gm,gm);
<a name="l00281"></a>00281                 v2pp=v2pp-(1.0-gm)*kprice*caux;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283                 caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(s,p,tt,-x,1.0+gm,gm)+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(s,p,tt,x,1.0+gm,gm);
<a name="l00284"></a>00284                 v2pp=v2pp-exp(gm*s)*gm*hbarr*caux;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286                 v2p=v2p+(alpha(tmp1)-gm*0.5*sigmaq(tmp1))*v2pp;
<a name="l00287"></a>00287             }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289             v2=v2+v2p*(alpha(tmp)-gm*0.5*sigmaq(tmp))*dtp;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         v2=exp(disc)*et*v2*<a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02yieldtermstructure_8cpp_03.html#a380ac4fa89b26a124e27dfdb4dfdc6a5">dt</a>;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="keywordflow">return</span> v0+v1+v2;
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">// standard normal density function</span>
<a name="l00299"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa081b5a3b7ab1aa27ab243b2fa4e85e1">00299</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa081b5a3b7ab1aa27ab243b2fa4e85e1">ndf</a>(<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>) {
<a name="l00300"></a>00300         <span class="keywordflow">return</span> 0.398942280401433*exp(-t*t/2);
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <span class="comment">// standard normal cumulative distribution function</span>
<a name="l00304"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a92f65f969a12afdf46cdcd5ec12534cb">00304</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a92f65f969a12afdf46cdcd5ec12534cb">nc</a>(<span class="keywordtype">double</span> x){
<a name="l00305"></a>00305         <span class="keywordtype">double</span> result;
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (x&lt;-7.) {
<a name="l00307"></a>00307             result = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa081b5a3b7ab1aa27ab243b2fa4e85e1">ndf</a>(x)/sqrt(1.+x*x);
<a name="l00308"></a>00308         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x&gt;7.) {
<a name="l00309"></a>00309             result = 1. - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a92f65f969a12afdf46cdcd5ec12534cb">nc</a>(-x);
<a name="l00310"></a>00310         } <span class="keywordflow">else</span> {
<a name="l00311"></a>00311             result = 0.2316419;
<a name="l00312"></a>00312             <span class="keyword">static</span> <span class="keywordtype">double</span> a[5] = {0.31938153,-0.356563782,1.781477937,-1.821255978,1.330274429};
<a name="l00313"></a>00313             result=1./(1+result*fabs(x));
<a name="l00314"></a>00314             result=1-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa081b5a3b7ab1aa27ab243b2fa4e85e1">ndf</a>(x)*(result*(a[0]+result*(a[1]+result*(a[2]+result*(a[3]+result*a[4])))));
<a name="l00315"></a>00315             <span class="keywordflow">if</span> (x&lt;=0.) result=1.-result;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317         <span class="keywordflow">return</span> result;
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">00321</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(<span class="keywordtype">double</span> Z){
<a name="l00322"></a>00322         <span class="comment">/*</span>
<a name="l00323"></a>00323 <span class="comment">         *     Normal distribution probabilities accurate to 1D-15.</span>
<a name="l00324"></a>00324 <span class="comment">         *     Z = number of standard deviations from the mean.</span>
<a name="l00325"></a>00325 <span class="comment">         *</span>
<a name="l00326"></a>00326 <span class="comment">         *     The software that computes the normal distribution</span>
<a name="l00327"></a>00327 <span class="comment">         *     probabilities has been developed by M.C. Recchioni</span>
<a name="l00328"></a>00328 <span class="comment">         *     based upon algorithm 5666 (Programmer Alan Miller)</span>
<a name="l00329"></a>00329 <span class="comment">         *     for the error function, taken from:</span>
<a name="l00330"></a>00330 <span class="comment">         *     Hart, J.F. et al, &#39;Computer Approximations&#39;, Wiley, 1968</span>
<a name="l00331"></a>00331 <span class="comment">         *</span>
<a name="l00332"></a>00332 <span class="comment">         */</span>
<a name="l00333"></a>00333         <span class="keywordtype">double</span> P0, P1, P2, P3, P4, P5, P6;
<a name="l00334"></a>00334         <span class="keywordtype">double</span> Q0, Q1, Q2, Q3, Q4, Q5, Q6, Q7;
<a name="l00335"></a>00335         <span class="keywordtype">double</span> P, EXPNTL, CUTOFF, ROOTPI, ZABS;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         P0 = 220.2068679123761;
<a name="l00338"></a>00338         P1 = 221.2135961699311;
<a name="l00339"></a>00339         P2 = 112.0792914978709;
<a name="l00340"></a>00340         P3 = 33.91286607838300;
<a name="l00341"></a>00341         P4 = 6.373962203531650;
<a name="l00342"></a>00342         P5 = 0.7003830644436881;
<a name="l00343"></a>00343         P6 = 0.03526249659989109;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         Q0 = 440.4137358247522;
<a name="l00346"></a>00346         Q1 = 793.8265125199484;
<a name="l00347"></a>00347         Q2 = 637.3336333788311;
<a name="l00348"></a>00348         Q3 = 296.5642487796737;
<a name="l00349"></a>00349         Q4 = 86.78073220294608;
<a name="l00350"></a>00350         Q5 = 16.064177579206950;
<a name="l00351"></a>00351         Q6 = 1.7556671631826420;
<a name="l00352"></a>00352         Q7 = 0.088388347648318440;
<a name="l00353"></a>00353         ROOTPI = 2.506628274631001;
<a name="l00354"></a>00354         CUTOFF = 7.071067811865475;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         ZABS = fabs(Z);
<a name="l00357"></a>00357         <span class="comment">/*</span>
<a name="l00358"></a>00358 <span class="comment">          |Z| &gt; 37</span>
<a name="l00359"></a>00359 <span class="comment">        */</span>
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (ZABS &gt; 37)
<a name="l00361"></a>00361             P = 0;
<a name="l00362"></a>00362         <span class="keywordflow">else</span>
<a name="l00363"></a>00363         {
<a name="l00364"></a>00364             <span class="comment">/*</span>
<a name="l00365"></a>00365 <span class="comment">              |Z| &lt;= 37</span>
<a name="l00366"></a>00366 <span class="comment">            */</span>
<a name="l00367"></a>00367             EXPNTL =exp(-ZABS*ZABS/2);
<a name="l00368"></a>00368             <span class="comment">/*</span>
<a name="l00369"></a>00369 <span class="comment">              |Z| &lt; CUTOFF = 10/SQRT(2)</span>
<a name="l00370"></a>00370 <span class="comment">            */</span>
<a name="l00371"></a>00371             <span class="keywordflow">if</span> ( ZABS &lt; CUTOFF )
<a name="l00372"></a>00372                 P = EXPNTL*((((((P6*ZABS + P5)*ZABS + P4)*ZABS + P3)*ZABS+ P2)*ZABS + P1)*ZABS + P0)/(((((((Q7*ZABS + Q6)*ZABS + Q5)*ZABS + Q4)*ZABS + Q3)*ZABS + Q2)*ZABS + Q1)*ZABS + Q0);
<a name="l00373"></a>00373             <span class="comment">/*</span>
<a name="l00374"></a>00374 <span class="comment">              |Z| &gt;= CUTOFF.</span>
<a name="l00375"></a>00375 <span class="comment">            */</span>
<a name="l00376"></a>00376             <span class="keywordflow">else</span>
<a name="l00377"></a>00377                 P = EXPNTL/(ZABS + 1/(ZABS + 2/(ZABS + 3/(ZABS + 4/(ZABS + 0.65)))))/ROOTPI;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="keywordflow">if</span> ( Z &gt; 0 ) P = 1 - P;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="keywordflow">return</span>(P);
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="comment">//function needed to calculate the two dimensional cumulative distribution function</span>
<a name="l00388"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a18ee9929f01bcb3568544248b01ed6e4">00388</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a18ee9929f01bcb3568544248b01ed6e4">fxy</a>(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> rho) {
<a name="l00389"></a>00389         <span class="keywordtype">double</span> a_s;
<a name="l00390"></a>00390         <span class="keywordtype">double</span> b_s;
<a name="l00391"></a>00391         <span class="keywordtype">double</span> result;
<a name="l00392"></a>00392         a_s = a / sqrt(2 * (1 - rho * rho));
<a name="l00393"></a>00393         b_s = b / sqrt(2 * (1 - rho * rho));
<a name="l00394"></a>00394         result = exp(a_s * (2 * x - a_s) + b_s * (2 * y - b_s) + 2 * rho * (x - a_s) * (y - b_s));
<a name="l00395"></a>00395         <span class="keywordflow">return</span> result;
<a name="l00396"></a>00396     }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="comment">/*</span>
<a name="l00401"></a>00401 <span class="comment">      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00402"></a>00402 <span class="comment">      !!                                                              !!</span>
<a name="l00403"></a>00403 <span class="comment">      !! Functions needed to compute the  first order term  P_1       !!</span>
<a name="l00404"></a>00404 <span class="comment">      !!                                                              !!</span>
<a name="l00405"></a>00405 <span class="comment">      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00406"></a>00406 <span class="comment">    */</span>
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="comment">/*</span>
<a name="l00409"></a>00409 <span class="comment">      !!</span>
<a name="l00410"></a>00410 <span class="comment">      !! Function F(p,tt,a,b,gm)</span>
<a name="l00411"></a>00411 <span class="comment">      !!</span>
<a name="l00412"></a>00412 <span class="comment">    */</span>
<a name="l00413"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">00413</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd0702ab2efd15487a19263a556852ed">ff</a>(<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> gm) {
<a name="l00414"></a>00414         <span class="keywordtype">double</span> phid;
<a name="l00415"></a>00415         <span class="keywordtype">double</span> aa, caux;
<a name="l00416"></a>00416         <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         aa=-(b*p-b*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         caux=2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi,0.5)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00421"></a>00421         aa=b*b-(1.0-gm)*(1.0-gm);
<a name="l00422"></a>00422         aa=aa/4.0;
<a name="l00423"></a>00423         phid=exp(-0.5*a*b)*exp(aa*(tt-p))*caux;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         <span class="keywordflow">return</span> phid;
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="comment">/*</span>
<a name="l00429"></a>00429 <span class="comment">      !!</span>
<a name="l00430"></a>00430 <span class="comment">      !! Function  E(p,tt,a,b,gm)</span>
<a name="l00431"></a>00431 <span class="comment">      !!</span>
<a name="l00432"></a>00432 <span class="comment">    */</span>
<a name="l00433"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">00433</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(<span class="keywordtype">double</span> p, <span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm)
<a name="l00434"></a>00434     {
<a name="l00435"></a>00435         <span class="keywordtype">double</span> result;
<a name="l00436"></a>00436         <span class="keywordtype">double</span> aa,caux;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         aa=-(p*(a-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)+b*tt)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*p*tt*(tt-p),0.5);
<a name="l00439"></a>00439         caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         aa=exp(<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((a-b),2)/(4.0*tt))*exp(<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-gm),2)*tt/4.0)*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(tt,0.5);
<a name="l00442"></a>00442         result=caux/aa;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         <span class="keywordflow">return</span>(result);
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="comment">/*</span>
<a name="l00448"></a>00448 <span class="comment">      !!</span>
<a name="l00449"></a>00449 <span class="comment">      !! Fuction L(p,tt,a,b,c,gm)</span>
<a name="l00450"></a>00450 <span class="comment">      !!</span>
<a name="l00451"></a>00451 <span class="comment">    */</span>
<a name="l00452"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">00452</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a136be4926ac994114e726843fbfd0e9b">llold</a>(<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b,<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>, <span class="keywordtype">double</span> gm){
<a name="l00453"></a>00453         <span class="keywordtype">double</span> bvnd;
<a name="l00454"></a>00454         <span class="keywordtype">double</span> xx,yy,rho,caux;
<a name="l00455"></a>00455         <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00456"></a>00456         <span class="keywordtype">double</span> aa;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         xx=(-a+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00459"></a>00459         yy=(-a+b*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00460"></a>00460         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/tt,0.5);
<a name="l00461"></a>00461         aa=b*b-(1.0-gm)*(1.0-gm);
<a name="l00462"></a>00462         aa=aa/4.0;
<a name="l00463"></a>00463         caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         bvnd=2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi,0.5)*exp(-a*b*0.5)*exp(aa*(tt-p))*caux;
<a name="l00466"></a>00466         <span class="keywordflow">return</span>(bvnd);
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <span class="comment">/*</span>
<a name="l00470"></a>00470 <span class="comment">      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00471"></a>00471 <span class="comment">      !!                                                              !!</span>
<a name="l00472"></a>00472 <span class="comment">      !! Functions needed to compute the  second order term  P_2      !!</span>
<a name="l00473"></a>00473 <span class="comment">      !!                                                              !!</span>
<a name="l00474"></a>00474 <span class="comment">      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00475"></a>00475 <span class="comment">    */</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="comment">/*</span>
<a name="l00478"></a>00478 <span class="comment">      !!</span>
<a name="l00479"></a>00479 <span class="comment">      !! Function  D_E(s,p,tt,a,b,gm)</span>
<a name="l00480"></a>00480 <span class="comment">      !!</span>
<a name="l00481"></a>00481 <span class="comment">    */</span>
<a name="l00482"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">00482</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aa5c95c98bae41d2f28453830768d0660">dvv</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm)
<a name="l00483"></a>00483     {
<a name="l00484"></a>00484         <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00485"></a>00485         <span class="keywordtype">double</span> result;
<a name="l00486"></a>00486         <span class="keywordtype">double</span> aa,caux,caux1,caux2;
<a name="l00487"></a>00487         <span class="keywordtype">double</span> xx,yy,rho;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         aa=(a*p+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*p*tt*(tt-p),0.5);
<a name="l00490"></a>00490         caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492         aa=exp((a-b)*(a-b)/(4.0*tt))*exp(<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-gm),2)*tt/4.0)*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(tt,0.5);
<a name="l00493"></a>00493         caux=-caux/aa;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         xx=(a*p+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*p*(tt-p),0.5);
<a name="l00496"></a>00496         yy=(a*s+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*s*(tt-s),0.5);
<a name="l00497"></a>00497         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((s*(tt-p))/(p*(tt-s)),0.5);
<a name="l00498"></a>00498         caux1=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00499"></a>00499         caux1=caux1/aa;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         aa=exp((a+b)*(a+b)/(4.0*tt))*exp(<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-gm),2)*tt/4.0)*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(tt,0.5);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         xx=(a*p-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*p*(tt-p),0.5);
<a name="l00505"></a>00505         yy=(a*s-b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*s*(tt-s),0.5);
<a name="l00506"></a>00506         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((s*(tt-p))/(p*(tt-s)),0.5);
<a name="l00507"></a>00507         caux2=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00508"></a>00508         caux2=caux2/aa;
<a name="l00509"></a>00509         result=(caux+caux1+caux2)/(2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi,0.5));
<a name="l00510"></a>00510         <span class="keywordflow">return</span>(result);
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="comment">/*</span>
<a name="l00514"></a>00514 <span class="comment">      !!</span>
<a name="l00515"></a>00515 <span class="comment">      !! Function D_F(s,p,tt,a,b,gm)</span>
<a name="l00516"></a>00516 <span class="comment">      !!</span>
<a name="l00517"></a>00517 <span class="comment">    */</span>
<a name="l00518"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">00518</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a52651175fbb4f00e632decc2b753bbff">dff</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm)
<a name="l00519"></a>00519     {
<a name="l00520"></a>00520         <span class="keywordtype">double</span> result;
<a name="l00521"></a>00521         <span class="keywordtype">double</span> aa,caux,caux1,caux2;
<a name="l00522"></a>00522         <span class="keywordtype">double</span> xx,yy,rho;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524         xx=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00525"></a>00525         caux=-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(xx)*exp(-0.5*a*b);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         xx=(a+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00528"></a>00528         yy=(a+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00529"></a>00529         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00530"></a>00530         caux1=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00531"></a>00531         caux1=exp(0.5*a*b)*caux1;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         xx=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00534"></a>00534         yy=(a-b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00535"></a>00535         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00536"></a>00536         caux2=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00537"></a>00537         caux2=exp(-0.5*a*b)*caux2;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         aa=exp((b*b-(1.0-gm)*(1.0-gm))*(tt-s)/4.0);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541         result=(caux+caux1+caux2)*aa;
<a name="l00542"></a>00542         <span class="keywordflow">return</span>(result);
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="comment">/*</span>
<a name="l00547"></a>00547 <span class="comment">      !!</span>
<a name="l00548"></a>00548 <span class="comment">      !! Function D_L(s,p,a,b,c,gm)</span>
<a name="l00549"></a>00549 <span class="comment">      !!</span>
<a name="l00550"></a>00550 <span class="comment">    */</span>
<a name="l00551"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">00551</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a14ed968e88e78b2fc5074d1a5788374e">dll</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>,<span class="keywordtype">double</span> gm)
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553         <span class="keywordtype">double</span> result;
<a name="l00554"></a>00554         <span class="keywordtype">double</span> aa,caux,caux1;
<a name="l00555"></a>00555         <span class="keywordtype">double</span> sigmarho[4],limit[4],epsi;
<a name="l00556"></a>00556         <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(<span class="keywordtype">int</span> jj,<span class="keywordtype">double</span> limit[4],<span class="keywordtype">double</span> sigmarho[4],<span class="keywordtype">double</span> epsi);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         epsi=1.e-12;
<a name="l00559"></a>00559         limit[1]=(a+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00560"></a>00560         limit[2]=(a+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00561"></a>00561         limit[3]=(a+b*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00562"></a>00562         sigmarho[1]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00563"></a>00563         sigmarho[2]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/tt,0.5);
<a name="l00564"></a>00564         sigmarho[3]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-s)/tt,0.5);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         caux=exp(0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(0,limit,sigmarho,epsi);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         limit[1]=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00569"></a>00569         limit[2]=(-a+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00570"></a>00570         limit[3]=(-a+b*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00571"></a>00571         sigmarho[1]=-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00572"></a>00572         sigmarho[2]=-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/tt,0.5);
<a name="l00573"></a>00573         sigmarho[3]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-s)/tt,0.5);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         caux1=-exp(-0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(0,limit,sigmarho,epsi);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         aa=exp((b*b-(1.0-gm)*(1.0-gm))*(tt-s)/4.0);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 
<a name="l00580"></a>00580         result=(caux+caux1)*aa;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <span class="keywordflow">return</span>(result);
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="comment">/*</span>
<a name="l00586"></a>00586 <span class="comment">      !!</span>
<a name="l00587"></a>00587 <span class="comment">      !! Derivative with respect to a of the function D_F(s,p,tt,a,b,gm)</span>
<a name="l00588"></a>00588 <span class="comment">      !!</span>
<a name="l00589"></a>00589 <span class="comment">    */</span>
<a name="l00590"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">00590</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#add806343b0abfb64da47c796f2b3e2b3">ddff</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt,<span class="keywordtype">double</span> a,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> gm)
<a name="l00591"></a>00591     {
<a name="l00592"></a>00592         <span class="keywordtype">double</span> aa,caux,caux1,caux2,caux3,caux4;
<a name="l00593"></a>00593         <span class="keywordtype">double</span> xx,yy,rho;
<a name="l00594"></a>00594         <span class="keywordtype">double</span> result;
<a name="l00595"></a>00595         <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         xx=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00598"></a>00598         caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(xx)*exp(-0.5*a*b);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         xx=(a+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00601"></a>00601         yy=(a+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00602"></a>00602         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00603"></a>00603         caux1=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00604"></a>00604         caux1=exp(0.5*a*b)*caux1;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         xx=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00607"></a>00607         yy=(a-b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00608"></a>00608         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00609"></a>00609         caux2=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00610"></a>00610         caux2=-exp(-0.5*a*b)*caux2;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         caux=0.5*b*(caux+caux1+caux2);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         xx=(a+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00615"></a>00615         yy=b*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s),0.5)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0,0.5);
<a name="l00616"></a>00616         caux1=exp(-0.5*xx*xx)*exp(0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(yy)/(2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi*(tt-p),0.5));
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         xx=(a+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00620"></a>00620         yy=a*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s),0.5)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p)*(tt-s),0.5);
<a name="l00621"></a>00621         caux2=exp(-0.5*xx*xx)*exp(0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(yy)/(2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi*(tt-s),0.5));
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         xx=(a-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00624"></a>00624         yy=b*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s),0.5)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0,0.5);
<a name="l00625"></a>00625         caux3=-exp(-0.5*xx*xx)*exp(-0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(yy)/(2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi*(tt-p),0.5));
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         xx=(a-b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00629"></a>00629         yy=a*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s),0.5)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p)*(tt-s),0.5);
<a name="l00630"></a>00630         caux4=exp(-0.5*xx*xx)*exp(-0.5*a*b)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(yy)/(2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi*(tt-s),0.5));
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         aa=exp((b*b-(1.0-gm)*(1.0-gm))*(tt-p)/4.0);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         result=(caux+caux1+caux2+caux3+caux4)*aa;
<a name="l00638"></a>00638         <span class="keywordflow">return</span>(result);
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="comment">/*</span>
<a name="l00642"></a>00642 <span class="comment">      !!</span>
<a name="l00643"></a>00643 <span class="comment">      !! Derivative with respect to a of the function D_L(s,p,tt,a,b,c,gm)</span>
<a name="l00644"></a>00644 <span class="comment">      !!</span>
<a name="l00645"></a>00645 <span class="comment">    */</span>
<a name="l00646"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">00646</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a345345e84fb9ca25be6bb57b0526b03b">ddll</a>(<span class="keywordtype">double</span> s,<span class="keywordtype">double</span> p,<span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> ax, <span class="keywordtype">double</span> bx,<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>, <span class="keywordtype">double</span> gm)
<a name="l00647"></a>00647     {
<a name="l00648"></a>00648         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l00649"></a>00649         <span class="keyword">static</span> <span class="keywordtype">double</span> aa,caux,caux1;
<a name="l00650"></a>00650         <span class="keyword">static</span> <span class="keywordtype">double</span> sigmarho[4],limit[4];
<a name="l00651"></a>00651         <span class="keyword">static</span> <span class="keywordtype">int</span> idx;
<a name="l00652"></a>00652         <span class="keywordtype">double</span> epsi;
<a name="l00653"></a>00653         <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(<span class="keywordtype">double</span>[],<span class="keywordtype">double</span>[], <span class="keywordtype">int</span> );
<a name="l00654"></a>00654         <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(<span class="keywordtype">int</span> ,<span class="keywordtype">double</span>[],<span class="keywordtype">double</span>[],<span class="keywordtype">double</span>);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         epsi=1.e-12;
<a name="l00657"></a>00657         limit[1]=(ax+bx*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00658"></a>00658         limit[2]=(ax+bx*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00659"></a>00659         limit[3]=(ax+bx*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00660"></a>00660         sigmarho[1]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00661"></a>00661         sigmarho[2]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/tt,0.5);
<a name="l00662"></a>00662         sigmarho[3]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-s)/tt,0.5);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         caux=0.5*bx*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(0,limit,sigmarho,epsi);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         idx=1;
<a name="l00668"></a>00668         caux=caux+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         idx=2;
<a name="l00671"></a>00671         caux=caux+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         idx=3;
<a name="l00674"></a>00674         caux=caux+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         caux=exp(0.5*ax*bx)*caux;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         limit[1]=(ax-bx*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00679"></a>00679         limit[2]=(-ax+bx*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00680"></a>00680         limit[3]=(-ax+bx*tt+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ad0cf80d5912ef85423efe32835d4603c">c</a>)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00681"></a>00681         sigmarho[1]=-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/(tt-s),0.5);
<a name="l00682"></a>00682         sigmarho[2]=-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-p)/tt,0.5);
<a name="l00683"></a>00683         sigmarho[3]=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((tt-s)/tt,0.5);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685         caux1=0.5*bx*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(0,limit,sigmarho,epsi);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         idx=1;
<a name="l00688"></a>00688         caux1=caux1-<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p),0.5);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         idx=2;
<a name="l00691"></a>00691         caux1=caux1+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-s),0.5);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         idx=3;
<a name="l00695"></a>00695         caux1=caux1+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(limit,sigmarho,idx)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt,0.5);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697         caux1=exp(-0.5*ax*bx)*caux1;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         aa=exp((bx*bx-(1.0-gm)*(1.0-gm))*(tt-s)/4.0);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         result=(caux+caux1)*aa;
<a name="l00703"></a>00703         <span class="keywordflow">return</span>(result);
<a name="l00704"></a>00704     }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <span class="comment">/*</span>
<a name="l00707"></a>00707 <span class="comment">      !!</span>
<a name="l00708"></a>00708 <span class="comment">      !!   Derivative with respect to a of the function D_E(s,p,tt,a,b,gm)</span>
<a name="l00709"></a>00709 <span class="comment">      !!</span>
<a name="l00710"></a>00710 <span class="comment">    */</span>
<a name="l00711"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#afdff3da0091a96a033a55c5946217728">00711</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#afdff3da0091a96a033a55c5946217728">ddvv</a>(<span class="keywordtype">double</span> s, <span class="keywordtype">double</span> p, <span class="keywordtype">double</span> tt, <span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> gm)
<a name="l00712"></a>00712     {
<a name="l00713"></a>00713         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l00714"></a>00714         <span class="keyword">static</span> <span class="keywordtype">double</span> aa,caux,caux1,caux2,caux6;
<a name="l00715"></a>00715         <span class="keyword">static</span> <span class="keywordtype">double</span> caux3,caux4,caux5,aux;
<a name="l00716"></a>00716         <span class="keyword">static</span> <span class="keywordtype">double</span> xx,yy,rho;
<a name="l00717"></a>00717         <span class="keyword">static</span> <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         aa=(a*p+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*p*tt*(tt-p),0.5);
<a name="l00720"></a>00720         caux=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         aa=exp(-(a-b)*(a-b)/(4.0*tt))/tt;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         caux=0.5*aa*caux*(a-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>);
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         xx=(a*p+b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*p*(tt-p),0.5);
<a name="l00727"></a>00727         yy=(a*s+b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*s*(tt-s),0.5);
<a name="l00728"></a>00728         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((s*(tt-p))/(p*(tt-s)),0.5);
<a name="l00729"></a>00729         caux1=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00730"></a>00730         caux1=-0.5*aa*caux1*(a-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         aa=exp(-(a+b)*(a+b)/(4.0*tt))/tt;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         xx=(a*p-b*(tt-p))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*p*(tt-p),0.5);
<a name="l00736"></a>00736         yy=(a*s-b*(tt-s))/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*tt*s*(tt-s),0.5);
<a name="l00737"></a>00737         rho=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((s*(tt-p))/(p*(tt-s)),0.5);
<a name="l00738"></a>00738         caux2=<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho);
<a name="l00739"></a>00739         caux2=-0.5*aa*caux2*(a+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         aa=-b*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*p*s,0.5),0.5);
<a name="l00742"></a>00742         aux=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(p/(ppi*tt*(tt-p)),0.5)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         xx=(a+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)*(a+b)/(4.0*tt);
<a name="l00745"></a>00745         yy=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((a*p-b*(tt-p)),2)/(4.0*p*tt*(tt-p));
<a name="l00746"></a>00746         caux3=aux*exp(-xx)*exp(-yy)/2.0;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         xx=(a-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)*(a-b)/(4.0*tt);
<a name="l00750"></a>00750         yy=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((a*p+b*(tt-p)),2)/(4.0*p*tt*(tt-p));
<a name="l00751"></a>00751         caux4=aux*exp(-xx)*exp(-yy)/2.0;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         aa=a*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((p-s)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*(tt-p)*(tt-s),0.5),0.5);
<a name="l00754"></a>00754         aux=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(s/(ppi*tt*(tt-s)),0.5)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(aa);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         xx=(a+<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)*(a+b)/(4.0*tt);
<a name="l00757"></a>00757         yy=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((a*s-b*(tt-s)),2)/(4.0*s*tt*(tt-s));
<a name="l00758"></a>00758         caux5=aux*exp(-xx)*exp(-yy)/2.0;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760         xx=(a-<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>)*(a-b)/(4.0*tt);
<a name="l00761"></a>00761         yy=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((a*s+b*(tt-s)),2)/(4.0*s*tt*(tt-s));
<a name="l00762"></a>00762         caux6=aux*exp(-xx)*exp(-yy)/2.0;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         aux=exp((1.0-gm)*(1.0-gm)*tt/4.0)*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(tt,0.5);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         result=(caux+caux1+caux2+caux3+caux4+caux5+caux6)/(aux*2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ppi,0.5));
<a name="l00767"></a>00767         <span class="keywordflow">return</span>(result);
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <span class="comment">/*</span>
<a name="l00771"></a>00771 <span class="comment">      !!</span>
<a name="l00772"></a>00772 <span class="comment">      !! Derivn3 computes the derivatives of the trivariate cumulative normal</span>
<a name="l00773"></a>00773 <span class="comment">      !! distribution with respect to one of the integration limits</span>
<a name="l00774"></a>00774 <span class="comment">      !!</span>
<a name="l00775"></a>00775 <span class="comment">    */</span>
<a name="l00776"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">00776</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aeddd4e8e35788bbb6f46de640e6c79f6">derivn3</a>(<span class="keywordtype">double</span> limit[4],<span class="keywordtype">double</span> sigmarho[4], <span class="keywordtype">int</span> idx)
<a name="l00777"></a>00777     {
<a name="l00778"></a>00778         <span class="keyword">static</span> <span class="keywordtype">double</span> aa;
<a name="l00779"></a>00779         <span class="keyword">static</span> <span class="keywordtype">double</span> xx,yy,rho,sc;
<a name="l00780"></a>00780         <span class="keyword">static</span> <span class="keywordtype">double</span>  ppi= 3.14159265358979324;
<a name="l00781"></a>00781         <span class="keyword">static</span> <span class="keywordtype">double</span> deriv;
<a name="l00782"></a>00782         sc=<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(2.0*ppi,0.5);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="keywordflow">if</span>(idx==1)
<a name="l00785"></a>00785             {
<a name="l00786"></a>00786                 aa=exp(-0.5*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(limit[1],2));
<a name="l00787"></a>00787                 xx=(limit[3]-sigmarho[2]*limit[1])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[2],2)),0.5);
<a name="l00788"></a>00788                 yy=(limit[2]-sigmarho[1]*limit[1])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[1],2)),0.5);
<a name="l00789"></a>00789                 rho=(sigmarho[3]-sigmarho[1]*sigmarho[2])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-sigmarho[1]*sigmarho[1])*(1.0-sigmarho[2]*sigmarho[2]),0.5);
<a name="l00790"></a>00790                 deriv=aa*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho)/sc;
<a name="l00791"></a>00791             }
<a name="l00792"></a>00792         <span class="keywordflow">else</span>
<a name="l00793"></a>00793             {
<a name="l00794"></a>00794                 <span class="keywordflow">if</span>(idx==2)
<a name="l00795"></a>00795                     {
<a name="l00796"></a>00796                         aa=exp(-0.5*limit[2]*limit[2]);
<a name="l00797"></a>00797                         xx=(limit[1]-sigmarho[1]*limit[2])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[1],2)),0.5);
<a name="l00798"></a>00798                         yy=(limit[3]-sigmarho[3]*limit[2])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[3],2)),0.5);
<a name="l00799"></a>00799                         rho=(sigmarho[2]-sigmarho[1]*sigmarho[3])/ \
<a name="l00800"></a>00800                             <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-sigmarho[1]*sigmarho[1])*(1.0-sigmarho[3]*sigmarho[3]),0.5);
<a name="l00801"></a>00801                         deriv=aa*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho)/sc;
<a name="l00802"></a>00802                     }
<a name="l00803"></a>00803                 <span class="keywordflow">else</span>
<a name="l00804"></a>00804                     {
<a name="l00806"></a>00806                         aa=exp(-0.5*limit[3]*limit[3]);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808                         xx=(limit[1]-sigmarho[2]*limit[3])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[2],2)),0.5);
<a name="l00809"></a>00809                         yy=(limit[2]-sigmarho[3]*limit[3])/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(sigmarho[3],2)),0.5);
<a name="l00810"></a>00810                         rho=(sigmarho[1]-sigmarho[2]*sigmarho[3])/ \
<a name="l00811"></a>00811                             <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1.0-sigmarho[2]*sigmarho[2])*(1.0-sigmarho[3]*sigmarho[3]),0.5);
<a name="l00812"></a>00812                         deriv=aa*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(-xx,-yy,rho)/sc;
<a name="l00813"></a>00813                     }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815             }
<a name="l00816"></a>00816         <span class="keywordflow">return</span>(deriv);
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>(<span class="keywordtype">int</span> NU, <span class="keywordtype">double</span> DH, <span class="keywordtype">double</span> DK, <span class="keywordtype">double</span> RRR );
<a name="l00821"></a>00821     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> H1, <span class="keywordtype">double</span> H2, <span class="keywordtype">double</span> H3,
<a name="l00822"></a>00822                   <span class="keywordtype">double</span> R23, <span class="keywordtype">double</span> RUA, <span class="keywordtype">double</span> RUB, <span class="keywordtype">double</span> AR,
<a name="l00823"></a>00823                   <span class="keywordtype">double</span> RUC, <span class="keywordtype">int</span> NUC);
<a name="l00824"></a>00824     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a75e211334db54a064564a63ae12350d5">ADONET</a>(<span class="keywordtype">double</span> ZRO,<span class="keywordtype">double</span> ONE,<span class="keywordtype">double</span> EPS,
<a name="l00825"></a>00825                   <span class="keywordtype">double</span>(*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>)(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> H1, <span class="keywordtype">double</span> H2,
<a name="l00826"></a>00826                                   <span class="keywordtype">double</span> H3, <span class="keywordtype">double</span> R23, <span class="keywordtype">double</span> RUA,
<a name="l00827"></a>00827                                   <span class="keywordtype">double</span> RUB, <span class="keywordtype">double</span> AR, <span class="keywordtype">double</span> RUC,
<a name="l00828"></a>00828                                   <span class="keywordtype">int</span> NUC));
<a name="l00829"></a>00829 
<a name="l00830"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a2424516ac427745126c95f7e48e36087">00830</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#af81500cb4ddf7928668ba1535dba066a">tvtl</a>(<span class="keywordtype">int</span> NU, <span class="keywordtype">double</span> limit[], <span class="keywordtype">double</span> sigmarho[],<span class="keywordtype">double</span> epsi)
<a name="l00831"></a>00831     {
<a name="l00832"></a>00832         <span class="comment">/*</span>
<a name="l00833"></a>00833 <span class="comment">          A function for computing trivariate normal and t-probabilities.</span>
<a name="l00834"></a>00834 <span class="comment"></span>
<a name="l00835"></a>00835 <span class="comment">          This function uses algorithms developed from the ideas</span>
<a name="l00836"></a>00836 <span class="comment">          described in the papers:</span>
<a name="l00837"></a>00837 <span class="comment">          R.L. Plackett, Biometrika 41(1954), pp. 351-360.</span>
<a name="l00838"></a>00838 <span class="comment">          Z. Drezner, Math. Comp. 62(1994), pp. 289-294.</span>
<a name="l00839"></a>00839 <span class="comment">          and uses adaptive integration.</span>
<a name="l00840"></a>00840 <span class="comment"></span>
<a name="l00841"></a>00841 <span class="comment">          The software given here is based on algorithms described in</span>
<a name="l00842"></a>00842 <span class="comment">          the paper A. Genz: &quot;Numerical Computation of Rectangular</span>
<a name="l00843"></a>00843 <span class="comment">          Bivariate and Trivariate Normal and t Probabilities&quot;,</span>
<a name="l00844"></a>00844 <span class="comment">          Statistics and Computing 14 (2004) 251-260.</span>
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">          This software has been developed by M.C. Recchioni based on</span>
<a name="l00847"></a>00847 <span class="comment">          previous software developed by</span>
<a name="l00848"></a>00848 <span class="comment">          Alan Genz</span>
<a name="l00849"></a>00849 <span class="comment">          Department of Mathematics</span>
<a name="l00850"></a>00850 <span class="comment">          Washington State University</span>
<a name="l00851"></a>00851 <span class="comment">          Pullman, WA 99164-3113</span>
<a name="l00852"></a>00852 <span class="comment">          Email : alangenz@wsu.edu</span>
<a name="l00853"></a>00853 <span class="comment">          The software developed by A. Genz is available free of</span>
<a name="l00854"></a>00854 <span class="comment">          charge in the website:</span>
<a name="l00855"></a>00855 <span class="comment">          www.math.wsu.edu/faculty/genz/software/software.html</span>
<a name="l00856"></a>00856 <span class="comment"></span>
<a name="l00857"></a>00857 <span class="comment">          The software calculates the probability that</span>
<a name="l00858"></a>00858 <span class="comment">          X(I) &lt; H(I), for I = 1,2,3</span>
<a name="l00859"></a>00859 <span class="comment"></span>
<a name="l00860"></a>00860 <span class="comment">          NU        INTEGER degrees of freedom; use NU = 0 for normal cases.</span>
<a name="l00861"></a>00861 <span class="comment">          LIMIT     REAL array of uppoer limits for probability distribution</span>
<a name="l00862"></a>00862 <span class="comment">          SIGMARHO  REAL array of three correlation coefficients, should</span>
<a name="l00863"></a>00863 <span class="comment">          contain the lower left portion of the correlation matrix.</span>
<a name="l00864"></a>00864 <span class="comment">          SIGMARHO should contains the values r21, r31, r23 in that order.</span>
<a name="l00865"></a>00865 <span class="comment">          EPSI      REAL required absolute accuracy; maximum accuracy for most</span>
<a name="l00866"></a>00866 <span class="comment">          computations is approximately 1D-14</span>
<a name="l00867"></a>00867 <span class="comment"></span>
<a name="l00868"></a>00868 <span class="comment">        */</span>
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l00871"></a>00871         <span class="keyword">static</span> <span class="keywordtype">double</span>  ONE=1.0, ZRO=0.0, EPS,  TVT;
<a name="l00872"></a>00872         <span class="keyword">static</span> <span class="keywordtype">double</span> PT, R12, R13;
<a name="l00873"></a>00873         <span class="keyword">static</span> <span class="keywordtype">double</span> ppi= 3.14159265358979324;
<a name="l00874"></a>00874         EPS = max( 1.e-14, epsi );
<a name="l00875"></a>00875         PT=ppi/2.0;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         NUC = NU;
<a name="l00878"></a>00878         H1 = limit[1];
<a name="l00879"></a>00879         H2 = limit[2];
<a name="l00880"></a>00880         H3 = limit[3];
<a name="l00881"></a>00881         R12 = sigmarho[1];
<a name="l00882"></a>00882         R13 = sigmarho[2];
<a name="l00883"></a>00883         R23 = sigmarho[3];
<a name="l00884"></a>00884         <span class="comment">/*</span>
<a name="l00885"></a>00885 <span class="comment">         *     Sort R&#39;s and check for special cases</span>
<a name="l00886"></a>00886 <span class="comment">         */</span>
<a name="l00887"></a>00887         <span class="keywordflow">if</span> ( fabs(R12) &gt; fabs(R13) ) {
<a name="l00888"></a>00888             H2 = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aad31cbfa93a6ffef32d2bfbf36afebb8">H3</a>;
<a name="l00889"></a>00889             H3 = limit[2];
<a name="l00890"></a>00890             R12 = R13;
<a name="l00891"></a>00891             R13 = sigmarho[1];
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894         <span class="keywordflow">if</span> ( fabs(R13) &gt; fabs(R23) ) {
<a name="l00895"></a>00895             H1 = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6464138479012cf12084a0d6c2bf785d">H2</a>;
<a name="l00896"></a>00896             H2 = limit[1];
<a name="l00897"></a>00897             R23 = R13;
<a name="l00898"></a>00898             R13 = sigmarho[3];
<a name="l00899"></a>00899         }
<a name="l00900"></a>00900 
<a name="l00901"></a>00901         TVT = 0.0;
<a name="l00902"></a>00902         <span class="keywordflow">if</span> ( (fabs(H1) + fabs(H2) + fabs(H3)) &lt; EPS ) TVT = ( 1 + ( asin(R12) + asin(R13) + asin(R23) )/PT )/8.0;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ( (NU &lt; 1) &amp;&amp; ( (fabs(R12) + fabs(R13)) &lt; EPS) )  TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(H1)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H2, H3, R23 );
<a name="l00905"></a>00905 
<a name="l00906"></a>00906         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ( (NU &lt; 1) &amp;&amp; ((fabs(R13) + fabs(R23))&lt; EPS) ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(H3)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, H2, R12 );
<a name="l00907"></a>00907 
<a name="l00908"></a>00908         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (NU &lt; 1) &amp;&amp; ((fabs(R12) + fabs(R23))&lt; EPS) ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(H2)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, H3, R13 );
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (1.0 - R23)&lt; EPS ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, min( H2, H3 ), R12 );
<a name="l00911"></a>00911 
<a name="l00912"></a>00912         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ( (R23 + 1.0) &lt;EPS ) {
<a name="l00913"></a>00913             <span class="keywordflow">if</span>  ( H2 &gt; -H3 ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, H2, R12 ) - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, -H3, R12 );}
<a name="l00914"></a>00914         <span class="keywordflow">else</span>
<a name="l00915"></a>00915             {
<a name="l00916"></a>00916                 <span class="comment">/*</span>
<a name="l00917"></a>00917 <span class="comment">                 *        Compute singular TVT value</span>
<a name="l00918"></a>00918 <span class="comment">                 */</span>
<a name="l00919"></a>00919                 <span class="keywordflow">if</span> ( NU &lt; 1 ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H2, H3, R23 )*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(H1);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( R23 &gt; 0 ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, min( H2, H3 ), ZRO );
<a name="l00922"></a>00922 
<a name="l00923"></a>00923                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( H2 &gt; -H3 ) TVT = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, H2, ZRO ) - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>( NU, H1, -H3, ZRO );
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                 <span class="comment">/*</span>
<a name="l00926"></a>00926 <span class="comment">                 *        Use numerical integration to compute probability</span>
<a name="l00927"></a>00927 <span class="comment">                 *</span>
<a name="l00928"></a>00928 <span class="comment">                 */</span>
<a name="l00929"></a>00929                 RUA = asin( R12 );
<a name="l00930"></a>00930                 RUB = asin( R13 );
<a name="l00931"></a>00931                 AR = asin( R23);
<a name="l00932"></a>00932                 RUC = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ac89d5f8a358eb8a1abdcd0fcef134f1a">SIGN</a>( PT, AR ) - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#abd7073d8df2267b123de5f5d8b049172">AR</a>;
<a name="l00933"></a>00933                 TVT = TVT + <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a75e211334db54a064564a63ae12350d5">ADONET</a>(  ZRO, ONE, EPS, *<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>)/( 4.0*PT );
<a name="l00934"></a>00934             }
<a name="l00935"></a>00935         result = max( ZRO, min( TVT, ONE ) );
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         <span class="keywordflow">return</span>(result);
<a name="l00938"></a>00938     }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     <span class="keywordtype">void</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">SINCS</a>(<span class="keywordtype">double</span> v1,<span class="keywordtype">double</span> v2, <span class="keywordtype">double</span> v3);
<a name="l00941"></a>00941     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">PNTGND</a>(<span class="keywordtype">int</span> , <span class="keywordtype">double</span> ,<span class="keywordtype">double</span> ,<span class="keywordtype">double</span> ,
<a name="l00942"></a>00942                   <span class="keywordtype">double</span> ,<span class="keywordtype">double</span> ,<span class="keywordtype">double</span> ,<span class="keywordtype">double</span> );
<a name="l00943"></a>00943 
<a name="l00944"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">00944</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> H1, <span class="keywordtype">double</span> H2, <span class="keywordtype">double</span> H3, <span class="keywordtype">double</span> R23,
<a name="l00945"></a>00945                   <span class="keywordtype">double</span> RUA, <span class="keywordtype">double</span> RUB, <span class="keywordtype">double</span> AR,<span class="keywordtype">double</span> RUC, <span class="keywordtype">int</span> NUC ){
<a name="l00946"></a>00946         <span class="comment">/*</span>
<a name="l00947"></a>00947 <span class="comment">          Computes Plackett formula integrands</span>
<a name="l00948"></a>00948 <span class="comment">        */</span>
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <span class="keyword">static</span> <span class="keywordtype">double</span>  R12=0.0, RR2=0, R13=0.0, RR3=0.0, R=0.0, RR=0.0, ZRO=0.0;
<a name="l00951"></a>00951         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         ZRO = 0.0;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         result = 0.0;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">SINCS</a>( RUA*X, R12, RR2 );
<a name="l00958"></a>00958         <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">SINCS</a>( RUB*X, R13, RR3 );
<a name="l00959"></a>00959 
<a name="l00960"></a>00960         <span class="keywordflow">if</span> ( fabs(RUA)&gt; 0 )  result = result + RUA*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">PNTGND</a>( NUC, H1,H2,H3, R13,R23,R12,RR2);
<a name="l00961"></a>00961         <span class="keywordflow">if</span>( fabs(RUB)&gt;0 ) result = result + RUB*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">PNTGND</a>( NUC, H1,H3,H2, R12,R23,R13,RR3 ) ;
<a name="l00962"></a>00962         <span class="keywordflow">if</span> ( NUC &gt; 0 )
<a name="l00963"></a>00963             {
<a name="l00964"></a>00964                 <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">SINCS</a>( AR + RUC*X, R, RR );
<a name="l00965"></a>00965                 result = result - RUC*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">PNTGND</a>( NUC, H2, H3, H1, ZRO, ZRO, R, RR );
<a name="l00966"></a>00966             }
<a name="l00967"></a>00967         <span class="keywordflow">return</span>(result);
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969     <span class="comment">//</span>
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 
<a name="l00972"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">00972</a>     <span class="keywordtype">void</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a6877f2a2f654587ecb96bf604fa5ac42">SINCS</a>(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> SX, <span class="keywordtype">double</span> CS )
<a name="l00973"></a>00973     {
<a name="l00974"></a>00974         <span class="comment">/*</span>
<a name="l00975"></a>00975 <span class="comment">          Computes SIN(X), COS(X)^2, with series approx. for |X| near PI/2</span>
<a name="l00976"></a>00976 <span class="comment">        */</span>
<a name="l00977"></a>00977         <span class="keyword">static</span> <span class="keywordtype">double</span> PT, EE;
<a name="l00978"></a>00978         PT = 1.57079632679489661923132169163975;
<a name="l00979"></a>00979         EE = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( PT - fabs(X) ),2);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <span class="keywordflow">if</span> ( EE &lt; 5e-5 )
<a name="l00982"></a>00982             {
<a name="l00983"></a>00983                 SX = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ac89d5f8a358eb8a1abdcd0fcef134f1a">SIGN</a>( 1 - EE*( 1 - EE/12 )/2, X );
<a name="l00984"></a>00984                 CS = EE*( 1 - EE*( 1 - 2*EE/15 )/3 );
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986         <span class="keywordflow">else</span>
<a name="l00987"></a>00987             {
<a name="l00988"></a>00988                 SX = sin(X);
<a name="l00989"></a>00989                 CS = 1 - SX*SX;
<a name="l00990"></a>00990             }
<a name="l00991"></a>00991         <span class="keywordflow">return</span>;
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993     <span class="comment">//</span>
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a7a928543a2509276892abc731ff7c55d">KRNRDT</a>(<span class="keywordtype">double</span>, <span class="keywordtype">double</span>,
<a name="l00996"></a>00996                   <span class="keywordtype">double</span>(*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>)(<span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">double</span>,
<a name="l00997"></a>00997                                   <span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">double</span>, <span class="keywordtype">int</span>),
<a name="l00998"></a>00998                   <span class="keywordtype">double</span> );
<a name="l00999"></a>00999 
<a name="l01000"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a75e211334db54a064564a63ae12350d5">01000</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a75e211334db54a064564a63ae12350d5">ADONET</a>(<span class="keywordtype">double</span> A,<span class="keywordtype">double</span> B, <span class="keywordtype">double</span> TOL,<span class="keywordtype">double</span>(*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>)(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> H1, <span class="keywordtype">double</span> H2, <span class="keywordtype">double</span> H3, <span class="keywordtype">double</span> R23, <span class="keywordtype">double</span> RUA, <span class="keywordtype">double</span> RUB, <span class="keywordtype">double</span> AR, <span class="keywordtype">double</span> RUC, <span class="keywordtype">int</span> NUC)){
<a name="l01001"></a>01001         <span class="comment">//</span>
<a name="l01002"></a>01002         <span class="comment">//     One Dimensional Globally Adaptive Integration Function</span>
<a name="l01003"></a>01003         <span class="comment">//</span>
<a name="l01004"></a>01004         <span class="keywordtype">int</span> NL=100, <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>, IM, IP;
<a name="l01005"></a>01005         <span class="keyword">static</span> <span class="keywordtype">double</span> EI[101], AI[101], BI[101], FI[101], FIN;
<a name="l01006"></a>01006         <span class="keyword">static</span> <span class="keywordtype">double</span> result,ERR;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 
<a name="l01009"></a>01009         AI[1] = A;
<a name="l01010"></a>01010         BI[1] = B;
<a name="l01011"></a>01011         ERR = 1;
<a name="l01012"></a>01012         IP = 1;
<a name="l01013"></a>01013         IM = 1;
<a name="l01014"></a>01014         <span class="keywordflow">while</span> ( ((4*ERR)&gt; TOL) &amp;&amp; (IM&lt; NL) )
<a name="l01015"></a>01015             {
<a name="l01016"></a>01016                 IM = IM + 1;
<a name="l01017"></a>01017                 BI[IM] = BI[IP];
<a name="l01018"></a>01018                 AI[IM] = (AI[IP] + BI[IP] )/2.0;
<a name="l01019"></a>01019                 BI[IP] = AI[IM];
<a name="l01020"></a>01020                 FI[IP] = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a7a928543a2509276892abc731ff7c55d">KRNRDT</a>( AI[IP], BI[IP], *<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>, EI[IP] );
<a name="l01021"></a>01021                 FI[IM] = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a7a928543a2509276892abc731ff7c55d">KRNRDT</a>( AI[IM], BI[IM], *<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>, EI[IM] );
<a name="l01022"></a>01022 
<a name="l01023"></a>01023                 ERR = 0.0;
<a name="l01024"></a>01024                 FIN = 0.0;
<a name="l01025"></a>01025                 <span class="keywordflow">for</span>(<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a> = 1; <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>&lt;=IM; <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>++)
<a name="l01026"></a>01026                     {
<a name="l01027"></a>01027                         <span class="keywordflow">if</span>( EI[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>] &gt; EI[IP]) IP = <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>;
<a name="l01028"></a>01028                         FIN = FIN + FI[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>];
<a name="l01029"></a>01029                         ERR = ERR + EI[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>]*EI[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>];
<a name="l01030"></a>01030                     }
<a name="l01031"></a>01031                 ERR = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( ERR,0.5 );
<a name="l01032"></a>01032             }
<a name="l01033"></a>01033         result=FIN;
<a name="l01034"></a>01034         <span class="comment">//   ADONET = FIN</span>
<a name="l01035"></a>01035         <span class="keywordflow">return</span>(result);
<a name="l01036"></a>01036     }
<a name="l01037"></a>01037     <span class="comment">//</span>
<a name="l01038"></a>01038 
<a name="l01039"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a887b3dd544e90342af96092dde616a1b">01039</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a7a928543a2509276892abc731ff7c55d">KRNRDT</a>(<span class="keywordtype">double</span> A, <span class="keywordtype">double</span> B,<span class="keywordtype">double</span>(*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>)(<span class="keywordtype">double</span> X, <span class="keywordtype">double</span> H1, <span class="keywordtype">double</span> H2, <span class="keywordtype">double</span> H3, <span class="keywordtype">double</span> R23, <span class="keywordtype">double</span> RUA, <span class="keywordtype">double</span> RUB, <span class="keywordtype">double</span> AR, <span class="keywordtype">double</span> RUC, <span class="keywordtype">int</span> NUC),<span class="keywordtype">double</span> ERR ){
<a name="l01040"></a>01040 
<a name="l01041"></a>01041         <span class="comment">//</span>
<a name="l01042"></a>01042         <span class="comment">//     Kronrod Rule</span>
<a name="l01043"></a>01043         <span class="comment">//</span>
<a name="l01044"></a>01044         <span class="keyword">static</span> <span class="keywordtype">double</span>  <a class="code" href="class_t.html">T</a>, CEN, FC, WID, RESG, RESK;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046         <span class="keywordtype">double</span>  <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>(<span class="keywordtype">int</span>, <span class="keywordtype">double</span> );
<a name="l01047"></a>01047         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l01048"></a>01048         <span class="comment">//</span>
<a name="l01049"></a>01049         <span class="comment">//        The abscissae and weights are given for the interval (-1,1);</span>
<a name="l01050"></a>01050         <span class="comment">//        only positive abscissae and corresponding weights are given.</span>
<a name="l01051"></a>01051         <span class="comment">//</span>
<a name="l01052"></a>01052         <span class="comment">//        XGK    - abscissae of the 2N+1-point Kronrod rule:</span>
<a name="l01053"></a>01053         <span class="comment">//                 XGK(2), XGK(4), ...  N-point Gauss rule abscissae;</span>
<a name="l01054"></a>01054         <span class="comment">//                 XGK(1), XGK(3), ...  optimally added abscissae.</span>
<a name="l01055"></a>01055         <span class="comment">//        WGK    - weights of the 2N+1-point Kronrod rule.</span>
<a name="l01056"></a>01056         <span class="comment">//        WG     - weights of the N-point Gauss rule.</span>
<a name="l01057"></a>01057         <span class="comment">//</span>
<a name="l01058"></a>01058         <span class="keywordtype">int</span> J, <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a>=11;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060         <span class="keyword">static</span> <span class="keywordtype">double</span>  WG[7], WGK[13], XGK[13];
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         WG[1]= 0.2729250867779007;
<a name="l01063"></a>01063         WG[2]=0.05566856711617449;
<a name="l01064"></a>01064         WG[3]=0.1255803694649048;
<a name="l01065"></a>01065         WG[4]=0.1862902109277352;
<a name="l01066"></a>01066         WG[5]= 0.2331937645919914;
<a name="l01067"></a>01067         WG[6]= 0.2628045445102478;
<a name="l01068"></a>01068         <span class="comment">//</span>
<a name="l01069"></a>01069         XGK[1]= 0.0000000000000000;
<a name="l01070"></a>01070         XGK[2]= 0.9963696138895427;
<a name="l01071"></a>01071         XGK[3]= 0.9782286581460570;
<a name="l01072"></a>01072         XGK[4]= 0.9416771085780681;
<a name="l01073"></a>01073         XGK[5]= 0.8870625997680953;
<a name="l01074"></a>01074         XGK[6]= 0.8160574566562211;
<a name="l01075"></a>01075         XGK[7]= 0.7301520055740492;
<a name="l01076"></a>01076         XGK[8]= 0.6305995201619651;
<a name="l01077"></a>01077         XGK[9]= 0.5190961292068118;
<a name="l01078"></a>01078         XGK[10]= 0.3979441409523776;
<a name="l01079"></a>01079         XGK[11]= 0.2695431559523450;
<a name="l01080"></a>01080         XGK[12]= 0.1361130007993617;
<a name="l01081"></a>01081         <span class="comment">//</span>
<a name="l01082"></a>01082         WGK[1]=0.1365777947111183;
<a name="l01083"></a>01083         WGK[2]=0.9765441045961290e-02;
<a name="l01084"></a>01084         WGK[3]=0.2715655468210443e-01;
<a name="l01085"></a>01085         WGK[4]=0.4582937856442671e-01;
<a name="l01086"></a>01086         WGK[5]=0.6309742475037484e-01;
<a name="l01087"></a>01087         WGK[6]=0.7866457193222764e-01;
<a name="l01088"></a>01088         WGK[7]=0.9295309859690074e-01;
<a name="l01089"></a>01089         WGK[8]=0.1058720744813894;
<a name="l01090"></a>01090         WGK[9]=0.1167395024610472;
<a name="l01091"></a>01091         WGK[10]=0.1251587991003195;
<a name="l01092"></a>01092         WGK[11]=0.1312806842298057;
<a name="l01093"></a>01093         WGK[12]=0.1351935727998845;
<a name="l01094"></a>01094         <span class="comment">/*</span>
<a name="l01095"></a>01095 <span class="comment">          Major variables</span>
<a name="l01096"></a>01096 <span class="comment"></span>
<a name="l01097"></a>01097 <span class="comment">          CEN  - mid point of the interval</span>
<a name="l01098"></a>01098 <span class="comment">          WID  - half-length of the interval</span>
<a name="l01099"></a>01099 <span class="comment">          RESG - result of the N-point Gauss formula</span>
<a name="l01100"></a>01100 <span class="comment">          RESK - result of the 2N+1-point Kronrod formula</span>
<a name="l01101"></a>01101 <span class="comment">          Compute the 2N+1-point Kronrod approximation to</span>
<a name="l01102"></a>01102 <span class="comment">          the integral, and estimate the absolute error.</span>
<a name="l01103"></a>01103 <span class="comment">        */</span>
<a name="l01104"></a>01104         WID = ( B - A )/2.0;
<a name="l01105"></a>01105         CEN = ( B + A )/2.0;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         FC = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>(CEN,H1, H2,  H3, R23, RUA, RUB, AR, RUC, NUC);
<a name="l01108"></a>01108 
<a name="l01109"></a>01109         RESG = FC*WG[0+1];
<a name="l01110"></a>01110         RESK = FC*WGK[0+1];
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <span class="keywordflow">for</span> (J = 1; J&lt;= <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#ac87ee18cd779f22a128d46ae455ac2f8">N</a>; J++)
<a name="l01113"></a>01113             {
<a name="l01114"></a>01114                 T = WID*XGK[J+1];
<a name="l01115"></a>01115                 FC = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>(CEN-T,H1, H2,  H3, R23, RUA, RUB, AR, RUC, NUC )+<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1b6ea2aace8541e1813a51805a26a185">TVTMFN</a>(CEN+T,H1, H2,  H3, R23, RUA, RUB, AR, RUC, NUC );
<a name="l01116"></a>01116                 RESK = RESK + WGK[J+1]*FC;
<a name="l01117"></a>01117                 <span class="keywordflow">if</span>((J-2*<span class="keywordtype">int</span>(J/2)) == 0 ) RESG = RESG + WG[1+J/2]*FC;
<a name="l01118"></a>01118             }
<a name="l01119"></a>01119         result = WID*RESK;
<a name="l01120"></a>01120         ERR = fabs( WID*( RESK - RESG ) );
<a name="l01121"></a>01121         <span class="keywordflow">return</span>(result);
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="comment">//</span>
<a name="l01125"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">01125</a>     <span class="keywordtype">double</span>  <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>(<span class="keywordtype">int</span> NU, <span class="keywordtype">double</span> <a class="code" href="class_t.html">T</a> )
<a name="l01126"></a>01126     {
<a name="l01127"></a>01127         <span class="comment">/*</span>
<a name="l01128"></a>01128 <span class="comment">          Student t Distribution Function</span>
<a name="l01129"></a>01129 <span class="comment">        */</span>
<a name="l01130"></a>01130         <span class="keyword">static</span> <span class="keywordtype">int</span> J;
<a name="l01131"></a>01131         <span class="keyword">static</span> <span class="keywordtype">double</span>  ZRO=0.0, ONE=1.0;
<a name="l01132"></a>01132         <span class="keyword">static</span> <span class="keywordtype">double</span>  CSSTHE, SNTHE, POLYN, TT, TS, RN;
<a name="l01133"></a>01133         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01136"></a>01136         <span class="keywordflow">if</span> ( NU &lt; 1 ) result= <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>( T );
<a name="l01137"></a>01137         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( NU == 1 ) result = ( 1 + 2.0*atan(T)/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a> )/2.0;
<a name="l01138"></a>01138         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( NU == 2 ) result = ( 1 + T/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( 2.0 + T*T),0.5))/2.0;
<a name="l01139"></a>01139         <span class="keywordflow">else</span>
<a name="l01140"></a>01140             {
<a name="l01141"></a>01141                 TT = T*T;
<a name="l01142"></a>01142                 CSSTHE = 1/( 1 + TT/double(NU) );
<a name="l01143"></a>01143                 POLYN = 1;
<a name="l01144"></a>01144                 <span class="keywordflow">for</span>( J = NU-2; J&gt;= 2; J=J-2)
<a name="l01145"></a>01145                     {
<a name="l01146"></a>01146                         POLYN = 1.0 + ( J - 1.0 )*CSSTHE*POLYN/(<span class="keywordtype">double</span>)J;
<a name="l01147"></a>01147                     }
<a name="l01148"></a>01148                 <span class="keywordflow">if</span> ((NU-2*<span class="keywordtype">int</span>(NU/2) ) == 1 )
<a name="l01149"></a>01149                     {
<a name="l01150"></a>01150                         RN = NU;
<a name="l01151"></a>01151                         TS = T/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(RN,0.5);
<a name="l01152"></a>01152                         result = ( 1.0 + 2.0*( atan(TS) + TS*CSSTHE*POLYN )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a> )/2.0;
<a name="l01153"></a>01153                     }
<a name="l01154"></a>01154                 <span class="keywordflow">else</span>
<a name="l01155"></a>01155                     {
<a name="l01156"></a>01156                         SNTHE = T/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( NU + TT ),0.5);
<a name="l01157"></a>01157                         result = ( 1 + SNTHE*POLYN )/2.0;
<a name="l01158"></a>01158                     }
<a name="l01159"></a>01159                 result = max( ZRO, min( result, ONE ) );
<a name="l01160"></a>01160             }
<a name="l01161"></a>01161         <span class="keywordflow">return</span>(result);
<a name="l01162"></a>01162     }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     <span class="comment">//</span>
<a name="l01165"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">01165</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#aec796ffb56fd24f67e440e3210b09868">BVTL</a>(<span class="keywordtype">int</span> NU, <span class="keywordtype">double</span> DH, <span class="keywordtype">double</span> DK, <span class="keywordtype">double</span> R )
<a name="l01166"></a>01166     {
<a name="l01167"></a>01167         <span class="comment">/*</span>
<a name="l01168"></a>01168 <span class="comment">          A function for computing bivariate t probabilities.</span>
<a name="l01169"></a>01169 <span class="comment">          This function is based on the method described by</span>
<a name="l01170"></a>01170 <span class="comment">          Dunnett, C.W. and M. Sobel, (1954),</span>
<a name="l01171"></a>01171 <span class="comment">          A bivariate generalization of Student&#39;s t-distribution</span>
<a name="l01172"></a>01172 <span class="comment">          with tables for certain special cases,</span>
<a name="l01173"></a>01173 <span class="comment">          Biometrika 41, pp. 153-169.</span>
<a name="l01174"></a>01174 <span class="comment">          The software given here has been developed by M.C. Recchioni based on previous</span>
<a name="l01175"></a>01175 <span class="comment">          software developed by</span>
<a name="l01176"></a>01176 <span class="comment">          Alan Genz</span>
<a name="l01177"></a>01177 <span class="comment">          Department of Mathematics</span>
<a name="l01178"></a>01178 <span class="comment">          Washington State University</span>
<a name="l01179"></a>01179 <span class="comment">          Pullman, WA 99164-3113</span>
<a name="l01180"></a>01180 <span class="comment">          Email : alangenz@wsu.edu</span>
<a name="l01181"></a>01181 <span class="comment">          The software developed by A. Genz is available free of charge in</span>
<a name="l01182"></a>01182 <span class="comment">          the website: www.math.wsu.edu/faculty/genz/software/software.html</span>
<a name="l01183"></a>01183 <span class="comment">          ***</span>
<a name="l01184"></a>01184 <span class="comment"></span>
<a name="l01185"></a>01185 <span class="comment">          BVTL - calculate the probability that X &lt; DH and Y &lt; DK.</span>
<a name="l01186"></a>01186 <span class="comment"></span>
<a name="l01187"></a>01187 <span class="comment">          parameters</span>
<a name="l01188"></a>01188 <span class="comment"></span>
<a name="l01189"></a>01189 <span class="comment">          NU number of degrees of freedom</span>
<a name="l01190"></a>01190 <span class="comment">          DH 1st lower integration limit</span>
<a name="l01191"></a>01191 <span class="comment">          DK 2nd lower integration limit</span>
<a name="l01192"></a>01192 <span class="comment">          R   correlation coefficient</span>
<a name="l01193"></a>01193 <span class="comment">        */</span>
<a name="l01194"></a>01194         <span class="keyword">static</span> <span class="keywordtype">int</span>  J, HS, KS;
<a name="l01195"></a>01195         <span class="keyword">static</span> <span class="keywordtype">double</span>  TPI, ORS, HRK, KRH, BVT, SNU;
<a name="l01196"></a>01196         <span class="keyword">static</span> <span class="keywordtype">double</span>  GMPH, GMPK, XNKH, XNHK, QHRK, HKN, HPK, HKRN;
<a name="l01197"></a>01197         <span class="keyword">static</span> <span class="keywordtype">double</span>  BTNCKH, BTNCHK, BTPDKH, BTPDHK, ONE, EPS;
<a name="l01198"></a>01198         <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>(<span class="keywordtype">int</span> , <span class="keywordtype">double</span> );
<a name="l01199"></a>01199         <span class="keyword">static</span> <span class="keywordtype">double</span> result;
<a name="l01200"></a>01200         ONE = 1;
<a name="l01201"></a>01201         EPS = 1e-15;
<a name="l01202"></a>01202         <span class="keywordflow">if</span> ( NU &lt;1 ) result = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>( -DH, -DK, R );
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (1 - R)&lt;= EPS ) result = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>( NU, min( DH, DK ) );
<a name="l01205"></a>01205 
<a name="l01206"></a>01206         <span class="keywordflow">else</span>  <span class="keywordflow">if</span>( (R + 1)&lt;=EPS )
<a name="l01207"></a>01207             {
<a name="l01208"></a>01208                 <span class="keywordflow">if</span>( DH &gt; -DK ) result = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>( NU, DH ) - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>( NU, -DK );
<a name="l01209"></a>01209                 <span class="keywordflow">else</span>
<a name="l01210"></a>01210                     result = 0.0;
<a name="l01211"></a>01211             }
<a name="l01212"></a>01212         <span class="keywordflow">else</span>
<a name="l01213"></a>01213             {
<a name="l01214"></a>01214                 TPI = 2.0*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l01215"></a>01215                 SNU = (double)NU;
<a name="l01216"></a>01216                 SNU = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(SNU,0.5);
<a name="l01217"></a>01217                 ORS = 1.0 - R*R;
<a name="l01218"></a>01218                 HRK = DH - R*DK;
<a name="l01219"></a>01219                 KRH = DK - R*DH;
<a name="l01220"></a>01220                 <span class="keywordflow">if</span>((fabs(HRK) + ORS)&gt; 0 )
<a name="l01221"></a>01221                     {
<a name="l01222"></a>01222                         XNHK = HRK*HRK/( HRK*HRK + ORS*( NU + DK*DK ) );
<a name="l01223"></a>01223                         XNKH = KRH*KRH/( KRH*KRH+ ORS*( NU + DH*DH ) );
<a name="l01224"></a>01224                     }
<a name="l01225"></a>01225                 <span class="keywordflow">else</span>
<a name="l01226"></a>01226                     {
<a name="l01227"></a>01227                         XNHK = 0.0;
<a name="l01228"></a>01228                         XNKH = 0.0;
<a name="l01229"></a>01229                     }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231                 HS =(int)<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ac89d5f8a358eb8a1abdcd0fcef134f1a">SIGN</a>( ONE, DH - R*DK );
<a name="l01232"></a>01232                 KS =(int)<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ac89d5f8a358eb8a1abdcd0fcef134f1a">SIGN</a>( ONE, DK - R*DH );
<a name="l01233"></a>01233                 <span class="keywordflow">if</span>((NU-2*(<span class="keywordtype">int</span>)(NU/2))==0 )
<a name="l01234"></a>01234                     {
<a name="l01235"></a>01235                         BVT = atan2( <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(ORS,0.5), -R )/TPI;
<a name="l01236"></a>01236                         GMPH = DH/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( 16*( NU + DH*DH ),0.5 );
<a name="l01237"></a>01237                         GMPK = DK/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( 16*( NU + DK*DK),0.5);
<a name="l01238"></a>01238                         BTNCKH = 2*atan2( <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNKH,0.5 ), <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( 1-XNKH),0.5) )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l01239"></a>01239                         BTPDKH = 2*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNKH*( 1 - XNKH ),0.5 )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l01240"></a>01240                         BTNCHK = 2*atan2( <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNHK,0.5 ), <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1 - XNHK),0.5) )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l01241"></a>01241                         BTPDHK = 2*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNHK*( 1 - XNHK ),0.5 )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l01242"></a>01242                         <span class="keywordflow">for</span>( J = 1; J&lt;= NU/2;J++)
<a name="l01243"></a>01243                             {
<a name="l01244"></a>01244                                 BVT = BVT + GMPH*( 1 + KS*BTNCKH );
<a name="l01245"></a>01245                                 BVT = BVT + GMPK*( 1 + HS*BTNCHK );
<a name="l01246"></a>01246                                 BTNCKH = BTNCKH + BTPDKH;
<a name="l01247"></a>01247                                 BTPDKH = 2*J*BTPDKH*( 1 - XNKH )/( 2*J + 1 );
<a name="l01248"></a>01248                                 BTNCHK = BTNCHK + BTPDHK;
<a name="l01249"></a>01249                                 BTPDHK = 2*J*BTPDHK*( 1 - XNHK )/( 2*J + 1 );
<a name="l01250"></a>01250                                 GMPH = GMPH*( 2*J - 1 )/( 2*J*( 1 + DH*DH/NU ) );
<a name="l01251"></a>01251                                 GMPK = GMPK*( 2*J - 1 )/( 2*J*( 1 + DK*DK/NU ) );
<a name="l01252"></a>01252                             }
<a name="l01253"></a>01253                     }
<a name="l01254"></a>01254                 <span class="keywordflow">else</span>
<a name="l01255"></a>01255                     {
<a name="l01256"></a>01256                         QHRK = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((DH*DH + DK*DK - 2*R*DH*DK + NU*ORS),0.5 ) ;
<a name="l01257"></a>01257                         HKRN = DH*DK + R*NU ;
<a name="l01258"></a>01258                         HKN = DH*DK - NU;
<a name="l01259"></a>01259                         HPK = DH + DK;
<a name="l01260"></a>01260                         BVT = atan2( -SNU*( HKN*QHRK + HPK*HKRN ),HKN*HKRN-NU*HPK*QHRK )/TPI;
<a name="l01261"></a>01261                         <span class="keywordflow">if</span> ( BVT &lt; -EPS ) BVT = BVT + 1;
<a name="l01262"></a>01262                         GMPH = DH/( TPI*SNU*( 1 + DH*DH/NU ) );
<a name="l01263"></a>01263                         GMPK = DK/( TPI*SNU*( 1 + DK*DK/NU ) );
<a name="l01264"></a>01264                         BTNCKH = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNKH,0.5 );
<a name="l01265"></a>01265                         BTPDKH = BTNCKH;
<a name="l01266"></a>01266                         BTNCHK = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( XNHK,0.5 );
<a name="l01267"></a>01267                         BTPDHK = BTNCHK;
<a name="l01268"></a>01268                         <span class="keywordflow">for</span>( J = 1;J&lt;= ( NU - 1 )/2; J++)
<a name="l01269"></a>01269                             {
<a name="l01270"></a>01270                                 BVT = BVT + GMPH*( 1 + KS*BTNCKH );
<a name="l01271"></a>01271                                 BVT = BVT + GMPK*( 1 + HS*BTNCHK );
<a name="l01272"></a>01272                                 BTPDKH = ( 2*J - 1 )*BTPDKH*( 1 - XNKH )/( 2*J );
<a name="l01273"></a>01273                                 BTNCKH = BTNCKH + BTPDKH;
<a name="l01274"></a>01274                                 BTPDHK = ( 2*J - 1 )*BTPDHK*( 1 - XNHK )/( 2*J );
<a name="l01275"></a>01275                                 BTNCHK = BTNCHK + BTPDHK;
<a name="l01276"></a>01276                                 GMPH = 2*J*GMPH/( ( 2*J + 1 )*( 1 + DH*DH/NU ) );
<a name="l01277"></a>01277                                 GMPK = 2*J*GMPK/( ( 2*J + 1 )*( 1 + DK*DK/NU ) );
<a name="l01278"></a>01278                             }
<a name="l01279"></a>01279                     }
<a name="l01280"></a>01280                 result = BVT;
<a name="l01281"></a>01281             }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283         <span class="keywordflow">return</span>(result);
<a name="l01284"></a>01284 
<a name="l01285"></a>01285     }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 
<a name="l01288"></a>01288 
<a name="l01289"></a>01289 
<a name="l01290"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">01290</a>       <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a30555fb868b18f0d9657aafc473ddc6e">PNTGND</a>(<span class="keywordtype">int</span> NUC, <span class="keywordtype">double</span> BA, <span class="keywordtype">double</span> BB, <span class="keywordtype">double</span> BC, <span class="keywordtype">double</span> RA, <span class="keywordtype">double</span> RB, <span class="keywordtype">double</span> R, <span class="keywordtype">double</span> RR) {
<a name="l01291"></a>01291           <span class="comment">/*</span>
<a name="l01292"></a>01292 <span class="comment">            Computes Plackett formula integrand</span>
<a name="l01293"></a>01293 <span class="comment">          */</span>
<a name="l01294"></a>01294           <span class="keyword">static</span> <span class="keywordtype">double</span> DT, FT, BT,result;
<a name="l01295"></a>01295           <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>(<span class="keywordtype">int</span>, <span class="keywordtype">double</span>);
<a name="l01296"></a>01296 
<a name="l01297"></a>01297           result = 0.0;
<a name="l01298"></a>01298           DT = RR*( RR - <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( RA - RB ),2) - 2*RA*RB*( 1 - R ) );
<a name="l01299"></a>01299           <span class="keywordflow">if</span>( DT &gt; 0 ) {
<a name="l01300"></a>01300               BT = ( BC*RR + BA*( R*RB - RA ) + BB*( R*RA -RB ) )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(DT,0.5);
<a name="l01301"></a>01301               FT = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( BA - R*BB ),0.5)/RR + BB*BB;
<a name="l01302"></a>01302               <span class="keywordflow">if</span>( NUC&lt;1 ) {
<a name="l01303"></a>01303                   <span class="keywordflow">if</span> ( (BT &gt; -10) &amp;&amp; (FT &lt;100) ) {
<a name="l01304"></a>01304                       result = exp( -FT/2 );
<a name="l01305"></a>01305                       <span class="keywordflow">if</span> ( BT &lt;10 ) result= result*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(BT);
<a name="l01306"></a>01306                   } <span class="keywordflow">else</span> {
<a name="l01307"></a>01307                       FT = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>((1 + FT/NUC),0.5);
<a name="l01308"></a>01308                       result = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a832cc566efd401151896e48abf8c5b77">STUDNT</a>( NUC, BT/FT )/<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(FT,NUC);
<a name="l01309"></a>01309                   }
<a name="l01310"></a>01310               }
<a name="l01311"></a>01311           }
<a name="l01312"></a>01312           <span class="keywordflow">return</span>(result);
<a name="l01313"></a>01313       }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315 
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="comment">//***********************************************************</span>
<a name="l01318"></a><a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">01318</a>     <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#ae282125e85629aa0c3e5837e86f038f7">ND2</a>(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> rho ){
<a name="l01319"></a>01319         <span class="comment">/*</span>
<a name="l01320"></a>01320 <span class="comment">         *     A function for computing bivariate normal probabilities.</span>
<a name="l01321"></a>01321 <span class="comment">         *     This function is based on the method described by</span>
<a name="l01322"></a>01322 <span class="comment">         *     Z. Drezner and G.O. Wesolowsky, (1989),</span>
<a name="l01323"></a>01323 <span class="comment">         *     On the computation of the bivariate normal integral,</span>
<a name="l01324"></a>01324 <span class="comment">         *     Journal of Statist. Comput. Simul. 35, pp. 101-107,</span>
<a name="l01325"></a>01325 <span class="comment">         *     with major modifications for double precision, and for |R| close to 1.</span>
<a name="l01326"></a>01326 <span class="comment">         *     The software given here has been developed by M.C. Recchioni based on previous</span>
<a name="l01327"></a>01327 <span class="comment">         *     software developed by:</span>
<a name="l01328"></a>01328 <span class="comment">         *     Alan Genz</span>
<a name="l01329"></a>01329 <span class="comment">         *     Department of Mathematics</span>
<a name="l01330"></a>01330 <span class="comment">         *     Washington State University</span>
<a name="l01331"></a>01331 <span class="comment">         *     Pullman, WA 99164-3113</span>
<a name="l01332"></a>01332 <span class="comment">         *     Email : alangenz@wsu.edu</span>
<a name="l01333"></a>01333 <span class="comment">         *     The software developed by A. Genz is available free of charge in the website:</span>
<a name="l01334"></a>01334 <span class="comment">         *     www.math.wsu.edu/faculty/genz/software/software.html</span>
<a name="l01335"></a>01335 <span class="comment">         *</span>
<a name="l01336"></a>01336 <span class="comment">         *</span>
<a name="l01337"></a>01337 <span class="comment">         *      ND2 calculates the probability that X &gt; DH and Y &gt; DK.</span>
<a name="l01338"></a>01338 <span class="comment">         *      Note: Prob( X &lt; DH, Y &lt; DK ) = ND2( -DH, -DK, R ).</span>
<a name="l01339"></a>01339 <span class="comment">         *</span>
<a name="l01340"></a>01340 <span class="comment">         * Parameters</span>
<a name="l01341"></a>01341 <span class="comment">         *</span>
<a name="l01342"></a>01342 <span class="comment">         *   DH  DOUBLE PRECISION, integration limit</span>
<a name="l01343"></a>01343 <span class="comment">         *   DK  DOUBLE PRECISION, integration limit</span>
<a name="l01344"></a>01344 <span class="comment">         *   R   DOUBLE PRECISION, correlation coefficient</span>
<a name="l01345"></a>01345 <span class="comment">         */</span>
<a name="l01346"></a>01346         <span class="keyword">static</span> <span class="keywordtype">double</span> TWOPI = 6.283185307179586;
<a name="l01347"></a>01347         <span class="keyword">static</span> <span class="keywordtype">double</span> result, DK, DH, R;
<a name="l01348"></a>01348         <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>, IS, LG, NG;
<a name="l01349"></a>01349 
<a name="l01350"></a>01350         <span class="keyword">static</span> <span class="keywordtype">double</span> XL[11][4], WL[11][4], AS, AA, BB, C, D, RS, XS, BVN;
<a name="l01351"></a>01351         <span class="keyword">static</span> <span class="keywordtype">double</span> SN, ASR, H, K, BS, HS, HK;
<a name="l01352"></a>01352         <span class="comment">//  Gauss Legendre Points and Weights, N =  6</span>
<a name="l01353"></a>01353         <span class="comment">//  DATA ( W(I,1), X(I,1), I = 1,3) /</span>
<a name="l01354"></a>01354         WL[1][1]=0.1713244923791705;
<a name="l01355"></a>01355         XL[1][1]=-0.9324695142031522;
<a name="l01356"></a>01356         WL[2][1]= 0.3607615730481384;
<a name="l01357"></a>01357         XL[2][1]=-0.6612093864662647;
<a name="l01358"></a>01358         WL[3][1]= 0.4679139345726904;
<a name="l01359"></a>01359         XL[3][1]=-0.2386191860831970;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361         <span class="comment">//  Gauss Legendre Points and Weights, N = 12</span>
<a name="l01362"></a>01362         <span class="comment">//  DATA ( W(I,2), X(I,2), I = 1,6) /</span>
<a name="l01363"></a>01363         WL[1][2]=0.4717533638651177e-01;
<a name="l01364"></a>01364         XL[1][2]=-0.9815606342467191;
<a name="l01365"></a>01365         WL[2][2]=  0.1069393259953183;
<a name="l01366"></a>01366         XL[2][2]=-0.9041172563704750;
<a name="l01367"></a>01367         WL[3][2]=  0.1600783285433464;
<a name="l01368"></a>01368         XL[3][2]=-0.7699026741943050;
<a name="l01369"></a>01369         WL[4][2]=  0.2031674267230659;
<a name="l01370"></a>01370         XL[4][2]=-0.5873179542866171;
<a name="l01371"></a>01371         WL[5][2]=  0.2334925365383547;
<a name="l01372"></a>01372         XL[5][2]=-0.3678314989981802;
<a name="l01373"></a>01373         WL[6][2] = 0.2491470458134029;
<a name="l01374"></a>01374         XL[6][2]=-0.1252334085114692;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         <span class="comment">//  Gauss Legendre Points and Weights, N = 20</span>
<a name="l01377"></a>01377         <span class="comment">//  DATA ( W(I,3), X(I,3), I = 1, 10 ) /</span>
<a name="l01378"></a>01378         WL[1][3]=0.1761400713915212e-01;
<a name="l01379"></a>01379         XL[1][3]=-0.9931285991850949;
<a name="l01380"></a>01380         WL[2][3]=0.4060142980038694e-01;
<a name="l01381"></a>01381         XL[2][3]=-0.9639719272779138;
<a name="l01382"></a>01382         WL[3][3]=0.6267204833410906e-01;
<a name="l01383"></a>01383         XL[3][3]=-0.9122344282513259;
<a name="l01384"></a>01384         WL[4][3]=0.8327674157670475e-01;
<a name="l01385"></a>01385         XL[4][3]=-0.8391169718222188;
<a name="l01386"></a>01386         WL[5][3]=0.1019301198172404;
<a name="l01387"></a>01387         XL[5][3]=-0.7463319064601508;
<a name="l01388"></a>01388         WL[6][3]=0.1181945319615184;
<a name="l01389"></a>01389         XL[6][3]=-0.6360536807265150;
<a name="l01390"></a>01390         WL[7][3]=0.1316886384491766;
<a name="l01391"></a>01391         XL[7][3]=-0.5108670019508271;
<a name="l01392"></a>01392         WL[8][3]=0.1420961093183821;
<a name="l01393"></a>01393         XL[8][3]=-0.3737060887154196;
<a name="l01394"></a>01394         WL[9][3]=0.1491729864726037;
<a name="l01395"></a>01395         XL[9][3]=-0.2277858511416451;
<a name="l01396"></a>01396         WL[10][3]=0.1527533871307259;
<a name="l01397"></a>01397         XL[10][3]=-0.7652652113349733e-01;
<a name="l01398"></a>01398 
<a name="l01399"></a>01399         R=rho;
<a name="l01400"></a>01400         DH=<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#ae0e5e63c42e87bfe1ae6c53a72160068">a</a>;
<a name="l01401"></a>01401         DK=<a class="code" href="namespaceanonymous__namespace_02marketmodel_8cpp_03.html#a363b018ed55f2c9dd81e7c8d53aab592">b</a>;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403         <span class="keywordflow">if</span>( fabs(R) &lt; 0.3 ) {
<a name="l01404"></a>01404             NG = 1;
<a name="l01405"></a>01405             LG = 3; }
<a name="l01406"></a>01406         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( fabs(R) &lt; 0.75 ) {
<a name="l01407"></a>01407             NG = 2;
<a name="l01408"></a>01408             LG = 6;}
<a name="l01409"></a>01409         <span class="keywordflow">else</span>{
<a name="l01410"></a>01410             NG = 3;
<a name="l01411"></a>01411             LG = 10;
<a name="l01412"></a>01412         }
<a name="l01413"></a>01413         H = DH;
<a name="l01414"></a>01414         K = DK;
<a name="l01415"></a>01415         HK = H*K;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417         BVN = 0.0 ;
<a name="l01418"></a>01418         <span class="keywordflow">if</span>( fabs(R) &lt; 0.925 ) {
<a name="l01419"></a>01419             <span class="keywordflow">if</span>( fabs(R) &gt; 0 ) {
<a name="l01420"></a>01420                 HS = ( H*H + K*K )/2;
<a name="l01421"></a>01421                 ASR = asin(R);
<a name="l01422"></a>01422                 <span class="keywordflow">for</span> (I = 1;I&lt;= LG; I++){
<a name="l01423"></a>01423                     <span class="keywordflow">for</span>( IS = -1; IS&lt;= 1; IS=IS+2){
<a name="l01424"></a>01424                         SN = sin( ASR*(  IS*XL[I][NG] + 1 )/2 );
<a name="l01425"></a>01425                         BVN = BVN + WL[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>][NG]*exp( ( SN*HK-HS )/( 1.0-SN*SN ) );
<a name="l01426"></a>01426 
<a name="l01427"></a>01427                     }
<a name="l01428"></a>01428                 }
<a name="l01429"></a>01429                 BVN = BVN*ASR/( 2*TWOPI );
<a name="l01430"></a>01430 
<a name="l01431"></a>01431             }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433             BVN = BVN + <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(-H)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(-K);
<a name="l01434"></a>01434 
<a name="l01435"></a>01435         }
<a name="l01436"></a>01436         <span class="keywordflow">else</span>
<a name="l01437"></a>01437             {
<a name="l01438"></a>01438                 <span class="keywordflow">if</span> ( R &lt; 0 ) {
<a name="l01439"></a>01439                     K = -K;
<a name="l01440"></a>01440                     HK = -HK;
<a name="l01441"></a>01441                 }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443                 <span class="keywordflow">if</span>( fabs(R) &lt;1 ) {
<a name="l01444"></a>01444                     AS = ( 1 - R )*( 1 + R );
<a name="l01445"></a>01445                     AA = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(AS,0.5);
<a name="l01446"></a>01446 
<a name="l01447"></a>01447                     BS = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(( H - K ),2);
<a name="l01448"></a>01448                     C = ( 4 - HK )/8 ;
<a name="l01449"></a>01449                     D = ( 12 - HK )/16;
<a name="l01450"></a>01450                     ASR = -( BS/AS + HK )/2;
<a name="l01451"></a>01451                     <span class="keywordflow">if</span>( ASR &gt; -100 ) BVN = AA*exp(ASR)*( 1 - C*( BS - AS )*( 1 - D*BS/5 )/3 + C*D*AS*AS/5 );
<a name="l01452"></a>01452                     <span class="keywordflow">if</span>( -HK&lt;100 ){
<a name="l01453"></a>01453                         BB = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(BS,0.5);
<a name="l01454"></a>01454                         BVN = BVN - exp( -HK/2 )*<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>(TWOPI,0.5)*<a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(-BB/AA)*BB*( 1 - C*BS*( 1 - D*BS/5 )/3 );
<a name="l01455"></a>01455                     }
<a name="l01456"></a>01456                     AA = AA/2   ;
<a name="l01457"></a>01457                     <span class="keywordflow">for</span> (I = 1; I&lt;= LG;I++){
<a name="l01458"></a>01458                         <span class="keywordflow">for</span>( IS = -1; IS&lt;=1; IS=IS+2){
<a name="l01459"></a>01459                             XS =<a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( ( AA*(  IS*XL[I][NG] + 1 ) ),2)  ;
<a name="l01460"></a>01460                             RS = <a class="code" href="perturbativebarrieroptionengine_8cpp.html#ad3fdc89d294523ce27c49c1c4b34f558">POW</a>( (1 - XS),2 );
<a name="l01461"></a>01461                             ASR = -( BS/XS + HK )/2;
<a name="l01462"></a>01462                             <span class="keywordflow">if</span> ( ASR &gt; -100 ) {
<a name="l01463"></a>01463 
<a name="l01464"></a>01464                                 BVN = BVN + AA*WL[<a class="code" href="namespaceanonymous__namespace_02matrices_8cpp_03.html#acde38c3bc61e50097a3422b06a1816aa">I</a>][NG]*exp( ASR )*(exp( -HK*( 1 - RS )/( 2*( 1 + RS ) ) )/RS- ( 1 + C*XS*( 1 + D*XS ) ) );
<a name="l01465"></a>01465 
<a name="l01466"></a>01466 
<a name="l01467"></a>01467                             }
<a name="l01468"></a>01468                         }
<a name="l01469"></a>01469                     }
<a name="l01470"></a>01470                     BVN = -BVN/TWOPI;
<a name="l01471"></a>01471                 }
<a name="l01472"></a>01472                 <span class="keywordflow">if</span> ( R &gt; 0 )  {
<a name="l01473"></a>01473 
<a name="l01474"></a>01474                     BVN =  BVN + <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>( -max( H, K ) );
<a name="l01475"></a>01475 
<a name="l01476"></a>01476                 }
<a name="l01477"></a>01477                 <span class="keywordflow">else</span>
<a name="l01478"></a>01478                     {
<a name="l01479"></a>01479                         BVN = -BVN;
<a name="l01480"></a>01480                         <span class="keywordflow">if</span>( K &gt; H ) BVN = BVN + <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(K) - <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a95a2d20c2dbb17ceb66217aae9befa91">PHID</a>(H);
<a name="l01481"></a>01481                     }
<a name="l01482"></a>01482             }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 
<a name="l01485"></a>01485         result=BVN;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487         <span class="keywordflow">return</span>(result);
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 <span class="keyword">namespace </span>QuantLib {
<a name="l01495"></a>01495 
<a name="l01496"></a><a class="code" href="namespace_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html">01496</a>     <span class="keyword">namespace </span>{
<a name="l01497"></a>01497 
<a name="l01498"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html">01498</a>         <span class="keyword">struct </span><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html">integr_adapter</a> {
<a name="l01499"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html#aa7bba4d6fe48f6cd7bcab3f0325f3d6d">01499</a>             boost::shared_ptr&lt;YieldTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html#aa7bba4d6fe48f6cd7bcab3f0325f3d6d">r</a>;
<a name="l01500"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html#acebe20022fe671dbed676cabc4c86c81">01500</a>             <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html">integr_adapter</a>(
<a name="l01501"></a>01501                     boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt; process)
<a name="l01502"></a>01502             : r(*(process-&gt;riskFreeRate())) {}
<a name="l01503"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html#a6a97ee6fadf40f295db408243bec468a">01503</a>             <span class="keywordtype">double</span> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integr__adapter.html#a6a97ee6fadf40f295db408243bec468a">operator()</a>(<span class="keywordtype">double</span> t1,<span class="keywordtype">double</span> t2)<span class="keyword"> const </span>{
<a name="l01504"></a>01504                 <span class="keywordflow">return</span> r-&gt;forwardRate(t1,t2,<a class="code" href="namespace_quant_lib.html#a1d1b94285bc6741279c70fac8b34265baae77494393cf12a7dd3634b002d4ffda">Continuous</a>) * (t2-t1);
<a name="l01505"></a>01505             }
<a name="l01506"></a>01506         };
<a name="l01507"></a>01507 
<a name="l01508"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html">01508</a>         <span class="keyword">struct </span><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html">integalpha_adapter</a> {
<a name="l01509"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#a4619b74d8defcf84b3ef347d44aedc7e">01509</a>             boost::shared_ptr&lt;YieldTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#a4619b74d8defcf84b3ef347d44aedc7e">r</a>;
<a name="l01510"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#a8ef2192633256082ddb1f9137e0da2a8">01510</a>             boost::shared_ptr&lt;YieldTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#a8ef2192633256082ddb1f9137e0da2a8">q</a>;
<a name="l01511"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#a015a8c5b8f697e5314056cb2be3fc104">01511</a>             <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html">integalpha_adapter</a>(
<a name="l01512"></a>01512                     boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt; process)
<a name="l01513"></a>01513             : r(*(process-&gt;riskFreeRate())),
<a name="l01514"></a>01514               q(*(process-&gt;dividendYield())) {}
<a name="l01515"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#aa5d4aba5904d20594cd0eeee9d33f9dc">01515</a>             <span class="keywordtype">double</span> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integalpha__adapter.html#aa5d4aba5904d20594cd0eeee9d33f9dc">operator()</a>(<span class="keywordtype">double</span> t1,<span class="keywordtype">double</span> t2)<span class="keyword"> const </span>{
<a name="l01516"></a>01516                 <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> alpha = r-&gt;forwardRate(t1,t2,<a class="code" href="namespace_quant_lib.html#a1d1b94285bc6741279c70fac8b34265baae77494393cf12a7dd3634b002d4ffda">Continuous</a>)
<a name="l01517"></a>01517                            - q-&gt;forwardRate(t1,t2,<a class="code" href="namespace_quant_lib.html#a1d1b94285bc6741279c70fac8b34265baae77494393cf12a7dd3634b002d4ffda">Continuous</a>);
<a name="l01518"></a>01518                 <span class="keywordflow">return</span> alpha * (t2-t1);
<a name="l01519"></a>01519             }
<a name="l01520"></a>01520         };
<a name="l01521"></a>01521 
<a name="l01522"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html">01522</a>         <span class="keyword">struct </span><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html">alpha_adapter</a> {
<a name="l01523"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a17027774d6b0e192d0f227e877a05691">01523</a>             boost::shared_ptr&lt;YieldTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a17027774d6b0e192d0f227e877a05691">r</a>;
<a name="l01524"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a5182dd79be921c5e010b3d480b734798">01524</a>             boost::shared_ptr&lt;YieldTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a5182dd79be921c5e010b3d480b734798">q</a>;
<a name="l01525"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a9ca0e22189d2715a71937bcab51c0290">01525</a>             <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html">alpha_adapter</a>(
<a name="l01526"></a>01526                     boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt; process)
<a name="l01527"></a>01527             : r(*(process-&gt;riskFreeRate())),
<a name="l01528"></a>01528               q(*(process-&gt;dividendYield())) {}
<a name="l01529"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a626f9a82f3fc60bc3993a2859ee80e1b">01529</a>             <span class="keywordtype">double</span> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1alpha__adapter.html#a626f9a82f3fc60bc3993a2859ee80e1b">operator()</a>(<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>)<span class="keyword"> const </span>{
<a name="l01530"></a>01530                 <span class="keywordflow">return</span> r-&gt;forwardRate(t,t,<a class="code" href="namespace_quant_lib.html#a1d1b94285bc6741279c70fac8b34265baae77494393cf12a7dd3634b002d4ffda">Continuous</a>)
<a name="l01531"></a>01531                      - q-&gt;forwardRate(t,t,<a class="code" href="namespace_quant_lib.html#a1d1b94285bc6741279c70fac8b34265baae77494393cf12a7dd3634b002d4ffda">Continuous</a>);
<a name="l01532"></a>01532             }
<a name="l01533"></a>01533         };
<a name="l01534"></a>01534 
<a name="l01535"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html">01535</a>         <span class="keyword">struct </span><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html">sigmaq_adapter</a> {
<a name="l01536"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#a8429c4a3c105cbe98e0afdcc159bae2a">01536</a>             boost::shared_ptr&lt;BlackVolTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#a8429c4a3c105cbe98e0afdcc159bae2a">v</a>;
<a name="l01537"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#a464933aa2bf58944dcfef9da88ef09a1">01537</a>             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#a464933aa2bf58944dcfef9da88ef09a1">s</a>;
<a name="l01538"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#a24029b99d012413e41d6167c6ab39647">01538</a>             <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html">sigmaq_adapter</a>(
<a name="l01539"></a>01539                     boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt; process)
<a name="l01540"></a>01540             : <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(*(process-&gt;blackVolatility())),
<a name="l01541"></a>01541               s(process-&gt;x0()) {}
<a name="l01542"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#aa44e0884b6f396f98fa3ba034986ff45">01542</a>             <span class="keywordtype">double</span> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1sigmaq__adapter.html#aa44e0884b6f396f98fa3ba034986ff45">operator()</a>(<span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02quantlibbenchmark_8cpp_03.html#a7a969063fde0030bd36b46055e824c34">t</a>)<span class="keyword"> const </span>{
<a name="l01543"></a>01543                 <span class="keywordtype">double</span> <a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a> = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>-&gt;blackForwardVol(t,t,s,<span class="keyword">true</span>);
<a name="l01544"></a>01544                 <span class="keywordflow">return</span> sigma*<a class="code" href="namespaceanonymous__namespace_02distributions_8cpp_03.html#ab5b4e39d0154ccd92bd47cff2ea0f8da">sigma</a>;
<a name="l01545"></a>01545             }
<a name="l01546"></a>01546         };
<a name="l01547"></a>01547 
<a name="l01548"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html">01548</a>         <span class="keyword">struct </span><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html">integs_adapter</a> {
<a name="l01549"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a069da14e79ffeb94a84cec2f7ef1fa4a">01549</a>             boost::shared_ptr&lt;BlackVolTermStructure&gt; <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a069da14e79ffeb94a84cec2f7ef1fa4a">v</a>;
<a name="l01550"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a5d09db565e8e170b2abd4b14238c2bba">01550</a>             <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a5d09db565e8e170b2abd4b14238c2bba">s</a>;
<a name="l01551"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a8a8ed1d3e57b061e5965fa8334fac8ff">01551</a>             <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html">integs_adapter</a>(
<a name="l01552"></a>01552                     boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt; process)
<a name="l01553"></a>01553             : <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>(*(process-&gt;blackVolatility())),
<a name="l01554"></a>01554               s(process-&gt;x0()) {}
<a name="l01555"></a><a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a315f1afed51d54b4bc055c84ed1b9c17">01555</a>             <span class="keywordtype">double</span> <a class="code" href="struct_quant_lib_1_1anonymous__namespace_02perturbativebarrieroptionengine_8cpp_03_1_1integs__adapter.html#a315f1afed51d54b4bc055c84ed1b9c17">operator()</a>(<span class="keywordtype">double</span> t1,<span class="keywordtype">double</span> t2)<span class="keyword"> const </span>{
<a name="l01556"></a>01556                 <span class="keywordflow">return</span> <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a1c6cf95dc58d77fbce730d3c1f8ccda7">v</a>-&gt;blackForwardVariance(t1,t2,s,<span class="keyword">true</span>);
<a name="l01557"></a>01557             }
<a name="l01558"></a>01558         };
<a name="l01559"></a>01559 
<a name="l01560"></a>01560     }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 
<a name="l01563"></a><a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#ae93a5a9fba1d432805125008d36684a2">01563</a>     PerturbativeBarrierOptionEngine::PerturbativeBarrierOptionEngine(
<a name="l01564"></a>01564              <span class="keyword">const</span> boost::shared_ptr&lt;GeneralizedBlackScholesProcess&gt;&amp; process,
<a name="l01565"></a>01565              <a class="code" href="namespace_quant_lib.html#a9adc2615d630d6006896b3402b09b03b" title="positive integer">Natural</a> order,
<a name="l01566"></a>01566              <span class="keywordtype">bool</span> zeroGamma)
<a name="l01567"></a>01567     : process_(process), order_(order), zeroGamma_(zeroGamma) {
<a name="l01568"></a>01568         <a class="code" href="class_quant_lib_1_1_observer.html#a4c9f4fc7a6b55b246566c40462b95121">registerWith</a>(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>);
<a name="l01569"></a>01569     }
<a name="l01570"></a>01570 
<a name="l01571"></a><a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#a2c8bb3d51db1bd55ad5711412f5c6a90">01571</a>     <span class="keywordtype">void</span> <a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#a2c8bb3d51db1bd55ad5711412f5c6a90">PerturbativeBarrierOptionEngine::calculate</a>()<span class="keyword"> const </span>{
<a name="l01572"></a>01572 
<a name="l01573"></a>01573         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(<a class="code" href="class_quant_lib_1_1_generic_engine.html#ad2371cdbafa1989afb0e4733b1212c0d">arguments_</a>.<a class="code" href="class_quant_lib_1_1_barrier_option_1_1arguments.html#a2bf0f30265216f30ac7fad6479b12c05">barrierType</a> == <a class="code" href="struct_quant_lib_1_1_barrier.html#a74f1d3a3af3f96c1b79b27e057930afea72da8e89652b3788c5176399ec3a55c4">Barrier::UpOut</a>,
<a name="l01574"></a>01574                    <span class="stringliteral">&quot;this engine only manages up-and-out options&quot;</span>);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(<a class="code" href="class_quant_lib_1_1_generic_engine.html#ad2371cdbafa1989afb0e4733b1212c0d">arguments_</a>.<a class="code" href="class_quant_lib_1_1_barrier_option_1_1arguments.html#a1ab85bcdc6da257ce14550d46261f832">rebate</a> == 0.0,
<a name="l01577"></a>01577                    <span class="stringliteral">&quot;this engine does not manage non-null rebates&quot;</span>);
<a name="l01578"></a>01578 
<a name="l01579"></a>01579         boost::shared_ptr&lt;PlainVanillaPayoff&gt; payoff =
<a name="l01580"></a>01580             boost::dynamic_pointer_cast&lt;<a class="code" href="class_quant_lib_1_1_plain_vanilla_payoff.html" title="Plain-vanilla payoff.">PlainVanillaPayoff</a>&gt;(<a class="code" href="class_quant_lib_1_1_generic_engine.html#ad2371cdbafa1989afb0e4733b1212c0d">arguments_</a>.payoff);
<a name="l01581"></a>01581         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(payoff &amp;&amp; payoff-&gt;optionType() == <a class="code" href="class_quant_lib_1_1_option.html#abaee7fc605354c444867545492cd5845aa96ffa37e51c7bbea13951f106dbd3c0">Option::Put</a>,
<a name="l01582"></a>01582                    <span class="stringliteral">&quot;this engine only manages put options&quot;</span>);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> stock = <a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>-&gt;x0();
<a name="l01585"></a>01585         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> kprice = payoff-&gt;strike();
<a name="l01586"></a>01586         <a class="code" href="namespace_quant_lib.html#a372ac5c1a422a6b276fe0552d4d83f50" title="real number">Real</a> hbarr = <a class="code" href="class_quant_lib_1_1_generic_engine.html#ad2371cdbafa1989afb0e4733b1212c0d">arguments_</a>.<a class="code" href="class_quant_lib_1_1_barrier_option_1_1arguments.html#aedad56574cc1d09c921fe3c40041801d">barrier</a>;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <a class="code" href="namespace_quant_lib.html#a4f78b18a4dd1a979eb78b4e1e8ac1503" title="continuous quantity with 1-year units">Time</a> tauMin = 0.0;
<a name="l01589"></a>01589         <a class="code" href="namespace_quant_lib.html#a4f78b18a4dd1a979eb78b4e1e8ac1503" title="continuous quantity with 1-year units">Time</a> tauMax = <a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>-&gt;time(<a class="code" href="class_quant_lib_1_1_generic_engine.html#ad2371cdbafa1989afb0e4733b1212c0d">arguments_</a>.exercise-&gt;lastDate());
<a name="l01590"></a>01590 
<a name="l01591"></a>01591         <a class="code" href="errors_8hpp.html#a7a9bcab8006882bc7d5302a0861ab1a6" title="throw an error if the given pre-condition is not verified">QL_REQUIRE</a>(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#a2bea38f882b2449374831d35117f9366">order_</a> &lt;= 2, <span class="stringliteral">&quot;order must be &lt;= 2&quot;</span>);
<a name="l01592"></a>01592 
<a name="l01593"></a>01593         <span class="keywordtype">int</span> igm = <a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#a6ba1961a53cdf82d666a37935f184912">zeroGamma_</a> ? 0 : 1;
<a name="l01594"></a>01594         
<a name="l01595"></a>01595         <a class="code" href="class_quant_lib_1_1_generic_engine.html#a41281f2ea4990dbce90be1f9f2e231f6">results_</a>.<a class="code" href="class_quant_lib_1_1_instrument_1_1results.html#a83e6af07c17237ade11121f8ad74b4e5">value</a> = <a class="code" href="namespaceanonymous__namespace_02perturbativebarrieroptionengine_8cpp_03.html#a83b7af85879e60d95a0cbadd8d033c01">BarrierUPD</a>(kprice, stock, hbarr,
<a name="l01596"></a>01596                                     tauMin, tauMax, <a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#a2bea38f882b2449374831d35117f9366">order_</a>, igm,
<a name="l01597"></a>01597                                     integr_adapter(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>),
<a name="l01598"></a>01598                                     integalpha_adapter(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>),
<a name="l01599"></a>01599                                     integs_adapter(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>),
<a name="l01600"></a>01600                                     alpha_adapter(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>),
<a name="l01601"></a>01601                                     sigmaq_adapter(<a class="code" href="class_quant_lib_1_1_perturbative_barrier_option_engine.html#abb5ca0f8702c07cea9e7c6a75dbaf806">process_</a>));
<a name="l01602"></a>01602     }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 }
<a name="l01605"></a>01605 
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="perturbativebarrieroptionengine_8cpp.html">perturbativebarrieroptionengine.cpp</a>      </li>

    <li class="footer">Generated on Sat Aug 25 2012 13:50:42 for QuantLib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
